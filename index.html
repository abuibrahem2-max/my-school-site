<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†ØµØ© Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø±Ø§Ø´Ø¯ÙˆÙ†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    
    <script>
        function replaceEmojis(text) {
             const emojiMap = {
                 ':)': 'ğŸ˜Š', ':D': 'ğŸ˜', ':(': 'ğŸ˜', ';)': 'ğŸ˜‰', 
                 ':|': 'ğŸ˜', ':o': 'ğŸ˜®', '<3': 'â¤ï¸', '8)': 'ğŸ˜'
             };
             let replacedText = text;
             for (const key in emojiMap) {
                 const safeKey = key.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
                 const regex = new RegExp(safeKey, 'g');
                 replacedText = replacedText.replace(regex, emojiMap[key]);
             }
             return replacedText;
        }
    </script>

    <style>
        body { font-family: 'Cairo', sans-serif; padding-bottom: 100px; }
        #chat-messages::-webkit-scrollbar { width: 6px; }
        #chat-messages::-webkit-scrollbar-thumb { background-color: #9ca3af; border-radius: 3px; }
        .notification-badge { position: absolute; top: -8px; right: -8px; background-color: red; color: white; border-radius: 50%; padding: 0.1em 0.4em; font-size: 0.75rem; font-weight: bold; display: flex; align-items: center; justify-content: center; min-width: 1.25rem; height: 1.25rem; z-index: 10; }
        #chat-total-badge { position: absolute; top: 0; right: 0; transform: translate(50%, -50%); background-color: red; color: white; border-radius: 50%; padding: 0.1em 0.5em; font-size: 0.85rem; font-weight: bold; display: flex; align-items: center; justify-content: center; min-width: 1.75rem; height: 1.75rem; box-shadow: 0 0 0 3px #f3f4f6; }
        .private-chat-header { font-weight: bold; color: #008080; padding: 10px 0; border-bottom: 2px solid #008080; }
        
        /* Print Styles */
        .print-container { position: absolute; left: -9999px; top: -9999px; width: 210mm; height: 297mm; padding: 15mm; background-color: white; color: black; font-family: 'Cairo', sans-serif; display: flex; flex-direction: column; box-sizing: border-box; }
        .print-super-header { background-color: #008080; color: white; padding: 15px; text-align: center; border-radius: 8px; margin-bottom: 10px; line-height: 1.6; font-size: 16px; }
        .print-header { background-color: #008080; color: white; padding: 20px; text-align: center; border-radius: 8px; margin-bottom: 20px; }
        .print-header h1 { font-size: 28px; font-weight: bold; margin: 0; }
        .print-content-wrapper { flex-grow: 1; }
        .print-section { margin-bottom: 25px; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; }
        .print-section-title { font-size: 22px; font-weight: bold; padding: 15px; background-color: #f4f4f4; border-bottom: 1px solid #ddd; }
        .print-item-list { padding: 15px; }
        .print-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #eee; }
        .print-item:last-child { border-bottom: none; }
        .print-item-text { flex-grow: 1; margin-right: 15px; display: flex; flex-direction: column; justify-content: center; }
        .print-item-title { font-size: 18px; font-weight: 600; margin-bottom: 5px; }
        .print-item-qr { width: 80px; height: 80px; margin-left: 15px; flex-shrink: 0; }
        .print-footer { display: flex; justify-content: space-between; padding-top: 15px; margin-top: 20px; border-top: 2px solid #008080; font-size: 14px; font-weight: 600; }
        
        .drag-handle { cursor: move; flex-shrink: 0; margin-left: 8px; padding: 4px; border-radius: 4px; transition: background-color 0.2s; color: #008080; }
        .drag-handle:hover { background-color: #f3f4f6; color: #008080; }
        .section-drag-handle { cursor: move; flex-shrink: 0; padding: 0.5rem; color: #6b7280; border-radius: 4px; transition: background-color 0.2s; }
        .section-drag-handle:hover { background-color: #f3f4f6; color: #1f2937; }
        .sortable-drag { opacity: 0.5 !important; border: 2px dashed #008080; }
        .sortable-ghost { opacity: 0.1; }
        .action-popup { position: absolute; top: 100%; left: 0; z-index: 20; min-width: 120px; }
        
        #selection-bar { position: fixed; bottom: 0; left: 0; right: 0; z-index: 90; transition: transform 0.3s ease-in-out; transform: translateY(100%); }
        #selection-bar.visible { transform: translateY(0); }
        .item-selection-checkbox { flex-shrink: 0; width: 1.25rem; height: 1.25rem; margin-left: 12px; border-radius: 4px; border-color: #9ca3af; color: #008080; cursor: pointer; transition: all 0.2s; }
        .item-selection-checkbox:hover { border-color: #008080; }
        .item-selection-checkbox:focus { ring: 0; ring-offset: 0; outline: none; box-shadow: none; }

        .icon-picker { display: flex; flex-wrap: wrap; gap: 8px; max-height: 150px; overflow-y: auto; padding: 8px; border: 1px solid #ddd; border-radius: 8px; background-color: #f9f9f9; }
        .icon-picker-item { cursor: pointer; font-size: 1.5rem; padding: 4px; border-radius: 4px; transition: background-color 0.2s, transform 0.2s; border: 2px solid transparent; }
        .icon-picker-item:hover { background-color: #e9e9e9; transform: scale(1.1); }
        .icon-picker-item.selected { border-color: #008080; background-color: #e0f2f1; }
        .section-title-icon { font-size: 1.5rem; margin-left: 8px; flex-shrink: 0; }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, addDoc, onSnapshot, query, updateDoc, arrayUnion, getDoc, setDoc, deleteDoc, getDocs, where, serverTimestamp, arrayRemove, orderBy, limit, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
        const firebaseConfig = {
          apiKey: "AIzaSyCAabU3qzh2wmWmA8v95oabloap1PNyHwI",
          authDomain: "jaded-3ef9d.firebaseapp.com",
          projectId: "jaded-3ef9d",
          storageBucket: "jaded-3ef9d.firebasestorage.app",
          messagingSenderId: "240292137665",
          appId: "1:240292137665:web:02597426d8288ca0c16240"
        };
        
        const DEFAULT_ADMIN_EMAIL = "abuibrahem2@gmail.com"; 
        
        let app, auth, db, userId;
        let sectionsCollectionRef, usersCollectionRef, permissionRequestsCollectionRef;
        const sectionsPath = `sections`, usersPath = `users`, permissionRequestsPath = `permissionRequests`, configPath = 'config';

        let currentUserName = null, currentUserEmail = null, currentUserRole = 'viewer', isUserAdmin = false, isAppInitialized = false;
        let selectionBasket = []; 
        const adminControls = ['add-section-btn', 'admin-manage-btn', 'admin-perms-btn', 'admin-settings-btn'];
        const generalControls = ['print-sections-btn', 'logout-btn'];
        let globalConfig = { isChatEnabled: true };

        let permissionRequestsUnsubscribe = null, userDocUnsubscribe = null, globalConfigUnsubscribe = null, sectionSortingInstance = null;

        let chatAllUsers = {}, chatAdminList = {}, chatCurrentChat = { type: 'group', id: 'group' };
        let chatUnreadCounts = {}, chatMessageListeners = {}, chatSynth, chatSoundReady = false;
        
        const chatPaths = {
            usersCollection: () => collection(db, usersPath), 
            userDoc: (uid) => doc(db, usersPath, uid), 
            groupChatCollection: () => collection(db, `chat_group`),
            privateChatCollection: (chatId) => collection(db, `chat_private/${chatId}`, 'messages'),
            userChatStateCollection: (uid) => collection(db, `chat_state/${uid}/state`), 
            userChatStateDoc: (uid, chatId) => doc(db, `chat_state/${uid}/state`, chatId),
        };

        const PREDEFINED_ICONS = ['ğŸ“š', 'ğŸ’¡', 'ğŸ”—', 'ğŸ“‹', 'ğŸ“', 'ğŸ“', 'â­', 'ğŸš€', 'ğŸ¯', 'ğŸ”', 'ğŸ””', 'ğŸ‘¤', 'ğŸŒ', 'ğŸ“ˆ', 'ğŸ”§', 'âœ…', 'âš ï¸', 'ğŸ ', 'ğŸ“…', 'ğŸ’¬'];
        const DEFAULT_ICON = 'ğŸ“š';

        // Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ù†Ø§ØµØ± DOM
        let sectionsContainer, userNameDisplay, userAvatar, permsBtnBadge, initialLoadingMessage; 
        let chatWindow, chatListView, chatMessageView, closeChatBtn1, closeChatBtn2, chatBackBtn, chatUsernameDisplay, chatUsersListDiv, chatMessagesDiv, messageForm, messageInput, chatTitle, chatSubtitle;
        let loginModal, loginForm, loginError, addSectionModal, addSectionModalContent, addSectionForm, closeSectionModalBtn, cancelSectionModalBtn;
        let addItemModal, modalContent, closeModalBtn, cancelModalBtn, addItemForm, columnIdInput, itemTypeInput;
        let editSectionModal, editSectionForm, editSectionTitleInput, editSectionIdInput;
        let editItemModal, editItemForm, editItemTitleInput, editItemLinkInput, editItemIdInput, editItemSectionIdInput;
        let alertModal, pdfSpinnerModal, adminManageModal, adminUsersList, adminPermsModal, adminPermsList, adminSettingsModal;
        let currentEditorsList, currentEditorsContainer; 
        let logoutBtn, loginAdminBtn, chatTotalBadge, deleteAllChatBtn; 
        let selectionBar, selectionCountShare, selectionCountPrint, selectionShareBtn, selectionPrintBtn, selectionClearBtn;

        document.addEventListener('DOMContentLoaded', () => {
            sectionsContainer = document.getElementById('sections-container');
            userNameDisplay = document.getElementById('user-name-display');
            userAvatar = document.getElementById('user-avatar');
            pdfSpinnerModal = document.getElementById('pdf-spinner-modal');
            permsBtnBadge = document.getElementById('admin-perms-badge'); 
            initialLoadingMessage = document.getElementById('initial-loading-message'); 
            
            logoutBtn = document.getElementById('logout-btn');
            loginAdminBtn = document.getElementById('login-admin-btn');
            chatTotalBadge = document.getElementById('chat-toggle').querySelector('#chat-total-badge');
            deleteAllChatBtn = document.getElementById('delete-all-chat-btn');

            loginModal = document.getElementById('login-modal');
            loginForm = document.getElementById('login-form');
            loginError = document.getElementById('login-error');
            
            selectionBar = document.getElementById('selection-bar');
            selectionCountShare = document.getElementById('selection-count-share');
            selectionCountPrint = document.getElementById('selection-count-print');
            selectionShareBtn = document.getElementById('selection-share-btn');
            selectionPrintBtn = document.getElementById('selection-print-btn');
            selectionClearBtn = document.getElementById('selection-clear-btn');
            
            if (selectionShareBtn) selectionShareBtn.addEventListener('click', shareSelectedItems);
            if (selectionPrintBtn) selectionPrintBtn.addEventListener('click', printSelectedItems);
            if (selectionClearBtn) selectionClearBtn.addEventListener('click', clearSelection);

            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            sectionsCollectionRef = collection(db, sectionsPath);
            usersCollectionRef = collection(db, usersPath);
            permissionRequestsCollectionRef = collection(db, permissionRequestsPath);

            listenToAuthChanges();

            if (loginForm) loginForm.addEventListener('submit', handleLoginSubmit);
            
            if (loginAdminBtn) {
                 loginAdminBtn.addEventListener('click', () => {
                     if (loginError) loginError.classList.add('hidden');
                     if (loginModal) loginModal.classList.remove('hidden');
                 });
            }
            
            const registerBtn = document.getElementById('register-new-user-btn');
            if (registerBtn) registerBtn.addEventListener('click', handleRegistration);
            
             document.addEventListener('click', (e) => {
                 const popups = document.querySelectorAll('.item-action-popup:not(.hidden)');
                 popups.forEach(popup => {
                     const itemCard = popup.closest('.item-card');
                     const itemActionBtn = itemCard ? itemCard.querySelector('.item-action-btn') : null;
                     if (itemActionBtn && !itemActionBtn.contains(e.target) && !popup.contains(e.target)) {
                         popup.classList.add('hidden');
                     }
                 });
             });
        });

        // --- Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© ---
        function createIconPicker(containerId, hiddenInputId) {
            const container = document.getElementById(containerId);
            const hiddenInput = document.getElementById(hiddenInputId);
            if (!container || !hiddenInput) return;

            container.innerHTML = '';
            PREDEFINED_ICONS.forEach(icon => {
                const span = document.createElement('span');
                span.className = 'icon-picker-item';
                span.textContent = icon;
                span.dataset.icon = icon;
                span.title = icon;
                
                span.addEventListener('click', () => {
                    container.querySelectorAll('.icon-picker-item').forEach(item => {
                        item.classList.remove('selected');
                    });
                    span.classList.add('selected');
                    hiddenInput.value = icon;
                });
                container.appendChild(span);
            });
        }
        
        function setSelectedIcon(containerId, hiddenInputId, icon) {
            const container = document.getElementById(containerId);
            const hiddenInput = document.getElementById(hiddenInputId);
            if (!container || !hiddenInput) return;

            const iconToSelect = icon || DEFAULT_ICON;
            hiddenInput.value = iconToSelect;
            
            container.querySelectorAll('.icon-picker-item').forEach(item => {
                if (item.dataset.icon === iconToSelect) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
        }

        // --- Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ÙˆØ§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ---
        function listenToAuthChanges() {
             onAuthStateChanged(auth, async (user) => {
                 if (userDocUnsubscribe) { userDocUnsubscribe(); userDocUnsubscribe = null; }
                 if (permissionRequestsUnsubscribe) { permissionRequestsUnsubscribe(); permissionRequestsUnsubscribe = null; }
                 if (globalConfigUnsubscribe) { globalConfigUnsubscribe(); globalConfigUnsubscribe = null; }
                 
                 if (user) {
                     userId = user.uid;
                     currentUserEmail = user.email || 'ØºÙŠØ± Ù…Ø³Ø¬Ù„';
                     if (initialLoadingMessage) initialLoadingMessage.classList.add('hidden');

                     const userDocRef = doc(db, usersPath, userId);
                     const userDocSnap = await getDoc(userDocRef);
                     
                     let initialUserData;
                     if (userDocSnap.exists()) {
                         initialUserData = userDocSnap.data();
                         currentUserName = initialUserData.name || currentUserEmail;
                         currentUserRole = initialUserData.role || 'viewer';
                         isUserAdmin = (currentUserRole === 'admin');
                     } else {
                          const name = user.displayName || currentUserEmail.split('@')[0] || 'Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯';
                          initialUserData = { name: name, email: currentUserEmail, role: 'viewer', createdAt: serverTimestamp() };
                          await setDoc(userDocRef, initialUserData, { merge: true });
                          currentUserName = name; currentUserRole = 'viewer'; isUserAdmin = false;
                     }

                     if (loginModal) loginModal.classList.add('hidden');
                     
                     if (!isAppInitialized) {
                         initializeAppLogic(currentUserName);
                         isAppInitialized = true;
                     }

                     if (isUserAdmin) { listenForPermissionRequests(); }
                     updateUserPresence();
                     listenToUserRoleChanges(userDocRef);
                     listenToGlobalConfig();
                     
                 } else {
                      userId = ''; currentUserName = 'Ø²Ø§Ø¦Ø±'; currentUserEmail = null; currentUserRole = 'viewer'; isUserAdmin = false; isAppInitialized = false; 
                      updateUIForUser(currentUserName, false);
                      if (initialLoadingMessage) initialLoadingMessage.classList.remove('hidden');
                      if (loginModal) loginModal.classList.remove('hidden');
                 }
             });
        }
        
        function listenToUserRoleChanges(userDocRef) {
            if (userDocUnsubscribe) userDocUnsubscribe();
            userDocUnsubscribe = onSnapshot(userDocRef, async (userSnap) => {
                if (!userSnap.exists()) { await signOut(auth); return; }
                const userData = userSnap.data();
                const newRole = userData.role || 'viewer';
                const newIsAdmin = (newRole === 'admin');
                const newName = userData.name || currentUserEmail;

                if (newRole !== currentUserRole) {
                    currentUserRole = newRole; isUserAdmin = newIsAdmin; currentUserName = newName;
                    showAlert(newIsAdmin ? 'âœ… ØªÙ…Øª ØªØ±Ù‚ÙŠØªÙƒ Ø¥Ù„Ù‰ Ù…Ø¯ÙŠØ±.' : 'â„¹ï¸ ØªÙ… ØªØ­Ø¯ÙŠØ« ØµÙ„Ø§Ø­ÙŠØ§ØªÙƒ Ø¥Ù„Ù‰ Ù…Ø´Ø§Ù‡Ø¯.');
                    updateUIForUser(currentUserName, isUserAdmin);
                    
                    if (newIsAdmin && !permissionRequestsUnsubscribe) { listenForPermissionRequests(); } 
                    else if (!newIsAdmin && permissionRequestsUnsubscribe) { permissionRequestsUnsubscribe(); permissionRequestsUnsubscribe = null; if (permsBtnBadge) permsBtnBadge.classList.add('hidden'); }

                    const sectionsQuery = query(sectionsCollectionRef, orderBy("order"));
                    const snapshot = await getDocs(sectionsQuery);
                    
                    if (sectionsContainer) sectionsContainer.innerHTML = '';
                    if(snapshot.empty && sectionsContainer) sectionsContainer.innerHTML = `<p class="text-gray-500 text-center col-span-3">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‚Ø³Ø§Ù… Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†...</p>`;
                    
                    snapshot.docs.forEach((doc) => { renderSection(doc); });
                    setupItemSorting();
                    setupSectionSorting(newIsAdmin);
                } else if (newName !== currentUserName) {
                    currentUserName = newName;
                    updateUIForUser(currentUserName, isUserAdmin);
                }
            }, (error) => { signOut(auth); });
        }
        
        function listenToGlobalConfig() {
            if (globalConfigUnsubscribe) globalConfigUnsubscribe();
            const configRef = doc(db, configPath, 'appSettings');
            globalConfigUnsubscribe = onSnapshot(configRef, (docSnap) => {
                if (docSnap.exists()) { globalConfig = docSnap.data(); } 
                else { if(isUserAdmin) { setDoc(configRef, { isChatEnabled: true }); } globalConfig = { isChatEnabled: true }; }
                updateUIChatVisibility(globalConfig.isChatEnabled);
            });
        }

        function updateUIChatVisibility(isEnabled) {
            const chatToggleBtn = document.getElementById('chat-toggle');
            if (chatToggleBtn) chatToggleBtn.classList.toggle('hidden', !isEnabled);
            if (!isEnabled && chatWindow && !chatWindow.classList.contains('hidden')) {
                chatWindow.classList.add('hidden');
                showAlert("ØªÙ… ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø¯ÙŠØ±.");
            }
        }

        async function handleLoginSubmit(e) {
            e.preventDefault();
            const emailInput = document.getElementById('user-email-input'), passwordInput = document.getElementById('user-password-input');
            if (!emailInput || !passwordInput) return;
            const email = emailInput.value.trim(), password = passwordInput.value.trim();
            if (!email || !password) { showLoginError("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±."); return; }
            try {
                showLoginError("Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„..."); 
                await signInWithEmailAndPassword(auth, email, password);
                if (loginError) loginError.classList.add('hidden');
            } catch (error) {
                let errorMessage;
                switch (error.code) {
                    case 'auth/user-not-found': case 'auth/wrong-password': case 'auth/invalid-credential': errorMessage = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±."; break;
                    case 'auth/invalid-email': errorMessage = "ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­."; break;
                    case 'auth/too-many-requests': errorMessage = "ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø¤Ù‚ØªØ§Ù‹ Ø¨Ø³Ø¨Ø¨ Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ù…ØªÙƒØ±Ø±Ø© ÙØ§Ø´Ù„Ø©."; break;
                    default: errorMessage = `ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„. (${error.message})`;
                }
                showLoginError(errorMessage);
            }
        }
        
        async function handleRegistration() {
            const nameInput = document.getElementById('user-name-input'), emailInput = document.getElementById('user-email-input'), passwordInput = document.getElementById('user-password-input');
            if (!nameInput || !emailInput || !passwordInput) return;
            const name = nameInput.value.trim(), email = emailInput.value.trim(), password = passwordInput.value.trim();
            if (!name || !email || password.length < 6) { showLoginError("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…Ùƒ ÙˆØ¨Ø±ÙŠØ¯ÙƒØŒ ÙˆØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„."); return; }
            try {
                 showLoginError("Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨..."); 
                 const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                 const newUser = userCredential.user;
                 const role = (email === DEFAULT_ADMIN_EMAIL) ? 'admin' : 'viewer';
                 await setDoc(doc(db, usersPath, newUser.uid), { name: name, email: email, role: role, createdAt: serverTimestamp() });
                 showAlert("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.", 'success');
                 if (loginError) loginError.classList.add('hidden');
            } catch (error) {
                 let errorMessage;
                 switch (error.code) {
                      case 'auth/email-already-in-use': errorMessage = "Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„."; break;
                      case 'auth/weak-password': errorMessage = "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ© Ø¬Ø¯Ø§Ù‹."; break;
                      default: errorMessage = `ÙØ´Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„. (${error.message})`;
                 }
                 showLoginError(errorMessage);
            }
        }

        function showLoginError(message) {
             if (loginError) { loginError.textContent = message; loginError.classList.remove('hidden'); }
        }

        function initializeAppLogic(userName) {
             if (!userName) return;
             updateUIForUser(userName, isUserAdmin);
             setupAddSectionModal(); setupAddItemModal(); setupEditSectionModal(); setupEditItemModal(); setupAlertModal();
             setupAdminManageModal(); setupAdminPermsModal(); setupAdminSettingsModal(); 
             setupChatWindow(); initializeChatApp();
             setupControlEvents(isUserAdmin); listenForSections();
        }

        function updateUIForUser(name, isAdmin) {
             if (userNameDisplay) userNameDisplay.textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒØŒ ${name} (${isAdmin ? 'Ù…Ø¯ÙŠØ±' : 'Ù…Ø´Ø§Ù‡Ø¯'})`;
            adminControls.forEach(id => {
                const btn = document.getElementById(id);
                if (btn) {
                     const wrapper = btn.closest('.relative');
                     if (isAdmin) { btn.classList.remove('hidden'); if (wrapper) wrapper.classList.remove('hidden'); } 
                     else { btn.classList.add('hidden'); if (wrapper) wrapper.classList.add('hidden'); }
                }
            });
            generalControls.forEach(id => { const btn = document.getElementById(id); if (btn) btn.classList.remove('hidden'); });
            
            if (logoutBtn && loginAdminBtn) {
                if (userId) { logoutBtn.classList.remove('hidden'); loginAdminBtn.classList.add('hidden'); } 
                else { logoutBtn.classList.add('hidden'); loginAdminBtn.classList.remove('hidden'); }
            }
            const deleteAllChatBtnNav = document.getElementById('delete-all-chat-btn');
            if (deleteAllChatBtnNav) deleteAllChatBtnNav.classList.toggle('hidden', !isAdmin);
            updateUIChatVisibility(globalConfig.isChatEnabled);
        }

        // --- ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†ÙˆØ§ÙØ° (Modals) ---
        function setupAddSectionModal() {
             addSectionModal = document.getElementById('add-section-modal'); if (!addSectionModal) return;
             addSectionModalContent = document.getElementById('add-section-modal-content'); addSectionForm = document.getElementById('add-section-form');
             closeSectionModalBtn = document.getElementById('close-section-modal'); cancelSectionModalBtn = document.getElementById('cancel-section-modal');
             createIconPicker('add-section-icon-picker', 'section-icon');
             const addSectionBtn = document.getElementById('add-section-btn');
             if (addSectionBtn) {
                 addSectionBtn.addEventListener('click', () => {
                     setSelectedIcon('add-section-icon-picker', 'section-icon', DEFAULT_ICON);
                     addSectionModal.classList.remove('hidden');
                     setTimeout(() => { if (addSectionModalContent) { addSectionModalContent.classList.remove('scale-95', 'opacity-0'); addSectionModalContent.classList.add('scale-100', 'opacity-100'); } }, 10);
                 });
             }
             const close = () => {
                  if (addSectionModalContent) addSectionModalContent.classList.add('scale-95', 'opacity-0');
                  setTimeout(() => { addSectionModal.classList.add('hidden'); if (addSectionForm) addSectionForm.reset(); setSelectedIcon('add-section-icon-picker', 'section-icon', DEFAULT_ICON); }, 200);
             };
             if (closeSectionModalBtn) closeSectionModalBtn.addEventListener('click', close);
             if (cancelSectionModalBtn) cancelSectionModalBtn.addEventListener('click', close);
             addSectionModal.addEventListener('click', (e) => (e.target === addSectionModal) && close());
             if (addSectionForm) addSectionForm.addEventListener('submit', handleSectionFormSubmit);
        }

        function setupAddItemModal() {
            addItemModal = document.getElementById('add-item-modal'); if (!addItemModal) return;
            modalContent = document.getElementById('modal-content'); closeModalBtn = document.getElementById('close-modal'); cancelModalBtn = document.getElementById('cancel-modal');
            addItemForm = document.getElementById('add-item-form'); columnIdInput = document.getElementById('column-id-input'); itemTypeInput = document.getElementById('item-type-input');
            if (!sectionsContainer) return;
            sectionsContainer.addEventListener('click', (e) => {
                const addItemBtn = e.target.closest('.add-item-btn');
                const sectionEl = addItemBtn ? addItemBtn.closest('.column-wrapper') : null;
                const canEdit = isUserAdmin || (sectionEl && sectionEl.dataset.canEdit === 'true');
                if (addItemBtn && canEdit) {
                    columnIdInput.value = addItemBtn.getAttribute('data-column-id');
                    const tabLinkBtn = document.getElementById('tab-link'); if (tabLinkBtn) tabLinkBtn.click();
                    addItemModal.classList.remove('hidden');
                    setTimeout(() => { if (modalContent) { modalContent.classList.remove('scale-95', 'opacity-0'); modalContent.classList.add('scale-100', 'opacity-100'); } }, 10);
                }
            });
            const closeModal = () => { if (modalContent) modalContent.classList.add('scale-95', 'opacity-0'); setTimeout(() => { addItemModal.classList.add('hidden'); if (addItemForm) addItemForm.reset(); }, 200); };
            if(closeModalBtn) closeModalBtn.addEventListener('click', closeModal);
            if (cancelModalBtn) cancelModalBtn.addEventListener('click', closeModal);
            addItemModal.addEventListener('click', (e) => (e.target === addItemModal) && closeModal());
            
            const tabLink = document.getElementById('tab-link'), tabFile = document.getElementById('tab-file'), linkSection = document.getElementById('link-input-section'), fileSection = document.getElementById('file-input-section');
            if (tabLink) tabLink.addEventListener('click', () => { linkSection.classList.remove('hidden'); fileSection.classList.add('hidden'); tabLink.classList.add('border-teal-500', 'text-teal-600'); tabLink.classList.remove('border-transparent', 'text-gray-500'); if (tabFile) { tabFile.classList.add('border-transparent', 'text-gray-500'); tabFile.classList.remove('border-teal-500', 'text-teal-600'); } if (itemTypeInput) itemTypeInput.value = 'link'; });
            if (tabFile) tabFile.addEventListener('click', () => { showAlert('Ù…ÙŠØ²Ø© Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±.'); });
            if (addItemForm) addItemForm.addEventListener('submit', handleItemFormSubmit);
        }

        function setupEditSectionModal() {
            editSectionModal = document.getElementById('edit-section-modal'); if (!editSectionModal) return;
            const closeBtn = document.getElementById('close-edit-section-modal'), cancelBtn = document.getElementById('cancel-edit-section-modal');
            editSectionForm = document.getElementById('edit-section-form'); editSectionTitleInput = document.getElementById('edit-section-title'); editSectionIdInput = document.getElementById('edit-section-id');
            currentEditorsList = document.getElementById('current-editors-list'); currentEditorsContainer = document.getElementById('current-editors-container');
            const editSectionVisibilityCheckbox = document.getElementById('edit-section-visibility'); 
            createIconPicker('edit-section-icon-picker', 'edit-section-icon');
            if (!sectionsContainer) return;
            sectionsContainer.addEventListener('click', async (e) => { 
                const editBtn = e.target.closest('.section-edit-btn');
                const sectionEl = editBtn ? editBtn.closest('.column-wrapper') : null;
                const canEdit = isUserAdmin || (sectionEl && sectionEl.dataset.canEdit === 'true');
                if (editBtn && canEdit) {
                    const sectionId = sectionEl.dataset.sectionId;
                    const sectionData = await getSectionDataById(sectionId); if (!sectionData) return;
                    if(editSectionTitleInput) editSectionTitleInput.value = sectionData.title || '';
                    if (editSectionIdInput) editSectionIdInput.value = sectionId;
                    if (editSectionVisibilityCheckbox) editSectionVisibilityCheckbox.checked = sectionData.isVisible !== false; 
                    setSelectedIcon('edit-section-icon-picker', 'edit-section-icon', sectionData.icon || DEFAULT_ICON);
                    await loadEditorsForSection(sectionId);
                    editSectionModal.classList.remove('hidden');
                }
            });
            const close = () => editSectionModal.classList.add('hidden');
            if (closeBtn) closeBtn.addEventListener('click', close); if (cancelBtn) cancelBtn.addEventListener('click', close);
            editSectionModal.addEventListener('click', (e) => (e.target === editSectionModal) && close());
            if (editSectionForm) editSectionForm.addEventListener('submit', handleEditSectionFormSubmit);
            if (currentEditorsList) currentEditorsList.addEventListener('click', handleRemoveEditorClick);
        }

        function setupEditItemModal() {
            editItemModal = document.getElementById('edit-item-modal'); if (!editItemModal) return;
            const closeBtn = document.getElementById('close-edit-item-modal'), cancelBtn = document.getElementById('cancel-edit-item-modal');
            editItemForm = document.getElementById('edit-item-form'); editItemTitleInput = document.getElementById('edit-item-title'); editItemLinkInput = document.getElementById('edit-item-link'); editItemIdInput = document.getElementById('edit-item-id'); editItemSectionIdInput = document.getElementById('edit-item-section-id');
            if (!sectionsContainer) return;
            sectionsContainer.addEventListener('click', (e) => {
                const editBtn = e.target.closest('.item-edit-btn-action'); 
                const sectionEl = editBtn ? editBtn.closest('.column-wrapper') : null;
                const canEdit = isUserAdmin || (sectionEl && sectionEl.dataset.canEdit === 'true');
                if (editBtn && canEdit) {
                    const itemEl = editBtn.closest('.item-card'); if (!itemEl || !sectionEl) return;
                    const popup = editBtn.closest('.item-action-popup'); if (popup) popup.classList.add('hidden');
                    const itemId = itemEl.dataset.itemId, sectionId = sectionEl.dataset.sectionId, linkElement = itemEl.querySelector('a');
                    if(editItemTitleInput) editItemTitleInput.value = linkElement ? linkElement.textContent.trim() : '';
                    if(editItemLinkInput) editItemLinkInput.value = linkElement ? linkElement.href : '';
                    if(editItemIdInput) editItemIdInput.value = itemId; 
                    if(editItemSectionIdInput) editItemSectionIdInput.value = sectionId;
                    editItemModal.classList.remove('hidden');
                }
            });
            const close = () => editItemModal.classList.add('hidden');
            if (closeBtn) closeBtn.addEventListener('click', close); if(cancelBtn) cancelBtn.addEventListener('click', close);
            editItemModal.addEventListener('click', (e) => (e.target === editItemModal) && close());
            if (editItemForm) editItemForm.addEventListener('submit', handleEditItemFormSubmit);
        }
        
        window.showItemActionsPopup = function(button) {
            const itemCard = button.closest('.item-card');
            const popup = itemCard ? itemCard.querySelector('.item-action-popup') : null;
            if (popup) {
                document.querySelectorAll('.item-action-popup:not(.hidden)').forEach(p => p.classList.add('hidden'));
                popup.classList.toggle('hidden');
            }
        }

        function setupAlertModal() {
            alertModal = document.getElementById('alert-modal'); if (!alertModal) return;
            const alertModalContent = document.getElementById('alert-modal-content'), closeAlertModalBtn = document.getElementById('close-alert-modal');
            const close = () => { if (alertModalContent) alertModalContent.classList.add('scale-95', 'opacity-0'); setTimeout(() => { alertModal.classList.add('hidden'); }, 200); };
            if(closeAlertModalBtn) closeAlertModalBtn.addEventListener('click', close);
            alertModal.addEventListener('click', (e) => (e.target === alertModal) && close());
        }

        function setupChatWindow() {
            const chatToggle = document.getElementById('chat-toggle');
            chatWindow = document.getElementById('chat-window');
            closeChatBtn1 = document.getElementById('close-chat'); closeChatBtn2 = document.getElementById('close-chat-2'); chatBackBtn = document.getElementById('chat-back-btn');
            chatListView = document.getElementById('chat-list-view'); chatMessageView = document.getElementById('chat-message-view');
            if (!chatToggle || !chatWindow || !closeChatBtn1 || !closeChatBtn2 || !chatBackBtn || !chatListView || !chatMessageView) return;
            chatToggle.addEventListener('click', () => {
                chatWindow.classList.toggle('hidden');
                if (!chatWindow.classList.contains('hidden')) { chatListView.classList.remove('hidden'); chatMessageView.classList.add('hidden'); }
            });
            const closeChat = () => chatWindow.classList.add('hidden');
            closeChatBtn1.addEventListener('click', closeChat); closeChatBtn2.addEventListener('click', closeChat);
            chatBackBtn.addEventListener('click', () => {
                chatListView.classList.remove('hidden'); chatMessageView.classList.add('hidden');
                if (chatMessageListeners[chatCurrentChat.id]) { chatMessageListeners[chatCurrentChat.id](); delete chatMessageListeners[chatCurrentChat.id]; }
                chatCurrentChat = { type: 'group', id: 'group' };
            });
        }

        function setupAdminManageModal() {
            adminManageModal = document.getElementById('admin-manage-modal'); if (!adminManageModal) return;
            adminUsersList = document.getElementById('admin-users-list');
            const closeBtn = document.getElementById('close-admin-manage-modal'), adminManageBtn = document.getElementById('admin-manage-btn');
            if (adminManageBtn) {
                adminManageBtn.addEventListener('click', async () => { if (!isUserAdmin) return; await loadUsersForAdminModal(); adminManageModal.classList.remove('hidden'); });
            }
            const close = () => adminManageModal.classList.add('hidden');
            if (closeBtn) closeBtn.addEventListener('click', close);
            adminManageModal.addEventListener('click', (e) => (e.target === adminManageModal) && close());
            if (adminUsersList) {
                adminUsersList.addEventListener('click', async (e) => {
                    const targetButton = e.target.closest('button');
                    const userIdToUpdate = targetButton ? targetButton.dataset.userId : null;
                    if (!userIdToUpdate) return;
                    const action = targetButton.dataset.roleAction || targetButton.dataset.action;
                    await updateUserRole(userIdToUpdate, action);
                });
            }
        }

        function setupAdminPermsModal() {
            adminPermsModal = document.getElementById('admin-perms-modal'); if (!adminPermsModal) return;
            adminPermsList = document.getElementById('admin-perms-list');
            const closeBtn = document.getElementById('close-admin-perms-modal'), adminPermsBtn = document.getElementById('admin-perms-btn');
            if (adminPermsBtn) {
                 adminPermsBtn.addEventListener('click', async () => {
                      if (!isUserAdmin) { showAlert('Ù„Ø·Ù„Ø¨ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¥Ø¶Ø§ÙÙŠØ©ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ù†ØµØ©.'); return; }
                      await loadPermissionRequests(); adminPermsModal.classList.remove('hidden');
                 });
            }
            const close = () => adminPermsModal.classList.add('hidden');
            if (closeBtn) closeBtn.addEventListener('click', close);
            adminPermsModal.addEventListener('click', (e) => (e.target === adminPermsModal) && close());
            if (adminPermsList) {
                adminPermsList.addEventListener('click', async (e) => {
                    const targetButton = e.target.closest('button');
                    if (!targetButton || !targetButton.dataset.requestId) return;
                    const requestId = targetButton.dataset.requestId, action = targetButton.dataset.action; 
                    await handlePermissionRequest(requestId, action);
                });
            }
        }
        
        function setupAdminSettingsModal() {
            adminSettingsModal = document.getElementById('admin-settings-modal'); if (!adminSettingsModal) return;
            const closeBtn = document.getElementById('close-admin-settings-modal'), adminSettingsBtn = document.getElementById('admin-settings-btn');
            const chatToggleSwitch = document.getElementById('setting-toggle-chat'), revokeEditorsBtn = document.getElementById('setting-revoke-editors'), revokeAdminsBtn = document.getElementById('setting-revoke-admins');
            if (adminSettingsBtn) {
                 adminSettingsBtn.addEventListener('click', () => { if (!isUserAdmin) return; if (chatToggleSwitch) { chatToggleSwitch.checked = globalConfig.isChatEnabled; } adminSettingsModal.classList.remove('hidden'); });
            }
            const close = () => adminSettingsModal.classList.add('hidden');
            if (closeBtn) closeBtn.addEventListener('click', close);
            adminSettingsModal.addEventListener('click', (e) => (e.target === adminSettingsModal) && close());
            if (chatToggleSwitch) chatToggleSwitch.addEventListener('change', handleToggleChatSetting);
            if (revokeEditorsBtn) revokeEditorsBtn.addEventListener('click', handleRevokeAllEditors);
            if (revokeAdminsBtn) revokeAdminsBtn.addEventListener('click', handleRevokeOtherAdmins);
        }
        
        // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ ---
        async function handleToggleChatSetting(e) {
            if (!isUserAdmin) return;
            const isEnabled = e.target.checked;
            try { await setDoc(doc(db, configPath, 'appSettings'), { isChatEnabled: isEnabled }, { merge: true }); showAlert(isEnabled ? 'âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹.' : 'ğŸš« ØªÙ… ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹.'); } 
            catch (error) { showAlert("âŒ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©."); e.target.checked = !isEnabled; }
        }
        
        async function handleRevokeAllEditors() {
            if (!isUserAdmin) return; if (!confirm("âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø¥Ù„ØºØ§Ø¡ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ØªØ­Ø±ÙŠØ± Ù…Ù† (Ø¬Ù…ÙŠØ¹) Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†ØŸ")) return;
            showAlert("Ø¬Ø§Ø±ÙŠ Ø¥Ù„ØºØ§Ø¡ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø­Ø±Ø±ÙŠÙ†...");
            try {
                const batch = writeBatch(db);
                const sectionsQuery = query(sectionsCollectionRef, where("editors", "!=", []));
                const sectionsSnapshot = await getDocs(sectionsQuery);
                if (sectionsSnapshot.empty) { showAlert("â„¹ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙ„Ø§Ø­ÙŠØ§Øª Ù„Ø¥Ù„ØºØ§Ø¦Ù‡Ø§."); return; }
                sectionsSnapshot.forEach(sectionDoc => { batch.update(doc(db, sectionsPath, sectionDoc.id), { editors: [] }); });
                await batch.commit(); showAlert("âœ… ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø¬Ù…ÙŠØ¹ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ØªØ­Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­.");
            } catch (error) { showAlert("âŒ ÙØ´Ù„ Ø¥Ù„ØºØ§Ø¡ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø­Ø±Ø±ÙŠÙ†."); }
        }
        
        async function handleRevokeOtherAdmins() {
            if (!isUserAdmin || !userId) return; if (!confirm("âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø¥Ù„ØºØ§Ø¡ ØµÙ„Ø§Ø­ÙŠØ§Øª (Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¯Ø±Ø§Ø¡ Ø§Ù„Ø¢Ø®Ø±ÙŠÙ†)ØŸ")) return;
            showAlert("Ø¬Ø§Ø±ÙŠ Ø¥Ù„ØºØ§Ø¡ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø¯Ø±Ø§Ø¡ Ø§Ù„Ø¢Ø®Ø±ÙŠÙ†...");
            try {
                const batch = writeBatch(db);
                const allAdminsQuery = query(usersCollectionRef, where("role", "==", "admin"));
                const adminsSnapshot = await getDocs(allAdminsQuery);
                let demotedCount = 0;
                adminsSnapshot.forEach(userDoc => {
                    if (userDoc.id !== userId && userDoc.data().email !== DEFAULT_ADMIN_EMAIL) {
                        batch.update(doc(db, usersPath, userDoc.id), { role: 'viewer' }); demotedCount++;
                    }
                });
                if (demotedCount === 0) { showAlert("â„¹ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¯Ø±Ø§Ø¡ Ø¢Ø®Ø±ÙˆÙ†."); return; }
                await batch.commit(); showAlert(`âœ… ØªÙ… Ø¥Ù„ØºØ§Ø¡ ØµÙ„Ø§Ø­ÙŠØ§Øª ${demotedCount} Ù…Ø¯ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­.`);
            } catch (error) { showAlert("âŒ ÙØ´Ù„ Ø¥Ù„ØºØ§Ø¡ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø¯Ø±Ø§Ø¡."); }
        }

        async function loadUsersForAdminModal() {
            if (!adminUsersList || !usersCollectionRef) return;
            adminUsersList.innerHTML = '<li>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†...</li>';
            try {
                const querySnapshot = await getDocs(usersCollectionRef);
                adminUsersList.innerHTML = '';
                if (querySnapshot.empty) { adminUsersList.innerHTML = '<li>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†.</li>'; return; }
                querySnapshot.forEach(docSnap => {
                    const user = docSnap.data(), docId = docSnap.id, userName = user.name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ', userRole = user.role || 'viewer';
                    let roleLabel = 'ÙØ¹Ù‘Ø§Ù„ ğŸŸ¢', roleColor = 'text-green-600';
                    if (userRole === 'admin') { roleLabel = 'Ù…Ø¯ÙŠØ± ğŸ”µ'; roleColor = 'text-blue-600'; }
                    else if (userRole === 'editor') { roleLabel = 'Ù…Ø­Ø±Ø± ğŸŸ '; roleColor = 'text-orange-600'; }
                    else if (userRole === 'suspended') { roleLabel = 'Ù…ÙˆÙ‚ÙˆÙ ğŸ”´'; roleColor = 'text-red-600'; }
                    let actionsHTML = '';
                    if (docId === userId) { actionsHTML = '<span class="text-xs text-gray-400">(Ø£Ù†Øª)</span>'; }
                    else if (user.email === DEFAULT_ADMIN_EMAIL) { actionsHTML = '<span class="text-xs text-gray-400 font-bold">(Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ)</span>'; }
                    else {
                        actionsHTML = `
                            ${userRole !== 'admin' ? `<button data-user-id="${docId}" data-role-action="promote" class="text-xs bg-green-500 text-white font-bold py-1 px-2 rounded">ØªØ±Ù‚ÙŠØ©</button>` : `<button data-user-id="${docId}" data-role-action="demote" class="text-xs bg-blue-500 text-white font-bold py-1 px-2 rounded">ØªÙ†Ø²ÙŠÙ„</button>`}
                            ${userRole !== 'suspended' ? `<button data-user-id="${docId}" data-role-action="suspend" class="text-xs bg-yellow-500 text-white font-bold py-1 px-2 rounded">Ø¥ÙŠÙ‚Ø§Ù</button>` : `<button data-user-id="${docId}" data-role-action="reactivate" class="text-xs bg-green-500 text-white font-bold py-1 px-2 rounded">ØªÙØ¹ÙŠÙ„</button>`}
                            <button data-user-id="${docId}" data-role-action="remove" class="text-xs bg-red-500 text-white font-bold py-1 px-2 rounded">Ø­Ø°Ù</button>
                        `;
                    }
                    const li = document.createElement('li'); li.className = 'py-3 sm:py-4 border-b last:border-b-0';
                    li.innerHTML = `<div class="grid grid-cols-12 items-center gap-3"><div class="col-span-5"><p class="text-sm font-medium text-gray-900 truncate">${userName}</p></div><div class="col-span-3"><span class="text-sm font-semibold ${roleColor}">${roleLabel}</span></div><div class="col-span-4 inline-flex items-center gap-2">${actionsHTML}</div></div>`;
                    adminUsersList.appendChild(li);
                });
            } catch (error) { adminUsersList.innerHTML = '<li>Ø­Ø¯Ø« Ø®Ø·Ø£.</li>'; }
        }

        async function updateUserRole(userIdToUpdate, action) {
            if (!isUserAdmin || !db || !usersPath) return;
            try {
                const userRef = doc(db, usersPath, userIdToUpdate);
                const userSnap = await getDoc(userRef); if (!userSnap.exists()) return;
                const userData = userSnap.data();
                if (userData.email === DEFAULT_ADMIN_EMAIL) { showAlert("âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ."); return; }
                if (action === 'promote') await updateDoc(userRef, { role: 'admin' });
                else if (action === 'demote' || action === 'reactivate') await updateDoc(userRef, { role: 'viewer' });
                else if (action === 'suspend') await updateDoc(userRef, { role: 'suspended' });
                else if (action === 'remove') { if (!confirm("Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØŸ")) return; await deleteDoc(userRef); }
                await loadUsersForAdminModal();
            } catch (error) { showAlert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£."); }
        }

        function listenForPermissionRequests() {
            if (!permissionRequestsCollectionRef || !permsBtnBadge) return;
            const q = query(permissionRequestsCollectionRef, where("status", "==", "pending"));
            if (permissionRequestsUnsubscribe) permissionRequestsUnsubscribe();
            permissionRequestsUnsubscribe = onSnapshot(q, (snapshot) => {
                const pendingCount = snapshot.size;
                permsBtnBadge.textContent = pendingCount;
                if (pendingCount > 0) permsBtnBadge.classList.remove('hidden'); else permsBtnBadge.classList.add('hidden');
            });
        }

        async function loadPermissionRequests() {
            if (!adminPermsList || !permissionRequestsCollectionRef) return;
            adminPermsList.innerHTML = '<li>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</li>';
            try {
                const q = query(permissionRequestsCollectionRef, where("status", "==", "pending"));
                const querySnapshot = await getDocs(q);
                adminPermsList.innerHTML = '';
                if (querySnapshot.empty) { adminPermsList.innerHTML = '<li>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª.</li>'; return; }
                querySnapshot.forEach(doc => {
                    const request = doc.data(), requestId = doc.id;
                    const li = document.createElement('li'); li.className = 'py-3 sm:py-4 border-b last:border-b-0';
                    li.innerHTML = `<div class="flex items-center justify-between space-x-4 gap-3"><div class="flex-1"><p class="text-sm font-medium"><b>${request.requesterName}</b> ÙŠØ·Ù„Ø¨: ${request.sectionTitle}</p></div><div><button data-request-id="${requestId}" data-action="approve" class="text-xs bg-green-500 text-white py-1 px-2 rounded">Ù…ÙˆØ§ÙÙ‚Ø©</button> <button data-request-id="${requestId}" data-action="reject" class="text-xs bg-red-500 text-white py-1 px-2 rounded">Ø±ÙØ¶</button></div></div>`;
                    adminPermsList.appendChild(li);
                });
            } catch (error) { adminPermsList.innerHTML = '<li>Ø­Ø¯Ø« Ø®Ø·Ø£.</li>'; }
        }

        async function handlePermissionRequest(requestId, action) {
             if (!isUserAdmin) return;
             const requestRef = doc(db, permissionRequestsPath, requestId);
             try {
                 const requestSnap = await getDoc(requestRef); if (!requestSnap.exists()) return;
                 const requestData = requestSnap.data();
                 await updateDoc(requestRef, { status: (action === 'approve' ? 'approved' : 'rejected') });
                 if (action === 'approve' && requestData.sectionId) {
                     await updateDoc(doc(db, sectionsPath, requestData.sectionId), { editors: arrayUnion(requestData.requesterName) });
                     showAlert(`ØªÙ… Ù…Ù†Ø­ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù€ ${requestData.requesterName}.`);
                 }
                 await loadPermissionRequests();
             } catch (error) { showAlert("Ø­Ø¯Ø« Ø®Ø·Ø£."); }
        }

        async function requestSectionControl(sectionId, sectionTitle) {
            if (!currentUserName) return;
            try {
                const q = query(permissionRequestsCollectionRef, where("requesterName", "==", currentUserName), where("sectionId", "==", sectionId), where("status", "==", "pending"));
                if (!(await getDocs(q)).empty) { showAlert("Ø§Ù„Ø·Ù„Ø¨ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©."); return; }
                await addDoc(permissionRequestsCollectionRef, { requesterName: currentUserName, sectionId: sectionId, sectionTitle: sectionTitle, status: 'pending', timestamp: serverTimestamp() });
                showAlert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨.");
            } catch (error) { showAlert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„."); }
        }

        // --- CRUD Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ÙˆØ§Ù„Ø¹Ù†Ø§ØµØ± ---
        async function handleSectionFormSubmit(e) {
            e.preventDefault();
            const titleInput = document.getElementById('section-title'), visibilityCheckbox = document.getElementById('section-visibility'), iconInput = document.getElementById('section-icon');
            if (!titleInput) return;
            const newTitle = titleInput.value.trim(), isVisible = visibilityCheckbox ? visibilityCheckbox.checked : true, newIcon = iconInput ? iconInput.value : DEFAULT_ICON;
            const newOrder = (await getDocs(sectionsCollectionRef)).size;
            if (!newTitle) return;
            try { await addDoc(sectionsCollectionRef, { title: newTitle, icon: newIcon, items: [], editors: [], isVisible: isVisible, order: newOrder }); document.getElementById('close-section-modal').click(); } 
            catch (error) { showAlert("âŒ ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø³Ù…."); }
        }

        function listenForSections() {
             if (!sectionsCollectionRef) return;
            const sectionsQuery = query(sectionsCollectionRef, orderBy("order"));
            onSnapshot(sectionsQuery, (snapshot) => {
                if (sectionsContainer) sectionsContainer.innerHTML = '';
                if(snapshot.empty && sectionsContainer) sectionsContainer.innerHTML = `<p class="text-gray-500 text-center col-span-3">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‚Ø³Ø§Ù….</p>`;
                snapshot.docs.forEach((doc) => { renderSection(doc); });
                setupItemSorting(); setupSectionSorting(isUserAdmin);
            });
        }
        
        function setupItemSorting() {
            const lists = sectionsContainer ? sectionsContainer.querySelectorAll('.column-list') : [];
            lists.forEach(list => {
                const sectionEl = list.closest('.column-wrapper');
                const sectionId = sectionEl ? sectionEl.dataset.sectionId : null;
                const canEdit = sectionEl ? sectionEl.dataset.canEdit === 'true' : false;
                if (list && sectionId && canEdit) {
                    Sortable.create(list, { group: 'shared', animation: 150, handle: '.drag-handle', filter: '.add-item-btn',
                        onEnd: async function (evt) {
                            const newSectionEl = evt.to.closest('.column-wrapper');
                            const oldSectionId = sectionId, newSectionId = newSectionEl ? newSectionEl.dataset.sectionId : null; if (!newSectionId) return;
                            const itemId = evt.item.dataset.itemId;
                            const currentSectionData = await getSectionDataById(oldSectionId); if (!currentSectionData) return;
                            let items = currentSectionData.items || [];
                            const movedItem = items.find(item => item.id === itemId); if (!movedItem) return;
                            if (oldSectionId !== newSectionId) {
                                items = items.filter(item => item.id !== itemId);
                                await updateDoc(doc(db, sectionsPath, oldSectionId), { items: items });
                                const newSectionData = await getSectionDataById(newSectionId);
                                let newItems = newSectionData.items || [];
                                newItems.splice(evt.newIndex, 0, movedItem);
                                await updateDoc(doc(db, sectionsPath, newSectionId), { items: newItems });
                            } else {
                                items.splice(evt.oldIndex, 1); items.splice(evt.newIndex, 0, movedItem);
                                await updateDoc(doc(db, sectionsPath, sectionId), { items: items });
                            }
                        }
                    });
                } else if (list) { Sortable.create(list, { disabled: true }); }
            });
        }

        function setupSectionSorting(isAdmin) {
            if (sectionSortingInstance) { sectionSortingInstance.destroy(); sectionSortingInstance = null; }
            if (sectionsContainer && isAdmin) {
                sectionSortingInstance = Sortable.create(sectionsContainer, { animation: 150, handle: '.section-drag-handle', onEnd: handleSectionSortEnd });
            } else if (sectionsContainer) { Sortable.create(sectionsContainer, { disabled: true }); }
        }

        async function handleSectionSortEnd(evt) {
            if (!sectionsContainer || !isUserAdmin) return;
            const sectionElements = sectionsContainer.querySelectorAll('.column-wrapper');
            const batch = writeBatch(db);
            try {
                sectionElements.forEach((sectionEl, index) => {
                    const sectionId = sectionEl.dataset.sectionId;
                    if (sectionId) batch.update(doc(db, sectionsPath, sectionId), { order: index });
                });
                await batch.commit();
            } catch (error) { showAlert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ±ØªÙŠØ¨."); }
        }

        async function handleEditSectionFormSubmit(e) {
            e.preventDefault();
            const newTitle = editSectionTitleInput ? editSectionTitleInput.value.trim() : '';
            const sectionId = editSectionIdInput ? editSectionIdInput.value : '';
            const newVisibility = document.getElementById('edit-section-visibility') ? document.getElementById('edit-section-visibility').checked : true;
            const newIcon = document.getElementById('edit-section-icon')?.value || DEFAULT_ICON;
            if (!newTitle || !sectionId) return;
            try { await updateDoc(doc(db, sectionsPath, sectionId), { title: newTitle, isVisible: newVisibility, icon: newIcon }); if(editSectionModal) editSectionModal.classList.add('hidden'); } 
            catch (error) { showAlert("âŒ ÙØ´Ù„ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø³Ù…."); }
        }

        async function loadEditorsForSection(sectionId) {
            if (!currentEditorsList || !currentEditorsContainer) return;
            if (!isUserAdmin) { currentEditorsContainer.classList.add('hidden'); return; }
            currentEditorsContainer.classList.remove('hidden'); currentEditorsList.innerHTML = '<li>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</li>';
            const sectionData = await getSectionDataById(sectionId); 
            if (!sectionData || !sectionData.editors || sectionData.editors.length === 0) { currentEditorsList.innerHTML = '<li>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­Ø±Ø±ÙˆÙ†.</li>'; return; }
            currentEditorsList.innerHTML = '';
            sectionData.editors.forEach(editorName => {
                const li = document.createElement('li'); li.className = 'flex justify-between items-center py-2 last:border-b-0';
                li.innerHTML = `<span class="text-sm text-gray-800">${editorName}</span><button type="button" data-editor-name="${editorName}" data-section-id="${sectionId}" class="remove-editor-btn text-xs bg-red-500 text-white font-bold py-1 px-2 rounded">Ø¥Ø²Ø§Ù„Ø©</button>`;
                currentEditorsList.appendChild(li);
            });
        }

        async function handleRemoveEditorClick(e) {
            const removeBtn = e.target.closest('.remove-editor-btn'); if (!removeBtn || !isUserAdmin) return;
            const editorName = removeBtn.dataset.editorName, sectionId = removeBtn.dataset.sectionId;
            if (!confirm(`Ø¥Ø²Ø§Ù„Ø© "${editorName}"ØŸ`)) return;
            try { await updateDoc(doc(db, sectionsPath, sectionId), { editors: arrayRemove(editorName) }); await loadEditorsForSection(sectionId); } catch (error) { showAlert("âŒ ÙØ´Ù„ Ø§Ù„Ø¥Ø²Ø§Ù„Ø©."); }
        }

        async function handleItemFormSubmit(e) {
            e.preventDefault();
            const title = document.getElementById('item-title').value.trim(), sectionId = columnIdInput.value, itemType = itemTypeInput.value;
            if (!title || !sectionId) return;
            let newItemData = { id: crypto.randomUUID(), title: title, type: itemType };
            if (itemType === 'link') { const link = document.getElementById('item-link').value.trim(); if (!link) return; newItemData.url = link; } 
            else { showAlert("Ù…ÙŠØ²Ø© Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±."); return; }
            try { await updateDoc(doc(db, sectionsPath, sectionId), { items: arrayUnion(newItemData) }); document.getElementById('close-modal').click(); } 
            catch (error) { showAlert("âŒ ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù†ØµØ±."); }
        }

        async function handleEditItemFormSubmit(e) {
            e.preventDefault();
            const sectionId = editItemSectionIdInput.value, itemId = editItemIdInput.value, newTitle = editItemTitleInput.value.trim(), newLink = editItemLinkInput.value.trim();
            if (!sectionId || !itemId || !newTitle || !newLink) return;
            try {
                const sectionRef = doc(db, sectionsPath, sectionId);
                const sectionSnap = await getDoc(sectionRef);
                if (sectionSnap.exists()) {
                    let items = sectionSnap.data().items || [];
                    const updatedItems = items.map(item => (item.id === itemId ? { ...item, title: newTitle, url: newLink } : item));
                    await updateDoc(sectionRef, { items: updatedItems });
                    document.getElementById('close-edit-item-modal').click();
                }
            } catch (error) { showAlert("âŒ ÙØ´Ù„ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù†ØµØ±."); }
        }

        async function deleteItem(sectionId, itemId) {
             const sectionRef = doc(db, sectionsPath, sectionId);
             const sectionSnap = await getDoc(sectionRef);
             const editors = (sectionSnap.exists() && sectionSnap.data().editors) ? sectionSnap.data().editors : [];
             if (!isUserAdmin && !editors.includes(currentUserName)) return;
             try {
                 if (sectionSnap.exists()) {
                     const updatedItems = (sectionSnap.data().items || []).filter(item => item.id !== itemId);
                     await updateDoc(sectionRef, { items: updatedItems });
                     selectionBasket = selectionBasket.filter(item => item.id !== itemId); updateSelectionBar();
                 }
             } catch (error) { showAlert("âŒ ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù."); }
        }

        async function deleteSection(sectionId) {
            if (!isUserAdmin) return; if (!confirm(`Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ`)) return;
            try { await deleteDoc(doc(db, sectionsPath, sectionId)); clearSelection(); } catch (error) { showAlert("âŒ ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù."); }
        }

        // --- Render ---
        function renderSection(doc) {
            const section = doc.data(), sectionId = doc.id, editors = section.editors || []; 
            const userCanEditThisSection = currentUserRole !== 'suspended' && (isUserAdmin || editors.includes(currentUserName)); 
            const sectionIcon = section.icon || DEFAULT_ICON;
            if (section.isVisible === false && !isUserAdmin) return;

            const sectionDiv = document.createElement('div'); sectionDiv.className = "bg-white rounded-xl shadow-2xl overflow-hidden flex flex-col column-wrapper"; sectionDiv.dataset.sectionId = sectionId; sectionDiv.dataset.canEdit = userCanEditThisSection; 
            const headerDiv = document.createElement('div'); headerDiv.className = "column-header p-5 border-b border-gray-200 bg-gray-50 flex justify-between items-center";
            headerDiv.innerHTML = `${isUserAdmin ? `<div class="section-drag-handle" title="Ø³Ø­Ø¨"><svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" /></svg></div>` : ''} <h2 class="text-2xl font-bold text-teal-800 flex items-center gap-3 flex-1 min-w-0"><span class="section-title-icon">${sectionIcon}</span> <span class="section-title-text">${section.title || 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†'}</span></h2><div class="flex items-center gap-2 flex-shrink-0">${userCanEditThisSection ? `<button class="section-edit-btn p-1 text-blue-500 hover:text-blue-700" title="ØªØ¹Ø¯ÙŠÙ„"><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L6.832 19.82a4.5 4.5 0 01-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 011.13-1.897L16.863 4.487zm0 0L19.5 7.125" /></svg></button>${isUserAdmin ? `<button class="section-delete-btn p-1 text-red-500 hover:text-red-700" title="Ø­Ø°Ù"><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12.578 0a48.09 48.09 0 013.478-.397m7.5 0a48.09 48.09 0 00-7.5 0" /></svg></button>` : ''}` : ''}<button class="section-print-btn p-1 text-green-500 hover:text-green-700" title="Ø·Ø¨Ø§Ø¹Ø©"><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 2.75C5 1.784 5.784 1 6.75 1h6.5c.966 0 1.75.784 1.75 1.75v3.5A1.75 1.75 0 0113.25 8H6.75A1.75 1.75 0 015 6.25v-3.5zm.75 0v3.5c0 .138.112.25.25.25h6.5a.25.25 0 00.25-.25v-3.5a.25.25 0 00-.25-.25h-6.5a.25.25 0 00-.25.25zM6 10.75A.75.75 0 016.75 10h6.5a.75.75 0 010 1.5h-6.5A.75.75 0 016 10.75zM6 13.75A.75.75 0 016.75 13h6.5a.75.75 0 010 1.5h-6.5A.75.75 0 016 13.75zM3.25 9A1.75 1.75 0 001.5 10.75v3.5c0 .966.784 1.75 1.75 1.75h1.25a.75.75 0 010 1.5H3.25A3.25 3.25 0 010 14.25v-3.5A3.25 3.25 0 013.25 7.5h13.5A3.25 3.25 0 0120 10.75v3.5A3.25 3.25 0 0116.75 17.5h-1.25a.75.75 0 010-1.5h1.25A1.75 1.75 0 0018.5 14.25v-3.5A1.75 1.75 0 0016.75 9H3.25z" clip-rule="evenodd" /></svg></button><button class="section-share-btn p-1 text-green-500 hover:text-green-600" title="Ù…Ø´Ø§Ø±ÙƒØ©"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 16 16"> <path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 014.66 1.931 6.557 6.557 0 011.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z"/> </svg></button></div>`;
            sectionDiv.appendChild(headerDiv);
            const listDiv = document.createElement('div'); listDiv.className = "p-4 space-y-3 flex-grow column-list"; listDiv.dataset.sectionTitle = section.title || 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†';
            const items = section.items || [];
            if (items.length > 0) { items.forEach(item => { listDiv.appendChild(renderItem(item, userCanEditThisSection, sectionId)); }); } 
            else { listDiv.innerHTML = `<p class="text-gray-400 text-center p-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ±.</p>`; }
            sectionDiv.appendChild(listDiv);
            const footerDiv = document.createElement('div'); footerDiv.className = "p-4 bg-gray-100 border-t";
            footerDiv.innerHTML = userCanEditThisSection ? `<button class="add-item-btn w-full bg-teal-600 text-white py-3 px-4 rounded-lg font-bold hover:bg-teal-700 flex items-center justify-center gap-2" data-column-id="${sectionId}"><svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg> Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ±</button>` : `<button class="request-control-btn w-full bg-yellow-500 text-white py-3 px-4 rounded-lg font-bold hover:bg-yellow-600 flex items-center justify-center gap-2" data-section-id="${sectionId}" data-section-title="${section.title || ''}"><svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25a3 3 0 013 3m3 0a6 6 0 01-7.029 5.912c-.563-.097-1.159.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 1121.75 8.25z" /></svg> Ø·Ù„Ø¨ ØªØ­ÙƒÙ…</button>`;
            sectionDiv.appendChild(footerDiv);
            if (sectionsContainer) sectionsContainer.appendChild(sectionDiv);
        }

        function renderItem(item, canEdit, sectionId) { 
            if (!item || !item.id) return document.createElement('div');
            const itemDiv = document.createElement('div'); itemDiv.className = "group item-card bg-white p-4 rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition-shadow relative item-wrapper flex items-center";
            itemDiv.dataset.itemId = item.id; itemDiv.dataset.sectionId = sectionId;
            let href = item.url || '#', target = (item.type === 'link' && item.url) ? 'target="_blank" rel="noopener noreferrer"' : '';
            const formattedTitle = replaceEmojis(item.title);
            const itemTypeIcon = (item.type === 'link') ? `<svg class="w-6 h-6 text-blue-500 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244" /></svg>` : `<svg class="w-6 h-6 text-green-500 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m.75 12l3 3m0 0l3-3m-3 3v-6m-1.5-9H5.625a3.375 3.375 0 00-3.375 3.375v11.25a3.375 3.375 0 003.375 3.375h12.75a3.375 3.375 0 003.375-3.375V12M10.5 1.5H18" /></svg>`;
            const selectionCheckbox = (item.type === 'link' && item.url) ? `<input type="checkbox" class="item-selection-checkbox" data-item-id="${item.id}" data-item-title="${item.title || ''}" data-item-url="${item.url}" onchange="handleItemSelection(this)" ${selectionBasket.some(b => b.id === item.id) ? 'checked' : ''}>` : '<div class="w-5 mr-3"></div>';
            itemDiv.innerHTML = `${selectionCheckbox} ${canEdit ? `<div class="drag-handle text-teal-800 hover:bg-gray-100 hidden md:flex md:group-hover:flex" title="Ø³Ø­Ø¨"><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5M12 17.25h8.25"/></svg></div>` : ''} <div class="flex items-center gap-3 flex-1 min-w-0"> ${itemTypeIcon} <a href="${href}" ${target} class="font-semibold text-gray-800 hover:text-teal-600 transition-colors flex-grow min-w-0 overflow-hidden"> <span class="block">${formattedTitle || 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†'}</span> </a> </div> <div class="flex items-center gap-1 flex-shrink-0 mr-2 relative"> <button class="item-share-btn p-1 text-green-500 hover:text-green-600" title="Ù…Ø´Ø§Ø±ÙƒØ©"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 16 16"> <path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 014.66 1.931 6.557 6.557 0 011.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z"/> </svg></button> ${canEdit ? `<div class="hidden md:flex md:group-hover:flex items-center gap-1 flex-shrink-0"><button class="item-edit-btn-desktop p-1 text-blue-500 hover:text-blue-700"><svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L6.832 19.82a4.5 4.5 0 01-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 011.13-1.897L16.863 4.487zm0 0L19.5 7.125" /></svg></button><button class="item-delete-btn-desktop p-1 text-red-500 hover:text-red-700"><svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12.578 0a48.09 48.09 0 013.478-.397m7.5 0a48.09 48.09 0 00-7.5 0" /></svg></button></div> <button class="item-action-btn md:hidden p-1 text-gray-500 hover:text-gray-700" onclick="showItemActionsPopup(this)"><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5M3.75 17.25h16.5" /></svg></button> <div class="item-action-popup hidden action-popup bg-white border border-gray-200 rounded-lg shadow-xl py-1"><button class="item-edit-btn-action w-full text-right px-4 py-2 text-sm text-blue-600 hover:bg-gray-100 flex items-center gap-2" data-item-id="${item.id}" data-section-id="${sectionId}">ØªØ¹Ø¯ÙŠÙ„</button><button class="item-delete-btn-action w-full text-right px-4 py-2 text-sm text-red-600 hover:bg-gray-100 flex items-center gap-2" onclick="if(confirm('Ø­Ø°ÙØŸ')) { deleteItem('${sectionId}', '${item.id}'); document.querySelector('.item-action-popup:not(.hidden)').classList.add('hidden'); }">Ø­Ø°Ù</button></div>` : ''} </div>`;
            return itemDiv;
        }

        window.handleItemSelection = function(checkbox) {
            const item = { id: checkbox.dataset.itemId, title: checkbox.dataset.itemTitle, url: checkbox.dataset.itemUrl, type: 'link', sectionTitle: checkbox.closest('.column-list')?.dataset.sectionTitle || 'Ù‚Ø³Ù… ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ' };
            if (checkbox.checked) { if (!selectionBasket.some(b => b.id === item.id)) selectionBasket.push(item); } 
            else { selectionBasket = selectionBasket.filter(b => b.id !== item.id); }
            updateSelectionBar();
        }
        function updateSelectionBar() {
            const count = selectionBasket.length;
            if (count > 0) { selectionCountShare.textContent = `(${count})`; selectionCountPrint.textContent = `(${count})`; selectionBar.classList.add('visible'); } 
            else { selectionBar.classList.remove('visible'); }
        }
        function clearSelection() { selectionBasket = []; document.querySelectorAll('.item-selection-checkbox:checked').forEach(c => c.checked = false); updateSelectionBar(); }
        function shareSelectedItems() {
            if (selectionBasket.length === 0) { showAlert("Ø§Ø®ØªØ± Ø¹Ù†ØµØ±Ø§Ù‹."); return; }
            const itemsBySection = selectionBasket.reduce((acc, item) => { if (!acc[item.sectionTitle]) acc[item.sectionTitle] = []; acc[item.sectionTitle].push(item); return acc; }, {});
            let message = "*Ù…Ù„ÙØ§Øª Ù…Ù† Ù…Ù†ØµØ© Ø§Ù„Ø±Ø§Ø´Ø¯ÙˆÙ†:*\n\n";
            for (const sectionTitle in itemsBySection) { message += `*${sectionTitle}*\n`; itemsBySection[sectionTitle].forEach(item => { message += `${item.title}\n${item.url}\n\n`; }); }
            window.open(`https://wa.me/?text=${encodeURIComponent(message.trim())}`, '_blank'); clearSelection();
        }

        async function createPdfPageFromHTML(doc, sectionTitle, sectionIcon, itemChunk, isFirstPage, reportTitle = "ØªÙ‚Ø±ÙŠØ± Ù…Ù†ØµØ© Ø§Ù„Ø±Ø§Ø´Ø¯ÙˆÙ†") {
            const printContainer = document.createElement('div'); printContainer.className = 'print-container';
            const superHeader = document.createElement('div'); superHeader.className = 'print-super-header';
            superHeader.innerHTML = `<div>Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©</div><div>ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…</div><div>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„ØªØ¹Ù„ÙŠÙ… Ø¨Ù…Ù†Ø·Ù‚Ø© Ø¹Ø³ÙŠØ±</div><div>Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ© ÙˆÙ…ØªÙˆØ³Ø·Ø© Ø§Ù„Ø±Ø§Ø´Ø¯ÙˆÙ† Ø¨Ø§Ù„Ù…Ø±Ø¨Ø¹</div>`;
            printContainer.appendChild(superHeader);
            const header = document.createElement('div'); header.className = 'print-header'; header.innerHTML = `<h1>${reportTitle}</h1>`; printContainer.appendChild(header);
            const contentWrapper = document.createElement('div'); contentWrapper.className = 'print-content-wrapper';
            const sectionDiv = document.createElement('div'); sectionDiv.className = 'print-section';
            const titleDiv = document.createElement('div'); titleDiv.className = 'print-section-title'; titleDiv.textContent = `${sectionIcon} ${sectionTitle || 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†'}`; sectionDiv.appendChild(titleDiv);
            const listDiv = document.createElement('div'); listDiv.className = 'print-item-list';
            
            const clickableElements = [];
            
            if (Array.isArray(itemChunk) && itemChunk.length > 0) {
                for (const item of itemChunk) {
                    if (typeof item !== 'object' || item === null) continue;
                    const itemDiv = document.createElement('div'); itemDiv.className = 'print-item';
                    const textDiv = document.createElement('div'); textDiv.className = 'print-item-text';
                    
                    const titleNode = document.createElement('div'); titleNode.className = 'print-item-title'; titleNode.textContent = item.title || 'Ø¹Ù†ØµØ± Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†';
                    textDiv.appendChild(titleNode);

                    if (reportTitle === "ØªÙ‚Ø±ÙŠØ± Ù…Ø®ØµØµ" && item.sectionTitle) {
                        const subTitle = document.createElement('div'); subTitle.style.fontSize = '12px'; subTitle.style.color = '#555'; subTitle.textContent = `(Ù…Ù† Ù‚Ø³Ù…: ${item.sectionTitle})`;
                        textDiv.appendChild(subTitle);
                    }

                    const url = (item.type === 'link' && item.url) ? item.url : '';
                    let linkHintDiv = null;
                    if (url) {
                        linkHintDiv = document.createElement('div');
                        linkHintDiv.textContent = 'Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø· ğŸ”—';
                        linkHintDiv.style.fontSize = '11px'; linkHintDiv.style.color = '#008080'; linkHintDiv.style.textDecoration = 'underline'; linkHintDiv.style.marginTop = '5px'; linkHintDiv.style.fontWeight = 'bold';
                        textDiv.appendChild(linkHintDiv);
                    }

                    const qrDiv = document.createElement('div'); qrDiv.className = 'print-item-qr'; qrDiv.style.marginLeft = '0';
                    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø§Ø¨Ø· ÙƒØ¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ Ù„Ø§Ø­Ù‚Ø§Ù‹ (Ù‡Ø§Ù… Ø¬Ø¯Ø§Ù‹ Ù„Ù„ØªÙ…ÙŠÙŠØ²)
                    if(url) qrDiv.dataset.url = url;

                    itemDiv.appendChild(textDiv); itemDiv.appendChild(qrDiv); listDiv.appendChild(itemDiv);
                    
                    if (url) {
                        // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø¶ØºØ· (Ø¨Ø¯ÙˆÙ† ØªÙˆÙ„ÙŠØ¯ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù‡Ù†Ø§)
                        clickableElements.push({ element: qrDiv, url: url });
                        if (linkHintDiv) clickableElements.push({ element: linkHintDiv, url: url });
                        clickableElements.push({ element: titleNode, url: url });
                    }
                }
            } else { listDiv.innerHTML = '<p style="padding: 10px; text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ±.</p>'; }
            sectionDiv.appendChild(listDiv); contentWrapper.appendChild(sectionDiv); printContainer.appendChild(contentWrapper);
            const footer = document.createElement('div'); footer.className = 'print-footer'; footer.innerHTML = `<span>Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø¹Ù„Ù…: Ø¹Ù„ÙŠ Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ… Ø¹Ø³ÙŠØ±ÙŠ</span><span>Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©: Ø£Ø­Ù…Ø¯ Ø³Ø§Ù„Ù… Ø§Ù„Ø´Ù‡Ø±ÙŠ</span>`; printContainer.appendChild(footer);
            document.body.appendChild(printContainer);

            // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ *ÙÙ‚Ø·* Ø¯Ø§Ø®Ù„ div Ø§Ù„Ù…Ø®ØµØµ Ù„Ù‡ØŒ ÙˆÙ„ÙŠØ³ Ù„ÙƒÙ„ Ø¹Ù†ØµØ± Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø¶ØºØ·
            const qrDivs = printContainer.querySelectorAll('.print-item-qr');
            qrDivs.forEach((div) => {
                 const url = div.dataset.url;
                 if(url) {
                     try { new QRCode(div, { text: url, width: 80, height: 80, correctLevel: QRCode.CorrectLevel.L }); } catch(e){}
                 }
            });

            await new Promise(resolve => setTimeout(resolve, 500));
            
            let canvas; try { canvas = await html2canvas(printContainer, { scale: 2, useCORS: true, width: printContainer.offsetWidth, height: printContainer.offsetHeight }); } catch (e) { document.body.removeChild(printContainer); throw e; }
            const imgData = canvas.toDataURL('image/png');
            const pdfWidth = doc.internal.pageSize.getWidth(), pdfHeight = doc.internal.pageSize.getHeight();
            if (!isFirstPage) doc.addPage();
            
            const pageRect = printContainer.getBoundingClientRect();
            const scaleFactorX = pdfWidth / pageRect.width;
            const scaleFactorY = pdfHeight / pageRect.height;

            clickableElements.forEach(item => {
                const rect = item.element.getBoundingClientRect();
                const finalX = (pageRect.width - ((rect.left - pageRect.left) + rect.width)) * scaleFactorX; // RTL adjustment
                const finalY = (rect.top - pageRect.top) * scaleFactorY;
                const boundWidth = rect.width * scaleFactorX;
                const boundHeight = rect.height * scaleFactorY;
                doc.link(finalX, finalY, boundWidth, boundHeight, { url: item.url });
            });

            doc.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
            document.body.removeChild(printContainer);
        }

        function chunkArray(array, size) { if (!Array.isArray(array)) return []; const chunks = []; for (let i = 0; i < array.length; i += size) { chunks.push(array.slice(i, i + size)); } return chunks; }

        async function generatePdfForSections(specificSectionElement) {
            if (!pdfSpinnerModal) return; pdfSpinnerModal.classList.remove('hidden');
            const { jsPDF } = window.jspdf; const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
            try {
                const sectionsToPrintElements = specificSectionElement ? [specificSectionElement] : (sectionsContainer ? Array.from(sectionsContainer.querySelectorAll('.column-wrapper')) : []);
                const sectionsData = [];
                for (const el of sectionsToPrintElements) { if (el && el.dataset && el.dataset.sectionId) { const data = await getSectionDataById(el.dataset.sectionId); if (data) sectionsData.push(data); } }
                let isFirstPage = true;
                for (const section of sectionsData) {
                    const items = section.items || [], sectionTitle = section.title || 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†', sectionIcon = section.icon || DEFAULT_ICON;
                    const itemChunks = chunkArray(items, 5);
                    if (itemChunks.length === 0) { await createPdfPageFromHTML(doc, sectionTitle, sectionIcon, [], isFirstPage); isFirstPage = false; } 
                    else { for (const chunk of itemChunks) { await createPdfPageFromHTML(doc, sectionTitle, sectionIcon, chunk, isFirstPage); isFirstPage = false; } }
                }
                if (!isFirstPage) doc.save('ØªÙ‚Ø±ÙŠØ±-Ø§Ù„Ø±Ø§Ø´Ø¯ÙˆÙ†.pdf'); else showAlert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰.");
            } catch (error) { showAlert("Ø­Ø¯Ø« Ø®Ø·Ø£."); } finally { if (pdfSpinnerModal) pdfSpinnerModal.classList.add('hidden'); }
        }
        
        async function printSelectedItems() {
            if (selectionBasket.length === 0) { showAlert("Ø§Ø®ØªØ± Ø¹Ù†ØµØ±Ø§Ù‹."); return; }
            if (!pdfSpinnerModal) return; pdfSpinnerModal.classList.remove('hidden');
            const { jsPDF } = window.jspdf; const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
            try {
                let isFirstPage = true;
                const itemChunks = chunkArray(selectionBasket, 5);
                for (const chunk of itemChunks) { await createPdfPageFromHTML(doc, "Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©", 'ğŸ“‹', chunk, isFirstPage, "ØªÙ‚Ø±ÙŠØ± Ù…Ø®ØµØµ"); isFirstPage = false; }
                if (!isFirstPage) doc.save('ØªÙ‚Ø±ÙŠØ±-Ù…Ø®ØµØµ-Ø§Ù„Ø±Ø§Ø´Ø¯ÙˆÙ†.pdf'); else showAlert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰.");
            } catch (error) { showAlert("Ø®Ø·Ø£ PDF."); } finally { if (pdfSpinnerModal) pdfSpinnerModal.classList.add('hidden'); clearSelection(); }
        }

        async function getSectionDataById(sectionId) { if (!sectionId || !db) return null; try { const sectionSnap = await getDoc(doc(db, sectionsPath, sectionId)); return sectionSnap.exists() ? sectionSnap.data() : null; } catch (e) { return null; } }

        function initializeChatApp() {
            chatUsernameDisplay = document.getElementById('chat-username-display'); chatUsersListDiv = document.getElementById('chat-users-list'); chatMessagesDiv = document.getElementById('chat-messages'); messageForm = document.getElementById('message-form'); messageInput = document.getElementById('message-input'); chatTitle = document.getElementById('chat-title'); chatSubtitle = document.getElementById('chat-subtitle');
            if (!chatUsernameDisplay || !chatUsersListDiv) return;
            chatUsernameDisplay.textContent = currentUserName;
            initChatAudio(); document.body.addEventListener('click', initChatAudio, { once: true });
            messageForm.addEventListener('submit', handleChatMessageSubmit);
            listenToChatUsersAndAdmins(); listenToChatUnreadCounts();
            chatCurrentChat = { type: 'group', id: 'group' };
        }
        async function updateUserPresence() { if (!userId) return; try { await setDoc(chatPaths.userDoc(userId), { name: currentUserName, role: currentUserRole, lastSeen: serverTimestamp(), email: currentUserEmail }, { merge: true }); } catch (e) {} }
        function initChatAudio() { if (chatSoundReady) return; Tone.start().then(() => { chatSynth = new Tone.Synth({ oscillator: { type: "triangle" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0, release: 0.3 } }).toDestination(); chatSoundReady = true; }).catch(e => {}); }
        function playChatNotificationSound() { if (chatSoundReady && chatSynth) { try { chatSynth.triggerAttackRelease("C5", "8n"); } catch(e) {} } else { if (!chatSoundReady) initChatAudio(); } }
        function listenToChatUsersAndAdmins() { onSnapshot(chatPaths.usersCollection(), (snapshot) => { chatAllUsers = {}; chatAdminList = {}; snapshot.forEach((doc) => { const u = doc.data(); const id = doc.id; chatAllUsers[id] = u; if (u.role === 'admin') chatAdminList[id] = u; }); renderPrivateChatList(); setupPersistentChatListeners(); }); }
        window.selectChat = function(type, targetId) {
            const oldTab = document.getElementById(`chat-tab-${chatCurrentChat.id.replace(':', '-')}`); if (oldTab) oldTab.classList.remove('bg-blue-50', 'border-r-4', 'border-blue-500');
            let chatId, title, subtitle;
            if (type === 'group') { chatId = 'group'; title = 'Ø¯Ø±Ø¯Ø´Ø© Ø¬Ù…Ø§Ø¹ÙŠØ©'; subtitle = 'Ø¹Ø§Ù…'; const newTab = document.getElementById('chat-tab-group'); if(newTab) newTab.classList.add('bg-blue-50', 'border-r-4', 'border-blue-500'); } 
            else { const u = chatAllUsers[targetId]; if (!u) return; title = u.name; subtitle = `Ø®Ø§Øµ`; chatId = [userId, targetId].sort().join(':'); const newTab = document.getElementById(`chat-tab-${chatId.replace(':', '-')}`); if (newTab) newTab.classList.add('bg-blue-50', 'border-r-4', 'border-blue-500'); }
            chatListView.classList.add('hidden'); chatMessageView.classList.remove('hidden'); chatCurrentChat = { type, id: chatId }; chatTitle.textContent = title; chatSubtitle.textContent = subtitle; chatMessagesDiv.innerHTML = '<div class="text-center text-gray-500">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>'; listenToChatMessages(chatId, type); clearChatUnreadCount(chatId);
        }
        function getPrivateChatId(oid) { return [userId, oid].sort().join(':'); }
        function listenToChatMessages(chatId, type) { if (chatMessageListeners[chatCurrentChat.id]) { chatMessageListeners[chatCurrentChat.id](); delete chatMessageListeners[chatCurrentChat.id]; } const q = query(type === 'group' ? chatPaths.groupChatCollection() : chatPaths.privateChatCollection(chatId), orderBy("timestamp", "desc"), limit(50)); const unsub = onSnapshot(q, (snap) => { const msgs = []; snap.forEach(d => msgs.push({ id: d.id, ...d.data() })); renderChatMessages(msgs.reverse()); if (snap.docChanges().length > 0 && snap.docChanges()[snap.docChanges().length - 1].type === "added") { const m = snap.docChanges()[snap.docChanges().length - 1].doc.data(); if (m.userId !== userId && (Date.now() - (m.timestamp?.toDate().getTime() || 0)) < 5000) playChatNotificationSound(); } }); chatMessageListeners[chatId] = unsub; }
        async function handleChatMessageSubmit(e) { e.preventDefault(); const txt = messageInput.value.trim(); if (!txt || !userId) return; initChatAudio(); try { await addDoc(chatCurrentChat.type === 'group' ? chatPaths.groupChatCollection() : chatPaths.privateChatCollection(chatCurrentChat.id), { text: txt, userId: userId, username: currentUserName, timestamp: serverTimestamp() }); messageInput.value = ''; } catch (e) { showAlert("Ø®Ø·Ø£."); } }
        window.deleteChatMessage = async function(mid) { if (!isUserAdmin || !confirm("Ø­Ø°ÙØŸ")) return; try { await deleteDoc(doc(db, chatCurrentChat.type === 'group' ? 'chat_group' : `chat_private/${chatCurrentChat.id}/messages`, mid)); showAlert("ØªÙ… Ø§Ù„Ø­Ø°Ù."); } catch (e) {} }
        function renderChatMessages(msgs) { if (msgs.length === 0) { chatMessagesDiv.innerHTML = '...'; return; } chatMessagesDiv.innerHTML = msgs.map(m => { const isMe = m.userId === userId; return `<div class="flex justify-${isMe ? 'start' : 'end'}"><div class="max-w-xs px-4 py-3 rounded-lg ${isMe ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-800'}"><p class="text-sm font-bold">${isMe ? 'Ø£Ù†Øª' : m.username}</p><p>${replaceEmojis(m.text)}</p>${isUserAdmin ? `<button onclick="deleteChatMessage('${m.id}')" class="text-xs text-red-300">Ø­Ø°Ù</button>` : ''}</div></div>`; }).join(''); chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight; }
        function renderPrivateChatList() { if (!chatUsersListDiv) return; let html = ''; const list = isUserAdmin ? chatAllUsers : chatAdminList; Object.keys(list).forEach(uid => { if (uid === userId) return; const u = list[uid], cid = getPrivateChatId(uid), unread = chatUnreadCounts[cid] || 0; html += `<div id="chat-tab-${cid.replace(':', '-')}" class="p-4 border-b cursor-pointer hover:bg-gray-100 flex justify-between" onclick="selectChat('private', '${uid}')"><div><h3>${u.name}</h3></div><span id="unread-badge-${cid.replace(':', '-')}" class="${unread>0?'':'hidden'} bg-red-500 text-white rounded-full px-2 text-xs">${unread}</span></div>`; }); chatUsersListDiv.innerHTML = html; }
        function listenToChatUnreadCounts() { if (!userId) return; onSnapshot(chatPaths.userChatStateCollection(userId), (snap) => { let total = 0; snap.forEach(d => { const c = d.data().unreadCount || 0; chatUnreadCounts[d.id] = c; total += c; const b = document.getElementById(`unread-badge-${d.id.replace(':', '-')}`); if (b) { b.textContent = c; b.classList.toggle('hidden', c===0); } }); if (chatTotalBadge) { chatTotalBadge.textContent = total; chatTotalBadge.classList.toggle('hidden', total===0); } }); }
        function setupPersistentChatListeners() { if (!userId) return; const gq = query(chatPaths.groupChatCollection(), orderBy("timestamp", "desc"), limit(1)); chatMessageListeners['ug'] = onSnapshot(gq, (s) => { if(s.docChanges().length && s.docChanges()[0].type==='added' && s.docChanges()[0].doc.data().userId!==userId && chatCurrentChat.id!=='group') incrementChatUnreadCount('group'); }); const list = isUserAdmin ? Object.keys(chatAllUsers) : Object.keys(chatAdminList); list.forEach(uid => { if (uid===userId) return; const cid = getPrivateChatId(uid); if(chatMessageListeners[`u-${cid}`]) return; const q = query(chatPaths.privateChatCollection(cid), orderBy("timestamp", "desc"), limit(1)); chatMessageListeners[`u-${cid}`] = onSnapshot(q, (s) => { if(s.docChanges().length && s.docChanges()[0].type==='added' && s.docChanges()[0].doc.data().userId!==userId && chatCurrentChat.id!==cid) incrementChatUnreadCount(cid); }); }); }
        async function incrementChatUnreadCount(cid) { if (!userId) return; const r = chatPaths.userChatStateDoc(userId, cid); try { const s = await getDoc(r); await setDoc(r, { unreadCount: (s.exists() ? s.data().unreadCount : 0) + 1 }, { merge: true }); playChatNotificationSound(); } catch (e) {} }
        async function clearChatUnreadCount(cid) { if (!userId) return; try { await setDoc(chatPaths.userChatStateDoc(userId, cid), { unreadCount: 0 }, { merge: true }); } catch (e) {} }
        window.deleteAllChats = async function() { if (!isUserAdmin || !confirm("Ø­Ø°Ù Ø§Ù„ÙƒÙ„ØŸ")) return; try { const b = writeBatch(db); (await getDocs(chatPaths.groupChatCollection())).forEach(d => b.delete(d.ref)); await b.commit(); showAlert("ØªÙ… Ø§Ù„Ø­Ø°Ù."); } catch(e){} }
        function showAlert(msg) { const m = document.getElementById('alert-modal'); if (m) { document.getElementById('alert-modal-message').textContent = msg; m.classList.remove('hidden'); setTimeout(()=>document.getElementById('alert-modal-content').classList.remove('opacity-0'), 10); } }
        function shareItemViaWhatsApp(t, u) { window.open(`https://wa.me/?text=${encodeURIComponent(`${t}\n${u}`)}`, '_blank'); }
        async function shareSectionViaWhatsApp(sid) { const d = await getSectionDataById(sid); if(d) { let m = `*${d.title}*\n`; (d.items||[]).forEach(i=>m+=`${i.title}\n${i.url}\n`); window.open(`https://wa.me/?text=${encodeURIComponent(m)}`, '_blank'); } }
        function setupControlEvents(isAdmin) { 
            if (logoutBtn) logoutBtn.addEventListener('click', async () => { if(confirm("Ø®Ø±ÙˆØ¬ØŸ")) await signOut(auth); });
            document.getElementById('print-sections-btn')?.addEventListener('click', () => generatePdfForSections(null));
            if (deleteAllChatBtn && isAdmin) deleteAllChatBtn.addEventListener('click', deleteAllChats);
            if (sectionsContainer) sectionsContainer.addEventListener('click', async (e) => {
                if (e.target.closest('.request-control-btn') && !isUserAdmin) requestSectionControl(e.target.closest('.request-control-btn').dataset.sectionId, e.target.closest('.request-control-btn').dataset.sectionTitle);
                const delBtn = e.target.closest('.item-delete-btn-desktop'); if (delBtn && confirm('Ø­Ø°ÙØŸ')) deleteItem(delBtn.closest('.item-card').dataset.sectionId, delBtn.closest('.item-card').dataset.itemId);
                const editBtn = e.target.closest('.item-edit-btn-desktop'); if (editBtn) editBtn.closest('.item-card').querySelector('.item-edit-btn-action')?.click();
                const delSec = e.target.closest('.section-delete-btn'); if (delSec && isAdmin) deleteSection(delSec.closest('.column-wrapper').dataset.sectionId);
                const prSec = e.target.closest('.section-print-btn'); if (prSec) generatePdfForSections(prSec.closest('.column-wrapper'));
                const shSec = e.target.closest('.section-share-btn'); if (shSec) shareSectionViaWhatsApp(shSec.closest('.column-wrapper').dataset.sectionId);
                const shItm = e.target.closest('.item-share-btn'); if (shItm) shareItemViaWhatsApp(shItm.closest('.item-card').querySelector('a span')?.textContent, shItm.closest('.item-card').querySelector('a')?.href);
            });
        }
    </script>
</head>
<body class="bg-gray-100">
    <div class="flex flex-col min-h-screen">
        <header class="bg-teal-700 text-white p-4 shadow-lg"><div class="container mx-auto flex justify-between items-center"><div class="flex items-center gap-3"><svg class="w-10 h-10" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 21v-8.25M15.75 21v-8.25M8.25 21v-8.25M3 9l9-6 9 6m-1.5 12V10.332A48.36 48.36 0 0012 9.75c-2.551 0-5.056.2-7.5.582V21M3 21h18M12 6.75h.008v.008H12V6.75z" /></svg><h1 class="text-2xl font-bold">Ù…Ù†ØµØ© Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø±Ø§Ø´Ø¯ÙˆÙ†</h1></div><div class="flex items-center gap-3"><span id="user-name-display" class="hidden md:inline"></span><svg id="user-avatar" class="w-8 h-8 bg-white text-teal-700 rounded-full p-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" /></svg></div></div></header>
        <nav class="bg-white shadow-md p-3 sticky top-0 z-40">
            <div class="container mx-auto flex justify-center items-center gap-2 md:gap-4 flex-wrap">
                <div class="relative hidden flex-shrink-0">
                    <button id="admin-settings-btn" class="flex items-center gap-1 bg-gray-700 text-white px-3 py-1 text-sm rounded-lg hover:bg-gray-800">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-1.003 1.11-1.226.554-.223 1.19-.02 1.61.428.39.39.582.936.582 1.48v.081c.01.04.02.079.03.118.22.879.683 1.657 1.3 2.27.618.614 1.39 1.062 2.27 1.3.039.01.079.02.118.03h.082c.543 0 1.09.192 1.48.582.449.42.65.956.428 1.61-.223.554-.684 1.018-1.226 1.11a47.803 47.803 0 01-1.02.078c-.468 0-.93.04-1.38.118-.614.108-1.17.318-1.67.614-.5.3-.95.666-1.35 1.087-.4.42-.76.9-1.087 1.35-.296.5-.506 1.056-.614 1.67-.078.45-.118.912-.118 1.38 0 .36.026.712.078 1.02.09.542.56 1.003 1.11 1.226.554.223 1.19-.02 1.61-.428.39.39.582.936.582 1.48v-.081c-.01-.04-.02-.079-.03-.118a6.74 6.74 0 00-1.3-2.27 6.703 6.703 0 00-2.27-1.3c-.039-.01-.078-.02-.118-.03h-.082c-.543 0-1.09-.192-1.48-.582-.449-.42-.65-.956-.428-1.61.223-.554.684-1.018-1.226-1.11a47.803 47.803 0 01-1.02-.078c-.468 0-.93-.04-1.38-.118-.614-.108-1.17-.318-1.67.614-.5-.3-.95-.666-1.35 1.087-.4-.42-.76-.9-1.087-1.35-.296-.5-.506 1.056-.614 1.67-.078-.45-.118.912-.118-1.38 0-.36.026.712.078-1.02.09-.542.56 1.003 1.11-1.226.554-.223 1.19-.02 1.61.428.39.39.582.936.582 1.48v.081c.01.04.02.079.03.118.22.879.683 1.657 1.3 2.27.618.614 1.39 1.062 2.27 1.3.039.01.078.02.118.03h.082c.543 0 1.09.192 1.48.582.449.42.65.956.428 1.61-.223.554-.684 1.018-1.226-1.11a47.803 47.803 0 01-1.02-.078c-.468 0-.93-.04-1.38-.118z" /></svg>
                        ØªØ­ÙƒÙ…
                    </button>
                </div>
                <div class="relative hidden flex-shrink-0">
                    <button id="admin-manage-btn" class="flex items-center gap-1 bg-blue-600 text-white px-3 py-1 text-sm rounded-lg hover:bg-blue-700">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM12 15a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" /></svg>
                        Ø¥Ø¯Ø§Ø±Ø©
                    </button>
                </div>
                <div class="relative hidden flex-shrink-0">
                    <button id="admin-perms-btn" class="flex items-center gap-1 bg-yellow-500 text-white px-3 py-1 text-sm rounded-lg hover:bg-yellow-600">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        Ø·Ù„Ø¨Ø§Øª
                    </button>
                    <span id="admin-perms-badge" class="notification-badge hidden">0</span>
                </div>
                <div class="relative hidden flex-shrink-0">
                    <button id="add-section-btn" class="flex items-center gap-1 bg-green-500 text-white px-3 py-1 text-sm rounded-lg hover:bg-green-600">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v6m3-3H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        Ø¥Ø¶Ø§ÙØ©
                    </button>
                </div>
                
                <button id="delete-all-chat-btn" class="hidden flex items-center gap-1 bg-red-700 text-white px-3 py-1 text-sm rounded-lg hover:bg-red-800">
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12.578 0a48.09 48.09 0 013.478-.397m7.5 0a48.09 48.09 0 00-7.5 0" /></svg>
                    Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
                </button>
                
                <button id="print-sections-btn" class="hidden flex items-center gap-1 bg-gray-600 text-white px-3 py-1 text-sm rounded-lg hover:bg-gray-700">
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 2.75C5 1.784 5.784 1 6.75 1h6.5c.966 0 1.75.784 1.75 1.75v3.5A1.75 1.75 0 0113.25 8H6.75A1.75 1.75 0 015 6.25v-3.5zm.75 0v3.5c0 .138.112.25.25.25h6.5a.25.25 0 00.25-.25v-3.5a.25.25 0 00-.25-.25h-6.5a.25.25 0 00-.25.25zM6 10.75A.75.75 0 016.75 10h6.5a.75.75 0 010 1.5h-6.5A.75.75 0 016 10.75zM6 13.75A.75.75 0 016.75 13h6.5a.75.75 0 010 1.5h-6.5A.75.75 0 016 13.75zM3.25 9A1.75 1.75 0 001.5 10.75v3.5c0 .966.784 1.75 1.75 1.75h1.25a.75.75 0 010 1.5H3.25A3.25 3.25 0 010 14.25v-3.5A3.25 3.25 0 013.25 7.5h13.5A3.25 3.25 0 0120 10.75v3.5A3.25 3.25 0 0116.75 17.5h-1.25a.75.75 0 010-1.5h1.25A1.75 1.75 0 0018.5 14.25v-3.5A1.75 1.75 0 0016.75 9H3.25z" clip-rule="evenodd" /></svg>
                    Ø§Ù„ÙƒÙ„
                </button>
                
                <button id="logout-btn" class="hidden flex items-center gap-1 bg-red-500 text-white px-3 py-1 text-sm rounded-lg hover:bg-red-600">
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M12 9l-3 3m0 0l3 3m-3-3h12.75" /></svg>
                    Ø®Ø±ÙˆØ¬
                </button>
                
                <button id="login-admin-btn" class="flex items-center gap-1 bg-teal-600 text-white px-3 py-1 text-sm rounded-lg hover:bg-teal-700">
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M12 9l-3 3m0 0l3 3m-3-3h12.75" /></svg>
                    Ø¯Ø®ÙˆÙ„
                </button>
            </div>
        </nav>
        <main class="flex-grow p-4 md:p-8"><div id="sections-container" class="container mx-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"><p id="initial-loading-message" class="text-gray-500 text-center col-span-3 text-xl p-10">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</p></div></main>
    </div>
    <div id="selection-bar" class="bg-gray-800 text-white shadow-lg p-3"><div class="container mx-auto flex flex-wrap justify-center md:justify-between items-center gap-3"><span class="text-lg font-semibold">ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ¯:</span><div class="flex flex-wrap justify-center gap-3"><button id="selection-share-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Ù…Ø´Ø§Ø±ÙƒØ© <span id="selection-count-share"></span></button><button id="selection-print-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Ø·Ø¨Ø§Ø¹Ø© <span id="selection-count-print"></span></button><button id="selection-clear-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Ø¥Ù„ØºØ§Ø¡</button></div></div></div>
    <div class="fixed bottom-6 right-6 z-50"><button id="chat-toggle" class="bg-blue-600 text-white rounded-full w-16 h-16 flex items-center justify-center shadow-xl hover:scale-110 transition-transform relative"><svg class="w-8 h-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.76c0 1.6 1.123 2.994 2.707 3.227 1.087.16 2.185.283 3.293.369V21l4.076-4.076a1.526 1.526 0 011.037-.443h2.88a1.875 1.875 0 001.875-1.875V16.5m-13.5-3.825V6.375c0-1.6 1.123-2.994 2.707-3.227 1.087.16 2.185.283 3.293.369V3l4.076 4.076a1.526 1.526 0 011.037.443h2.88a1.875 1.875 0 011.875 1.875v1.65M16.5 12V6.375m0 5.625v3.825m0 0v3.75m-13.5-3.75h13.5" /></svg><span id="chat-total-badge" class="hidden absolute top-0 right-0 transform translate-x-1/2 -translate-y-1/2 bg-red-500 text-white text-xs font-bold rounded-full w-6 h-6 flex items-center justify-center">0</span></button></div>
    <div id="login-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[100] p-4"><div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md text-center"><h2 class="text-3xl font-bold mb-2">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2><form id="login-form"><input type="text" id="user-name-input" class="w-full px-4 py-3 border mb-4 rounded-lg" placeholder="Ø§Ù„Ø§Ø³Ù…"><input type="email" id="user-email-input" required class="w-full px-4 py-3 border mb-4 rounded-lg" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯"><input type="password" id="user-password-input" required class="w-full px-4 py-3 border mb-4 rounded-lg" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"><p id="login-error" class="hidden text-red-500 mb-4"></p><button type="submit" class="w-full bg-teal-600 text-white py-3 rounded-lg mb-3">Ø¯Ø®ÙˆÙ„</button><button type="button" id="register-new-user-btn" class="w-full bg-gray-500 text-white py-3 rounded-lg">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button></form></div></div>
    <div id="chat-window" class="hidden fixed bottom-24 right-6 w-96 h-[500px] bg-white rounded-lg shadow-2xl flex flex-col z-50 overflow-hidden"><div id="chat-list-view" class="flex flex-col h-full"><div class="flex justify-between items-center p-3 bg-blue-600 text-white"><h3 class="font-bold">Ø§Ù„Ø¯Ø±Ø¯Ø´Ø§Øª</h3><button id="close-chat" class="text-2xl">&times;</button></div><div id="chat-user-info" class="p-3 border-b text-sm"><p>Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ <span id="chat-username-display"></span></p></div><div class="flex-grow overflow-y-auto"><div id="chat-tab-group" class="p-4 border-b hover:bg-gray-100 cursor-pointer flex justify-between" onclick="selectChat('group','group')"><div><b>Ø¹Ø§Ù…</b></div><span id="unread-badge-group" class="hidden bg-red-500 text-white rounded-full px-2">0</span></div><div id="chat-users-list"></div></div></div><div id="chat-message-view" class="hidden flex flex-col h-full"><div class="flex justify-between items-center p-3 bg-blue-600 text-white"><button id="chat-back-btn">Ø±Ø¬ÙˆØ¹</button><h3 id="chat-title">...</h3><button id="close-chat-2">&times;</button></div><div id="chat-messages" class="flex-1 p-3 overflow-y-auto bg-gray-50 space-y-3"></div><form id="message-form" class="p-3 border-t flex gap-2"><input id="message-input" class="flex-1 border rounded-full px-3 py-2"><button type="submit" class="bg-blue-500 text-white rounded-full w-10 h-10">></button></form></div></div>
    <div id="add-item-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4"><div class="bg-white rounded-lg p-6 w-full max-w-md" id="modal-content"><h3 class="text-2xl font-bold mb-4">Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ±</h3><div class="mb-4 flex gap-4"><button id="tab-link" class="w-1/2 border-b-2 border-teal-500 text-teal-600">Ø±Ø§Ø¨Ø·</button><button id="tab-file" class="w-1/2 border-b-2 border-transparent">Ù…Ù„Ù</button></div><form id="add-item-form"><input type="hidden" id="column-id-input"><input type="hidden" id="item-type-input" value="link"><input type="text" id="item-title" class="w-full border p-2 rounded mb-4" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†"><div id="link-input-section"><input type="url" id="item-link" class="w-full border p-2 rounded mb-4" placeholder="URL"></div><div id="file-input-section" class="hidden"><input type="file" id="item-file" class="w-full"></div><div class="flex justify-end gap-3"><button type="button" id="cancel-modal" class="bg-gray-200 px-4 py-2 rounded">Ø¥Ù„ØºØ§Ø¡</button><button type="submit" class="bg-teal-600 text-white px-4 py-2 rounded">Ø¥Ø¶Ø§ÙØ©</button></div></form></div></div>
    <div id="add-section-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4"><div class="bg-white rounded-lg p-6 w-full max-w-md" id="add-section-modal-content"><h3 class="text-2xl font-bold mb-4">Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù…</h3><form id="add-section-form"><input type="hidden" id="section-icon" value="ğŸ“š"><input type="text" id="section-title" class="w-full border p-2 rounded mb-4" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†"><div id="add-section-icon-picker" class="icon-picker mb-4"></div><div class="flex items-center mb-4"><input id="section-visibility" type="checkbox" checked class="ml-2"><label>Ø¥Ø¸Ù‡Ø§Ø± Ù„Ù„Ø¬Ù…ÙŠØ¹</label></div><div class="flex justify-end gap-3"><button type="button" id="cancel-section-modal" class="bg-gray-200 px-4 py-2 rounded">Ø¥Ù„ØºØ§Ø¡</button><button type="submit" class="bg-teal-600 text-white px-4 py-2 rounded">Ø¥Ø¶Ø§ÙØ©</button></div><button id="close-section-modal" class="hidden"></button></form></div></div>
    <div id="edit-section-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4"><div class="bg-white rounded-lg p-6 w-full max-w-md"><h3 class="text-2xl font-bold mb-4">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø³Ù…</h3><form id="edit-section-form"><input type="hidden" id="edit-section-id"><input type="hidden" id="edit-section-icon"><input type="text" id="edit-section-title" class="w-full border p-2 rounded mb-4"><div id="edit-section-icon-picker" class="icon-picker mb-4"></div><div class="flex items-center mb-4"><input id="edit-section-visibility" type="checkbox" class="ml-2"><label>Ø¥Ø¸Ù‡Ø§Ø± Ù„Ù„Ø¬Ù…ÙŠØ¹</label></div><div id="current-editors-container" class="hidden mb-4"><ul id="current-editors-list"></ul></div><div class="flex justify-end gap-3"><button type="button" id="cancel-edit-section-modal" class="bg-gray-200 px-4 py-2 rounded">Ø¥Ù„ØºØ§Ø¡</button><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Ø­ÙØ¸</button></div><button id="close-edit-section-modal" class="hidden"></button></form></div></div>
    <div id="edit-item-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4"><div class="bg-white rounded-lg p-6 w-full max-w-md"><h3 class="text-2xl font-bold mb-4">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù†ØµØ±</h3><form id="edit-item-form"><input type="hidden" id="edit-item-id"><input type="hidden" id="edit-item-section-id"><input type="text" id="edit-item-title" class="w-full border p-2 rounded mb-4"><input type="url" id="edit-item-link" class="w-full border p-2 rounded mb-4"><div class="flex justify-end gap-3"><button type="button" id="cancel-edit-item-modal" class="bg-gray-200 px-4 py-2 rounded">Ø¥Ù„ØºØ§Ø¡</button><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Ø­ÙØ¸</button></div><button id="close-edit-item-modal" class="hidden"></button></form></div></div>
    <div id="alert-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[60]"><div class="bg-white rounded-lg p-6 w-full max-w-sm" id="alert-modal-content"><h3 class="text-xl font-bold mb-4">ØªÙ†Ø¨ÙŠÙ‡</h3><p id="alert-modal-message" class="mb-6"></p><button id="close-alert-modal" class="bg-teal-600 text-white px-4 py-2 rounded float-left">Ø­Ø³Ù†Ø§Ù‹</button></div></div>
    <div id="pdf-spinner-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[100]"><div class="bg-white rounded-lg p-8 text-center"><p>Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ PDF...</p></div></div>
    <div id="admin-manage-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[70]"><div class="bg-white rounded-lg p-6 w-full max-w-lg"><h3 class="text-2xl font-bold mb-4">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† <button id="close-admin-manage-modal" class="float-left">&times;</button></h3><ul id="admin-users-list" class="max-h-96 overflow-y-auto"></ul></div></div>
    <div id="admin-perms-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[70]"><div class="bg-white rounded-lg p-6 w-full max-w-lg"><h3 class="text-2xl font-bold mb-4">Ø§Ù„Ø·Ù„Ø¨Ø§Øª <button id="close-admin-perms-modal" class="float-left">&times;</button></h3><ul id="admin-perms-list" class="max-h-96 overflow-y-auto"></ul></div></div>
    <div id="admin-settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[70]"><div class="bg-white rounded-lg p-6 w-full max-w-lg"><h3 class="text-2xl font-bold mb-4">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª <button id="close-admin-settings-modal" class="float-left">&times;</button></h3><div class="space-y-4"><div class="flex justify-between border p-2"><p>ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</p><input type="checkbox" id="setting-toggle-chat"></div><div class="border p-2 bg-yellow-50"><button id="setting-revoke-editors" class="text-red-600">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…Ø­Ø±Ø±ÙŠÙ†</button></div><div class="border p-2 bg-red-50"><button id="setting-revoke-admins" class="text-red-600">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…Ø¯Ø±Ø§Ø¡</button></div></div></div></div>
</body>
</html>
