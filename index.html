<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†ØµØ© Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø±Ø§Ø´Ø¯ÙˆÙ†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght+400;600;700&display=swap" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    
    <script>
        function replaceEmojis(text) {
             const emojiMap = {
                ':)': 'ğŸ˜Š', ':D': 'ğŸ˜', ':(': 'ğŸ˜', ';)': 'ğŸ˜‰', 
                ':|': 'ğŸ˜', ':o': 'ğŸ˜®', '<3': 'â¤ï¸', '8)': 'ğŸ˜'
             };
             let replacedText = text;
             for (const key in emojiMap) {
                 const safeKey = key.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
                 const regex = new RegExp(safeKey, 'g');
                 replacedText = replacedText.replace(regex, emojiMap[key]);
             }
             return replacedText;
        }
    </script>

    <style>
        /* ØªØ·Ø¨ÙŠÙ‚ Ø®Ø· "Cairo" Ø¹Ù„Ù‰ ÙƒØ§Ù…Ù„ Ø§Ù„ØµÙØ­Ø© */
        body {
            font-family: 'Cairo', sans-serif;
            /* (Ø¬Ø¯ÙŠØ¯) Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø§Ø­Ø© Ø³ÙÙ„ÙŠØ© Ù„Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ø§Ø¦Ù… */
            padding-bottom: 100px; 
        }
        /* Ø¥Ø®ÙØ§Ø¡ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© */
        #chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        #chat-messages::-webkit-scrollbar-thumb {
            background-color: #9ca3af; /* gray-400 */
            border-radius: 3px;
        }

        /* Ø£Ù†Ù…Ø§Ø· Ø´Ø§Ø±Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª */
        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: red;
            color: white;
            border-radius: 50%;
            padding: 0.1em 0.4em;
            font-size: 0.75rem; /* 12px */
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 1.25rem; /* 20px */
            height: 1.25rem; /* 20px */
            z-index: 10;
        }
        
        /* Ø´Ø§Ø±Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ø¦Ù…Ø© */
        #chat-total-badge {
            position: absolute;
            top: 0;
            right: 0;
            transform: translate(50%, -50%);
            background-color: red;
            color: white;
            border-radius: 50%;
            padding: 0.1em 0.5em;
            font-size: 0.85rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 1.75rem;
            height: 1.75rem;
            box-shadow: 0 0 0 3px #f3f4f6; /* gray-100 */
        }
        
        /* (Ø¬Ø¯ÙŠØ¯) ØªÙ…ÙŠÙŠØ² Ø¹Ù†ÙˆØ§Ù† "Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø®Ø§ØµØ©" */
        .private-chat-header {
            font-weight: bold;
            color: #008080; /* Teal - Ù„ÙˆÙ† Ù…Ù…ÙŠØ² */
            padding: 10px 0;
            border-bottom: 2px solid #008080;
        }


        /* Ø£Ù†Ù…Ø§Ø· Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© (Ù„Ø¥Ù†Ø´Ø§Ø¡ PDF) */
        .print-container {
            position: absolute;
            left: -9999px;
            top: -9999px;
            width: 210mm; /* A4 width */
            height: 297mm; /* A4 height (Ù‡Ø§Ù… Ø¬Ø¯Ø§Ù‹) */
            padding: 15mm;
            background-color: white;
            color: black;
            font-family: 'Cairo', sans-serif;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }

        /* Ø§Ù„ØªØ±ÙˆÙŠØ³Ø© Ø§Ù„Ø¹Ù„ÙˆÙŠØ© */
        .print-super-header {
            background-color: #008080; /* Teal */
            color: white;
            padding: 15px;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 10px;
            line-height: 1.6;
            font-size: 16px;
        }

        .print-header {
            background-color: #008080; /* Teal */
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .print-header h1 {
            font-size: 28px;
            font-weight: bold;
            margin: 0;
        }

        /* Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ */
        .print-content-wrapper {
             flex-grow: 1; /* ÙŠØ¯ÙØ¹ Ø§Ù„ØªØ°ÙŠÙŠÙ„ Ù„Ù„Ø£Ø³ÙÙ„ */
        }

        .print-section {
            margin-bottom: 25px;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }
        .print-section-title {
            font-size: 22px;
            font-weight: bold;
            padding: 15px;
            background-color: #f4f4f4;
            border-bottom: 1px solid #ddd;
        }
        .print-item-list {
            padding: 15px;
        }
        .print-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }
        .print-item:last-child {
            border-bottom: none;
        }
        .print-item-text {
            flex-grow: 1;
            margin-right: 15px; /* (ØªØ¹Ø¯ÙŠÙ„) Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø§ÙØ© Ù„Ù„ÙŠÙ…ÙŠÙ† */
        }
        .print-item-title {
            font-size: 18px;
            font-weight: 600;
        }
        .print-item-qr {
            width: 80px;
            height: 80px;
            margin-left: 15px; /* Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³Ø§ÙØ© Ù„Ù„ÙŠØ³Ø§Ø± */
            flex-shrink: 0; /* Ù…Ù†Ø¹ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ù† Ø§Ù„Ø§Ù†ÙƒÙ…Ø§Ø´ */
        }

        /* Ø§Ù„ØªØ°ÙŠÙŠÙ„ */
        .print-footer {
            display: flex;
            justify-content: space-between;
            padding-top: 15px;
            margin-top: 20px;
            border-top: 2px solid #008080;
            font-size: 14px;
            font-weight: 600;
        }
        
        /* (ØªØ¹Ø¯ÙŠÙ„) Ù†Ù…Ø· Ù…Ù‚Ø¨Ø¶ Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª (Ù„Ù„Ø¹Ù†Ø§ØµØ±) */
        .drag-handle {
            cursor: move;
            flex-shrink: 0;
            margin-left: 8px; 
            padding: 4px;
            border-radius: 4px;
            transition: background-color 0.2s;
            color: #008080; 
        }
        .drag-handle:hover {
            background-color: #f3f4f6; /* gray-100 */
            color: #008080; /* ØªØ«Ø¨ÙŠØª Ø§Ù„Ù„ÙˆÙ† ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ… */
        }
        
        /* (Ø¬Ø¯ÙŠØ¯) Ù†Ù…Ø· Ù…Ù‚Ø¨Ø¶ Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª (Ù„Ù„Ø£Ù‚Ø³Ø§Ù…) */
        .section-drag-handle {
            cursor: move;
            flex-shrink: 0;
            padding: 0.5rem; /* 8px */
            color: #6b7280; /* gray-500 */
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .section-drag-handle:hover {
            background-color: #f3f4f6; /* gray-100 */
            color: #1f2937; /* gray-800 */
        }
        
        /* (Ø¬Ø¯ÙŠØ¯) ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø³Ø­Ø¨ ÙˆÙ„ÙƒÙ† Ø§Ù„Ø³Ø­Ø¨ ÙŠØªÙ… Ø¹Ø¨Ø± Ø§Ù„Ù…Ù‚Ø¨Ø¶ ÙÙ‚Ø· */
        .sortable-drag {
            opacity: 0.5 !important;
            border: 2px dashed #008080;
        }
        .sortable-ghost {
            opacity: 0.1;
        }
        
        /* (Ø¬Ø¯ÙŠØ¯) Ù†Ù…Ø· Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª */
        .action-popup {
            position: absolute;
            top: 100%;
            left: 0; /* ÙŠØ¸Ù‡Ø± Ø¹Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø± ÙÙŠ RTL */
            z-index: 20;
            min-width: 120px;
        }
        
        /* (Ø¬Ø¯ÙŠØ¯) Ù†Ù…Ø· Ø´Ø±ÙŠØ· Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ø§Ø¦Ù… */
        #selection-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 90;
            transition: transform 0.3s ease-in-out;
            transform: translateY(100%); /* ÙŠØ¨Ø¯Ø£ Ù…Ø®ÙÙŠØ§Ù‹ */
        }
        #selection-bar.visible {
            transform: translateY(0); /* ÙŠØ¸Ù‡Ø± Ø¹Ù†Ø¯ Ø¥Ø¶Ø§ÙØ© ÙƒÙ„Ø§Ø³ "visible" */
        }
        
        /* (Ø¬Ø¯ÙŠØ¯) Ù†Ù…Ø· ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± */
        .item-selection-checkbox {
            flex-shrink: 0;
            width: 1.25rem; /* 20px */
            height: 1.25rem; /* 20px */
            margin-left: 12px; /* Ù…Ø³Ø§ÙØ© Ù„Ù„ÙŠØ³Ø§Ø± */
            border-radius: 4px;
            border-color: #9ca3af; /* gray-400 */
            color: #008080; /* teal-700 */
            cursor: pointer;
            transition: all 0.2s;
        }
        .item-selection-checkbox:hover {
            border-color: #008080;
        }
        .item-selection-checkbox:focus {
            ring: 0;
            ring-offset: 0;
            outline: none;
            box-shadow: none;
        }

        /* --- (Ø¬Ø¯ÙŠØ¯) Ø£Ù†Ù…Ø§Ø· Ù…Ù†ØªÙ‚ÙŠ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª --- */
        .icon-picker {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            max-height: 150px;
            overflow-y: auto;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        .icon-picker-item {
            cursor: pointer;
            font-size: 1.5rem; /* 24px */
            padding: 4px;
            border-radius: 4px;
            transition: background-color 0.2s, transform 0.2s;
            border: 2px solid transparent;
        }
        .icon-picker-item:hover {
            background-color: #e9e9e9;
            transform: scale(1.1);
        }
        .icon-picker-item.selected {
            border-color: #008080; /* Teal */
            background-color: #e0f2f1; /* Light Teal */
        }
        
        /* (Ø¬Ø¯ÙŠØ¯) Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù‚Ø³Ù… */
        .section-title-icon {
            font-size: 1.5rem; /* 24px */
            margin-left: 8px; /* margin-right in LTR */
            flex-shrink: 0;
        }
        /* --- Ù†Ù‡Ø§ÙŠØ© Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª --- */
        
    </style>

    <script type="module">
        // Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…ÙƒØªØ¨Ø§Øª Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, 
             signInWithEmailAndPassword, // ØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡
             createUserWithEmailAndPassword, // ØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡
             onAuthStateChanged, 
             signOut 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, collection, addDoc, onSnapshot, query, 
            updateDoc, arrayUnion, getDoc, setDoc, deleteDoc, getDocs, 
            where, serverTimestamp, arrayRemove, orderBy, limit, writeBatch, documentId
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        

        // --- 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase ---
        
        // (Ù‡Ø§Ù…) ÙŠØ¬Ø¨ ØªØºÙŠÙŠØ± Ù…ÙØªØ§Ø­ API Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ø³ÙŠÙØ³ØªØ®Ø¯Ù… ÙØ¹Ù„ÙŠØ§Ù‹
        const firebaseConfig = {
          apiKey: "AIzaSyCAabU3qzh2wmWmA8v95oabloap1PNyHwI",
          authDomain: "jaded-3ef9d.firebaseapp.com",
          projectId: "jaded-3ef9d",
          storageBucket: "jaded-3ef9d.firebasestorage.app",
          messagingSenderId: "240292137665",
          appId: "1:240292137665:web:02597426d8288ca0c16240"
        };
        
        // --- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯ÙŠØ± (Ø³ÙŠØªÙ… Ø¥Ø¯Ø§Ø±ØªÙ‡Ø§ Ø¹Ø¨Ø± Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†) ---
        const DEFAULT_ADMIN_EMAIL = "abuibrahem2@gmail.com"; // Ø§Ù„Ø§ÙŠÙ…ÙŠÙ„ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù„Ù…Ø¯ÙŠØ±
        // ------------------------------
        
        const CHAT_APP_ID = 'rashedon-app';

        // Ø®Ø¯Ù…Ø§Øª Firebase
        let app, auth, db, userId; // userId Ù‡Ùˆ Ù…Ø¹Ø±Ù Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© (Auth UID)
        let sectionsCollectionRef;
        let usersCollectionRef;
        let permissionRequestsCollectionRef;
        
        const sectionsPath = `sections`;
        const usersPath = `users`; 
        const permissionRequestsPath = `permissionRequests`;
        const configPath = 'config'; // (Ø¬Ø¯ÙŠØ¯) Ù…Ø³Ø§Ø± Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©

        // Ù…ØªØºÙŠØ±Ø§Øª Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø§Ù„Ù…Ù†ØµØ©)
        let currentUserName = null; // Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„)
        let currentUserEmail = null; // Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
        let currentUserRole = 'viewer';
        let isUserAdmin = false;
        let isAppInitialized = false; // (Ø¬Ø¯ÙŠØ¯) Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙ…Ù‡ÙŠØ¯ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯
        
        // (Ø¬Ø¯ÙŠØ¯) Ù…ØªØºÙŠØ± Ù„Ø³Ù„Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
        let selectionBasket = []; 

        // (ØªØ¹Ø¯ÙŠÙ„) Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        const adminControls = ['add-section-btn', 'admin-manage-btn', 'admin-perms-btn', 'admin-settings-btn'];
        const generalControls = ['print-sections-btn', 'logout-btn'];

        // (Ø¬Ø¯ÙŠØ¯) Ù…ØªØºÙŠØ± Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
        let globalConfig = { isChatEnabled: true };


        // Ù…ØªØºÙŠØ±Ø§Øª Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ† (Listeners)
        let permissionRequestsUnsubscribe = null; 
        let userDocUnsubscribe = null; // (Ø¬Ø¯ÙŠØ¯) Ù…Ø³ØªÙ…Ø¹ Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¯ÙˆØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        let globalConfigUnsubscribe = null; // (Ø¬Ø¯ÙŠØ¯) Ù…Ø³ØªÙ…Ø¹ Ù„Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
        let sectionSortingInstance = null; // (Ø¬Ø¯ÙŠØ¯) Ù…ØªØºÙŠØ± Ù„Ù€ Sortable.js Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ø£Ù‚Ø³Ø§Ù…

        // --- (Ø¬Ø¯ÙŠØ¯) Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ---
        let chatAllUsers = {}; 
        let chatAdminList = {}; 
        let chatCurrentChat = { type: 'group', id: 'group' };
        let chatUnreadCounts = {};
        let chatMessageListeners = {};
        let chatSynth;
        let chatSoundReady = false;
        
        const chatPaths = {
            usersCollection: () => collection(db, usersPath), 
            userDoc: (uid) => doc(db, usersPath, uid), 
            groupChatCollection: () => collection(db, `chat_group`),
            privateChatCollection: (chatId) => collection(db, `chat_private/${chatId}`, 'messages'),
            userChatStateCollection: (uid) => collection(db, `chat_state/${uid}/state`), 
            userChatStateDoc: (uid, chatId) => doc(db, `chat_state/${uid}/state`, chatId),
        };
        // --- Ù†Ù‡Ø§ÙŠØ© Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ---


        // --- (Ø¬Ø¯ÙŠØ¯) Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª ---
        const PREDEFINED_ICONS = ['ğŸ“š', 'ğŸ’¡', 'ğŸ”—', 'ğŸ“‹', 'ğŸ“', 'ğŸ“', 'â­', 'ğŸš€', 'ğŸ¯', 'ğŸ”', 'ğŸ””', 'ğŸ‘¤', 'ğŸŒ', 'ğŸ“ˆ', 'ğŸ”§', 'âœ…', 'âš ï¸', 'ğŸ ', 'ğŸ“…', 'ğŸ’¬'];
        const DEFAULT_ICON = 'ğŸ“š';

        // --- 2. Ø¹Ù†Ø§ØµØ± Ø§Ù„ØµÙØ­Ø© (DOM) ---
        let sectionsContainer;
        let userNameDisplay, userAvatar;
        let permsBtnBadge;
        let initialLoadingMessage; 
        
        // (Ø¬Ø¯ÙŠØ¯) Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
        let chatWindow, chatListView, chatMessageView, closeChatBtn1, closeChatBtn2, chatBackBtn;
        let chatUsernameDisplay, chatUsersListDiv, chatMessagesDiv, messageForm, messageInput, chatTitle, chatSubtitle;
        
        // Ù†ÙˆØ§ÙØ° (Ø§Ù„Ù…Ù†ØµØ©)
        let loginModal, loginForm, loginError;
        let addSectionModal, addSectionModalContent, addSectionForm, closeSectionModalBtn, cancelSectionModalBtn;
        let addItemModal, modalContent, closeModalBtn, cancelModalBtn, addItemForm, columnIdInput, itemTypeInput;
        let editSectionModal, editSectionForm, editSectionTitleInput, editSectionIdInput;
        let editItemModal, editItemForm, editItemTitleInput, editItemLinkInput, editItemIdInput, editItemSectionIdInput;
        let alertModal;
        let pdfSpinnerModal;
        let adminManageModal, adminUsersList;
        let adminPermsModal, adminPermsList;
        let adminSettingsModal; // (Ø¬Ø¯ÙŠØ¯) Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        let currentEditorsList, currentEditorsContainer; 
        
        // (Ø¬Ø¯ÙŠØ¯) Ø£Ø²Ø±Ø§Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„/Ø§Ù„Ø®Ø±ÙˆØ¬
        let logoutBtn, loginAdminBtn; 
        let chatTotalBadge; // Ø´Ø§Ø±Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ø¦Ù…Ø©
        let deleteAllChatBtn; // Ø²Ø± Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø§Øª
        
        // (Ø¬Ø¯ÙŠØ¯) Ø¹Ù†Ø§ØµØ± Ø´Ø±ÙŠØ· Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
        let selectionBar, selectionCountShare, selectionCountPrint, selectionShareBtn, selectionPrintBtn, selectionClearBtn;
        

        /**
         * =============================================
         * Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
         * =============================================
         */
        document.addEventListener('DOMContentLoaded', () => {
            // ØªÙ‡ÙŠØ¦Ø© Ø¹Ù†Ø§ØµØ± Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Ø§Ù„Ù…Ù†ØµØ©)
            sectionsContainer = document.getElementById('sections-container');
            userNameDisplay = document.getElementById('user-name-display');
            userAvatar = document.getElementById('user-avatar');
            pdfSpinnerModal = document.getElementById('pdf-spinner-modal');
            permsBtnBadge = document.getElementById('admin-perms-badge'); 
            initialLoadingMessage = document.getElementById('initial-loading-message'); 
            
            // (Ø¬Ø¯ÙŠØ¯) Ø¹Ù†Ø§ØµØ± Ø£Ø²Ø±Ø§Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„/Ø§Ù„Ø®Ø±ÙˆØ¬
            logoutBtn = document.getElementById('logout-btn');
            loginAdminBtn = document.getElementById('login-admin-btn');
            chatTotalBadge = document.getElementById('chat-toggle').querySelector('#chat-total-badge'); // Ø´Ø§Ø±Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„ÙƒÙ„ÙŠØ©
            deleteAllChatBtn = document.getElementById('delete-all-chat-btn'); // Ø²Ø± Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø§Øª

            // ØªÙ‡ÙŠØ¦Ø© Ù†Ø§ÙØ°Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ø§Ù„Ù…Ù†ØµØ©)
            loginModal = document.getElementById('login-modal');
            loginForm = document.getElementById('login-form');
            loginError = document.getElementById('login-error');
            
            // (Ø¬Ø¯ÙŠØ¯) ØªÙ‡ÙŠØ¦Ø© Ø¹Ù†Ø§ØµØ± Ø´Ø±ÙŠØ· Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
            selectionBar = document.getElementById('selection-bar');
            selectionCountShare = document.getElementById('selection-count-share');
            selectionCountPrint = document.getElementById('selection-count-print');
            selectionShareBtn = document.getElementById('selection-share-btn');
            selectionPrintBtn = document.getElementById('selection-print-btn');
            selectionClearBtn = document.getElementById('selection-clear-btn');
            
            // (Ø¬Ø¯ÙŠØ¯) Ø±Ø¨Ø· Ø£Ø­Ø¯Ø§Ø« Ø£Ø²Ø±Ø§Ø± Ø´Ø±ÙŠØ· Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
            if (selectionShareBtn) selectionShareBtn.addEventListener('click', shareSelectedItems);
            if (selectionPrintBtn) selectionPrintBtn.addEventListener('click', printSelectedItems);
            if (selectionClearBtn) selectionClearBtn.addEventListener('click', clearSelection);

            // === Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯: ÙŠØ¬Ø¨ Ø£Ù† ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§ ===
            
            // ØªÙ‡ÙŠØ¦Ø© Firebase Ù…Ø¨ÙƒØ±Ø§Ù‹
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // ØªØ­Ø¯ÙŠØ¯ Ù…Ø±Ø§Ø¬Ø¹ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª
            sectionsCollectionRef = collection(db, sectionsPath);
            usersCollectionRef = collection(db, usersPath);
            permissionRequestsCollectionRef = collection(db, permissionRequestsPath);

            // Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
            listenToAuthChanges();

            // Ø±Ø¨Ø· Ø­Ø¯Ø« Ø¥Ø±Ø³Ø§Ù„ Ù†Ù…ÙˆØ°Ø¬ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
            if (loginForm) loginForm.addEventListener('submit', handleLoginSubmit);
            
            // Ø±Ø¨Ø· Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„/Ø§Ù„Ø®Ø±ÙˆØ¬
            if (loginAdminBtn) {
                 loginAdminBtn.addEventListener('click', () => {
                     if (loginError) loginError.classList.add('hidden');
                     if (loginModal) loginModal.classList.remove('hidden');
                 });
            }
            
            // Ø±Ø¨Ø· Ø²Ø± Ø§Ù„ØªØ³Ø¬ÙŠÙ„ (New)
            const registerBtn = document.getElementById('register-new-user-btn');
            if (registerBtn) registerBtn.addEventListener('click', handleRegistration);
            
            // (Ø¬Ø¯ÙŠØ¯) Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø¹Ù†ØµØ± Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
             document.addEventListener('click', (e) => {
                const popups = document.querySelectorAll('.item-action-popup:not(.hidden)');
                popups.forEach(popup => {
                    const itemCard = popup.closest('.item-card');
                    const itemActionBtn = itemCard ? itemCard.querySelector('.item-action-btn') : null;
                    if (itemActionBtn && !itemActionBtn.contains(e.target) && !popup.contains(e.target)) {
                        popup.classList.add('hidden');
                    }
                });
            });
        });

        
        /**
         * (Ø¬Ø¯ÙŠØ¯) Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù†ØªÙ‚ÙŠ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª
         */
        function createIconPicker(containerId, hiddenInputId) {
            const container = document.getElementById(containerId);
            const hiddenInput = document.getElementById(hiddenInputId);
            if (!container || !hiddenInput) return;

            container.innerHTML = '';
            PREDEFINED_ICONS.forEach(icon => {
                const span = document.createElement('span');
                span.className = 'icon-picker-item';
                span.textContent = icon;
                span.dataset.icon = icon;
                span.title = icon;
                
                span.addEventListener('click', () => {
                    // Ø¥Ø²Ø§Ù„Ø© 'selected' Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø£Ø®Ø±Ù‰ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªÙ‚ÙŠ
                    container.querySelectorAll('.icon-picker-item').forEach(item => {
                        item.classList.remove('selected');
                    });
                    // Ø¥Ø¶Ø§ÙØ© 'selected' Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ØµØ±
                    span.classList.add('selected');
                    // ØªØ¹ÙŠÙŠÙ† Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ù…Ø®ÙÙŠ
                    hiddenInput.value = icon;
                });
                container.appendChild(span);
            });
        }
        
        /**
         * (Ø¬Ø¯ÙŠØ¯) Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¶Ø¨Ø· Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© ÙÙŠ Ø§Ù„Ù…Ù†ØªÙ‚ÙŠ
         */
        function setSelectedIcon(containerId, hiddenInputId, icon) {
            const container = document.getElementById(containerId);
            const hiddenInput = document.getElementById(hiddenInputId);
            if (!container || !hiddenInput) return;

            const iconToSelect = icon || DEFAULT_ICON;
            hiddenInput.value = iconToSelect;
            
            container.querySelectorAll('.icon-picker-item').forEach(item => {
                if (item.dataset.icon === iconToSelect) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
        }

        
        /**
         * Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
         */
        function listenToAuthChanges() {
             onAuthStateChanged(auth, async (user) => {
                 
                 // (Ø¬Ø¯ÙŠØ¯) Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                 if (userDocUnsubscribe) {
                     userDocUnsubscribe();
                     userDocUnsubscribe = null;
                 }
                 if (permissionRequestsUnsubscribe) {
                     permissionRequestsUnsubscribe();
                     permissionRequestsUnsubscribe = null;
                 }
                 if (globalConfigUnsubscribe) { // (Ø¬Ø¯ÙŠØ¯)
                     globalConfigUnsubscribe();
                     globalConfigUnsubscribe = null;
                 }
                 
                 if (user) {
                     userId = user.uid;
                     currentUserEmail = user.email || 'ØºÙŠØ± Ù…Ø³Ø¬Ù„';
                     
                     if (initialLoadingMessage) initialLoadingMessage.classList.add('hidden');

                     const userDocRef = doc(db, usersPath, userId);
                     const userDocSnap = await getDoc(userDocRef);
                     
                     let initialUserData;
                     
                     if (userDocSnap.exists()) {
                         initialUserData = userDocSnap.data();
                         currentUserName = initialUserData.name || currentUserEmail;
                         currentUserRole = initialUserData.role || 'viewer';
                         isUserAdmin = (currentUserRole === 'admin');
                     } else {
                          const name = user.displayName || currentUserEmail.split('@')[0] || 'Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯';
                          initialUserData = {
                             name: name,
                             email: currentUserEmail,
                             role: 'viewer',
                             createdAt: serverTimestamp()
                          };
                          await setDoc(userDocRef, initialUserData, { merge: true });
                          
                          currentUserName = name; 
                          currentUserRole = 'viewer';
                          isUserAdmin = false;
                     }

                     if (loginModal) loginModal.classList.add('hidden');
                     
                     if (!isAppInitialized) {
                         initializeAppLogic(currentUserName);
                         isAppInitialized = true;
                     }

                     if (isUserAdmin) {
                         listenForPermissionRequests();
                     }
                     updateUserPresence();
                     
                     // (Ø¬Ø¯ÙŠØ¯) Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„ÙÙˆØ±ÙŠØ© Ø¹Ù„Ù‰ Ø¯ÙˆØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                     listenToUserRoleChanges(userDocRef);
                     // (Ø¬Ø¯ÙŠØ¯) Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
                     listenToGlobalConfig();
                     
                 } else {
                      // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                     userId = '';
                     currentUserName = 'Ø²Ø§Ø¦Ø±';
                     currentUserEmail = null;
                     currentUserRole = 'viewer';
                     isUserAdmin = false;
                     isAppInitialized = false; 
                     
                     updateUIForUser(currentUserName, false);
                     
                     if (initialLoadingMessage) initialLoadingMessage.classList.remove('hidden');
                     if (loginModal) loginModal.classList.remove('hidden');
                 }
             });
        }
        
        /**
         * (Ø¬Ø¯ÙŠØ¯) Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„ÙÙˆØ±ÙŠØ© Ø¹Ù„Ù‰ Ø¯ÙˆØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
         * Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© ØªØ¹Ø§Ù„Ø¬ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø£ÙˆÙ„ (ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª ÙÙˆØ±Ø§Ù‹)
         */
        function listenToUserRoleChanges(userDocRef) {
            if (userDocUnsubscribe) userDocUnsubscribe();

            userDocUnsubscribe = onSnapshot(userDocRef, async (userSnap) => {
                if (!userSnap.exists()) {
                    // Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‚Ø¯ Ø­ÙØ°ÙØŒ Ø£Ø¹Ø¯Ù‡ Ù„ØµÙØ­Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
                    await signOut(auth);
                    return;
                }
                
                const userData = userSnap.data();
                const newRole = userData.role || 'viewer';
                const newIsAdmin = (newRole === 'admin');
                const newName = userData.name || currentUserEmail;

                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¯ÙˆØ± Ù‚Ø¯ ØªØºÙŠØ± ÙØ¹Ù„Ø§Ù‹
                if (newRole !== currentUserRole) {
                    console.log(`Role changed from ${currentUserRole} to ${newRole}`);
                    
                    currentUserRole = newRole;
                    isUserAdmin = newIsAdmin;
                    currentUserName = newName;

                    // 1. Ø¥Ø¸Ù‡Ø§Ø± ØªÙ†Ø¨ÙŠÙ‡ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
                    showAlert(newIsAdmin ? 'âœ… ØªÙ…Øª ØªØ±Ù‚ÙŠØªÙƒ Ø¥Ù„Ù‰ Ù…Ø¯ÙŠØ±.' : 'â„¹ï¸ ØªÙ… ØªØ­Ø¯ÙŠØ« ØµÙ„Ø§Ø­ÙŠØ§ØªÙƒ Ø¥Ù„Ù‰ Ù…Ø´Ø§Ù‡Ø¯.');
                    
                    // 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¹Ù„ÙˆÙŠØ© (Ø§Ù„Ø£Ø²Ø±Ø§Ø±)
                    updateUIForUser(currentUserName, isUserAdmin);
                    
                    // 3. ØªØ­Ø¯ÙŠØ« Ù…Ø³ØªÙ…Ø¹ Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
                    if (newIsAdmin && !permissionRequestsUnsubscribe) {
                        listenForPermissionRequests();
                    } else if (!newIsAdmin && permissionRequestsUnsubscribe) {
                        permissionRequestsUnsubscribe();
                        permissionRequestsUnsubscribe = null;
                        if (permsBtnBadge) permsBtnBadge.classList.add('hidden');
                    }

                    // 4. (Ù…Ù‡Ù…) Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                    // (Ù…Ø«Ù„ Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ù„Ø­Ø°Ù ÙˆØ§Ù„Ø³Ø­Ø¨)
                    
                    const sectionsQuery = query(sectionsCollectionRef, orderBy("order"));
                    const snapshot = await getDocs(sectionsQuery);
                    
                    if (sectionsContainer) sectionsContainer.innerHTML = '';
                    if(snapshot.empty) {
                         if (sectionsContainer) sectionsContainer.innerHTML = `<p class="text-gray-500 text-center col-span-3">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‚Ø³Ø§Ù… Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†...</p>`;
                    }
                    
                    snapshot.docs.forEach((doc) => {
                        renderSection(doc);
                    });
                    
                    // 5. Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Ø³Ø­Ø¨ Ø§Ù„Ø¹Ù†Ø§ØµØ± (Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©)
                    setupItemSorting();
                    
                    // 6. Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Ø³Ø­Ø¨ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… (Ù„ØªÙØ¹ÙŠÙ„Ù‡Ø§ Ø£Ùˆ ØªØ¹Ø·ÙŠÙ„Ù‡Ø§)
                    setupSectionSorting(newIsAdmin);
                } else if (newName !== currentUserName) {
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³Ù… Ø¥Ø°Ø§ ØªØºÙŠØ±
                    currentUserName = newName;
                    updateUIForUser(currentUserName, isUserAdmin);
                }
            }, (error) => {
                console.error("Ø®Ø·Ø£ ÙØ§Ø¯Ø­ ÙÙŠ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:", error);
                // ÙÙŠ Ø­Ø§Ù„Ø© Ø­Ø¯ÙˆØ« Ø®Ø·Ø£ (Ù…Ø«Ù„ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª)ØŒ ÙŠÙØ¶Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
                signOut(auth);
            });
        }
        
        /**
         * (Ø¬Ø¯ÙŠØ¯) Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© (Ù…Ø«Ù„ ØªÙØ¹ÙŠÙ„/ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©)
         */
        function listenToGlobalConfig() {
            if (globalConfigUnsubscribe) globalConfigUnsubscribe();
            
            const configRef = doc(db, configPath, 'appSettings');
            
            globalConfigUnsubscribe = onSnapshot(configRef, (docSnap) => {
                if (docSnap.exists()) {
                    globalConfig = docSnap.data();
                } else {
                    // Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©ØŒ Ø£Ù†Ø´Ø¦Ù‡Ø§ Ø¨Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© (Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·)
                    if(isUserAdmin) {
                        setDoc(configRef, { isChatEnabled: true });
                    }
                    globalConfig = { isChatEnabled: true };
                }
                
                // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                updateUIChatVisibility(globalConfig.isChatEnabled);
                
            }, (error) => {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©:", error);
                // ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ÙØ´Ù„ØŒ Ø§ÙØªØ±Ø¶ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
                updateUIChatVisibility(true);
            });
        }

        /**
         * (Ø¬Ø¯ÙŠØ¯) ØªØ­Ø¯ÙŠØ« Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
         */
        function updateUIChatVisibility(isEnabled) {
            const chatToggleBtn = document.getElementById('chat-toggle');
            
            if (chatToggleBtn) {
                chatToggleBtn.classList.toggle('hidden', !isEnabled);
            }
            
            if (!isEnabled && chatWindow && !chatWindow.classList.contains('hidden')) {
                // Ø¥Ø°Ø§ ØªÙ… ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø£Ø«Ù†Ø§Ø¡ ÙØªØ­Ù‡Ø§ØŒ Ù‚Ù… Ø¨Ø¥ØºÙ„Ø§Ù‚Ù‡Ø§
                chatWindow.classList.add('hidden');
                showAlert("ØªÙ… ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø¯ÙŠØ±.");
            }
        }


        /**
         * Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¥Ø±Ø³Ø§Ù„ Ù†Ù…ÙˆØ°Ø¬ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±)
         */
        async function handleLoginSubmit(e) {
            e.preventDefault();
            const emailInput = document.getElementById('user-email-input');
            const passwordInput = document.getElementById('user-password-input');
            if (!emailInput || !passwordInput) return;
            
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();

            if (!email || !password) {
                showLoginError("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.");
                return;
            }
            
            try {
                showLoginError("Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„..."); 
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                if (loginError) loginError.classList.add('hidden');
                
            } catch (error) {
                let errorMessage;
                switch (error.code) {
                    case 'auth/user-not-found':
                    case 'auth/wrong-password':
                    case 'auth/invalid-credential': // (Ø¬Ø¯ÙŠØ¯) Ù„Ù„Ù†Ø³Ø® Ø§Ù„Ø£Ø­Ø¯Ø«
                        errorMessage = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.";
                        break;
                    case 'auth/invalid-email':
                        errorMessage = "ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­.";
                        break;
                    case 'auth/too-many-requests':
                        errorMessage = "ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø¤Ù‚ØªØ§Ù‹ Ø¨Ø³Ø¨Ø¨ Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ù…ØªÙƒØ±Ø±Ø© ÙØ§Ø´Ù„Ø©.";
                        break;
                    default:
                        errorMessage = `ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„. (${error.message})`;
                }
                showLoginError(errorMessage);
            }
        }
        
        /**
         * Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØ³Ø¬ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯
         */
        async function handleRegistration() {
            const nameInput = document.getElementById('user-name-input');
            const emailInput = document.getElementById('user-email-input');
            const passwordInput = document.getElementById('user-password-input');
            
            if (!nameInput || !emailInput || !passwordInput) return;
            
            const name = nameInput.value.trim();
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();

            if (!name || !email || password.length < 6) {
                 showLoginError("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…Ùƒ ÙˆØ¨Ø±ÙŠØ¯ÙƒØŒ ÙˆØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.");
                 return;
            }
            
            try {
                 showLoginError("Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨..."); 
                 const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                 const newUser = userCredential.user;
                 
                 const role = (email === DEFAULT_ADMIN_EMAIL) ? 'admin' : 'viewer';
                 
                 await setDoc(doc(db, usersPath, newUser.uid), {
                     name: name,
                     email: email,
                     role: role,
                     createdAt: serverTimestamp()
                 });

                 showAlert("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.", 'success');
                 if (loginError) loginError.classList.add('hidden');
                 
            } catch (error) {
                 let errorMessage;
                 switch (error.code) {
                     case 'auth/email-already-in-use':
                         errorMessage = "Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„. Ù‡Ù„ Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ";
                         break;
                     case 'auth/weak-password':
                         errorMessage = "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ© Ø¬Ø¯Ø§Ù‹ (ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„).";
                         break;
                     default:
                         errorMessage = `ÙØ´Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„. (${error.message})`;
                 }
                 showLoginError(errorMessage);
            }
        }


        /**
         * Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ ÙÙŠ Ù†Ø§ÙØ°Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
         */
        function showLoginError(message) {
             if (loginError) {
                 loginError.textContent = message;
                 loginError.classList.remove('hidden');
             } else {
                 console.error("Ø¹Ù†ØµØ± loginError ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!");
             }
        }


        /**
         * Ø¨Ø¯Ø¡ Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¯ÙˆØ±
         */
        function initializeAppLogic(userName) {
             if (!userName) return;

            updateUIForUser(userName, isUserAdmin);

            setupAddSectionModal();
            setupAddItemModal();
            setupEditSectionModal();
            setupEditItemModal();
            setupAlertModal();
            setupAdminManageModal();
            setupAdminPermsModal();
            setupAdminSettingsModal(); // (Ø¬Ø¯ÙŠØ¯)
            
            setupChatWindow(); 
            initializeChatApp();

            setupControlEvents(isUserAdmin);
            listenForSections();
        }

        /**
         * ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
         */
        function updateUIForUser(name, isAdmin) {
             if (userNameDisplay) {
                 userNameDisplay.textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒØŒ ${name} (${isAdmin ? 'Ù…Ø¯ÙŠØ±' : 'Ù…Ø´Ø§Ù‡Ø¯'})`;
             } 

            adminControls.forEach(id => {
                const btn = document.getElementById(id);
                if (btn) {
                     const wrapper = btn.closest('.relative');
                     if (isAdmin) {
                         btn.classList.remove('hidden');
                         if (wrapper) wrapper.classList.remove('hidden');
                     } else {
                         btn.classList.add('hidden');
                          if (wrapper) wrapper.classList.add('hidden');
                     }
                }
            });

            generalControls.forEach(id => {
                const btn = document.getElementById(id);
                if (btn) {
                         btn.classList.remove('hidden');
                }
            });
            
            if (logoutBtn && loginAdminBtn) {
                if (userId) { 
                    logoutBtn.classList.remove('hidden');
                    loginAdminBtn.classList.add('hidden');
                } else {
                    logoutBtn.classList.add('hidden');
                    loginAdminBtn.classList.remove('hidden'); 
                }
            }
            
            // (Ø¬Ø¯ÙŠØ¯) ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø­Ø°Ù Ø§Ù„Ø¯Ø±Ø¯Ø´Ø§Øª ÙÙŠ Ø´Ø±ÙŠØ· Ø§Ù„ØªØ­ÙƒÙ…
            const deleteAllChatBtnNav = document.getElementById('delete-all-chat-btn');
            if (deleteAllChatBtnNav) {
                deleteAllChatBtnNav.classList.toggle('hidden', !isAdmin);
            }
            
            // (Ø¬Ø¯ÙŠØ¯) ØªØ­Ø¯ÙŠØ« Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
            updateUIChatVisibility(globalConfig.isChatEnabled);
        }
/**
         * =============================================
         * ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© (Modals)
         * =============================================
         */

        function setupAddSectionModal() {
             addSectionModal = document.getElementById('add-section-modal');
             if (!addSectionModal) return;

             addSectionModalContent = document.getElementById('add-section-modal-content');
             addSectionForm = document.getElementById('add-section-form');
             closeSectionModalBtn = document.getElementById('close-section-modal');
             cancelSectionModalBtn = document.getElementById('cancel-section-modal');
             const addSectionBtn = document.getElementById('add-section-btn');

             // (Ø¬Ø¯ÙŠØ¯) ØªÙ‡ÙŠØ¦Ø© Ù…Ù†ØªÙ‚ÙŠ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª
             createIconPicker('add-section-icon-picker', 'section-icon');


             if (addSectionBtn) {
                 addSectionBtn.addEventListener('click', () => {
                     // (Ø¬Ø¯ÙŠØ¯) ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­
                     setSelectedIcon('add-section-icon-picker', 'section-icon', DEFAULT_ICON);
                     
                     addSectionModal.classList.remove('hidden');
                     setTimeout(() => {
                         if (addSectionModalContent) {
                             addSectionModalContent.classList.remove('scale-95', 'opacity-0');
                             addSectionModalContent.classList.add('scale-100', 'opacity-100');
                         }
                     }, 10);
                 });
             }


             const close = () => {
                  if (addSectionModalContent) {
                      addSectionModalContent.classList.add('scale-95', 'opacity-0');
                  }
                 setTimeout(() => {
                     addSectionModal.classList.add('hidden');
                     if (addSectionForm) addSectionForm.reset();
                     // (Ø¬Ø¯ÙŠØ¯) Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
                     setSelectedIcon('add-section-icon-picker', 'section-icon', DEFAULT_ICON);
                 }, 200);
             };

             if (closeSectionModalBtn) closeSectionModalBtn.addEventListener('click', close);
             if (cancelSectionModalBtn) cancelSectionModalBtn.addEventListener('click', close);
             addSectionModal.addEventListener('click', (e) => (e.target === addSectionModal) && close());

             if (addSectionForm) addSectionForm.addEventListener('submit', handleSectionFormSubmit);
           }

        function setupAddItemModal() {
            addItemModal = document.getElementById('add-item-modal');
            if (!addItemModal) return;
            modalContent = document.getElementById('modal-content');
            closeModalBtn = document.getElementById('close-modal');
            cancelModalBtn = document.getElementById('cancel-modal');
            addItemForm = document.getElementById('add-item-form');
            columnIdInput = document.getElementById('column-id-input');
            itemTypeInput = document.getElementById('item-type-input');

            if (!sectionsContainer) return;
            sectionsContainer.addEventListener('click', (e) => {
                const addItemBtn = e.target.closest('.add-item-btn');
                const sectionEl = addItemBtn ? addItemBtn.closest('.column-wrapper') : null;
                const canEdit = isUserAdmin || (sectionEl && sectionEl.dataset.canEdit === 'true');

                if (addItemBtn && canEdit) {
                    const columnId = addItemBtn.getAttribute('data-column-id');
                    if(columnIdInput) columnIdInput.value = columnId;

                    const tabLinkBtn = document.getElementById('tab-link');
                    if (tabLinkBtn) tabLinkBtn.click();

                    addItemModal.classList.remove('hidden');
                    setTimeout(() => {
                        if (modalContent) {
                           modalContent.classList.remove('scale-95', 'opacity-0');
                           modalContent.classList.add('scale-100', 'opacity-100');
                        }
                    }, 10);
                }
            });


            const closeModal = () => {
                 if (modalContent) modalContent.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    addItemModal.classList.add('hidden');
                   if (addItemForm) addItemForm.reset();
                }, 200);
            };

            if(closeModalBtn) closeModalBtn.addEventListener('click', closeModal);
            if (cancelModalBtn) cancelModalBtn.addEventListener('click', closeModal);
            addItemModal.addEventListener('click', (e) => (e.target === addItemModal) && closeModal());


            const tabLink = document.getElementById('tab-link');
            const tabFile = document.getElementById('tab-file');
            const linkSection = document.getElementById('link-input-section');
            const fileSection = document.getElementById('file-input-section');

            if (tabLink) {
                tabLink.addEventListener('click', () => {
                    if(linkSection) linkSection.classList.remove('hidden');
                    if (fileSection) fileSection.classList.add('hidden');
                    tabLink.classList.add('border-teal-500', 'text-teal-600');
                    tabLink.classList.remove('border-transparent', 'text-gray-500');
                    if (tabFile) {
                        tabFile.classList.add('border-transparent', 'text-gray-500');
                        tabFile.classList.remove('border-teal-500', 'text-teal-600');
                    }
                    if (itemTypeInput) itemTypeInput.value = 'link';
                });
            }

            if (tabFile) {
                tabFile.addEventListener('click', () => {
                    showAlert('Ù…ÙŠØ²Ø© Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ± ÙˆØªØªØ·Ù„Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯ Firebase Storage.');
                });
            }

            if (addItemForm) addItemForm.addEventListener('submit', handleItemFormSubmit);
        }

        function setupEditSectionModal() {
            editSectionModal = document.getElementById('edit-section-modal');
            if (!editSectionModal) return;

            const closeBtn = document.getElementById('close-edit-section-modal');
            const cancelBtn = document.getElementById('cancel-edit-section-modal');
            editSectionForm = document.getElementById('edit-section-form');
            editSectionTitleInput = document.getElementById('edit-section-title');
            editSectionIdInput = document.getElementById('edit-section-id');
            currentEditorsList = document.getElementById('current-editors-list');
            currentEditorsContainer = document.getElementById('current-editors-container');
            
            const editSectionVisibilityCheckbox = document.getElementById('edit-section-visibility'); 

            // (Ø¬Ø¯ÙŠØ¯) ØªÙ‡ÙŠØ¦Ø© Ù…Ù†ØªÙ‚ÙŠ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
            createIconPicker('edit-section-icon-picker', 'edit-section-icon');
            
             if (!sectionsContainer) return;
            sectionsContainer.addEventListener('click', async (e) => { 
                const editBtn = e.target.closest('.section-edit-btn');
                 const sectionEl = editBtn ? editBtn.closest('.column-wrapper') : null;
                 const canEdit = isUserAdmin || (sectionEl && sectionEl.dataset.canEdit === 'true');

                if (editBtn && canEdit) {
                    if (!sectionEl) return;
                    const sectionId = sectionEl.dataset.sectionId;
                    
                    const sectionData = await getSectionDataById(sectionId);
                    if (!sectionData) return;

                    const sectionTitle = sectionData.title || '';
                    const isVisible = sectionData.isVisible !== false; // Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù‡ÙŠ true
                    const sectionIcon = sectionData.icon || DEFAULT_ICON; // (Ø¬Ø¯ÙŠØ¯) Ø¬Ù„Ø¨ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©

                   if(editSectionTitleInput) editSectionTitleInput.value = sectionTitle;
                    if (editSectionIdInput) editSectionIdInput.value = sectionId;
                    if (editSectionVisibilityCheckbox) editSectionVisibilityCheckbox.checked = isVisible; 
                    
                    // (Ø¬Ø¯ÙŠØ¯) ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ø­Ø§Ù„ÙŠØ§Ù‹
                    setSelectedIcon('edit-section-icon-picker', 'edit-section-icon', sectionIcon);

                    await loadEditorsForSection(sectionId);

                    editSectionModal.classList.remove('hidden');
                }
            });


            const close = () => editSectionModal.classList.add('hidden');
            if (closeBtn) closeBtn.addEventListener('click', close);
            if (cancelBtn) cancelBtn.addEventListener('click', close);
            editSectionModal.addEventListener('click', (e) => (e.target === editSectionModal) && close());


           if (editSectionForm) editSectionForm.addEventListener('submit', handleEditSectionFormSubmit);

           if (currentEditorsList) {
               currentEditorsList.addEventListener('click', handleRemoveEditorClick);
           }
        }
function setupEditItemModal() {
            editItemModal = document.getElementById('edit-item-modal');
            if (!editItemModal) return;

            const closeBtn = document.getElementById('close-edit-item-modal');
            const cancelBtn = document.getElementById('cancel-edit-item-modal');
            editItemForm = document.getElementById('edit-item-form');
            editItemTitleInput = document.getElementById('edit-item-title');
            editItemLinkInput = document.getElementById('edit-item-link');
            editItemIdInput = document.getElementById('edit-item-id'); 
            editItemSectionIdInput = document.getElementById('edit-item-section-id');

             if (!sectionsContainer) return;
            sectionsContainer.addEventListener('click', (e) => {
                const editBtn = e.target.closest('.item-edit-btn-action'); 
                 const sectionEl = editBtn ? editBtn.closest('.column-wrapper') : null;
                 const canEdit = isUserAdmin || (sectionEl && sectionEl.dataset.canEdit === 'true');

                if (editBtn && canEdit) {
                    const itemEl = editBtn.closest('.item-card');
                    if (!itemEl || !sectionEl) return;

                    const popup = editBtn.closest('.item-action-popup');
                    if (popup) popup.classList.add('hidden');

                    const itemId = itemEl.dataset.itemId;
                    const sectionId = sectionEl.dataset.sectionId;
                    const linkElement = itemEl.querySelector('a');
                    const title = linkElement ? linkElement.textContent.trim() : '';
                    const link = linkElement ? linkElement.href : '';


                    if(editItemTitleInput) editItemTitleInput.value = title;
                    if(editItemLinkInput) editItemLinkInput.value = link;
                    if(editItemIdInput) editItemIdInput.value = itemId; 
                    if(editItemSectionIdInput) editItemSectionIdInput.value = sectionId;

                    editItemModal.classList.remove('hidden');
                }
            });


            const close = () => editItemModal.classList.add('hidden');
            if (closeBtn) closeBtn.addEventListener('click', close);
            if(cancelBtn) cancelBtn.addEventListener('click', close);
            editItemModal.addEventListener('click', (e) => (e.target === editItemModal) && close());


           if (editItemForm) editItemForm.addEventListener('submit', handleEditItemFormSubmit);
        }
        
        /**
         * (Ø¬Ø¯ÙŠØ¯) Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª
         */
        window.showItemActionsPopup = function(button) {
            const itemCard = button.closest('.item-card');
            const popup = itemCard ? itemCard.querySelector('.item-action-popup') : null;
            if (popup) {
                document.querySelectorAll('.item-action-popup:not(.hidden)').forEach(p => p.classList.add('hidden'));
                popup.classList.toggle('hidden');
            }
        }


        function setupAlertModal() {
            alertModal = document.getElementById('alert-modal');
            if (!alertModal) return;

            const alertModalContent = document.getElementById('alert-modal-content');
            const closeAlertModalBtn = document.getElementById('close-alert-modal');

            const close = () => {
                 if (alertModalContent) alertModalContent.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    alertModal.classList.add('hidden');
                }, 200);
            };

           if(closeAlertModalBtn) closeAlertModalBtn.addEventListener('click', close);
            alertModal.addEventListener('click', (e) => (e.target === alertModal) && close());
        }

        function setupChatWindow() {
            const chatToggle = document.getElementById('chat-toggle');
            chatWindow = document.getElementById('chat-window');
            closeChatBtn1 = document.getElementById('close-chat'); 
            closeChatBtn2 = document.getElementById('close-chat-2'); 
            chatBackBtn = document.getElementById('chat-back-btn');
            
            chatListView = document.getElementById('chat-list-view');
            chatMessageView = document.getElementById('chat-message-view');

            if (!chatToggle || !chatWindow || !closeChatBtn1 || !closeChatBtn2 || !chatBackBtn || !chatListView || !chatMessageView) {
                return;
            }

            chatToggle.addEventListener('click', () => {
                chatWindow.classList.toggle('hidden');
                if (!chatWindow.classList.contains('hidden')) {
                    chatListView.classList.remove('hidden');
                    chatMessageView.classList.add('hidden');
                }
            });

            const closeChat = () => chatWindow.classList.add('hidden');
            closeChatBtn1.addEventListener('click', closeChat);
            closeChatBtn2.addEventListener('click', closeChat);

            chatBackBtn.addEventListener('click', () => {
                chatListView.classList.remove('hidden');
                chatMessageView.classList.add('hidden');
                
                if (chatMessageListeners[chatCurrentChat.id]) {
                    chatMessageListeners[chatCurrentChat.id]();
                    delete chatMessageListeners[chatCurrentChat.id];
                }
                chatCurrentChat = { type: 'group', id: 'group' };
            });
        }


        function setupAdminManageModal() {
            adminManageModal = document.getElementById('admin-manage-modal');
            if (!adminManageModal) return;

            adminUsersList = document.getElementById('admin-users-list');
            const closeBtn = document.getElementById('close-admin-manage-modal');
            const adminManageBtn = document.getElementById('admin-manage-btn');

            if (adminManageBtn) {
                adminManageBtn.addEventListener('click', async () => {
                    if (!isUserAdmin) return;
                    await loadUsersForAdminModal(); 
                    adminManageModal.classList.remove('hidden');
                });
            }

            const close = () => adminManageModal.classList.add('hidden');
            if (closeBtn) closeBtn.addEventListener('click', close);
            adminManageModal.addEventListener('click', (e) => (e.target === adminManageModal) && close());

            if (adminUsersList) {
                adminUsersList.addEventListener('click', async (e) => {
                    const targetButton = e.target.closest('button');
                    const userIdToUpdate = targetButton ? targetButton.dataset.userId : null;
                    if (!userIdToUpdate) return;

                    const action = targetButton.dataset.roleAction || targetButton.dataset.action || targetButton.getAttribute('data-role-action');
                    await updateUserRole(userIdToUpdate, action);
                });
            }
        }
        
        function setupAdminPermsModal() {
            adminPermsModal = document.getElementById('admin-perms-modal');
            if (!adminPermsModal) return;

            adminPermsList = document.getElementById('admin-perms-list');
            const closeBtn = document.getElementById('close-admin-perms-modal');
            const adminPermsBtn = document.getElementById('admin-perms-btn');

            if (adminPermsBtn) {
                 adminPermsBtn.addEventListener('click', async () => {
                     if (!isUserAdmin) {
                         showAlert('Ù„Ø·Ù„Ø¨ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¥Ø¶Ø§ÙÙŠØ©ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ù†ØµØ©.');
                          return;
                     }
                     await loadPermissionRequests(); 
                     adminPermsModal.classList.remove('hidden');
                 });
            }

            const close = () => adminPermsModal.classList.add('hidden');
            if (closeBtn) closeBtn.addEventListener('click', close);
            adminPermsModal.addEventListener('click', (e) => (e.target === adminPermsModal) && close());

            if (adminPermsList) {
                adminPermsList.addEventListener('click', async (e) => {
                    const targetButton = e.target.closest('button');
                    if (!targetButton || !targetButton.dataset.requestId) return;

                    const requestId = targetButton.dataset.requestId;
                    const action = targetButton.dataset.action; 

                    await handlePermissionRequest(requestId, action);
                });
            }
        }
        
        /**
         * (Ø¬Ø¯ÙŠØ¯) ØªÙ‡ÙŠØ¦Ø© Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© (Ø§Ù„ØªØ±Ø³)
         */
        function setupAdminSettingsModal() {
            adminSettingsModal = document.getElementById('admin-settings-modal');
            if (!adminSettingsModal) return;
            
            const closeBtn = document.getElementById('close-admin-settings-modal');
            const adminSettingsBtn = document.getElementById('admin-settings-btn');
            
            const chatToggleSwitch = document.getElementById('setting-toggle-chat');
            const revokeEditorsBtn = document.getElementById('setting-revoke-editors');
            const revokeAdminsBtn = document.getElementById('setting-revoke-admins');
            
            if (adminSettingsBtn) {
                 adminSettingsBtn.addEventListener('click', () => {
                     if (!isUserAdmin) return;
                     
                     // Ù…Ø²Ø§Ù…Ù†Ø© Ø­Ø§Ù„Ø© Ø²Ø± Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù…Ø¹ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
                     if (chatToggleSwitch) {
                         chatToggleSwitch.checked = globalConfig.isChatEnabled;
                     }
                     
                     adminSettingsModal.classList.remove('hidden');
                 });
            }
            
            const close = () => adminSettingsModal.classList.add('hidden');
            if (closeBtn) closeBtn.addEventListener('click', close);
            adminSettingsModal.addEventListener('click', (e) => (e.target === adminSettingsModal) && close());

            // Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ù„Ø£Ø²Ø±Ø§Ø± Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ø§ÙØ°Ø©
            if (chatToggleSwitch) {
                chatToggleSwitch.addEventListener('change', handleToggleChatSetting);
            }
            if (revokeEditorsBtn) {
                revokeEditorsBtn.addEventListener('click', handleRevokeAllEditors);
            }
            if (revokeAdminsBtn) {
                revokeAdminsBtn.addEventListener('click', handleRevokeOtherAdmins);
            }
        }
        
        /**
         * (Ø¬Ø¯ÙŠØ¯) Ù…Ø¹Ø§Ù„Ø¬Ø© ØªÙØ¹ÙŠÙ„/ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
         */
        async function handleToggleChatSetting(e) {
            if (!isUserAdmin) return;
            const isEnabled = e.target.checked;
            
            try {
                const configRef = doc(db, configPath, 'appSettings');
                await setDoc(configRef, { isChatEnabled: isEnabled }, { merge: true });
                showAlert(isEnabled ? 'âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹.' : 'ğŸš« ØªÙ… ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹.');
            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©:", error);
                showAlert("âŒ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©.");
                // Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø²Ø± Ù„Ø­Ø§Ù„ØªÙ‡ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
                e.target.checked = !isEnabled;
            }
        }
        
        /**
         * (Ø¬Ø¯ÙŠØ¯) Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¥Ù„ØºØ§Ø¡ Ø¬Ù…ÙŠØ¹ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø­Ø±Ø±ÙŠÙ†
         */
        async function handleRevokeAllEditors() {
            if (!isUserAdmin) return;
            if (!confirm("âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø¥Ù„ØºØ§Ø¡ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ØªØ­Ø±ÙŠØ± Ù…Ù† (Ø¬Ù…ÙŠØ¹) Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¹Ù† (Ø¬Ù…ÙŠØ¹) Ø§Ù„Ø£Ù‚Ø³Ø§Ù…ØŸ")) return;
            
            showAlert("Ø¬Ø§Ø±ÙŠ Ø¥Ù„ØºØ§Ø¡ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø­Ø±Ø±ÙŠÙ†... Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ Ù‡Ø°Ø§ Ø¨Ø¹Ø¶ Ø§Ù„ÙˆÙ‚Øª.");
            
            try {
                const batch = writeBatch(db);
                const sectionsQuery = query(sectionsCollectionRef, where("editors", "!=", []));
                const sectionsSnapshot = await getDocs(sectionsQuery);
                
                if (sectionsSnapshot.empty) {
                     showAlert("â„¹ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‚Ø³Ø§Ù… Ù„Ø¯ÙŠÙ‡Ø§ ØµÙ„Ø§Ø­ÙŠØ§Øª Ù…Ø­Ø±Ø±ÙŠÙ† Ù„Ø¥Ù„ØºØ§Ø¦Ù‡Ø§.");
                     return;
                }
                
                sectionsSnapshot.forEach(sectionDoc => {
                    const sectionRef = doc(db, sectionsPath, sectionDoc.id);
                    batch.update(sectionRef, { editors: [] });
                });
                
                await batch.commit();
                showAlert("âœ… ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø¬Ù…ÙŠØ¹ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ØªØ­Ø±ÙŠØ± Ù…Ù† ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­.");
                
            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø¥Ù„ØºØ§Ø¡ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø­Ø±Ø±ÙŠÙ†:", error);
                showAlert("âŒ ÙØ´Ù„ Ø¥Ù„ØºØ§Ø¡ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø­Ø±Ø±ÙŠÙ†.");
            }
        }
        
        /**
         * (Ø¬Ø¯ÙŠØ¯) Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¥Ù„ØºØ§Ø¡ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø¯Ø±Ø§Ø¡ Ø§Ù„Ø¢Ø®Ø±ÙŠÙ†
         */
        async function handleRevokeOtherAdmins() {
            if (!isUserAdmin || !userId) return;
            if (!confirm("âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø¥Ù„ØºØ§Ø¡ ØµÙ„Ø§Ø­ÙŠØ§Øª (Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¯Ø±Ø§Ø¡ Ø§Ù„Ø¢Ø®Ø±ÙŠÙ†) ÙˆØªØ­ÙˆÙŠÙ„Ù‡Ù… Ø¥Ù„Ù‰ Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ†ØŸ (ØµÙ„Ø§Ø­ÙŠØ§ØªÙƒ Ø³ØªØ¨Ù‚Ù‰).")) return;
            
            showAlert("Ø¬Ø§Ø±ÙŠ Ø¥Ù„ØºØ§Ø¡ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø¯Ø±Ø§Ø¡ Ø§Ù„Ø¢Ø®Ø±ÙŠÙ†...");
            
            try {
                const batch = writeBatch(db);
                
                // Ø§Ù„Ø­Ù„ Ø§Ù„Ø¨Ø¯ÙŠÙ„: Ø¬Ù„Ø¨ ÙƒÙ„ Ø§Ù„Ù…Ø¯Ø±Ø§Ø¡ Ø«Ù… ÙÙ„ØªØ±ØªÙ‡Ù…
                const allAdminsQuery = query(usersCollectionRef, where("role", "==", "admin"));
                const adminsSnapshot = await getDocs(allAdminsQuery);
                
                let demotedCount = 0;
                adminsSnapshot.forEach(userDoc => {
                    if (userDoc.id !== userId) { // Ø§Ù„ÙÙ„ØªØ±Ø© Ù‡Ù†Ø§
                        const userRef = doc(db, usersPath, userDoc.id);
                        batch.update(userRef, { role: 'viewer' });
                        demotedCount++;
                    }
                });
                
                if (demotedCount === 0) {
                    showAlert("â„¹ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¯Ø±Ø§Ø¡ Ø¢Ø®Ø±ÙˆÙ† Ù„Ø¥Ù„ØºØ§Ø¡ ØµÙ„Ø§Ø­ÙŠØ§ØªÙ‡Ù….");
                    return;
                }
                
                await batch.commit();
                showAlert(`âœ… ØªÙ… Ø¥Ù„ØºØ§Ø¡ ØµÙ„Ø§Ø­ÙŠØ§Øª ${demotedCount} Ù…Ø¯ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­.`);
                
            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø¥Ù„ØºØ§Ø¡ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø¯Ø±Ø§Ø¡:", error);
                showAlert("âŒ ÙØ´Ù„ Ø¥Ù„ØºØ§Ø¡ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø¯Ø±Ø§Ø¡. Ù‚Ø¯ ØªØ­ØªØ§Ø¬ Ù„Ø¥Ù†Ø´Ø§Ø¡ ÙÙ‡Ø±Ø³ Ù…Ø±ÙƒØ¨ ÙÙŠ Firestore.");
            }
        }


        /**
         * ØªØ­Ù…ÙŠÙ„ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙŠ Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†
         */
        async function loadUsersForAdminModal() {
            if (!adminUsersList || !usersCollectionRef) return;
            adminUsersList.innerHTML = '<li>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†...</li>';

            try {
                const querySnapshot = await getDocs(usersCollectionRef);
                adminUsersList.innerHTML = '';

                if (querySnapshot.empty) {
                    adminUsersList.innerHTML = '<li>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ù…Ø³Ø¬Ù„ÙˆÙ† Ø¨Ø¹Ø¯.</li>';
                    return;
                }

                querySnapshot.forEach(docSnap => {
                    const user = docSnap.data();
                    const docId = docSnap.id;
                    const userName = user.name || '[Ø§Ø³Ù… ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ]';
                    const userRole = user.role || 'viewer';

                    let roleLabel = 'ÙØ¹Ù‘Ø§Ù„ ğŸŸ¢';
                    let roleColor = 'text-green-600';
                    if (userRole === 'admin') { roleLabel = 'Ù…Ø¯ÙŠØ± ğŸ”µ'; roleColor = 'text-blue-600'; }
                    if (userRole === 'editor') { roleLabel = 'Ù…Ø­Ø±Ø± ğŸŸ '; roleColor = 'text-orange-600'; }
                    if (userRole === 'suspended') { roleLabel = 'Ù…ÙˆÙ‚ÙˆÙ ğŸ”´'; roleColor = 'text-red-600'; }

                    let actionsHTML = '';
                    if (docId === userId) {
                        actionsHTML = '<span class="text-xs text-gray-400">(Ø£Ù†Øª)</span>';
                    } else if (userRole === 'viewer' || userRole === 'editor') {
                        actionsHTML = `
                            <button data-user-id="${docId}" data-role-action="promote" class="text-xs bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-2 rounded">ØªØ±Ù‚ÙŠØ© Ù„Ù…Ø¯ÙŠØ±</button>
                            <button data-user-id="${docId}" data-role-action="suspend" class="text-xs bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1 px-2 rounded">Ø¥ÙŠÙ‚Ø§Ù</button>
                            <button data-user-id="${docId}" data-role-action="remove" class="text-xs bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-2 rounded">Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ</button>
                        `;
} else if (userRole === 'admin') {
                        
                        // (ØªØ¹Ø¯ÙŠÙ„) Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¯ÙŠØ± Ù‡Ùˆ Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
                        if (user.email === DEFAULT_ADMIN_EMAIL) {
                            actionsHTML = '<span class="text-xs text-gray-400 font-bold">(Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ)</span>';
                        } else {
                            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø¯ÙŠØ±Ø§Ù‹ Ø¹Ø§Ø¯ÙŠØ§Ù‹ØŒ Ø£Ø¸Ù‡Ø± Ø§Ù„Ø£Ø²Ø±Ø§Ø±
                            actionsHTML = `
                                <button data-user-id="${docId}" data-role-action="demote" class="text-xs bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-2 rounded">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…Ø¯ÙŠØ±</button>
                                <button data-user-id="${docId}" data-role-action="suspend" class="text-xs bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1 px-2 rounded">Ø¥ÙŠÙ‚Ø§Ù</button>
                                <button data-user-id="${docId}" data-role-action="remove" class="text-xs bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-2 rounded">Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ</button>
                            `;
                        }

                    } else if (userRole === 'suspended') {                        actionsHTML = `
                            <button data-user-id="${docId}" data-role-action="reactivate" class="text-xs bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-2 rounded">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„</button>
                            <button data-user-id="${docId}" data-role-action="remove" class="text-xs bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-2 rounded">Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ</button>
                        `;
                    }
const li = document.createElement('li');
                    li.className = 'py-3 sm:py-4 border-b last:border-b-0';
                    li.innerHTML = `
                        <div class="grid grid-cols-12 items-center gap-3">
                            <div class="col-span-5">
                                <p class="text-sm font-medium text-gray-900 truncate">${userName}</p>
                                <p class="text-xs text-gray-500 truncate">UID: ${docId.substring(0, 10)}...</p>
                            </div>
                            <div class="col-span-3">
                                <span class="text-sm font-semibold ${roleColor}">${roleLabel}</span>
                            </div>
                            <div class="col-span-4 inline-flex items-center text-base font-semibold text-gray-900 gap-2">
                                ${actionsHTML}
                            </div>
                        </div>
                    `;
                    adminUsersList.appendChild(li);
                });

            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©:", error);
                adminUsersList.innerHTML = '<li>Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†.</li>';
            }
        }


        /**
         * ØªØ­Ø¯ÙŠØ« Ø¯ÙˆØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firestore
         */
        async function updateUserRole(userIdToUpdate, action) {
            if (!isUserAdmin || !db || !usersPath) return;

            try {
                const userRef = doc(db, usersPath, userIdToUpdate);
                const userSnap = await getDoc(userRef);
                if (!userSnap.exists()) {
                    showAlert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….");
                    return;
                }
                const userData = userSnap.data();
                const userNameForEditors = userData.name || ''; 
// --- (Ø¬Ø¯ÙŠØ¯) Ø¥Ø¶Ø§ÙØ© Ø­Ù…Ø§ÙŠØ© Ù„Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ ---
                // ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù Ù‡Ùˆ Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
                if (userData.email === DEFAULT_ADMIN_EMAIL && (action === 'demote' || action === 'suspend' || action === 'remove')) {
                    showAlert("âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø£Ùˆ Ø­Ø°Ù Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù„Ù„Ù…Ù†ØµØ©.");
                    return; // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªÙ†ÙÙŠØ° ÙÙˆØ±Ø§Ù‹
                }
                // --- Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¥Ø¶Ø§ÙØ© ---
                if (action === 'promote') {
                    await updateDoc(userRef, { role: 'admin' });
                    showAlert("âœ… ØªÙ…Øª ØªØ±Ù‚ÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ Ù…Ø¯ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­.");
                } else if (action === 'demote') {
                    await updateDoc(userRef, { role: 'viewer' });
                    showAlert("ğŸ”„ ØªÙ… Ø¥Ù„ØºØ§Ø¡ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø¯ÙŠØ± Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….");
                } else if (action === 'suspend') {
                    await updateDoc(userRef, { role: 'suspended' });
                    showAlert("ğŸš« ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¤Ù‚ØªÙ‹Ø§.");
                } else if (action === 'reactivate') {
                    await updateDoc(userRef, { role: 'viewer' });
                    showAlert("âœ… ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….");
                } else if (action === 'remove') {
                    if (!confirm("âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§ ÙˆØ¬Ù…ÙŠØ¹ ØµÙ„Ø§Ø­ÙŠØ§ØªÙ‡ØŸ")) return;

                    const sectionsSnapshot = await getDocs(sectionsCollectionRef);
                    for (const section of sectionsSnapshot.docs) {
                        const sectionRef = doc(db, sectionsPath, section.id);
                        await updateDoc(sectionRef, {
                            editors: arrayRemove(userNameForEditors)
                        });
                    }

                    await deleteDoc(userRef);
                    showAlert("ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ¬Ù…ÙŠØ¹ ØµÙ„Ø§Ø­ÙŠØ§ØªÙ‡ Ø¨Ù†Ø¬Ø§Ø­.");
                }
                
                // (Ù…Ù„Ø§Ø­Ø¸Ø©: Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ÙØ¯Ø§Ø± ÙÙˆØ±Ø§Ù‹ Ø¨ÙØ¶Ù„ 
                // Ø§Ù„Ù…Ø³ØªÙ…Ø¹ Ø§Ù„ÙÙˆØ±ÙŠ Ø§Ù„Ø°ÙŠ Ø£Ø¶ÙÙ†Ø§Ù‡ ÙÙŠ listenToUserRoleChanges)
                
                // Ø³Ù†Ù‚ÙˆÙ… Ø¨ØªØ­Ø¯ÙŠØ« Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹
                await loadUsersForAdminModal();
            } catch (error) {
                console.error("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªÙ†ÙÙŠØ° Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡:", error);
                showAlert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªÙ†ÙÙŠØ° Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….");
            }
        }


          /**
           * Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø§Ø±Ø©
           */
        function listenForPermissionRequests() {
            if (!permissionRequestsCollectionRef || !permsBtnBadge) return;

            const q = query(permissionRequestsCollectionRef, where("status", "==", "pending"));

            if (permissionRequestsUnsubscribe) {
               permissionRequestsUnsubscribe();
            }

            permissionRequestsUnsubscribe = onSnapshot(q, (snapshot) => {
                const pendingCount = snapshot.size;
                if (pendingCount > 0) {
                    permsBtnBadge.textContent = pendingCount;
                    permsBtnBadge.classList.remove('hidden');
                } else {
                    permsBtnBadge.classList.add('hidden');
                }
            }, (error) => {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª:", error);
                permsBtnBadge.classList.add('hidden');
            });
        }


          /**
           * ØªØ­Ù…ÙŠÙ„ ÙˆØ¹Ø±Ø¶ Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© ÙÙŠ Ø§Ù„Ù†Ø§ÙØ°Ø©
           */
        async function loadPermissionRequests() {
            if (!adminPermsList || !permissionRequestsCollectionRef) return;
            adminPermsList.innerHTML = '<li>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</li>';

            try {
                const q = query(permissionRequestsCollectionRef, where("status", "==", "pending"));
                const querySnapshot = await getDocs(q);
                adminPermsList.innerHTML = '';

                if (querySnapshot.empty) {
                    adminPermsList.innerHTML = '<li>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª ØµÙ„Ø§Ø­ÙŠØ§Øª Ù…Ø¹Ù„Ù‚Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</li>';
                    return;
                }

                querySnapshot.forEach(doc => {
                    const request = doc.data();
                    const requestId = doc.id;
                    const requesterName = request.requesterName || '[Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ]';
                    const sectionTitle = request.sectionTitle || '[Ù‚Ø³Ù… ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ]';

                    const li = document.createElement('li');
                    li.className = 'py-3 sm:py-4 border-b last:border-b-0';
                    li.innerHTML = `
                        <div class="flex items-center justify-between space-x-4 gap-3">
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium text-gray-900 truncate"><b>${requesterName}</b> ÙŠØ·Ù„Ø¨ Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ù‚Ø³Ù…:</p>
                                <p class="text-sm text-gray-500 truncate">${sectionTitle}</p>
                            </div>
                            <div class="inline-flex items-center text-base font-semibold text-gray-900 gap-2">
                                <button data-request-id="${requestId}" data-action="approve" class="text-xs bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-2 rounded">Ù…ÙˆØ§ÙÙ‚Ø©</button>
                                <button data-request-id="${requestId}" data-action="reject" class="text-xs bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-2 rounded">Ø±ÙØ¶</button>
                            </div>
                        </div>
                    `;
                    adminPermsList.appendChild(li);
                });

            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª:", error);
                adminPermsList.innerHTML = '<li>Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª.</li>';
            }
        }

        /**
         * Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø£Ùˆ Ø§Ù„Ø±ÙØ¶ Ù„Ø·Ù„Ø¨ ØµÙ„Ø§Ø­ÙŠØ©
         */
        async function handlePermissionRequest(requestId, action) {
             if (!isUserAdmin || !db || !permissionRequestsPath || !sectionsPath) return;

             const requestRef = doc(db, permissionRequestsPath, requestId);
             const newStatus = (action === 'approve') ? 'approved' : 'rejected';

             try {
                 const requestSnap = await getDoc(requestRef);
                 if (!requestSnap.exists()) {
                     showAlert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨.");
                     return;
                 }
                 const requestData = requestSnap.data();

                 await updateDoc(requestRef, { status: newStatus });

                 if (action === 'approve' && requestData.sectionId && requestData.requesterName) {
                     const sectionRef = doc(db, sectionsPath, requestData.sectionId);
                     await updateDoc(sectionRef, {
                         editors: arrayUnion(requestData.requesterName) 
                     });
                     showAlert(`ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© ÙˆÙ…Ù†Ø­ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ØªØ­Ø±ÙŠØ± Ù„Ù€ ${requestData.requesterName} Ø¹Ù„Ù‰ Ù‚Ø³Ù… "${requestData.sectionTitle}".`);
                 } else if (action === 'reject') {
                     showAlert(`ØªÙ… Ø±ÙØ¶ Ø·Ù„Ø¨ ${requestData.requesterName} Ù„Ù„ØªØ­ÙƒÙ… ÙÙŠ Ù‚Ø³Ù… "${requestData.sectionTitle}".`);
                 }

                 await loadPermissionRequests(); 

             } catch (error) {
                 console.error(`Ø®Ø·Ø£ ÙÙŠ ${action === 'approve' ? 'Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰' : 'Ø±ÙØ¶'} Ø§Ù„Ø·Ù„Ø¨:`, error);
                 showAlert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨.");
             }
        }

          /**
           * Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ ØªØ­ÙƒÙ… ÙÙŠ Ù‚Ø³Ù…
           */
        async function requestSectionControl(sectionId, sectionTitle) {
            if (!currentUserName || !permissionRequestsCollectionRef) return;

            try {
                const q = query(permissionRequestsCollectionRef,
                                 where("requesterName", "==", currentUserName),
                                 where("sectionId", "==", sectionId),
                                 where("status", "==", "pending"));
                const existingRequests = await getDocs(q);

                if (!existingRequests.empty) {
                    showAlert("Ù„Ù‚Ø¯ Ù‚Ù…Øª Ø¨Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… ÙˆÙ‡Ùˆ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©.");
                    return;
                }

                await addDoc(permissionRequestsCollectionRef, {
                    requesterName: currentUserName,
                    sectionId: sectionId,
                    sectionTitle: sectionTitle,
                    status: 'pending',
                    timestamp: serverTimestamp()
                });
                showAlert(`ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ Ù„Ù„ØªØ­ÙƒÙ… ÙÙŠ Ù‚Ø³Ù… "${sectionTitle}". Ø³ÙŠÙ‚ÙˆÙ… Ø§Ù„Ù…Ø¯ÙŠØ± Ø¨Ù…Ø±Ø§Ø¬Ø¹ØªÙ‡.`);

            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªØ­ÙƒÙ…:", error);
                showAlert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªØ­ÙƒÙ….");
            }
        }
/**
         * =============================================
         * Ù…Ù†Ø·Ù‚ Firebase (CRUD Ù„Ù„Ø£Ù‚Ø³Ø§Ù… ÙˆØ§Ù„Ø¹Ù†Ø§ØµØ±)
         * =============================================
         */

        /**
         * (Create) Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… Ø¬Ø¯ÙŠØ¯
         */
        async function handleSectionFormSubmit(e) {
            e.preventDefault();
             const titleInput = document.getElementById('section-title');
             const visibilityCheckbox = document.getElementById('section-visibility'); 
             const iconInput = document.getElementById('section-icon'); // (Ø¬Ø¯ÙŠØ¯)
             
            if (!titleInput) return;
            const newTitle = titleInput.value.trim();
            const isVisible = visibilityCheckbox ? visibilityCheckbox.checked : true; 
            const newIcon = iconInput ? iconInput.value : DEFAULT_ICON; // (Ø¬Ø¯ÙŠØ¯)
            
            // (Ø¬Ø¯ÙŠØ¯) Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙƒØªØ±ØªÙŠØ¨
            const sectionsSnapshot = await getDocs(sectionsCollectionRef);
            const newOrder = sectionsSnapshot.size;

            if (!newTitle) return;

            try {
                 if (!sectionsCollectionRef) {
                     showAlert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø³Ù….");
                      return;
                 }
                await addDoc(sectionsCollectionRef, {
                    title: newTitle,
                    icon: newIcon, // (Ø¬Ø¯ÙŠØ¯) Ø­ÙØ¸ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©
                    items: [],
                    editors: [],
                    isVisible: isVisible, 
                    order: newOrder // (Ø¬Ø¯ÙŠØ¯) Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯
                });
                const closeButton = document.getElementById('close-section-modal');
                if (closeButton) closeButton.click();
            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø³Ù… (ØªØ£ÙƒØ¯ Ù…Ù† Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø£Ù…Ø§Ù†):", error);
                showAlert("âŒ ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø³Ù…. (ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‚ÙˆØ§Ø¹Ø¯ Ø£Ù…Ø§Ù† Firestore).");
            }
        }
/**
         * (Read) Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ÙˆØ§Ù„Ø¹Ù†Ø§ØµØ±
         */
        function listenForSections() {
             if (!sectionsCollectionRef) {
                 if (sectionsContainer) sectionsContainer.innerHTML = `<p class="text-red-500 text-center col-span-3">Ø®Ø·Ø£ ÙØ§Ø¯Ø­: Ù„Ù… ÙŠØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø§ØªØµØ§Ù„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù….</p>`;
                 return;
             }
            // (ØªØ¹Ø¯ÙŠÙ„) Ø¬Ù„Ø¨ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ù…Ø±ØªØ¨Ø© Ø­Ø³Ø¨ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø«Ø§Ù†ÙŠ
            const sectionsQuery = query(sectionsCollectionRef, orderBy("order"));

            onSnapshot(sectionsQuery, (snapshot) => {
                if (sectionsContainer) sectionsContainer.innerHTML = '';
                
                if(snapshot.empty) {
                    if (sectionsContainer) sectionsContainer.innerHTML = `<p class="text-gray-500 text-center col-span-3">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‚Ø³Ø§Ù… Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†. ${isUserAdmin ? 'Ù‚Ù… Ø¨Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„Ø²Ø± Ø§Ù„Ø¹Ù„ÙˆÙŠ.' : 'ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ÙŠÙ‚ÙˆÙ… Ø§Ù„Ù…Ø¯ÙŠØ± Ø¨Ø¥Ø¶Ø§ÙØ© Ù…Ø­ØªÙˆÙ‰.'}</p>`;
                }

                snapshot.docs.forEach((doc) => {
                    renderSection(doc);
                });
                
                // (Ø¬Ø¯ÙŠØ¯) ØªÙØ¹ÙŠÙ„ Ø®Ø§ØµÙŠØ© Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª Ù„Ù„Ø¹Ù†Ø§ØµØ±
                setupItemSorting();
                // (Ø¬Ø¯ÙŠØ¯) ØªÙØ¹ÙŠÙ„ Ø®Ø§ØµÙŠØ© Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª Ù„Ù„Ø£Ù‚Ø³Ø§Ù… (Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø«Ø§Ù†ÙŠ)
                setupSectionSorting(isUserAdmin);

            }, (error) => {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… (ØªØ£ÙƒØ¯ Ù…Ù† Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø£Ù…Ø§Ù†):", error);
                if (sectionsContainer) sectionsContainer.innerHTML = `<p class="text-red-500 text-center col-span-3">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ù‚ÙˆØ§Ø¹Ø¯ Ø£Ù…Ø§Ù† Firestore ØªØ³Ù…Ø­ Ø¨Ù‚Ø±Ø§Ø¡Ø© Ù…Ø¬Ù…ÙˆØ¹Ø© 'sections'.</p>`;
            });
        }
        
        /**
         * (Ø¬Ø¯ÙŠØ¯) Ø¥Ø¹Ø¯Ø§Ø¯ Ø®Ø§ØµÙŠØ© Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª Ø¯Ø§Ø®Ù„ ÙƒÙ„ Ù‚Ø³Ù… (Ù„Ù„Ø¹Ù†Ø§ØµØ±)
         */
        function setupItemSorting() {
            const lists = sectionsContainer ? sectionsContainer.querySelectorAll('.column-list') : [];
            lists.forEach(list => {
                const sectionEl = list.closest('.column-wrapper');
                const sectionId = sectionEl ? sectionEl.dataset.sectionId : null;
                const canEdit = sectionEl ? sectionEl.dataset.canEdit === 'true' : false;

                if (list && sectionId && canEdit) {
                    Sortable.create(list, {
                        group: 'shared', 
                        animation: 150,
                        handle: '.drag-handle', 
                        filter: '.add-item-btn', 
                        onEnd: async function (evt) {
                            const newSectionEl = evt.to.closest('.column-wrapper');
                            const oldSectionId = sectionId;
                            const newSectionId = newSectionEl ? newSectionEl.dataset.sectionId : null;

                            if (!newSectionId) return; 

                            const oldIndex = evt.oldIndex;
                            const newIndex = evt.newIndex;
                            const itemId = evt.item.dataset.itemId;
                            
                            const currentSectionData = await getSectionDataById(oldSectionId);
                            if (!currentSectionData) return;
                            
                            let items = currentSectionData.items || [];
                            const movedItem = items.find(item => item.id === itemId);
                            if (!movedItem) return;
                            
                            if (oldSectionId !== newSectionId) {
                                
                                items = items.filter(item => item.id !== itemId);
                                await updateDoc(doc(db, sectionsPath, oldSectionId), { items: items });

                                const newSectionData = await getSectionDataById(newSectionId);
                                if (!newSectionData) return;
                                
                                let newItems = newSectionData.items || [];
                                newItems.splice(newIndex, 0, movedItem); 
                                await updateDoc(doc(db, sectionsPath, newSectionId), { items: newItems });
                                
                            } 
                            else {
                                items.splice(oldIndex, 1);
                                items.splice(newIndex, 0, movedItem);

                                await updateDoc(doc(db, sectionsPath, sectionId), { items: items });
                            }
                        }
                    });
                } else if (list) {
                    Sortable.create(list, {
                        disabled: true
                    });
                }
            });
        }

        /**
         * (Ø¬Ø¯ÙŠØ¯) Ø¥Ø¹Ø¯Ø§Ø¯ Ø®Ø§ØµÙŠØ© Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª Ù„Ù„Ø£Ù‚Ø³Ø§Ù… (Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„) - Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø«Ø§Ù†ÙŠ
         */
        function setupSectionSorting(isAdmin) {
            if (sectionSortingInstance) {
                sectionSortingInstance.destroy();
                sectionSortingInstance = null;
            }
            
            if (sectionsContainer && isAdmin) {
                // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø³Ø­Ø¨ Ù„Ù„Ù…Ø¯ÙŠØ±
                sectionSortingInstance = Sortable.create(sectionsContainer, {
                    animation: 150,
                    handle: '.section-drag-handle', // Ù…Ù‚Ø¨Ø¶ Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ø°ÙŠ Ø£Ø¶ÙÙ†Ø§Ù‡
                    onEnd: handleSectionSortEnd // Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙŠ Ø³ØªÙ†ÙØ° Ø¹Ù†Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø³Ø­Ø¨
                });
            } else if (sectionsContainer) {
                // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø³Ø­Ø¨ Ù„ØºÙŠØ± Ø§Ù„Ù…Ø¯ÙŠØ±ÙŠÙ†
                sectionSortingInstance = Sortable.create(sectionsContainer, {
                    disabled: true
                });
            }
        }

        /**
         * (Ø¬Ø¯ÙŠØ¯) Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù†ØªÙ‡Ø§Ø¡ Ø³Ø­Ø¨ ÙˆØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… - Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø«Ø§Ù†ÙŠ
         */
        async function handleSectionSortEnd(evt) {
            if (!sectionsContainer || !isUserAdmin) return;

            // Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„Ù€ DOM
            const sectionElements = sectionsContainer.querySelectorAll('.column-wrapper');
            const batch = writeBatch(db);

            try {
                // ØªØ­Ø¯ÙŠØ« Ø­Ù‚Ù„ 'order' Ù„ÙƒÙ„ Ù‚Ø³Ù… Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ØªØ±ØªÙŠØ¨Ù‡ Ø§Ù„Ø¬Ø¯ÙŠØ¯
                sectionElements.forEach((sectionEl, index) => {
                    const sectionId = sectionEl.dataset.sectionId;
                    if (sectionId) {
                        const sectionRef = doc(db, sectionsPath, sectionId);
                        batch.update(sectionRef, { order: index });
                    }
                });

                // ØªÙ†ÙÙŠØ° Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©
                await batch.commit();
                
            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…:", error);
                showAlert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ù‚Ø³Ø§Ù….");
                // Ù„Ø§ Ø¯Ø§Ø¹ÙŠ Ù„Ù„Ù‚Ù„Ù‚ØŒ Ù…Ø³ØªÙ…Ø¹ onSnapshot Ø³ÙŠÙ‚ÙˆÙ… Ø¨Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
                // Ø¥Ù„Ù‰ ØªØ±ØªÙŠØ¨Ù‡Ø§ Ø§Ù„Ù‚Ø¯ÙŠÙ… (Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±) Ø¥Ø°Ø§ ÙØ´Ù„Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
            }
        }


        /**
         * (Update) Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù‚Ø³Ù… ÙˆØ­Ø§Ù„Ø© Ø§Ù„Ø±Ø¤ÙŠØ© ÙˆØ§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©
         */
        async function handleEditSectionFormSubmit(e) {
            e.preventDefault();
            const newTitle = editSectionTitleInput ? editSectionTitleInput.value.trim() : '';
            const sectionId = editSectionIdInput ? editSectionIdInput.value : '';
            const editSectionVisibilityCheckbox = document.getElementById('edit-section-visibility'); 
            const newVisibility = editSectionVisibilityCheckbox ? editSectionVisibilityCheckbox.checked : true;
            const newIcon = document.getElementById('edit-section-icon')?.value || DEFAULT_ICON; // (Ø¬Ø¯ÙŠØ¯)

            if (!newTitle || !sectionId) return;

            try {
                 if (!db || !sectionsPath) {
                     showAlert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø³Ù….");
                      return;
                 }
                const sectionRef = doc(db, sectionsPath, sectionId);
                await updateDoc(sectionRef, {
                    title: newTitle,
                    isVisible: newVisibility,
                    icon: newIcon // (Ø¬Ø¯ÙŠØ¯) ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©
                });
                if(editSectionModal) editSectionModal.classList.add('hidden');
            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø³Ù… (ØªØ£ÙƒØ¯ Ù…Ù† Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø£Ù…Ø§Ù†):", error);
                showAlert("âŒ ÙØ´Ù„ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø³Ù…. (ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‚ÙˆØ§Ø¹Ø¯ Ø£Ù…Ø§Ù† Firestore).");
            }
        }
/**
         * ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø±Ø±ÙŠÙ† Ù„Ù„Ù‚Ø³Ù… ÙÙŠ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
         */
        async function loadEditorsForSection(sectionId) {
            if (!currentEditorsList || !currentEditorsContainer) return;

            if (!isUserAdmin) {
                currentEditorsContainer.classList.add('hidden');
                return;
            }
            currentEditorsContainer.classList.remove('hidden');
            currentEditorsList.innerHTML = '<li>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø±Ø±ÙŠÙ†...</li>';

            const sectionData = await getSectionDataById(sectionId); 

            if (!sectionData || !sectionData.editors || sectionData.editors.length === 0) {
                currentEditorsList.innerHTML = '<li>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­Ø±Ø±ÙˆÙ† Ø¥Ø¶Ø§ÙÙŠÙˆÙ† Ù„Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù….</li>';
                return;
            }

            currentEditorsList.innerHTML = '';
            sectionData.editors.forEach(editorName => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center py-2 last:border-b-0';
                li.innerHTML = `
                    <span class="text-sm text-gray-800">${editorName}</span>
                    <button type="button" data-editor-name="${editorName}" data-section-id="${sectionId}" class="remove-editor-btn text-xs bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-2 rounded">
                        Ø¥Ø²Ø§Ù„Ø©
                    </button>
                `;
                currentEditorsList.appendChild(li);
            });
        }

        /**
         * Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± Ø¥Ø²Ø§Ù„Ø© Ù…Ø­Ø±Ø±
         */
        async function handleRemoveEditorClick(e) {
            const removeBtn = e.target.closest('.remove-editor-btn');
            if (!removeBtn || !isUserAdmin) return;

            const editorName = removeBtn.dataset.editorName;
            const sectionId = removeBtn.dataset.sectionId;

            if (!editorName || !sectionId) return;

            if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø¥Ø²Ø§Ù„Ø© ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø­Ø±Ø± "${editorName}" Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…ØŸ`)) return;

            try {
                const sectionRef = doc(db, sectionsPath, sectionId);
                await updateDoc(sectionRef, {
                    editors: arrayRemove(editorName)
                });

                showAlert(`ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© ØµÙ„Ø§Ø­ÙŠØ§Øª "${editorName}" Ø¨Ù†Ø¬Ø§Ø­.`);
                await loadEditorsForSection(sectionId); 

            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ø±Ø± (ØªØ£ÙƒØ¯ Ù…Ù† Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø£Ù…Ø§Ù†):", error);
                showAlert("âŒ ÙØ´Ù„ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ø±Ø±. (ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‚ÙˆØ§Ø¹Ø¯ Ø£Ù…Ø§Ù† Firestore).");
            }
        }


        /**
         * (Create) Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ± Ø¬Ø¯ÙŠØ¯ (Ø±Ø§Ø¨Ø·) Ø¥Ù„Ù‰ Ù‚Ø³Ù…
         */
        async function handleItemFormSubmit(e) {
            e.preventDefault();

            const titleInput = document.getElementById('item-title');
            const title = titleInput ? titleInput.value.trim() : '';
            const sectionId = columnIdInput ? columnIdInput.value : '';
            const itemType = itemTypeInput ? itemTypeInput.value : 'link';

            if (!title || !sectionId) {
                showAlert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ù†ÙˆØ§Ù† Ù„Ù„Ø¹Ù†ØµØ±.");
                return;
            }

            let newItemData = {
                id: crypto.randomUUID(),
                title: title,
                type: itemType
            };

            if (itemType === 'link') {
                const linkInput = document.getElementById('item-link');
                const link = linkInput ? linkInput.value.trim() : '';
                if (!link) {
                    showAlert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ø§Ø¨Ø·.");
                    return;
                }
                newItemData.url = link;
            } else if (itemType === 'file') {
                showAlert("Ù…ÙŠØ²Ø© Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±.");
                return;
            }


            try {
                 if (!sectionsCollectionRef) {
                     showAlert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù†ØµØ±.");
                      return;
                 }
                const sectionRef = doc(db, sectionsPath, sectionId);
                await updateDoc(sectionRef, {
                    items: arrayUnion(newItemData)
                });
                const closeButton = document.getElementById('close-modal');
                if (closeButton) closeButton.click();
            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù†ØµØ± (ØªØ£ÙƒØ¯ Ù…Ù† Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø£Ù…Ø§Ù†):", error);
                showAlert("âŒ ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù†ØµØ±. (ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‚ÙˆØ§Ø¹Ø¯ Ø£Ù…Ø§Ù† Firestore).");
            }
        }
/**
         * (Update) Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù†ØµØ±
         */
        async function handleEditItemFormSubmit(e) {
            e.preventDefault();
            const sectionId = editItemSectionIdInput ? editItemSectionIdInput.value : '';
            const itemId = editItemIdInput ? editItemIdInput.value : '';
            const newTitle = editItemTitleInput ? editItemTitleInput.value.trim() : '';
            const newLink = editItemLinkInput ? editItemLinkInput.value.trim() : '';

            if (!sectionId || !itemId || !newTitle || !newLink) return;

            try {
                 if (!db || !sectionsPath) {
                     showAlert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù†ØµØ±.");
                      return;
                 }
                const sectionRef = doc(db, sectionsPath, sectionId);
                const sectionSnap = await getDoc(sectionRef);

                if (sectionSnap.exists()) {
                    let items = sectionSnap.data().items || []; 

                    const updatedItems = items.map(item => {
                        if (item.id === itemId) {
                            return { ...item, title: newTitle, url: newLink };
                        }
                        return item;
                    });

                    await updateDoc(sectionRef, {
                        items: updatedItems
                    });
                    const closeButton = document.getElementById('close-edit-item-modal');
                   if(closeButton) closeButton.click();
                }
            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù†ØµØ± (ØªØ£ÙƒØ¯ Ù…Ù† Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø£Ù…Ø§Ù†):", error);
                showAlert("âŒ ÙØ´Ù„ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù†ØµØ±. (ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‚ÙˆØ§Ø¹Ø¯ Ø£Ù…Ø§Ù† Firestore).");
            }
        }

        /**
         * (Delete) Ø­Ø°Ù Ø¹Ù†ØµØ± Ù…Ù† Ù‚Ø³Ù…
         */
        async function deleteItem(sectionId, itemId) {
             if (!db || !sectionsPath) {
                 showAlert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ù„Ø­Ø°Ù Ø§Ù„Ø¹Ù†ØµØ±.");
                  return;
             }
            const sectionRef = doc(db, sectionsPath, sectionId);
            const sectionSnap = await getDoc(sectionRef);
            const editors = (sectionSnap.exists() && sectionSnap.data().editors) ? sectionSnap.data().editors : [];
            const canDelete = isUserAdmin || editors.includes(currentUserName);

            if (!canDelete) return;

            try {
                if (sectionSnap.exists()) {
                    let items = sectionSnap.data().items || [];

                    const updatedItems = items.filter(item => item.id !== itemId);


                    await updateDoc(sectionRef, {
                        items: updatedItems
                    });
                    
                    selectionBasket = selectionBasket.filter(item => item.id !== itemId);
                    updateSelectionBar();
                }
            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¹Ù†ØµØ± (ØªØ£ÙƒØ¯ Ù…Ù† Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø£Ù…Ø§Ù†):", error);
                showAlert("âŒ ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø¹Ù†ØµØ±. (ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‚ÙˆØ§Ø¹Ø¯ Ø£Ù…Ø§Ù† Firestore).");
            }
        }


        /**
         * (Delete) Ø­Ø°Ù Ù‚Ø³Ù… ÙƒØ§Ù…Ù„
         */
        async function deleteSection(sectionId) {
            if (!isUserAdmin) return;
            if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.`)) return;

            try {
                 if (!db || !sectionsPath) {
                     showAlert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ù„Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ù….");
                      return;
                 }
                const sectionRef = doc(db, sectionsPath, sectionId);
                await deleteDoc(sectionRef);
                
                clearSelection();
                
            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ù… (ØªØ£ÙƒØ¯ Ù…Ù† Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø£Ù…Ø§Ù†):", error);
                showAlert("âŒ ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ù…. (ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‚ÙˆØ§Ø¹Ø¯ Ø£Ù…Ø§Ù† Firestore).");
            }
        }

        /**
         * =============================================
         * Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (Rendering)
         * =============================================
         */

        /**
         * Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙˆØ¯ HTML Ù„Ù„Ù‚Ø³Ù… Ø§Ù„ÙˆØ§Ø­Ø¯ ÙˆØ¬Ù…ÙŠØ¹ Ø¹Ù†Ø§ØµØ±Ù‡
         */
        function renderSection(doc) {
            const section = doc.data();
            const sectionId = doc.id;
            const editors = section.editors || []; 
            const userCanEditThisSection = currentUserRole !== 'suspended' && (isUserAdmin || editors.includes(currentUserName)); 
            const sectionIcon = section.icon || DEFAULT_ICON; // (Ø¬Ø¯ÙŠØ¯)
            
            const isVisibleToAll = section.isVisible !== false; 

            if (!isVisibleToAll && !isUserAdmin) {
                return;
            }

            const sectionDiv = document.createElement('div');
            sectionDiv.className = "bg-white rounded-xl shadow-2xl overflow-hidden flex flex-col column-wrapper";
            sectionDiv.dataset.sectionId = sectionId;
            sectionDiv.dataset.canEdit = userCanEditThisSection; 

            const headerDiv = document.createElement('div');
            headerDiv.className = "column-header p-5 border-b border-gray-200 bg-gray-50 flex justify-between items-center";
            
            // (ØªØ¹Ø¯ÙŠÙ„) Ø¥Ø¶Ø§ÙØ© Ù…Ù‚Ø¨Ø¶ Ø§Ù„Ø³Ø­Ø¨ (Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø«Ø§Ù†ÙŠ)
            headerDiv.innerHTML = `
                ${isUserAdmin ? `
                    <div class="section-drag-handle" title="Ø³Ø­Ø¨ ÙˆØªØ±ØªÙŠØ¨ Ø§Ù„Ù‚Ø³Ù…">
                        <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" /></svg>
                    </div>
                ` : ''}
                <h2 class="text-2xl font-bold text-teal-800 flex items-center gap-3 flex-1 min-w-0">
                    <span class="section-title-icon">${sectionIcon}</span> <span class="section-title-text ">${section.title || 'Ù‚Ø³Ù… Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†'}</span>
                </h2>
                <div class="flex items-center gap-2 flex-shrink-0">
                    ${userCanEditThisSection ? ` 
                    <button class="section-edit-btn p-1 text-blue-500 hover:text-blue-700 transition-colors" title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø³Ù…"><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L6.832 19.82a4.5 4.5 0 01-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 011.13-1.897L16.863 4.487zm0 0L19.5 7.125" /></svg></button>
                    ${isUserAdmin ? `<button class="section-delete-btn p-1 text-red-500 hover:text-red-700 transition-colors" title="Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ù…"><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12.578 0a48.09 48.09 0 013.478-.397m7.5 0a48.09 48.09 0 00-7.5 0" /></svg></button>` : ''} 
                    ` : ''}
                    <button class="section-print-btn p-1 text-green-500 hover:text-green-700 transition-colors" title="Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù‚Ø³Ù… ÙƒÙ€ PDF">
                         <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                           <path fill-rule="evenodd" d="M5 2.75C5 1.784 5.784 1 6.75 1h6.5c.966 0 1.75.784 1.75 1.75v3.5A1.75 1.75 0 0113.25 8H6.75A1.75 1.75 0 015 6.25v-3.5zm.75 0v3.5c0 .138.112.25.25.25h6.5a.25.25 0 00.25-.25v-3.5a.25.25 0 00-.25-.25h-6.5a.25.25 0 00-.25.25zM6 10.75A.75.75 0 016.75 10h6.5a.75.75 0 010 1.5h-6.5A.75.75 0 016 10.75zM6 13.75A.75.75 0 016.75 13h6.5a.75.75 0 010 1.5h-6.5A.75.75 0 016 13.75zM3.25 9A1.75 1.75 0 001.5 10.75v3.5c0 .966.784 1.75 1.75 1.75h1.25a.75.75 0 010 1.5H3.25A3.25 3.25 0 010 14.25v-3.5A3.25 3.25 0 013.25 7.5h13.5A3.25 3.25 0 0120 10.75v3.5A3.25 3.25 0 0116.75 17.5h-1.25a.75.75 0 010-1.5h1.25A1.75 1.75 0 0018.5 14.25v-3.5A1.75 1.75 0 0016.75 9H3.25z" clip-rule="evenodd" />
                         </svg>
                    </button>
                    <button class="section-share-btn p-1 text-green-500 hover:text-green-600 transition-colors" title="Ù…Ø´Ø§Ø±ÙƒØ© Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨">
                       <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 16 16"> <path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 014.66 1.931 6.557 6.557 0 011.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z"/> </svg>
                    </button>
                </div>
            `;
            sectionDiv.appendChild(headerDiv);

            const listDiv = document.createElement('div');
            listDiv.className = "p-4 space-y-3 flex-grow column-list";
            listDiv.dataset.sectionTitle = section.title || 'Ù‚Ø³Ù… Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†'; 

            const items = section.items || [];
            if (items.length > 0) {
                items.forEach(item => {
                    listDiv.appendChild(renderItem(item, userCanEditThisSection, sectionId)); 
                });
            } else {
                listDiv.innerHTML = `<p class="text-gray-400 text-center p-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù….</p>`;
            }
            sectionDiv.appendChild(listDiv);

             const footerDiv = document.createElement('div');
             footerDiv.className = "p-4 bg-gray-100 border-t";
             if (userCanEditThisSection) {
                 footerDiv.innerHTML = `
                      <button class="add-item-btn w-full bg-teal-600 text-white py-3 px-4 rounded-lg font-bold hover:bg-teal-700 transition duration-300 flex items-center justify-center gap-2" data-column-id="${sectionId}">
                          <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                          Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ±
                      </button>
                 `;
             } else {
                 footerDiv.innerHTML = `
                      <button class="request-control-btn w-full bg-yellow-500 text-white py-3 px-4 rounded-lg font-bold hover:bg-yellow-600 transition duration-300 flex items-center justify-center gap-2" data-section-id="${sectionId}" data-section-title="${section.title || ''}">
                          <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25a3 3 0 013 3m3 0a6 6 0 01-7.029 5.912c-.563-.097-1.159.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 1121.75 8.25z" /></svg>
                          Ø·Ù„Ø¨ Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ù‚Ø³Ù…
                      </button>
                 `;
             }
             sectionDiv.appendChild(footerDiv);

            if (sectionsContainer) sectionsContainer.appendChild(sectionDiv);
        }

        /**
         * Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙˆØ¯ HTML Ù„Ù„Ø¹Ù†ØµØ± Ø§Ù„ÙˆØ§Ø­Ø¯
         */
        function renderItem(item, canEdit, sectionId) { 
             if (!item || !item.id) return document.createElement('div');

            const itemDiv = document.createElement('div');
            itemDiv.className = "group item-card bg-white p-4 rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition-shadow relative item-wrapper flex items-center";
            itemDiv.dataset.itemId = item.id;
            itemDiv.dataset.sectionId = sectionId;
            let href = item.url || '#';
            let target = (item.type === 'link' && item.url) ? 'target="_blank" rel="noopener noreferrer"' : '';
            let download = (item.type === 'file') ? `download="${item.title || 'file'}"` : '';
            
            const formattedTitle = replaceEmojis(item.title);


            const itemTypeIcon = (item.type === 'link')
                ? `<svg class="w-6 h-6 text-blue-500 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244" /></svg>`
                : `<svg class="w-6 h-6 text-green-500 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m.75 12l3 3m0 0l3-3m-3 3v-6m-1.5-9H5.625a3.375 3.375 0 00-3.375 3.375v11.25a3.375 3.375 0 003.375 3.375h12.75a3.375 3.375 0 003.375-3.375V12M10.5 1.5H18" /></svg>`;
                
            const dragHandle = canEdit ? `
                <div class="drag-handle text-teal-800 hover:bg-gray-100 hidden md:flex md:group-hover:flex" title="Ø³Ø­Ø¨ ÙˆØ¥ÙÙ„Ø§Øª">
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5M12 17.25h8.25"/></svg>
                </div>
            ` : '';
            
            
            const desktopControlButtons = canEdit ? `
                <div class="hidden md:flex md:group-hover:flex items-center gap-1 flex-shrink-0"> 
                    <button class="item-edit-btn-desktop item-edit-btn p-1 text-blue-500 hover:text-blue-700 transition-colors" title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù†ØµØ±">
                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L6.832 19.82a4.5 4.5 0 01-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 011.13-1.897L16.863 4.487zm0 0L19.5 7.125" /></svg>
                    </button>
                    <button class="item-delete-btn-desktop item-delete-btn p-1 text-red-500 hover:text-red-700 transition-colors" title="Ø­Ø°Ù Ø§Ù„Ø¹Ù†ØµØ±">
                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12.578 0a48.09 48.09 0 013.478-.397m7.5 0a48.09 48.09 0 00-7.5 0" /></svg>
                    </button>
                </div>
            ` : '';

            const mobileActionButton = canEdit ? `
                 <button class="item-action-btn md:hidden p-1 text-gray-500 hover:text-gray-700 transition-colors flex-shrink-0" 
                         title="Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"
                         onclick="showItemActionsPopup(this)">
                     <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5M3.75 17.25h16.5" /></svg>
                 </button>
            ` : '';

            const selectionCheckbox = (item.type === 'link' && item.url) ? `
                <input type="checkbox" 
                       class="item-selection-checkbox" 
                       data-item-id="${item.id}"
                       data-item-title="${item.title || ''}"
                       data-item-url="${item.url}"
                       onchange="handleItemSelection(this)"
                       ${selectionBasket.some(b => b.id === item.id) ? 'checked' : ''}
                       >
            ` : '<div class="w-5 mr-3"></div>'; 


            itemDiv.innerHTML = `
                ${selectionCheckbox} 
                ${dragHandle}
                <div class="flex items-center gap-3 flex-1 min-w-0"> 
                    ${itemTypeIcon}
                    <a href="${href}" ${target} ${download} class="font-semibold text-gray-800 hover:text-teal-600 transition-colors flex-grow min-w-0 overflow-hidden">
                        <span class="block ">${formattedTitle || 'Ø¹Ù†ØµØ± Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†'}</span>
                    </a>
                </div>

                <div class="flex items-center gap-1 flex-shrink-0 mr-2 relative"> 
                    
                    <button class="item-share-btn p-1 text-green-500 hover:text-green-600 transition-colors flex-shrink-0" title="Ù…Ø´Ø§Ø±ÙƒØ© Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 16 16"> <path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 014.66 1.931 6.557 6.557 0 011.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z"/> </svg>
                    </button>
                    ${desktopControlButtons}
                    ${mobileActionButton}
                    
                    <div class="item-action-popup hidden action-popup bg-white border border-gray-200 rounded-lg shadow-xl py-1">
                        <button class="item-edit-btn-action w-full text-right px-4 py-2 text-sm text-blue-600 hover:bg-gray-100 flex items-center gap-2"
                                title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù†ØµØ±"
                                data-item-id="${item.id}" 
                                data-section-id="${sectionId}">
                             <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L6.832 19.82a4.5 4.5 0 01-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 011.13-1.897L16.863 4.487zm0 0L19.5 7.125" /></svg>
                             ØªØ¹Ø¯ÙŠÙ„
                        </button>
                        <button class="item-delete-btn-action w-full text-right px-4 py-2 text-sm text-red-600 hover:bg-gray-100 flex items-center gap-2"
                                title="Ø­Ø°Ù Ø§Ù„Ø¹Ù†ØµØ±"
                                onclick="if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ØµØ±ØŸ')) { deleteItem('${sectionId}', '${item.id}'); document.querySelector('.item-action-popup:not(.hidden)').classList.add('hidden'); }">
                             <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12.578 0a48.09 48.09 0 013.478-.397m7.5 0a48.09 48.09 0 00-7.5 0" /></svg>
                             Ø­Ø°Ù
                        </button>
                    </div>
                </div>
            `;
            return itemDiv;
        }


        /**
         * =============================================
         * (Ø¬Ø¯ÙŠØ¯) Ù…Ù†Ø·Ù‚ Ø³Ù„Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
         * =============================================
         */
         
        /**
         * (Ø¬Ø¯ÙŠØ¯) Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
         */
        window.handleItemSelection = function(checkbox) {
            const item = {
                id: checkbox.dataset.itemId,
                title: checkbox.dataset.itemTitle,
                url: checkbox.dataset.itemUrl,
                type: 'link', // Ù†ÙØªØ±Ø¶ Ø£Ù†Ù†Ø§ Ù„Ø§ Ù†Ø®ØªØ§Ø± Ø¥Ù„Ø§ Ø§Ù„Ø±ÙˆØ§Ø¨Ø·
                // (Ø¬Ø¯ÙŠØ¯) Ø¬Ù„Ø¨ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù‚Ø³Ù…
                sectionTitle: checkbox.closest('.column-list')?.dataset.sectionTitle || 'Ù‚Ø³Ù… ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'
            };

            if (checkbox.checked) {
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù†ØµØ± Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
                if (!selectionBasket.some(b => b.id === item.id)) {
                    selectionBasket.push(item);
                }
            } else {
                // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¹Ù†ØµØ± Ù…Ù† Ø§Ù„Ø³Ù„Ø©
                selectionBasket = selectionBasket.filter(b => b.id !== item.id);
            }
            
            updateSelectionBar();
        }
        
        /**
         * (Ø¬Ø¯ÙŠØ¯) ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ø§Ø¦Ù…
         */
        function updateSelectionBar() {
            const count = selectionBasket.length;
            
            if (count > 0) {
                selectionCountShare.textContent = `(${count})`;
                selectionCountPrint.textContent = `(${count})`;
                selectionBar.classList.add('visible');
            } else {
                selectionBar.classList.remove('visible');
            }
        }
        
        /**
         * (Ø¬Ø¯ÙŠØ¯) Ù…Ø³Ø­ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
         */
        function clearSelection() {
            selectionBasket = [];
            
            // Ø¥Ù„ØºØ§Ø¡ ØªØ­Ø¯ÙŠØ¯ ÙƒÙ„ ØµÙ†Ø§Ø¯ÙŠÙ‚ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± ÙÙŠ Ø§Ù„ØµÙØ­Ø©
            document.querySelectorAll('.item-selection-checkbox:checked').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            updateSelectionBar();
        }
        
        /**
         * (Ø¬Ø¯ÙŠØ¯) Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨
         */
        function shareSelectedItems() {
            if (selectionBasket.length === 0) {
                showAlert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø¹Ù†ØµØ± ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ©.");
                return;
            }
            
            // (Ø¬Ø¯ÙŠØ¯) ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù…
            const itemsBySection = selectionBasket.reduce((acc, item) => {
                const section = item.sectionTitle;
                if (!acc[section]) {
                    acc[section] = [];
                }
                acc[section].push(item);
                return acc;
            }, {});

            let message = "*Ù…Ù„ÙØ§Øª Ù…Ù† Ù…Ù†ØµØ© Ø§Ù„Ø±Ø§Ø´Ø¯ÙˆÙ†:*\n\n";
            
            // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø§Ù„ØªØ¬Ù…ÙŠØ¹
            for (const sectionTitle in itemsBySection) {
                 message += `*${sectionTitle}*\n`; // Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù‚Ø³Ù…
                 itemsBySection[sectionTitle].forEach(item => {
                     message += `${item.title}\n${item.url}\n\n`;
                 });
            }

            const encodedMessage = encodeURIComponent(message.trim());
            const whatsappUrl = `https://wa.me/?text=${encodedMessage}`;
            window.open(whatsappUrl, '_blank');
            
            clearSelection();
        }
        
        /**
         * (Ø¬Ø¯ÙŠØ¯ ÙˆÙ…ÙØ¹Ø¯Ù„) Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
         * ÙŠØ¬Ù…Ø¹ ÙƒÙ„ Ø§Ù„Ø¹Ù†Ø§ØµØ± ÙÙŠ ØµÙØ­Ø© ÙˆØ§Ø­Ø¯Ø© Ø£Ùˆ Ø£ÙƒØ«Ø± Ø¨Ø¹Ù†ÙˆØ§Ù† "ØªÙ‚Ø±ÙŠØ± Ù…Ø®ØµØµ"
         */
        async function printSelectedItems() {
            if (selectionBasket.length === 0) {
                showAlert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø¹Ù†ØµØ± ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©.");
                return;
            }
            
            if (!pdfSpinnerModal) return; 
            pdfSpinnerModal.classList.remove('hidden');

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'p',
                unit: 'mm',
                format: 'a4'
            });

            try {
                 let isFirstPage = true;

                 // (ØªØ¹Ø¯ÙŠÙ„) ØªØ¬Ù…ÙŠØ¹ ÙƒÙ„ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© ÙÙŠ ØµÙØ­Ø© ÙˆØ§Ø­Ø¯Ø© (Ø£Ùˆ Ø£ÙƒØ«Ø±)
                 // Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† ØªØ¬Ù…ÙŠØ¹Ù‡Ø§ Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù…
                 const itemChunks = chunkArray(selectionBasket, 5); // 5 Ø¹Ù†Ø§ØµØ± ÙÙŠ ÙƒÙ„ ØµÙØ­Ø©

                 for (const chunk of itemChunks) {
                      // (ØªØ¹Ø¯ÙŠÙ„) Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¹Ù†ÙˆØ§Ù† Ø«Ø§Ø¨Øª "ØªÙ‚Ø±ÙŠØ± Ù…Ø®ØµØµ" ÙˆØ£ÙŠÙ‚ÙˆÙ†Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
                      await createPdfPageFromHTML(
                          doc, 
                          "Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©",  // Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù‚Ø³Ù… ÙÙŠ Ø§Ù„ØµÙØ­Ø©
                          'ğŸ“‹',               // Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
                          chunk,              // Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù„Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©
                          isFirstPage, 
                          "ØªÙ‚Ø±ÙŠØ± Ù…Ø®ØµØµ"       // Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªØ±ÙˆÙŠØ³Ø©
                      );
                      isFirstPage = false;
                 }

                 if (!isFirstPage) { 
                     doc.save('ØªÙ‚Ø±ÙŠØ±-Ù…Ø®ØµØµ-Ø§Ù„Ø±Ø§Ø´Ø¯ÙˆÙ†.pdf');
                 } else {
                     showAlert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰ Ù„Ø·Ø¨Ø§Ø¹ØªÙ‡.");
                 }

            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù PDF Ø§Ù„Ù…Ø®ØµØµ:", error);
                showAlert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù PDF.");
            } finally {
                if (pdfSpinnerModal) pdfSpinnerModal.classList.add('hidden');
                clearSelection(); // Ù…Ø³Ø­ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø¨Ø¹Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
            }
        }


        /**
         * =============================================
         * Ù…Ù†Ø·Ù‚ Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙˆØ§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©
         * =============================================
         */
        
        /**
         * Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ù„ÙˆÙŠØ© ÙˆØ£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ…
         */
        function setupControlEvents(isAdmin) {

            // --- 1. Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ø§Ù…Ø© ---
            
            // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„Ø¬Ø¯ÙŠØ¯
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async () => {
                    if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")) {
                        await signOut(auth); // Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø¬Ù„Ø³Ø© Firebase Ø§Ù„Ù…ØµØ§Ø¯Ù‚ Ø¹Ù„ÙŠÙ‡Ø§
                        // onAuthStateChanged Ø³ÙŠØªÙˆÙ„Ù‰ Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
                    }
                });
            }

            const printSectionsBtn = document.getElementById('print-sections-btn');
            if (printSectionsBtn) {
                printSectionsBtn.addEventListener('click', async () => {
                    await generatePdfForSections(null); // Ù‡Ø°Ù‡ Ù‡ÙŠ "Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙƒÙ„" Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
                });
            }
            
            // (Ø¬Ø¯ÙŠØ¯) Ø±Ø¨Ø· Ø²Ø± Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø§Øª
            if (deleteAllChatBtn && isAdmin) {
                 deleteAllChatBtn.classList.remove('hidden');
                 deleteAllChatBtn.addEventListener('click', deleteAllChats);
            } else if (deleteAllChatBtn) {
                 deleteAllChatBtn.classList.add('hidden');
            }


            // --- 3. ØªÙÙˆÙŠØ¶ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ù„Ø£Ø²Ø±Ø§Ø± Ø¯Ø§Ø®Ù„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ÙˆØ§Ù„Ø¹Ù†Ø§ØµØ± ---
            if (sectionsContainer) {
                 sectionsContainer.addEventListener('click', async (e) => {

                     const requestControlBtn = e.target.closest('.request-control-btn');
                     if (requestControlBtn && !isUserAdmin) { 
                         const sectionId = requestControlBtn.dataset.sectionId;
                         const sectionTitle = requestControlBtn.dataset.sectionTitle;
                         if (sectionId && sectionTitle) {
                            await requestSectionControl(sectionId, sectionTitle);
                         }
                         return;
                     }
                     
                     // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø­Ø°Ù Ø§Ù„Ø¹Ù†ØµØ± Ù…Ù† Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© (ÙŠØªÙ… Ù…Ø¹Ø§Ù„Ø¬ØªÙ‡Ø§ ÙÙŠ onclick Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ HTML)
                     // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø­Ø°Ù Ø§Ù„Ø¹Ù†ØµØ± Ù…Ù† Ø³Ø·Ø­ Ø§Ù„Ù…ÙƒØªØ¨
                     const deleteItemBtnDesktop = e.target.closest('.item-delete-btn-desktop');
                     if (deleteItemBtnDesktop) {
                          const itemEl = deleteItemBtnDesktop.closest('.item-card');
                          if (itemEl) {
                             const sectionId = itemEl.dataset.sectionId;
                             const itemId = itemEl.dataset.itemId;
                             if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ØµØ±ØŸ")) {
                                 deleteItem(sectionId, itemId);
                             }
                          }
                          return;
                     }
                     
                     // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù…Ù† Ø³Ø·Ø­ Ø§Ù„Ù…ÙƒØªØ¨
                     const editItemBtnDesktop = e.target.closest('.item-edit-btn-desktop');
                     if (editItemBtnDesktop) {
                         const itemEl = editItemBtnDesktop.closest('.item-card');
                         if (itemEl) {
                             const editBtn = itemEl.querySelector('.item-edit-btn-action');
                             if(editBtn) editBtn.click(); // ÙŠØ­Ø§ÙƒÙŠ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙÙŠ Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„ÙØªØ­ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
                         }
                         return;
                     }


                     const deleteSectionBtn = e.target.closest('.section-delete-btn');
                     if (deleteSectionBtn && isAdmin) {
                         const sectionEl = deleteSectionBtn.closest('.column-wrapper');
                         if (sectionEl) {
                            const sectionId = sectionEl.dataset.sectionId;
                            deleteSection(sectionId);
                         }
                         return;
                     }

                     const printSectionBtn = e.target.closest('.section-print-btn');
                     if (printSectionBtn) {
                         const sectionEl = printSectionBtn.closest('.column-wrapper');
                         if (sectionEl) {
                            await generatePdfForSections(sectionEl); // Ù‡Ø°Ù‡ Ø·Ø¨Ø§Ø¹Ø© Ù‚Ø³Ù… ÙˆØ§Ø­Ø¯
                         }
                         return;
                     }

                     const shareSectionBtn = e.target.closest('.section-share-btn');
                     if (shareSectionBtn) {
                         const sectionEl = shareSectionBtn.closest('.column-wrapper');
                         if (sectionEl) {
                             shareSectionViaWhatsApp(sectionEl.dataset.sectionId);
                         }
                         return;
                     }

                      const shareItemBtn = e.target.closest('.item-share-btn');
                      if (shareItemBtn) {
                          const itemEl = shareItemBtn.closest('.item-card');
                           if (itemEl) {
                                 const title = itemEl.querySelector('a span')?.textContent.trim() || '';
                                 const url = itemEl.querySelector('a')?.href || '';
                                 // ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ù‡Ù†Ø§Ùƒ Ø±Ø§Ø¨Ø· ØµØ§Ù„Ø­ Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ©
                                 if (itemEl.querySelector('a')?.getAttribute('target')) {
                                    shareItemViaWhatsApp(title, url);
                                 } else {
                                     showAlert("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù…Ø´Ø§Ø±ÙƒØ© Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ØµØ± Ù„Ø£Ù†Ù‡ Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø±Ø§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø±.");
                                 }
                           }
                           return;
                      }

                 });
            }
        }
        
        /**
         * (Ø¬Ø¯ÙŠØ¯ ÙˆÙ…ÙØ¹Ø¯ÙÙ‘Ù„) Ø¯Ø§Ù„Ø© Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø§Øª (Ù„Ù„Ù…Ø¯ÙŠØ±)
         */
        window.deleteAllChats = async function() {
            if (!isUserAdmin) {
                showAlert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø¯ÙŠØ± Ù„ØªÙ†ÙÙŠØ° Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.", 'error');
                return;
            }

            if (!confirm("âš ï¸ ØªØ­Ø°ÙŠØ± Ù†Ù‡Ø§Ø¦ÙŠ! Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ (Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ© ÙˆØ§Ù„Ø®Ø§ØµØ©) Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.")) return;

            try {
                const batch = writeBatch(db);
                
                // 1. Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ© (Collection: chat_group)
                const groupSnapshot = await getDocs(chatPaths.groupChatCollection());
                groupSnapshot.docs.forEach((doc) => {
                    batch.delete(doc.ref);
                });

                // 2. ØªØµÙØ­ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚ ÙÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ø®Ø§ØµØ© (Collection: chat_private)
                // ÙˆØ­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„ÙØ±Ø¹ÙŠØ© Ù„ÙƒÙ„ ÙˆØ«ÙŠÙ‚Ø©
                const privateChatsBaseRef = collection(db, 'chat_private');
                const privateChatsSnapshot = await getDocs(privateChatsBaseRef);
                
                for (const docSnap of privateChatsSnapshot.docs) {
                    const messagesCollectionRef = collection(db, `chat_private/${docSnap.id}/messages`);
                    const messagesSnapshot = await getDocs(messagesCollectionRef);
                    
                    // Ø­Ø°Ù ÙƒÙ„ Ø±Ø³Ø§Ù„Ø© Ø¯Ø§Ø®Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø®Ø§ØµØ©
                    messagesSnapshot.docs.forEach((msgDoc) => {
                        batch.delete(msgDoc.ref);
                    });
                }
                
                // 3. Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª ØºÙŠØ± Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø© (Collection: chat_state)
                const chatStateBaseRef = collection(db, 'chat_state');
                const chatStateSnapshot = await getDocs(chatStateBaseRef);
                
                for (const userStateDoc of chatStateSnapshot.docs) {
                     const stateSubCollection = collection(db, `chat_state/${userStateDoc.id}/state`);
                     const stateSnapshot = await getDocs(stateSubCollection);
                     
                     // Ø­Ø°Ù ÙƒÙ„ ÙˆØ«ÙŠÙ‚Ø© Ø­Ø§Ù„Ø© Ø¯Ø±Ø¯Ø´Ø© (Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª)
                     stateSnapshot.docs.forEach((stateDoc) => {
                         batch.delete(stateDoc.ref);
                     });
                }


                await batch.commit();
                showAlert("âœ… ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø¨Ù†Ø¬Ø§Ø­!", 'success');
                
                // Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ÙˆØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
                if (chatWindow && !chatWindow.classList.contains('hidden')) {
                     document.getElementById('close-chat').click();
                }
            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø§Øª:", error);
                showAlert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙƒØ¨ÙŠØ± Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø¯Ø±Ø¯Ø´Ø§Øª. (ØªØ£ÙƒØ¯ Ù…Ù† Ù‚ÙˆØ§Ø¹Ø¯ Ø£Ù…Ø§Ù† Firestore)", 'error');
            }
        }


        /**
         * Ø¥Ø¸Ù‡Ø§Ø± Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡
         */
        function showAlert(message, type = 'info') {
            const alertModalMessage = document.getElementById('alert-modal-message');
            const modalContent = document.getElementById('alert-modal-content');

            if (alertModalMessage && alertModal && modalContent) {
                alertModalMessage.textContent = message;
                alertModal.classList.remove('hidden');
                setTimeout(() => {
                    modalContent.classList.remove('scale-95', 'opacity-0');
                    modalContent.classList.add('scale-100', 'opacity-100');
                }, 10);
            }
        }

        /**
         * Ù…Ø´Ø§Ø±ÙƒØ© Ø¹Ù†ØµØ± Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨ (Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©)
         */
        function shareItemViaWhatsApp(title, url) {
            if (!title || !url) {
                showAlert("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù…Ø´Ø§Ø±ÙƒØ© Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ØµØ± Ù„Ø£Ù†Ù‡ Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¹Ù†ÙˆØ§Ù† Ø£Ùˆ Ø±Ø§Ø¨Ø·.");
                return;
            }
            const message = encodeURIComponent(`${title}\n${url}`);
            const whatsappUrl = `https://wa.me/?text=${message}`;
            window.open(whatsappUrl, '_blank');
        }

        /**
         * Ù…Ø´Ø§Ø±ÙƒØ© Ù‚Ø³Ù… ÙƒØ§Ù…Ù„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨ (Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©)
         */
        async function shareSectionViaWhatsApp(sectionId) {
             if (!sectionId) return;
             const sectionData = await getSectionDataById(sectionId);
             if (!sectionData) {
                 showAlert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø³Ù… Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ©.");
                 return;
             }
             
             const sectionIcon = sectionData.icon || ''; // (Ø¬Ø¯ÙŠØ¯)

             let message = `*${sectionIcon} ${sectionData.title || 'Ù‚Ø³Ù… Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†'}*\n\n`; // (Ø¬Ø¯ÙŠØ¯)
             const items = sectionData.items || [];
             if (items.length > 0) {
                 items.forEach(item => {
                      if (item.title && item.url && item.type === 'link') {
                          message += `${item.title}\n${item.url}\n\n`;
                      }
                 });
             } else {
                 message += "_Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…._"; 
             }

             const encodedMessage = encodeURIComponent(message.trim());
             const whatsappUrl = `https://wa.me/?text=${encodedMessage}`;
             window.open(whatsappUrl, '_blank');
        }


        /**
         * =============================================
         * Ù…Ù†Ø·Ù‚ Ø¥Ù†Ø´Ø§Ø¡ PDF Ù…Ø¹ QR Code
         * =============================================
         */
         
         /**
          * Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªÙ‚Ø³ÙŠÙ… Ù…ØµÙÙˆÙØ© Ø¥Ù„Ù‰ Ø£Ø¬Ø²Ø§Ø¡
          */
        function chunkArray(array, size) {
           if (!Array.isArray(array)) {
               return [];
           }
           const chunks = [];
           for (let i = 0; i < array.length; i += size) {
               chunks.push(array.slice(i, i + size));
           }
           return chunks;
        }


        /**
         * (Ù…Ø¹Ø¯Ù„Ø©) Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ ØµÙØ­Ø© PDF ÙˆØ§Ø­Ø¯Ø© Ù…Ù† ÙƒÙˆØ¯ HTML
         * (ØªØ¹Ø¯ÙŠÙ„) Ø¥Ø¶Ø§ÙØ© Ù†Øµ "Ø§Ø¶ØºØ· Ù„ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·" ØªØ­Øª Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
         */
        async function createPdfPageFromHTML(doc, sectionTitle, sectionIcon, itemChunk, isFirstPage, reportTitle = "ØªÙ‚Ø±ÙŠØ± Ù…Ù†ØµØ© Ø§Ù„Ø±Ø§Ø´Ø¯ÙˆÙ†") {
            const printContainer = document.createElement('div');
            printContainer.className = 'print-container';

            const superHeader = document.createElement('div');
            superHeader.className = 'print-super-header';
            superHeader.innerHTML = `
                <div>Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©</div>
                <div>ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…</div>
                <div>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„ØªØ¹Ù„ÙŠÙ… Ø¨Ù…Ù†Ø·Ù‚Ø© Ø¹Ø³ÙŠØ±</div>
                <div>Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ© ÙˆÙ…ØªÙˆØ³Ø·Ø© Ø§Ù„Ø±Ø§Ø´Ø¯ÙˆÙ† Ø¨Ø§Ù„Ù…Ø±Ø¨Ø¹</div>
            `;
            printContainer.appendChild(superHeader);

            const header = document.createElement('div');
            header.className = 'print-header';
            header.innerHTML = `<h1>${reportTitle}</h1>`; // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø®ØµØµ
            printContainer.appendChild(header);

            const contentWrapper = document.createElement('div');
            contentWrapper.className = 'print-content-wrapper';

            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'print-section';

            const titleDiv = document.createElement('div');
            titleDiv.className = 'print-section-title';
            // (Ø¬Ø¯ÙŠØ¯) Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù‚Ø³Ù…
            titleDiv.textContent = `${sectionIcon} ${sectionTitle || 'Ù‚Ø³Ù… Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†'}`;
            sectionDiv.appendChild(titleDiv);

            const listDiv = document.createElement('div');
            listDiv.className = 'print-item-list';

             const qrDataForPdf = [];
             
             if (Array.isArray(itemChunk) && itemChunk.length > 0) {
                 for (const item of itemChunk) {
                      if (typeof item !== 'object' || item === null) continue;

                      const itemDiv = document.createElement('div');
                      itemDiv.className = 'print-item';

                      const textDiv = document.createElement('div');
                      textDiv.className = 'print-item-text';
                      
                      // (ØªØ¹Ø¯ÙŠÙ„ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø®ØµØµØ©) Ø¥Ø¸Ù‡Ø§Ø± Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø£ØµÙ„ÙŠ
                      let titleHtml = `<div class="print-item-title">${item.title || 'Ø¹Ù†ØµØ± Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†'}</div>`;
                      if (reportTitle === "ØªÙ‚Ø±ÙŠØ± Ù…Ø®ØµØµ" && item.sectionTitle) {
                           titleHtml += `<div style="font-size: 14px; color: #555;">(Ù…Ù† Ù‚Ø³Ù…: ${item.sectionTitle})</div>`;
                      }
                      textDiv.innerHTML = titleHtml;

                      // (ØªØ¹Ø¯ÙŠÙ„) Ø¥Ø¶Ø§ÙØ© Ø­Ø§ÙˆÙŠØ© Ù„Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙˆØ§Ù„Ù†Øµ
                      const qrContainer = document.createElement('div');
                      qrContainer.style.textAlign = 'center'; // Ù„Ù…Ø­Ø§Ø°Ø§Ø© Ø§Ù„Ù†Øµ ÙˆØ§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
                      qrContainer.style.marginLeft = '15px';
                      qrContainer.style.flexShrink = '0';
                      
                      const qrDiv = document.createElement('div');
                      qrDiv.className = 'print-item-qr';
                      qrDiv.style.marginLeft = '0'; // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù‡Ø§Ù…Ø´ Ù…Ù† Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù†ÙØ³Ù‡
                      
                      const url = (item.type === 'link' && item.url) ? item.url : '';
                      qrDiv.dataset.url = url;
                      
                      qrContainer.appendChild(qrDiv);

                      // (Ø¬Ø¯ÙŠØ¯) Ø¥Ø¶Ø§ÙØ© Ù†Øµ "Ø§Ø¶ØºØ· Ù„ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·"
                      if (url) {
                          const qrLinkText = document.createElement('div');
                          qrLinkText.textContent = 'Ø§Ø¶ØºØ· Ù„ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·';
                          qrLinkText.style.fontSize = '10px';
                          qrLinkText.style.color = '#008080'; // Ù„ÙˆÙ† Teal
                          qrLinkText.style.fontWeight = 'bold';
                          qrLinkText.style.marginTop = '4px';
                          qrContainer.appendChild(qrLinkText);
                      }

                      itemDiv.appendChild(textDiv);
                      itemDiv.appendChild(qrContainer); // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¨Ø§Ø´Ø±Ø©
                      listDiv.appendChild(itemDiv);
                      
                      if (url) {
                         qrDataForPdf.push({ div: qrDiv, url: url, text: item.title });
                      }
                 }
             } else {
                 listDiv.innerHTML = '<p style="padding: 10px; text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù….</p>';
             }
            sectionDiv.appendChild(listDiv);
            contentWrapper.appendChild(sectionDiv);
            printContainer.appendChild(contentWrapper);

            const footer = document.createElement('div');
            footer.className = 'print-footer';
            footer.innerHTML = `
                <span>Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø¹Ù„Ù…: Ø¹Ù„ÙŠ Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ… Ø¹Ø³ÙŠØ±ÙŠ</span>
                <span>Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©: Ø£Ø­Ù…Ø¯ Ø³Ø§Ù„Ù… Ø§Ù„Ø´Ù‡Ø±ÙŠ</span>
            `;
            printContainer.appendChild(footer);

            document.body.appendChild(printContainer);

            // Ø¥Ù†Ø´Ø§Ø¡ ØµÙˆØ± QR Ù…Ø¤Ù‚ØªØ§Ù‹ ÙÙŠ HTML
            qrDataForPdf.forEach(qr => {
                try { 
                    new QRCode(qr.div, {
                        text: qr.url,
                        width: 80,
                        height: 80,
                        correctLevel: QRCode.CorrectLevel.L
                    });
                } catch(qrError) {
                    qr.div.textContent = "[Ø®Ø·Ø£ QR]"; 
                }
            });

            await new Promise(resolve => setTimeout(resolve, 500));

            let canvas;
            try {
                canvas = await html2canvas(printContainer, {
                    scale: 2,
                    useCORS: true,
                    width: printContainer.offsetWidth,
                    height: printContainer.offsetHeight
                });
            } catch (canvasError) {
                 document.body.removeChild(printContainer); 
                 throw canvasError; 
            }

            const imgData = canvas.toDataURL('image/png');
            const pdfWidth = doc.internal.pageSize.getWidth();
            const pdfHeight = doc.internal.pageSize.getHeight();
            
            if (!isFirstPage) doc.addPage();


            const elementsBounds = [];
            qrDataForPdf.forEach(qr => {
                 const rect = qr.div.getBoundingClientRect();
                 const pageRect = printContainer.getBoundingClientRect(); 

                 const scaleFactorX = pdfWidth / pageRect.width;
                 const scaleFactorY = pdfHeight / pageRect.height;

                 const x_on_page = rect.left - pageRect.left;
                 
                 // (ØªØ¹Ø¯ÙŠÙ„) ØªØ¹Ø¯ÙŠÙ„ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ù„Ù€ RTL
                 // Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯: (Ø¹Ø±Ø¶ Ø§Ù„ØµÙØ­Ø© Ø¨Ø§Ù„Ø¨ÙƒØ³Ù„ - Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠ Ø§Ù„Ø£ÙŠØ³Ø± - Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù†ØµØ±) * Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„Ù‚ÙŠØ§Ø³
                 const finalX = (pageRect.width - (x_on_page + rect.width)) * scaleFactorX;
                 const finalY = (rect.top - pageRect.top) * scaleFactorY;
                 
                 // (ØªØ¹Ø¯ÙŠÙ„) ØªÙˆØ³ÙŠØ¹ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¶ØºØ· Ù„ØªØ´Ù…Ù„ Ø§Ù„Ù†Øµ Ø£Ø³ÙÙ„Ù‡
                 const boundWidth = rect.width * scaleFactorX;
                 const boundHeight = (rect.height + 20) * scaleFactorY; // 20px Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ù†Øµ

                 elementsBounds.push({
                     url: qr.url,
                     x: finalX,
                     y: finalY,
                     width: boundWidth,
                     height: boundHeight
                 });
            });

            doc.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);

            // (Ø¬Ø¯ÙŠØ¯) Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø¶ØºØ· ÙÙˆÙ‚ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙˆØ§Ù„Ù†Øµ
            elementsBounds.forEach(bound => {
                if(bound.url) {
                    doc.link(bound.x, bound.y, bound.width, bound.height, { url: bound.url });
                }
            });

            document.body.removeChild(printContainer);
        }
/**
         * Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ø¥Ù†Ø´Ø§Ø¡ ÙˆØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù€ PDF (Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙƒÙ„ Ø£Ùˆ Ù‚Ø³Ù… Ù…Ø­Ø¯Ø¯)
         * (Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©)
         */
        async function generatePdfForSections(specificSectionElement) {

            if (!pdfSpinnerModal) return; 
            pdfSpinnerModal.classList.remove('hidden');

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'p',
                unit: 'mm',
                format: 'a4'
            });

            try {
                 const sectionsToPrintElements = specificSectionElement
                      ? [specificSectionElement]
                      : (sectionsContainer ? Array.from(sectionsContainer.querySelectorAll('.column-wrapper')) : []); 


                 const sectionsData = [];
                 for (const el of sectionsToPrintElements) {
                      if (el && el.dataset && el.dataset.sectionId) {
                          const data = await getSectionDataById(el.dataset.sectionId);
                          if (data) sectionsData.push(data);
                      }
                 }

                 let isFirstPage = true;

                 for (const section of sectionsData) {
                      const items = (section && Array.isArray(section.items)) ? section.items : [];
                      const sectionTitle = (section && section.title) ? section.title : 'Ù‚Ø³Ù… Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†';
                      const sectionIcon = section.icon || DEFAULT_ICON; // (Ø¬Ø¯ÙŠØ¯)

                      const itemChunks = chunkArray(items, 5); // 5 Ø¹Ù†Ø§ØµØ± ÙÙŠ ÙƒÙ„ ØµÙØ­Ø©

                      if (itemChunks.length === 0) {
                           await createPdfPageFromHTML(doc, sectionTitle, sectionIcon, [], isFirstPage); // (Ø¬Ø¯ÙŠØ¯)
                           isFirstPage = false;
                      } else {
                           for (const chunk of itemChunks) {
                                await createPdfPageFromHTML(doc, sectionTitle, sectionIcon, chunk, isFirstPage); // (Ø¬Ø¯ÙŠØ¯)
                                isFirstPage = false;
                           }
                      }
                 }

                 if (!isFirstPage) { 
                     doc.save('ØªÙ‚Ø±ÙŠØ±-Ø§Ù„Ø±Ø§Ø´Ø¯ÙˆÙ†.pdf');
                 } else {
                     showAlert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰ Ù„Ø·Ø¨Ø§Ø¹ØªÙ‡.");
                 }

            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù PDF:", error);
                showAlert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù PDF.");
            } finally {
                if (pdfSpinnerModal) pdfSpinnerModal.classList.add('hidden');
            }
        }


        /**
         * Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø­Ø¯Ø«Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
         */
        async function getSectionDataById(sectionId) {
            if (!sectionId) return null;
             if (!db || !sectionsPath) return null;
            try {
                const sectionRef = doc(db, sectionsPath, sectionId);
                const sectionSnap = await getDoc(sectionRef);
                if (sectionSnap.exists()) {
                    return sectionSnap.data();
                }
                return null;
            } catch (error) {
                return null;
            }
        }

        // =================================================================
        // == (Ø¬Ø¯ÙŠØ¯) Ø¨Ø¯Ø¡ Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ù…Ø¯Ù…Ø¬ ==
        // =================================================================
        // (Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ØªØ§Ù„ÙŠ Ù…ÙƒØ±Ø± Ù…Ù† Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© ÙˆÙ„Ù… ÙŠØªØºÙŠØ±)

        /**
         * (Ø¬Ø¯ÙŠØ¯) Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
         */
        function initializeChatApp() {
            // (ØªØ¹Ø¯ÙŠÙ„) Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø¬Ù…ÙŠØ¹ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ØªÙ… Ø¬Ù„Ø¨Ù‡Ø§ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
            chatUsernameDisplay = document.getElementById('chat-username-display');
            chatUsersListDiv = document.getElementById('chat-users-list');
            chatMessagesDiv = document.getElementById('chat-messages');
            messageForm = document.getElementById('message-form');
            messageInput = document.getElementById('message-input');
            chatTitle = document.getElementById('chat-title');
            chatSubtitle = document.getElementById('chat-subtitle');
            
            if (!chatUsernameDisplay || !chatUsersListDiv || !chatMessagesDiv || !messageForm) {
                return;
            }
            
            chatUsernameDisplay.textContent = currentUserName;

            initChatAudio(); 
            document.body.addEventListener('click', initChatAudio, { once: true });
            document.body.addEventListener('keydown', initChatAudio, { once: true });

            messageForm.addEventListener('submit', handleChatMessageSubmit);
            
            listenToChatUsersAndAdmins();
            
            listenToChatUnreadCounts();
            
            chatCurrentChat = { type: 'group', id: 'group' };
        }

        /**
         * (Ø¬Ø¯ÙŠØ¯) ØªØ­Ø¯ÙŠØ« ØªÙˆØ§Ø¬Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù„Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ±)
         */
        async function updateUserPresence() {
            if (!userId || !currentUserName) return;
            try {
                await setDoc(chatPaths.userDoc(userId), { 
                    name: currentUserName, 
                    role: currentUserRole,
                    lastSeen: serverTimestamp(),
                    email: currentUserEmail
                }, { merge: true });
            } catch (e) {
                console.error("ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ØªÙˆØ§Ø¬Ø¯:", e);
            }
        }
        
        /**
         * (Ø¬Ø¯ÙŠØ¯) ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙˆØª Ù„Ù„Ø¯Ø±Ø¯Ø´Ø©
         */
        function initChatAudio() {
            if (chatSoundReady) return;
            Tone.start().then(() => {
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… ØµÙˆØª Sine Ø¨Ø³ÙŠØ· ÙˆÙˆØ§Ø¶Ø­ Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
                chatSynth = new Tone.Synth({
                    oscillator: { type: "triangle" }, // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ÙˆØ¬Ø© Ù…Ø«Ù„Ø«ÙŠØ© Ø£ÙƒØ«Ø± ÙˆØ¶ÙˆØ­Ø§Ù‹
                    envelope: {
                        attack: 0.01,
                        decay: 0.2, 
                        sustain: 0,
                        release: 0.3
                    }
                }).toDestination();
                chatSoundReady = true;
            }).catch(e => console.error("Chat Audio init failed:", e));
        }
        
        /**
         * (Ø¬Ø¯ÙŠØ¯) ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
         */
        function playChatNotificationSound() {
            if (chatSoundReady && chatSynth) {
                try {
                    // ØªØ´ØºÙŠÙ„ Ù†ØºÙ…Ø© Ø¹Ø§Ù„ÙŠØ© ÙˆÙˆØ§Ø¶Ø­Ø© (C5) Ø¨Ù…Ø¯Ø© Ø£Ø·ÙˆÙ„
                    chatSynth.triggerAttackRelease("C5", "8n"); 
                } catch(e) {
                    // (ÙØ´Ù„)
                }
            } else {
                if (!chatSoundReady) initChatAudio();
            }
        }

        /**
         * (Ø¬Ø¯ÙŠØ¯) Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠ Ø§Ù„Ù…Ù†ØµØ© Ù„Ø¨Ù†Ø§Ø¡ Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
         */
        function listenToChatUsersAndAdmins() {
            onSnapshot(chatPaths.usersCollection(), (snapshot) => {
                chatAllUsers = {};
                chatAdminList = {};
                snapshot.forEach((doc) => {
                    const userData = doc.data();
                    const aUserId = doc.id; 
                    chatAllUsers[aUserId] = userData;
                    if (userData.role === 'admin') {
                        chatAdminList[aUserId] = userData;
                    }
                });
                renderPrivateChatList(); 
                setupPersistentChatListeners(); 
            }, (error) => console.error("Error listening to chat users:", error));
        }

        /**
         * (Ø¬Ø¯ÙŠØ¯) Ø¯Ø§Ù„Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© (ØªÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„)
         */
        window.selectChat = function(type, targetId) {
            const oldTab = document.getElementById(`chat-tab-${chatCurrentChat.id.replace(':', '-')}`);
            if (oldTab) {
                oldTab.classList.remove('bg-blue-50', 'border-r-4', 'border-blue-500');
            }
            
            let chatId, title, subtitle;
            
            if (type === 'group') {
                chatId = 'group';
                title = 'Ø¯Ø±Ø¯Ø´Ø© Ø¬Ù…Ø§Ø¹ÙŠØ©';
                subtitle = 'Ø±Ø³Ø§Ø¦Ù„ Ø¹Ø§Ù…Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹';
                
                const newTab = document.getElementById('chat-tab-group');
                if(newTab) newTab.classList.add('bg-blue-50', 'border-r-4', 'border-blue-500');

            } else {
                const otherUserId = targetId;
                const otherUserData = chatAllUsers[otherUserId];
                
                if (!otherUserData) {
                    showAlert("Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….");
                    return;
                }
                
                title = otherUserData.name || `Ù…Ø³ØªØ®Ø¯Ù… ${otherUserId.substring(0, 5)}`;
                subtitle = `Ù…Ø­Ø§Ø¯Ø«Ø© Ø®Ø§ØµØ© Ù…Ø¹ ${title}`;
                
                chatId = getPrivateChatId(otherUserId);
                
                const newTab = document.getElementById(`chat-tab-${chatId.replace(':', '-')}`);
                if (newTab) {
                    newTab.classList.add('bg-blue-50', 'border-r-4', 'border-blue-500');
                }
            }
            
            // --- ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ---
            if (chatListView && chatMessageView) {
                chatListView.classList.add('hidden');
                chatMessageView.classList.remove('hidden');
            }
            
            chatCurrentChat = { type, id: chatId };
            if (chatTitle) chatTitle.textContent = title;
            if (chatSubtitle) chatSubtitle.textContent = subtitle;
            if (chatMessagesDiv) chatMessagesDiv.innerHTML = '<div class="text-center text-gray-500">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„...</div>';
            
            listenToChatMessages(chatId, type);
            
            clearChatUnreadCount(chatId);
        }

        /**
         * (Ø¬Ø¯ÙŠØ¯) Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø±Ù Ø¯Ø±Ø¯Ø´Ø© Ø®Ø§Øµ
         */
        function getPrivateChatId(otherUserId) {
            if (!userId || !otherUserId) return null;
            return [userId, otherUserId].sort().join(':');
        }

        /**
         * (Ø¬Ø¯ÙŠØ¯) Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
         */
        function listenToChatMessages(chatId, type) {
            if (chatMessageListeners[chatCurrentChat.id]) {
                chatMessageListeners[chatCurrentChat.id]();
                delete chatMessageListeners[chatCurrentChat.id];
            }
            
            let q;
            if (type === 'group') {
                q = query(chatPaths.groupChatCollection(), orderBy("timestamp", "desc"), limit(50));
            } else {
                q = query(chatPaths.privateChatCollection(chatId), orderBy("timestamp", "desc"), limit(50));
            }
            
            const unsubscribe = onSnapshot(q, (snapshot) => {
                const messages = [];
                snapshot.forEach((doc) => {
                    messages.push({ id: doc.id, ...doc.data() });
                });
                renderChatMessages(messages.reverse());
                
                if (snapshot.docChanges().length > 0) {
                    const lastChange = snapshot.docChanges()[snapshot.docChanges().length - 1];
                    if (lastChange.type === "added") {
                        const newMessage = lastChange.doc.data();
                        if (newMessage.userId !== userId) { 
                            const now = Date.now();
                            const msgTime = newMessage.timestamp?.toDate().getTime() || now;
                            if ((now - msgTime) < 5000) { 
                                playChatNotificationSound();
                            }
                        }
                    }
                }
            }, (error) => {
                if (chatMessagesDiv) chatMessagesDiv.innerHTML = `<div class="text-center text-red-500">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„: ${error.message}</div>`;
            });
            
            chatMessageListeners[chatId] = unsubscribe;
        }


        /**
         * (Ø¬Ø¯ÙŠØ¯) Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¯Ø±Ø¯Ø´Ø©
         */
        async function handleChatMessageSubmit(e) {
            e.preventDefault();
            if (!messageInput) return;
            const messageText = messageInput.value.trim();
            if (messageText === '' || !userId || !currentUserName) return;
            
            initChatAudio(); 
            
            const messageData = {
                text: messageText,
                userId: userId, 
                username: currentUserName, 
                timestamp: serverTimestamp()
            };
            
            try {
                if (chatCurrentChat.type === 'group') {
                    await addDoc(chatPaths.groupChatCollection(), messageData);
                } else {
                    await addDoc(chatPaths.privateChatCollection(chatCurrentChat.id), messageData);
                }
                messageInput.value = '';
            } catch (e) {
                showAlert("Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©.");
            }
        }
        
        /**
         * (Ø¬Ø¯ÙŠØ¯) Ø­Ø°Ù Ø±Ø³Ø§Ù„Ø© (Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·)
         * @param {string} messageId - Ù…Ø¹Ø±Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙÙŠ Firestore
         */
        window.deleteChatMessage = async function(messageId) {
            if (!isUserAdmin || !messageId) return;

            if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŸ")) return;

            try {
                let docRef;
                if (chatCurrentChat.type === 'group') {
                    docRef = doc(db, 'chat_group', messageId);
                } else {
                    // chatId Ù‡Ùˆ Ù…Ø³Ø§Ø± Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚ Ø§Ù„ÙØ±Ø¹ÙŠØ©
                    docRef = doc(db, `chat_private/${chatCurrentChat.id}/messages`, messageId); 
                }
                
                await deleteDoc(docRef);
                showAlert("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­ (ÙƒÙ…Ø¯ÙŠØ±).", 'success');
            } catch (e) {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©:", e);
                showAlert("ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©.");
            }
        }

        /**
         * (Ø¬Ø¯ÙŠØ¯) Ø±Ø³Ù… Ù‚Ø§Ø¦Ù…Ø© Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
         */
        function renderChatMessages(messages) {
            if (!chatMessagesDiv) return;
            if (messages.length === 0) {
                chatMessagesDiv.innerHTML = '<div class="text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø¨Ø¹Ø¯.</div>';
                return;
            }
            
            chatMessagesDiv.innerHTML = messages.map(msg => {
                const isSender = msg.userId === userId; 
                const senderName = isSender ? 'Ø£Ù†Øª' : (msg.username || 'Ù…Ø³ØªØ®Ø¯Ù…');
                const time = msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' }) : '';
                
                // Ø¥Ø¶Ø§ÙØ© Ø¯Ø¹Ù… Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„ØªØ¹Ø¨ÙŠØ±ÙŠØ© Ø§Ù„Ø¨Ø³ÙŠØ·
                const formattedText = replaceEmojis(msg.text);
                
                // Ø²Ø± Ø§Ù„Ø­Ø°Ù (ÙŠØ¸Ù‡Ø± Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·)
                const deleteButton = isUserAdmin ? `
                    <button onclick="deleteChatMessage('${msg.id}')" class="text-red-300 hover:text-red-500 transition-colors ml-2" title="Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©">
                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                    </button>
                ` : '';

                if (isSender) {
                    return `
                        <div class="flex justify-start">
                            <div class="max-w-xs px-4 py-3 rounded-lg bg-blue-500 text-white shadow-md">
                                <p class="text-sm font-semibold mb-1">${senderName}</p>
                                <p class="text-base break-words">${formattedText}</p>
                                <div class="flex justify-between items-center text-xs text-blue-200 mt-1">
                                    ${deleteButton}
                                    <span>${time}</span>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    return `
                        <div class="flex justify-end">
                            <div class="max-w-xs px-4 py-3 rounded-lg bg-gray-200 text-gray-800 shadow-md">
                                <p class="text-sm font-semibold mb-1">${senderName}</p>
                                <p class="text-base break-words">${formattedText}</p>
                                <div class="flex justify-between items-center text-xs text-gray-500 mt-1">
                                    ${deleteButton}
                                    <span>${time}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }).join('');
            
            chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
        }
        
        /**
         * (Ø¬Ø¯ÙŠØ¯) Ø±Ø³Ù… Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø§Øª Ø§Ù„Ø®Ø§ØµØ© (Ø§Ù„Ù…Ø¯ÙŠØ±ÙŠÙ† Ø£Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†)
         */
        function renderPrivateChatList() {
            if (!chatUsersListDiv) return;
            
            let usersHtml = '';
            
            if (isUserAdmin) {
                Object.keys(chatAllUsers).forEach(uid => {
                    if (uid === userId) return;
                    
                    const user = chatAllUsers[uid];
                    const chatId = getPrivateChatId(uid);
                    const unreadCount = chatUnreadCounts[chatId] || 0;
                    
                    usersHtml += `
                        <div id="chat-tab-${chatId.replace(':', '-')}" class="p-4 flex justify-between items-center cursor-pointer border-b hover:bg-gray-100" onclick="selectChat('private', '${uid}')">
                            <div>
                                <h3 class="font-semibold text-gray-900">${user.name || `Ù…Ø³ØªØ®Ø¯Ù… ${uid.substring(0, 5)}`}</h3>
                                <p class="text-sm text-gray-600 truncate">${user.role || 'viewer'}</p>
                            </div>
                            <span id="unread-badge-${chatId.replace(':', '-')}" class="${unreadCount > 0 ? '' : 'hidden'} w-6 h-6 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center">${unreadCount}</span>
                        </div>
                    `;
                });
                chatUsersListDiv.innerHTML = usersHtml || '<p class="p-4 text-sm text-gray-500">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø¢Ø®Ø±ÙˆÙ† Ø¨Ø¹Ø¯.</p>';
                
            } else {
                Object.keys(chatAdminList).forEach(uid => {
                    if (uid === userId) return;
                    
                    const admin = chatAdminList[uid];
                    const chatId = getPrivateChatId(uid);
                    const unreadCount = chatUnreadCounts[chatId] || 0;
                    
                    usersHtml += `
                        <div id="chat-tab-${chatId.replace(':', '-')}" class="p-4 flex justify-between items-center cursor-pointer border-b hover:bg-gray-100" onclick="selectChat('private', '${uid}')">
                            <div>
                                <h3 class="font-semibold text-gray-900">${admin.name || `Ù…Ø¯ÙŠØ± ${uid.substring(0, 5)}`}</h3>
                                <p class="text-sm text-gray-600">Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…</p>
                            </div>
                            <span id="unread-badge-${chatId.replace(':', '-')}" class="${unreadCount > 0 ? '' : 'hidden'} w-6 h-6 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center">${unreadCount}</span>
                        </div>
                    `;
                });
                chatUsersListDiv.innerHTML = usersHtml || '<p class="p-4 text-sm text-gray-500">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¯ÙŠØ±ÙˆÙ† Ù…ØªØ§Ø­ÙˆÙ† Ù„Ù„Ø¯Ø±Ø¯Ø´Ø©.</p>';
            }
            
             const activeTab = document.getElementById(`chat-tab-${chatCurrentChat.id.replace(':', '-')}`);
             if (activeTab && chatMessageView.classList.contains('hidden')) {
                 activeTab.classList.add('bg-blue-50', 'border-r-4', 'border-blue-500');
             }
        }

        /**
         * (Ø¬Ø¯ÙŠØ¯) Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ØºÙŠØ± Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø©
         */
        function listenToChatUnreadCounts() {
            if (!userId) return;
            const chatStateQuery = chatPaths.userChatStateCollection(userId); 
            chatMessageListeners['all-state'] = onSnapshot(chatStateQuery, (snapshot) => {
                let totalUnread = 0; // Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙƒÙ„ÙŠ Ù„Ù„Ø²Ø± Ø§Ù„Ø¹Ø§Ø¦Ù…
                
                snapshot.forEach(doc => {
                    const chatId = doc.id;
                    const count = doc.data().unreadCount || 0;
                    chatUnreadCounts[chatId] = count;
                    totalUnread += count; // Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙƒÙ„ÙŠ
                    
                    const badge = document.getElementById(`unread-badge-${chatId.replace(':', '-')}`);
                    if (badge) {
                        badge.textContent = count;
                        badge.classList.toggle('hidden', count === 0);
                    }
                });
                
                // ØªØ­Ø¯ÙŠØ« Ø´Ø§Ø±Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ø¦Ù…Ø©
                if (chatTotalBadge) {
                    chatTotalBadge.textContent = totalUnread;
                    chatTotalBadge.classList.toggle('hidden', totalUnread === 0);
                }

                if (isUserAdmin) {
                    renderPrivateChatList();
                }

            }, (error) => console.error("Error listening to chat states:", error));
        }

        /**
         * (Ø¬Ø¯ÙŠØ¯) Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø¯Ø§Ø¦Ù…Ø© Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ ØºÙŠØ± Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø©
         */
        function setupPersistentChatListeners() {
            if (!userId) return;
            
            // 1. Ù…Ø³ØªÙ…Ø¹ Ø¯Ø§Ø¦Ù… Ù„Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ©
            const groupQuery = query(chatPaths.groupChatCollection(), orderBy("timestamp", "desc"), limit(1));
            chatMessageListeners['unread-group'] = onSnapshot(groupQuery, (snapshot) => {
                if (snapshot.docChanges().length > 0 && snapshot.docChanges()[0].type === 'added') {
                    const newMessage = snapshot.docChanges()[0].doc.data();
                    if (newMessage.userId !== userId && chatCurrentChat.id !== 'group') {
                        const now = Date.now();
                        const msgTime = newMessage.timestamp?.toDate().getTime() || now;
                        if ((now - msgTime) < 10000) { 
                            incrementChatUnreadCount('group');
                        }
                    }
                }
            });
            
            // 2. Ù…Ø³ØªÙ…Ø¹Ø§Øª Ù„Ù„Ø¯Ø±Ø¯Ø´Ø§Øª Ø§Ù„Ø®Ø§ØµØ©
            const usersToListen = isUserAdmin ? Object.keys(chatAllUsers) : Object.keys(chatAdminList);
            
            usersToListen.forEach(uid => {
                if (uid === userId) return;
                const chatId = getPrivateChatId(uid);
                
                // ØªØ¬Ù†Ø¨ ØªÙƒØ±Ø§Ø± Ø§Ù„Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø¥Ø°Ø§ ØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¯Ø§Ù„Ø© Ù…Ø±Ø§Ø±Ø§Ù‹
                if (chatMessageListeners[`unread-${chatId}`]) return; 
                
                const q = query(chatPaths.privateChatCollection(chatId), orderBy("timestamp", "desc"), limit(1));
                chatMessageListeners[`unread-${chatId}`] = onSnapshot(q, (snapshot) => {
                     if (snapshot.docChanges().length > 0 && snapshot.docChanges()[0].type === 'added') {
                          const newMessage = snapshot.docChanges()[0].doc.data();
                          if (newMessage.userId !== userId && chatCurrentChat.id !== chatId) {
                              const now = Date.now();
                              const msgTime = newMessage.timestamp?.toDate().getTime() || now;
                              if ((now - msgTime) < 10000) {
                                  incrementChatUnreadCount(chatId);
                              }
                          }
                     }
                });
            });
        }
        
        /**
         * (Ø¬Ø¯ÙŠØ¯) Ø²ÙŠØ§Ø¯Ø© Ø¹Ø¯Ø§Ø¯ ØºÙŠØ± Ù…Ù‚Ø±ÙˆØ¡
         */
        async function incrementChatUnreadCount(chatId) {
            if (!userId) return;
            const docRef = chatPaths.userChatStateDoc(userId, chatId);
            try {
                const docSnap = await getDoc(docRef);
                const currentCount = docSnap.exists() ? (docSnap.data().unreadCount || 0) : 0;
                await setDoc(docRef, { unreadCount: currentCount + 1 }, { merge: true });
                playChatNotificationSound(); // ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª Ù‡Ù†Ø§
            } catch (e) {
                // (ÙØ´Ù„)
            }
        }
        
        /**
         * (Ø¬Ø¯ÙŠØ¯) ØªØµÙÙŠØ± Ø¹Ø¯Ø§Ø¯ ØºÙŠØ± Ù…Ù‚Ø±ÙˆØ¡
         */
        async function clearChatUnreadCount(chatId) {
            if (!userId) return;
            const docRef = chatPaths.userChatStateDoc(userId, chatId);
            try {
                await setDoc(docRef, { unreadCount: 0 }, { merge: true });
            } catch (e) {
                // (ÙØ´Ù„)
            }
        }

        // =================================================================
        // == Ù†Ù‡Ø§ÙŠØ© Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ù…Ø¯Ù…Ø¬ ==
        // =================================================================

    </script>
</head>
<body class="bg-gray-100">

    <div class="flex flex-col min-h-screen">

        <header class="bg-teal-700 text-white p-4 shadow-lg">
            <div class="container mx-auto flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <svg class="w-10 h-10" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 21v-8.25M15.75 21v-8.25M8.25 21v-8.25M3 9l9-6 9 6m-1.5 12V10.332A48.36 48.36 0 0012 9.75c-2.551 0-5.056.2-7.5.582V21M3 21h18M12 6.75h.008v.008H12V6.75z" />
                    </svg>
                    <h1 class="text-2xl font-bold">Ù…Ù†ØµØ© Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø±Ø§Ø´Ø¯ÙˆÙ†</h1>
                </div>
                <div class="flex items-center gap-3">
                    <span id="user-name-display" class="hidden md:inline"></span>
                    <svg id="user-avatar" class="w-8 h-8 bg-white text-teal-700 rounded-full p-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" />
                    </svg>
                </div>
            </div>
        </header>

        <nav class="bg-white shadow-md p-3 sticky top-0 z-40">
            <div class="container mx-auto flex justify-center items-center gap-2 md:gap-4 flex-wrap">
                <div class="relative hidden flex-shrink-0"> 
                    <button id="admin-settings-btn" class="flex items-center gap-1 bg-gray-700 text-white px-3 py-1 text-sm sm:text-base rounded-lg shadow-md hover:bg-gray-800 transition duration-300">
                        <svg class="w-5 h-5 sm:w-6 sm:h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-1.003 1.11-1.226.554-.223 1.19-.02 1.61.428.39.39.582.936.582 1.48v.081c.01.04.02.079.03.118.22.879.683 1.657 1.3 2.27.618.614 1.39 1.062 2.27 1.3.039.01.078.02.118.03h.082c.543 0 1.09.192 1.48.582.449.42.65.956.428 1.61-.223.554-.684 1.018-1.226 1.11a47.803 47.803 0 01-1.02.078c-.468 0-.93.04-1.38.118-.614.108-1.17.318-1.67.614-.5.3-.95.666-1.35 1.087-.4.42-.76.9-1.087 1.35-.296.5-.506 1.056-.614 1.67-.078.45-.118.912-.118 1.38 0 .36.026.712.078 1.02.09.542.56 1.003 1.11 1.226.554.223 1.19-.02 1.61-.428.39.39.582.936.582 1.48v-.081c-.01-.04-.02-.079-.03-.118a6.74 6.74 0 00-1.3-2.27 6.703 6.703 0 00-2.27-1.3c-.039-.01-.078-.02-.118-.03h-.082c-.543 0-1.09-.192-1.48-.582-.449-.42-.65-.956-.428-1.61.223-.554.684-1.018-1.226-1.11a47.803 47.803 0 01-1.02-.078c-.468 0-.93-.04-1.38-.118-.614-.108-1.17-.318-1.67.614-.5-.3-.95-.666-1.35 1.087-.4-.42-.76-.9-1.087-1.35-.296-.5-.506-1.056-.614-1.67-.078-.45-.118.912-.118-1.38 0-.36.026.712.078-1.02.09-.542.56 1.003 1.11-1.226.554-.223 1.19-.02 1.61.428.39.39.582.936.582 1.48v.081c.01.04.02.079.03.118.22.879.683 1.657 1.3 2.27.618.614 1.39 1.062 2.27 1.3.039.01.078.02.118.03h.082c.543 0 1.09.192 1.48.582.449.42.65.956.428 1.61-.223-.554-.684-1.018-1.226-1.11a47.803 47.803 0 01-1.02-.078c-.468 0-.93-.04-1.38-.118z" /></svg>
                        ØªØ­ÙƒÙ…
                    </button>
                </div>
                
                <div class="relative hidden flex-shrink-0"> 
                    <button id="admin-manage-btn" class="flex items-center gap-1 bg-blue-600 text-white px-3 py-1 text-sm sm:text-base rounded-lg shadow-md hover:bg-blue-700 transition duration-300">
                        <svg class="w-5 h-5 sm:w-6 sm:h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM12 15a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" /></svg>
                        Ø¥Ø¯Ø§Ø±Ø© 
                    </button>
                </div>
                <div class="relative hidden flex-shrink-0"> 
                    <button id="admin-perms-btn" class="flex items-center gap-1 bg-yellow-500 text-white px-3 py-1 text-sm sm:text-base rounded-lg shadow-md hover:bg-yellow-600 transition duration-300">
                        <svg class="w-5 h-5 sm:w-6 sm:h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        Ø·Ù„Ø¨Ø§Øª
                    </button>
                    <span id="admin-perms-badge" class="notification-badge hidden">0</span>
                </div>
                <div class="relative hidden flex-shrink-0"> 
                    <button id="add-section-btn" class="flex items-center gap-1 bg-green-500 text-white px-3 py-1 text-sm sm:text-base rounded-lg shadow-md hover:bg-green-600 transition duration-300">
                        <svg class="w-5 h-5 sm:w-6 sm:h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v6m3-3H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        Ø¥Ø¶Ø§ÙØ© 
                    </button>
                </div>
                
                <button id="delete-all-chat-btn" class="hidden flex items-center gap-1 bg-red-700 text-white px-3 py-1 text-sm sm:text-base rounded-lg shadow-md hover:bg-red-800 transition duration-300 flex-shrink-0">
                    <svg class="w-5 h-5 sm:w-6 sm:h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12.578 0a48.09 48.09 0 013.478-.397m7.5 0a48.09 48.09 0 00-7.5 0" /></svg>
                    Ø§Ù„Ø¯Ø±Ø¯Ø´Ø§Øª
                </button>

                <button id="print-sections-btn" class="hidden flex items-center gap-1 bg-gray-600 text-white px-3 py-1 text-sm sm:text-base rounded-lg shadow-md hover:bg-gray-700 transition duration-300 flex-shrink-0">
                    <svg class="w-5 h-5 sm:w-6 sm:h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                       <path fill-rule="evenodd" d="M5 2.75C5 1.784 5.784 1 6.75 1h6.5c.966 0 1.75.784 1.75 1.75v3.5A1.75 1.75 0 0113.25 8H6.75A1.75 1.75 0 015 6.25v-3.5zm.75 0v3.5c0 .138.112.25.25.25h6.5a.25.25 0 00.25-.25v-3.5a.25.25 0 00-.25-.25h-6.5a.25.25 0 00-.25.25zM6 10.75A.75.75 0 016.75 10h6.5a.75.75 0 010 1.5h-6.5A.75.75 0 016 10.75zM6 13.75A.75.75 0 016.75 13h6.5a.75.75 0 010 1.5h-6.5A.75.75 0 016 13.75zM3.25 9A1.75 1.75 0 001.5 10.75v3.5c0 .966.784 1.75 1.75 1.75h1.25a.75.75 0 010 1.5H3.25A3.25 3.25 0 010 14.25v-3.5A3.25 3.25 0 013.25 7.5h13.5A3.25 3.25 0 0120 10.75v3.5A3.25 3.25 0 0116.75 17.5h-1.25a.75.75 0 010-1.5h1.25A1.75 1.75 0 0018.5 14.25v-3.5A1.75 1.75 0 0016.75 9H3.25z" clip-rule="evenodd" />
                    </svg>
                    Ø§Ù„ÙƒÙ„
                </button>
                <button id="logout-btn" class="hidden flex items-center gap-1 bg-red-500 text-white px-3 py-1 text-sm sm:text-base rounded-lg shadow-md hover:bg-red-600 transition duration-300 flex-shrink-0">
                    <svg class="w-5 h-5 sm:w-6 sm:h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M12 9l-3 3m0 0l3 3m-3-3h12.75" /></svg>
                    Ø®Ø±ÙˆØ¬
                </button>
                <button id="login-admin-btn" class="flex items-center gap-1 bg-teal-600 text-white px-3 py-1 text-sm sm:text-base rounded-lg shadow-md hover:bg-teal-700 transition duration-300 flex-shrink-0">
                    <svg class="w-5 h-5 sm:w-6 sm:h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M12 9l-3 3m0 0l3 3m-3-3h12.75" /></svg>
                    ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                </button>
            </div>
        </nav>

        <main class="flex-grow p-4 md:p-8">
            <div id="sections-container" class="container mx-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <p id="initial-loading-message" class="text-gray-500 text-center col-span-3 text-xl p-10">
                    Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...
                </p>
            </div>
        </main>
    </div>

    <div id="selection-bar" class="bg-gray-800 text-white shadow-lg p-3">
        <div class="container mx-auto flex flex-wrap justify-center md:justify-between items-center gap-3">
            <span class="text-lg font-semibold">ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù†Ø§ØµØ±:</span>
            <div class="flex flex-wrap justify-center gap-3">
                <button id="selection-share-btn" class="flex items-center gap-2 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 16 16"> <path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 014.66 1.931 6.557 6.557 0 011.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z"/> </svg>
                    Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…Ø­Ø¯Ø¯
                    <span id="selection-count-share"></span>
                </button>
                <button id="selection-print-btn" class="flex items-center gap-2 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                       <path fill-rule="evenodd" d="M5 2.75C5 1.784 5.784 1 6.75 1h6.5c.966 0 1.75.784 1.75 1.75v3.5A1.75 1.75 0 0113.25 8H6.75A1.75 1.75 0 015 6.25v-3.5zm.75 0v3.5c0 .138.112.25.25.25h6.5a.25.25 0 00.25-.25v-3.5a.25.25 0 00-.25-.25h-6.5a.25.25 0 00-.25.25zM6 10.75A.75.75 0 016.75 10h6.5a.75.75 0 010 1.5h-6.5A.75.75 0 016 10.75zM6 13.75A.75.75 0 016.75 13h6.5a.75.75 0 010 1.5h-6.5A.75.75 0 016 13.75zM3.25 9A1.75 1.75 0 001.5 10.75v3.5c0 .966.784 1.75 1.75 1.75h1.25a.75.75 0 010 1.5H3.25A3.25 3.25 0 010 14.25v-3.5A3.25 3.25 0 013.25 7.5h13.5A3.25 3.25 0 0120 10.75v3.5A3.25 3.25 0 0116.75 17.5h-1.25a.75.75 0 010-1.5h1.25A1.75 1.75 0 0018.5 14.25v-3.5A1.75 1.75 0 0016.75 9H3.25z" clip-rule="evenodd" />
                    </svg>
                    Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯
                    <span id="selection-count-print"></span>
                </button>
                <button id="selection-clear-btn" class="flex items-center gap-2 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" /></svg>
                    Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯
                </button>
            </div>
        </div>
    </div>

    <div class="fixed bottom-6 right-6 z-50">
        <button id="chat-toggle" class="bg-blue-600 text-white rounded-full w-16 h-16 flex items-center justify-center shadow-xl hover:bg-blue-700 transition-transform hover:scale-110 relative">
            <svg class="w-8 h-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.76c0 1.6 1.123 2.994 2.707 3.227 1.087.16 2.185.283 3.293.369V21l4.076-4.076a1.526 1.526 0 011.037-.443h2.88a1.875 1.875 0 001.875-1.875V16.5m-13.5-3.825V6.375c0-1.6 1.123-2.994 2.707-3.227 1.087.16 2.185.283 3.293.369V3l4.076 4.076a1.526 1.526 0 011.037.443h2.88a1.875 1.875 0 011.875 1.875v1.65M16.5 12V6.375m0 5.625v3.825m0 0v3.75m-13.5-3.75h13.5" />
            </svg>
            <span id="chat-total-badge" class="hidden absolute top-0 right-0 transform translate-x-1/2 -translate-y-1/2 bg-red-500 text-white text-xs font-bold rounded-full w-6 h-6 flex items-center justify-center">0</span>
        </button>
    </div>

    <div id="login-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[100] p-4">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md text-center">
            <svg class="w-20 h-20 text-teal-600 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 21v-8.25M15.75 21v-8.25M8.25 21v-8.25M3 9l9-6 9 6m-1.5 12V10.332A48.36 48.36 0 0012 9.75c-2.551 0-5.056.2-7.5.582V21M3 21h18M12 6.75h.008v.008H12V6.75z" />
            </svg>
            <h2 class="text-3xl font-bold text-gray-800 mb-2">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ / Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</h2>
            <p class="text-gray-600 mb-6">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù„Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ù†ØµØ©.</p>
            <form id="login-form">
                <div class="mb-4 text-right">
                    <label for="user-name-input" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ (Ù„Ù„ØªØ³Ø¬ÙŠÙ„)</label>
                    <input type="text" id="user-name-input" class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500 text-lg" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
                </div>
                <div class="mb-4 text-right">
                    <label for="user-email-input" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                    <input type="email" id="user-email-input" required class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500 text-lg" placeholder="example@domain.com">
                </div>
                 <div class="mb-4 text-right">
                    <label for="user-password-input" class="block text-sm font-medium text-gray-700 mb-1">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)</label>
                    <input type="password" id="user-password-input" required class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500 text-lg" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                </div>
                <p id="login-error" class="hidden text-red-500 text-sm mb-4"></p>
                <div class="flex flex-col gap-3">
                    <button type="submit" class="w-full bg-teal-600 text-white py-3 px-5 rounded-lg hover:bg-teal-700 transition-colors font-bold text-lg">
                        ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                    </button>
                    <button type="button" id="register-new-user-btn" class="w-full bg-gray-500 text-white py-3 px-5 rounded-lg hover:bg-gray-600 transition-colors font-bold text-lg">
                        Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="chat-window" class="hidden fixed bottom-24 right-6 w-96 h-[500px] bg-white rounded-lg shadow-2xl flex flex-col z-50 overflow-hidden">
        
        <div id="chat-list-view" class="flex flex-col h-full">
            <div class="flex justify-between items-center p-3 bg-blue-600 text-white">
                <h3 id="chat-list-header-title" class="font-bold">Ø§Ù„Ø¯Ø±Ø¯Ø´Ø§Øª</h3>
                <button id="close-chat" class="text-white text-2xl">&times;</button>
            </div>
            
            <div id="chat-user-info" class="p-3 border-b text-sm">
                <p>Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ <span id="chat-username-display" class="font-semibold">...</span></p>
                <button id="delete-all-chat-btn-in-chat-window" class="hidden text-red-500 text-xs font-semibold mt-1 hover:text-red-700" onclick="deleteAllChats()">
                     [Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©]
                 </button>
            </div>

            <div class="flex-grow overflow-y-auto">
                <div id="chat-tab-group" class="p-4 flex justify-between items-center cursor-pointer border-b hover:bg-gray-100" onclick="selectChat('group', 'group')">
                    <div>
                        <h3 class="font-semibold text-gray-900">Ø¯Ø±Ø¯Ø´Ø© Ø¬Ù…Ø§Ø¹ÙŠØ©</h3>
                        <p class="text-sm text-gray-600">Ø±Ø³Ø§Ø¦Ù„ Ø¹Ø§Ù…Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹</p>
                    </div>
                    <span id="unread-badge-group" class="hidden w-6 h-6 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center">0</span>
                </div>
                
                <div class="p-4 border-b">
                    <h3 class="private-chat-header flex justify-between items-center">
                        Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø®Ø§ØµØ©
                        <span id="unread-badge-private-total" class="hidden w-6 h-6 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center">0</span>
                    </h3>
                </div>
                
                <div id="chat-users-list" class="flex-grow overflow-y-auto">
                    <p class="p-4 text-sm text-gray-500">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†...</p>
                </div>
            </div>
        </div>

        <div id="chat-message-view" class="hidden flex flex-col h-full">
            <div class="flex justify-between items-center p-3 bg-blue-600 text-white">
                <button id="chat-back-btn" class="text-white p-1 rounded-full hover:bg-blue-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l-4-4 4-4M9 5l-7 7 7 7"></path></svg>
                </button>
                <div class="text-right flex-grow min-w-0 px-2">
                    <h3 id="chat-title" class="font-bold truncate">...</h3>
                    <p id="chat-subtitle" class="text-xs truncate">...</p>
                </div>
                <button id="close-chat-2" class="text-white text-2xl flex-shrink-0">&times;</button>
            </div>
            
            <div id="chat-messages" class="flex-1 p-3 overflow-y-auto bg-gray-50 space-y-3">
                </div>
            
            <form id="message-form" class="p-3 border-t flex gap-2 bg-white relative">
                <input type="text" id="message-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." autocomplete="off"
                        class="flex-1 px-3 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 relative z-0">
                
                <button type="submit"
                         class="bg-blue-500 text-white w-10 h-10 rounded-full font-semibold hover:bg-blue-600 flex-shrink-0 flex items-center justify-center relative z-10">
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.875L6 12z" />
                    </svg>
                </button>
            </form>
        </div>
    </div>

    <div id="add-item-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4 transition-opacity duration-300">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md transform transition-all scale-95 opacity-0" id="modal-content">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 class="text-2xl font-bold text-gray-800">Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ± Ø¬Ø¯ÙŠØ¯</h3>
                <button id="close-modal" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
            </div>
            <div class="border-b border-gray-200 mb-4">
                <nav class="-mb-px flex gap-4" aria-label="Tabs">
                    <button id="tab-link" class="w-1/2 py-4 px-1 text-center border-b-2 font-medium text-sm border-teal-500 text-teal-600">
                        Ø¥Ø¶Ø§ÙØ© Ø±Ø§Ø¨Ø·
                    </button>
                    <button id="tab-file" class="w-1/2 py-4 px-1 text-center border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        Ø±ÙØ¹ Ù…Ù„Ù
                    </button>
                </nav>
            </div>
            <form id="add-item-form">
                <input type="hidden" id="column-id-input">
                <input type="hidden" id="item-type-input" value="link">
                <div class="space-y-4">
                    <div>
                        <label for="item-title" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (Ù…Ø·Ù„ÙˆØ¨)</label>
                        <input type="text" id="item-title" name="item-title" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500">
                    </div>
                    <div id="link-input-section">
                        <label for="item-link" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ø±Ø§Ø¨Ø· (URL)</label>
                        <input type="url" id="item-link" name="item-link" placeholder="https://example.com" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500">
                    </div>
                    <div id="file-input-section" class="hidden">
                        <label for="item-file" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ø®ØªØ± Ù…Ù„Ù</label>
                        <input type="file" id="item-file" name="item-file" class="w-full text-sm text-gray-500
                            file:mr-4 file:py-2 file:px-4
                            file:rounded-lg file:border-0
                            file:text-sm file:font-semibold
                            file:bg-teal-50 file:text-teal-700
                            hover:file:bg-teal-100">
                    </div>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" id="cancel-modal" class="py-2 px-4 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                        Ø¥Ù„ØºØ§Ø¡
                    </button>
                    <button type="submit" class="py-2 px-5 bg-teal-600 text-white rounded-lg hover:bg-teal-700 transition-colors font-semibold">
                        Ø¥Ø¶Ø§ÙØ©
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="add-section-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4 transition-opacity duration-300">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md transform transition-all scale-95 opacity-0" id="add-section-modal-content">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 class="text-2xl font-bold text-gray-800">Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… Ø¬Ø¯ÙŠØ¯</h3>
                <button id="close-section-modal" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
            </div>
            <form id="add-section-form">
                <input type="hidden" id="section-icon" value="ğŸ“š"> <div class="space-y-4">
                    <div>
                        <label for="section-title" class="block text-sm font-medium text-gray-700 mb-1">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù‚Ø³Ù…</label>
                        <input type="text" id="section-title" name="section-title" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ø§Ø®ØªØ± Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù„Ù„Ù‚Ø³Ù…</label>
                        <div id="add-section-icon-picker" class="icon-picker">
                            </div>
                    </div>
                    <div class="flex items-center">
                        <input id="section-visibility" type="checkbox" checked class="w-4 h-4 text-teal-600 border-gray-300 rounded focus:ring-teal-500">
                        <label for="section-visibility" class="mr-2 text-sm font-medium text-gray-900">Ø¥Ø¸Ù‡Ø§Ø± Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ù„Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ† Ø§Ù„Ø¹Ø§Ø¯ÙŠÙŠÙ†</label>
                    </div>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" id="cancel-section-modal" class="py-2 px-4 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                        Ø¥Ù„ØºØ§Ø¡
                    </button>
                    <button type="submit" class="py-2 px-5 bg-teal-600 text-white rounded-lg hover:bg-teal-700 transition-colors font-semibold">
                        Ø¥Ø¶Ø§ÙØ©
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="edit-section-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 class="text-2xl font-bold text-gray-800">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø³Ù…</h3>
                <button id="close-edit-section-modal" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
            </div>
            <form id="edit-section-form">
                <input type="hidden" id="edit-section-id">
                <input type="hidden" id="edit-section-icon" value="ğŸ“š"> <div class="space-y-4">
                    <div>
                        <label for="edit-section-title" class="block text-sm font-medium text-gray-700 mb-1">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù‚Ø³Ù…</label>
                        <input type="text" id="edit-section-title" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ø§Ø®ØªØ± Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù„Ù„Ù‚Ø³Ù…</label>
                        <div id="edit-section-icon-picker" class="icon-picker">
                            </div>
                    </div>
                    <div class="flex items-center">
                        <input id="edit-section-visibility" type="checkbox" class="w-4 h-4 text-teal-600 border-gray-300 rounded focus:ring-teal-500">
                        <label for="edit-section-visibility" class="mr-2 text-sm font-medium text-gray-900">Ø¥Ø¸Ù‡Ø§Ø± Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ù„Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ† Ø§Ù„Ø¹Ø§Ø¯ÙŠÙŠÙ†</label>
                    </div>
                </div>
                <div id="current-editors-container" class="hidden mt-6">
                    <h4 class="text-lg font-semibold text-gray-800 mb-2 border-t pt-4">Ø§Ù„Ù…Ø­Ø±Ø±ÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠÙˆÙ†</h4>
                    <p class="text-sm text-gray-500 mb-3">ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø²Ø§Ù„Ø© ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ØªØ­Ø±ÙŠØ± Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø¶Ø§ÙÙŠÙ† Ù‡Ù†Ø§.</p>
                    <div class="max-h-40 overflow-y-auto bg-gray-50 rounded-lg p-3">
                        <ul id="current-editors-list" class="divide-y divide-gray-200">
                            </ul>
                    </div>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" id="cancel-edit-section-modal" class="py-2 px-4 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="submit" class="py-2 px-5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
                </div>
            </form>
        </div>
    </div>

    <div id="edit-item-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 class="text-2xl font-bold text-gray-800">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù†ØµØ±</h3>
                <button id="close-edit-item-modal" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
            </div>
            <form id="edit-item-form">
                <input type="hidden" id="edit-item-id">
                <input type="hidden" id="edit-item-section-id">
                <div class="space-y-4">
                    <div>
                        <label for="edit-item-title" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
                        <input type="text" id="edit-item-title" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500">
                    </div>
                    <div>
                        <label for="edit-item-link" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ø±Ø§Ø¨Ø· (URL)</label>
                        <input type="url" id="edit-item-link" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500">
                    </div>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" id="cancel-edit-item-modal" class="py-2 px-4 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="submit" class="py-2 px-5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
                </div>
            </form>
        </div>
    </div>

    <div id="alert-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[60] p-4 transition-opacity duration-300">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm transform transition-all scale-95 opacity-0" id="alert-modal-content">
            <h3 class="text-xl font-bold text-gray-800 mb-4">ØªÙ†Ø¨ÙŠÙ‡</h3>
            <p id="alert-modal-message" class="text-gray-600 mb-6">Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ù‡Ù†Ø§.</p>
            <div class="flex justify-end">
                <button id="close-alert-modal" class="py-2 px-5 bg-teal-600 text-white rounded-lg hover:bg-teal-700 font-semibold">
                    Ø­Ø³Ù†Ø§Ù‹
                </button>
            </div>
        </div>
    </div>

    <div id="pdf-spinner-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[100] p-4">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-xs text-center">
            <svg class="animate-spin h-12 w-12 text-teal-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
             <p class="text-gray-700 mt-4 font-semibold">Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù PDF...</p>
        </div>
    </div>

    <div id="admin-manage-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[70] p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 class="text-2xl font-bold text-gray-800">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</h3>
                <button id="close-admin-manage-modal" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
            </div>
            <div class="flow-root max-h-96 overflow-y-auto">
                <ul id="admin-users-list" role="list" class="divide-y divide-gray-200">
                    <li>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†...</li>
                </ul>
            </div>
        </div>
    </div>

    <div id="admin-perms-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[70] p-4">
         <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
             <div class="flex justify-between items-center border-b pb-3 mb-4">
                 <h3 class="text-2xl font-bold text-gray-800">Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©</h3>
                 <button id="close-admin-perms-modal" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
             </div>
             <div class="flow-root max-h-96 overflow-y-auto">
                 <ul id="admin-perms-list" role="list" class="divide-y divide-gray-200">
                     <li>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</li>
                 </ul>
             </div>
         </div>
     </div>

    <div id="admin-settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[70] p-4">
         <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
             <div class="flex justify-between items-center border-b pb-3 mb-4">
                 <h3 class="text-2xl font-bold text-gray-800">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„Ù…Ù†ØµØ©</h3>
                 <button id="close-admin-settings-modal" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
             </div>
             
             <div class="space-y-6">
                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg border">
                    <div>
                        <h4 class="text-lg font-semibold text-gray-900">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</h4>
                        <p class="text-sm text-gray-600">Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ© ÙˆØ§Ù„Ø®Ø§ØµØ©.</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="setting-toggle-chat" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:right-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>
                
                <div class="p-4 bg-yellow-50 rounded-lg border border-yellow-300">
                    <h4 class="text-lg font-semibold text-yellow-900">Ø¥Ù„ØºØ§Ø¡ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø­Ø±Ø±ÙŠÙ†</h4>
                    <p class="text-sm text-yellow-700 mt-1 mb-3">Ø³ÙŠÙ‚ÙˆÙ… Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø¨Ø¥Ø²Ø§Ù„Ø© ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ØªØ­Ø±ÙŠØ± Ù…Ù† (Ø¬Ù…ÙŠØ¹) Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (Ù…Ø§ Ø¹Ø¯Ø§ Ø§Ù„Ù…Ø¯Ø±Ø§Ø¡) Ø¹Ù† (Ø¬Ù…ÙŠØ¹) Ø§Ù„Ø£Ù‚Ø³Ø§Ù….</p>
                    <button id="setting-revoke-editors" class="w-full bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-600 transition-colors">
                        Ø¥Ù„ØºØ§Ø¡ Ø¬Ù…ÙŠØ¹ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¢Ù†
                    </button>
                </div>
                
                <div class="p-4 bg-red-50 rounded-lg border border-red-300">
                    <h4 class="text-lg font-semibold text-red-900">Ø¥Ù„ØºØ§Ø¡ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø¯Ø±Ø§Ø¡</h4>
                    <p class="text-sm text-red-700 mt-1 mb-3">Ø³ÙŠÙ‚ÙˆÙ… Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø¨Ø¥Ù„ØºØ§Ø¡ ØµÙ„Ø§Ø­ÙŠØ§Øª (Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¯Ø±Ø§Ø¡ Ø§Ù„Ø¢Ø®Ø±ÙŠÙ†) ÙˆØªØ­ÙˆÙŠÙ„Ù‡Ù… Ø¥Ù„Ù‰ "Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ†". (ØµÙ„Ø§Ø­ÙŠØ§ØªÙƒ Ø³ØªØ¨Ù‚Ù‰).</p>
                    <button id="setting-revoke-admins" class="w-full bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition-colors">
                        Ø¥Ù„ØºØ§Ø¡ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø¯Ø±Ø§Ø¡ Ø§Ù„Ø¢Ø®Ø±ÙŠÙ† Ø§Ù„Ø¢Ù†
                    </button>
                </div>
             </div>
             
         </div>
     </div>


</body>
</html>
