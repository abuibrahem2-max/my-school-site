<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منصة مدرسة الراشدون</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    
    <script>
        function replaceEmojis(text) {
             const emojiMap = {
                ':)': '😊', ':D': '😁', ':(': '😞', ';)': '😉', 
                ':|': '😐', ':o': '😮', '<3': '❤️', '8)': '😎'
             };
             let replacedText = text;
             for (const key in emojiMap) {
                 const safeKey = key.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
                 const regex = new RegExp(safeKey, 'g');
                 replacedText = replacedText.replace(regex, emojiMap[key]);
             }
             return replacedText;
        }
    </script>

    <style>
        /* تطبيق خط "Cairo" على كامل الصفحة */
        body {
            font-family: 'Cairo', sans-serif;
        }
        /* إخفاء شريط التمرير لنافذة الدردشة */
        #chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        #chat-messages::-webkit-scrollbar-thumb {
            background-color: #9ca3af; /* gray-400 */
            border-radius: 3px;
        }

        /* أنماط شارة الإشعارات */
        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: red;
            color: white;
            border-radius: 50%;
            padding: 0.1em 0.4em;
            font-size: 0.75rem; /* 12px */
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 1.25rem; /* 20px */
            height: 1.25rem; /* 20px */
            z-index: 10;
        }
        
        /* شارة الدردشة العائمة */
        #chat-total-badge {
            position: absolute;
            top: 0;
            right: 0;
            transform: translate(50%, -50%);
            background-color: red;
            color: white;
            border-radius: 50%;
            padding: 0.1em 0.5em;
            font-size: 0.85rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 1.75rem;
            height: 1.75rem;
            box-shadow: 0 0 0 3px #f3f4f6; /* gray-100 */
        }
        
        /* (جديد) تمييز عنوان "محادثات خاصة" */
        .private-chat-header {
            font-weight: bold;
            color: #008080; /* Teal - لون مميز */
            padding: 10px 0;
            border-bottom: 2px solid #008080;
        }


        /* أنماط خاصة بالطباعة (لإنشاء PDF) */
        .print-container {
            position: absolute;
            left: -9999px;
            top: -9999px;
            width: 210mm; /* A4 width */
            height: 297mm; /* A4 height (هام جداً) */
            padding: 15mm;
            background-color: white;
            color: black;
            font-family: 'Cairo', sans-serif;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }

        /* الترويسة العلوية */
        .print-super-header {
            background-color: #008080; /* Teal */
            color: white;
            padding: 15px;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 10px;
            line-height: 1.6;
            font-size: 16px;
        }

        .print-header {
            background-color: #008080; /* Teal */
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .print-header h1 {
            font-size: 28px;
            font-weight: bold;
            margin: 0;
        }

        /* حاوية المحتوى */
        .print-content-wrapper {
             flex-grow: 1; /* يدفع التذييل للأسفل */
        }

        .print-section {
            margin-bottom: 25px;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }
        .print-section-title {
            font-size: 22px;
            font-weight: bold;
            padding: 15px;
            background-color: #f4f4f4;
            border-bottom: 1px solid #ddd;
        }
        .print-item-list {
            padding: 15px;
        }
        .print-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }
        .print-item:last-child {
            border-bottom: none;
        }
        .print-item-text {
            flex-grow: 1;
            margin-right: 15px; /* (تعديل) إضافة مسافة لليمين */
        }
        .print-item-title {
            font-size: 18px;
            font-weight: 600;
        }
        .print-item-qr {
            width: 80px;
            height: 80px;
            margin-left: 15px; /* الحفاظ على المسافة لليسار */
            flex-shrink: 0; /* منع الباركود من الانكماش */
        }

        /* التذييل */
        .print-footer {
            display: flex;
            justify-content: space-between;
            padding-top: 15px;
            margin-top: 20px;
            border-top: 2px solid #008080;
            font-size: 14px;
            font-weight: 600;
        }
        
        /* (تعديل) نمط مقبض السحب والإفلات */
        .drag-handle {
            cursor: move;
            flex-shrink: 0;
            margin-left: 8px; 
            padding: 4px;
            border-radius: 4px;
            transition: background-color 0.2s;
            /* (جديد) تطبيق لون تركوازي غامق */
            color: #008080; 
        }
        .drag-handle:hover {
            background-color: #f3f4f6; /* gray-100 */
            color: #008080; /* تثبيت اللون في حالة التحويم */
        }
        
        /* (جديد) تأكد من أن البطاقة قابلة للسحب ولكن السحب يتم عبر المقبض فقط */
        .sortable-drag {
            opacity: 0.5 !important;
            border: 2px dashed #008080;
        }
        .sortable-ghost {
            opacity: 0.1;
        }
        
    </style>

    <script type="module">
        // استيراد مكتبات Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, 
             signInWithEmailAndPassword, // تم إضافته
             createUserWithEmailAndPassword, // تم إضافته
             onAuthStateChanged, 
             signOut 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, collection, addDoc, onSnapshot, query, 
            updateDoc, arrayUnion, getDoc, setDoc, deleteDoc, getDocs, 
            where, serverTimestamp, arrayRemove, orderBy, limit, writeBatch
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // *******************************************************************
        // ملاحظة هامة: إذا لم تظهر الأقسام بعد الدخول، يرجى التأكد من أن قواعد 
        // أمان Firestore تسمح للمستخدمين المصادق عليهم (request.auth != null)
        // بقراءة وكتابة مجموعات 'users' و 'sections'.
        // *******************************************************************

        // --- 1. إعدادات Firebase ---
        
        // (هام) يجب تغيير مفتاح API الخاص بك إذا كان هذا الكود سيُستخدم فعلياً
        const firebaseConfig = {
          apiKey: "AIzaSyCAabU3qzh2wmWmA8v95oabloap1PNyHwI",
          authDomain: "jaded-3ef9d.firebaseapp.com",
          projectId: "jaded-3ef9d",
          storageBucket: "jaded-3ef9d.firebasestorage.app",
          messagingSenderId: "240292137665",
          appId: "1:240292137665:web:02597426d8288ca0c16240"
        };
        
        // --- بيانات المدير (سيتم إدارتها عبر قاعدة بيانات المستخدمين) ---
        // تم إلغاء ثوابت ADMIN_USERNAME, ADMIN_PASSWORD
        const DEFAULT_ADMIN_EMAIL = "admin@rashedon.sa"; // الايميل الافتراضي للمدير
        // ------------------------------
        
        const CHAT_APP_ID = 'rashedon-app';

        // خدمات Firebase
        let app, auth, db, userId; // userId هو معرف المصادقة (Auth UID)
        let sectionsCollectionRef;
        let usersCollectionRef;
        let permissionRequestsCollectionRef;
        
        // (تعديل) تبسيط جميع المسارات لضمان عملها بشكل موثوق
        const sectionsPath = `sections`;
        const usersPath = `users`; 
        const permissionRequestsPath = `permissionRequests`;

        // متغيرات لحالة المستخدم (المنصة)
        let currentUserName = null; // اسم المستخدم (من تسجيل الدخول)
        let currentUserEmail = null; // البريد الإلكتروني
        let currentUserRole = 'viewer';
        let isUserAdmin = false;
        let isAppInitialized = false; // (جديد) لمنع التمهيد المتعدد
        
        // (تم تصحيح الخطأ هنا) تعريف المتغيرات عالميا (Global)
        const adminControls = ['add-section-btn', 'admin-manage-btn', 'admin-perms-btn'];
        const generalControls = ['print-sections-btn', 'logout-btn'];


        // متغيرات لإدارة المستمعين (Listeners)
        let permissionRequestsUnsubscribe = null; 

        // --- (جديد) متغيرات الدردشة ---
        let chatAllUsers = {}; 
        let chatAdminList = {}; 
        let chatCurrentChat = { type: 'group', id: 'group' };
        let chatUnreadCounts = {};
        let chatMessageListeners = {};
        let chatSynth;
        let chatSoundReady = false;
        
        // (تعديل) تبسيط مسارات الدردشة
        const chatPaths = {
            usersCollection: () => collection(db, usersPath), 
            userDoc: (uid) => doc(db, usersPath, uid), 
            groupChatCollection: () => collection(db, `chat_group`),
            privateChatCollection: (chatId) => collection(db, `chat_private/${chatId}`, 'messages'),
            userChatStateCollection: (uid) => collection(db, `chat_state/${uid}/state`), 
            userChatStateDoc: (uid, chatId) => doc(db, `chat_state/${uid}/state`, chatId),
        };
        // --- نهاية متغيرات الدردشة ---


        // --- 2. عناصر الصفحة (DOM) ---
        let sectionsContainer;
        let userNameDisplay, userAvatar;
        let permsBtnBadge;
        let initialLoadingMessage; 
        
        // (جديد) متغيرات عناصر الدردشة التي لم يتم تعريفها كـ let
        let chatWindow, chatListView, chatMessageView, closeChatBtn1, closeChatBtn2, chatBackBtn;
        let chatUsernameDisplay, chatUsersListDiv, chatMessagesDiv, messageForm, messageInput, chatTitle, chatSubtitle;
        
        // نوافذ (المنصة)
        let loginModal, loginForm, loginError;
        // تم إزالة userPasswordInput
        let addSectionModal, addSectionModalContent, addSectionForm, closeSectionModalBtn, cancelSectionModalBtn;
        let addItemModal, modalContent, closeModalBtn, cancelModalBtn, addItemForm, columnIdInput, itemTypeInput;
        let editSectionModal, editSectionForm, editSectionTitleInput, editSectionIdInput;
        let editItemModal, editItemForm, editItemTitleInput, editItemLinkInput, editItemIdInput, editItemSectionIdInput;
        let alertModal;
        let pdfSpinnerModal;
        let adminManageModal, adminUsersList;
        let adminPermsModal, adminPermsList;
        let currentEditorsList, currentEditorsContainer; 
        
        // (جديد) أزرار تسجيل الدخول/الخروج
        let logoutBtn, loginAdminBtn; // تم الإبقاء على اسم الزر ولكن وظيفته تغيرت لفتح المودال فقط
        let chatTotalBadge; // شارة الدردشة العائمة
        let deleteAllChatBtn; // زر حذف جميع الدردشات
        

        /**
         * =============================================
         * بدء تشغيل التطبيق
         * =============================================
         */
        document.addEventListener('DOMContentLoaded', () => {
            // تهيئة عناصر الصفحة الرئيسية (المنصة)
            sectionsContainer = document.getElementById('sections-container');
            userNameDisplay = document.getElementById('user-name-display');
            userAvatar = document.getElementById('user-avatar');
            pdfSpinnerModal = document.getElementById('pdf-spinner-modal');
            permsBtnBadge = document.getElementById('admin-perms-badge'); 
            initialLoadingMessage = document.getElementById('initial-loading-message'); 
            
            // (جديد) عناصر أزرار تسجيل الدخول/الخروج
            logoutBtn = document.getElementById('logout-btn');
            loginAdminBtn = document.getElementById('login-admin-btn');
            chatTotalBadge = document.getElementById('chat-toggle').querySelector('#chat-total-badge'); // شارة الدردشة الكلية
            deleteAllChatBtn = document.getElementById('delete-all-chat-btn'); // زر حذف جميع الدردشات

            // تهيئة نافذة تسجيل الدخول (المنصة)
            loginModal = document.getElementById('login-modal');
            loginForm = document.getElementById('login-form');
            loginError = document.getElementById('login-error');

            // === منطق التشغيل الجديد: يجب أن يتم تسجيل الدخول أولا ===
            
            // تهيئة Firebase مبكراً
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // تحديد مراجع المجموعات
            sectionsCollectionRef = collection(db, sectionsPath);
            usersCollectionRef = collection(db, usersPath);
            permissionRequestsCollectionRef = collection(db, permissionRequestsPath);

            // بدء مراقبة حالة المصادقة
            listenToAuthChanges();

            // ربط حدث إرسال نموذج تسجيل الدخول
            if (loginForm) loginForm.addEventListener('submit', handleLoginSubmit);
            
            // ربط زر تسجيل الدخول/الخروج
            if (loginAdminBtn) {
                 loginAdminBtn.addEventListener('click', () => {
                     if (loginError) loginError.classList.add('hidden');
                     if (loginModal) loginModal.classList.remove('hidden');
                 });
            }
            
            // ربط زر التسجيل (New)
            const registerBtn = document.getElementById('register-new-user-btn');
            if (registerBtn) registerBtn.addEventListener('click', handleRegistration);
        });
        
        /**
         * الاستماع لتغييرات المصادقة
         */
        function listenToAuthChanges() {
             onAuthStateChanged(auth, async (user) => {
                 if (user) {
                     userId = user.uid;
                     currentUserEmail = user.email || 'غير مسجل';
                     
                     // 1. إخفاء رسالة التحميل وعرض واجهة الدخول إذا كانت مفتوحة
                     if (initialLoadingMessage) initialLoadingMessage.classList.add('hidden');

                     // 2. جلب بيانات المستخدم من Firestore
                     const userDocRef = doc(db, usersPath, userId);
                     const userDocSnap = await getDoc(userDocRef);
                     
                     if (userDocSnap.exists()) {
                         const userData = userDocSnap.data();
                         currentUserName = userData.name || currentUserEmail;
                         currentUserRole = userData.role || 'viewer';
                         isUserAdmin = (currentUserRole === 'admin');
                     } else {
                          // إذا كان المستخدم مصدقًا في Auth ولكنه غير موجود في Firestore،
                          // يجب إنشاء وثيقة له أولاً لتجنب الأخطاء في باقي التطبيق
                          const name = user.displayName || currentUserEmail.split('@')[0] || 'مستخدم جديد';
                          const userData = {
                             name: name,
                             email: currentUserEmail,
                             role: 'viewer',
                             createdAt: serverTimestamp()
                          };
                          await setDoc(userDocRef, userData, { merge: true });
                          
                          currentUserName = name; 
                          currentUserRole = 'viewer';
                          isUserAdmin = false;
                     }

                     if (loginModal) loginModal.classList.add('hidden');
                     
                     // (تعديل) نضمن أن الوظيفة تبدأ مرة واحدة فقط
                     if (!isAppInitialized) {
                         initializeAppLogic(currentUserName);
                         isAppInitialized = true;
                     }


                     if (isUserAdmin) {
                         listenForPermissionRequests();
                     }
                     updateUserPresence(); // لتسجيل التواجد
                     
                 } else {
                      // المستخدم غير مسجل الدخول
                     userId = '';
                     currentUserName = 'زائر';
                     currentUserEmail = null;
                     currentUserRole = 'viewer';
                     isUserAdmin = false;
                     isAppInitialized = false; // إعادة تعيين حالة التمهيد
                     
                     updateUIForUser(currentUserName, false);
                     
                     // إظهار رسالة التحميل الأولية (للتأكد من أن onAuthStateChanged يعمل)
                     if (initialLoadingMessage) initialLoadingMessage.classList.remove('hidden');
                     
                     // عرض شاشة الدخول إذا لم يكن المستخدم مصادقًا
                     if (loginModal) loginModal.classList.remove('hidden');
                 }
             });
        }


        /**
         * معالجة إرسال نموذج تسجيل الدخول (بالبريد الإلكتروني وكلمة المرور)
         */
        async function handleLoginSubmit(e) {
            e.preventDefault();
            const emailInput = document.getElementById('user-email-input');
            const passwordInput = document.getElementById('user-password-input');
            if (!emailInput || !passwordInput) return;
            
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();

            if (!email || !password) {
                showLoginError("الرجاء إدخال البريد الإلكتروني وكلمة المرور.");
                return;
            }
            
            // محاولة تسجيل الدخول
            try {
                // (جديد) إظهار رسالة تحميل خفيفة أثناء الاتصال
                showLoginError("جاري تسجيل الدخول..."); 
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                
                // إذا نجح الدخول، فإن onAuthStateChanged سيتولى باقي الأمور
                if (loginError) loginError.classList.add('hidden');
                
            } catch (error) {
                let errorMessage;
                switch (error.code) {
                    case 'auth/user-not-found':
                    case 'auth/wrong-password':
                        errorMessage = "خطأ في البريد الإلكتروني أو كلمة المرور.";
                        break;
                    case 'auth/invalid-email':
                        errorMessage = "تنسيق البريد الإلكتروني غير صحيح.";
                        break;
                    case 'auth/too-many-requests':
                        errorMessage = "تم حظر الدخول مؤقتاً بسبب محاولات متكررة فاشلة.";
                        break;
                    default:
                        errorMessage = `فشل تسجيل الدخول. (${error.message})`;
                }
                showLoginError(errorMessage);
            }
        }
        
        /**
         * معالجة تسجيل مستخدم جديد
         */
        async function handleRegistration() {
            const nameInput = document.getElementById('user-name-input');
            const emailInput = document.getElementById('user-email-input');
            const passwordInput = document.getElementById('user-password-input');
            
            if (!nameInput || !emailInput || !passwordInput) return;
            
            const name = nameInput.value.trim();
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();

            if (!name || !email || password.length < 6) {
                 showLoginError("الرجاء إدخال اسمك وبريدك، وتأكد من أن كلمة المرور 6 أحرف على الأقل.");
                 return;
            }
            
            try {
                 // (جديد) إظهار رسالة تحميل خفيفة أثناء الاتصال
                 showLoginError("جاري إنشاء الحساب..."); 
                 const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                 const newUser = userCredential.user;
                 
                 // تسجيل بيانات المستخدم في Firestore
                 const role = (email === DEFAULT_ADMIN_EMAIL) ? 'admin' : 'viewer';
                 
                 await setDoc(doc(db, usersPath, newUser.uid), {
                     name: name,
                     email: email,
                     role: role,
                     createdAt: serverTimestamp()
                 });

                 showAlert("تم إنشاء الحساب بنجاح! يمكنك الآن تسجيل الدخول.", 'success');
                 if (loginError) loginError.classList.add('hidden');
                 
            } catch (error) {
                 let errorMessage;
                 switch (error.code) {
                     case 'auth/email-already-in-use':
                         errorMessage = "هذا البريد الإلكتروني مستخدم بالفعل. هل نسيت كلمة المرور؟";
                         break;
                     case 'auth/weak-password':
                         errorMessage = "كلمة المرور ضعيفة جداً (يجب أن تكون 6 أحرف على الأقل).";
                         break;
                     default:
                         errorMessage = `فشل التسجيل. (${error.message})`;
                 }
                 showLoginError(errorMessage);
            }
        }


        /**
         * إظهار رسالة خطأ في نافذة تسجيل الدخول
         */
        function showLoginError(message) {
             if (loginError) {
                 loginError.textContent = message;
                 loginError.classList.remove('hidden');
             } else {
                 console.error("عنصر loginError غير موجود!");
             }
        }


        /**
         * بدء منطق التطبيق بعد تسجيل الدخول وتحديد الدور
         */
        function initializeAppLogic(userName) {
             if (!userName) return;

            // تم تحديث isUserAdmin بناءً على Firestore في listenToAuthChanges
            updateUIForUser(userName, isUserAdmin);

            // تهيئة جميع النوافذ المنبثقة (المنصة)
            setupAddSectionModal();
            setupAddItemModal();
            setupEditSectionModal();
            setupEditItemModal();
            setupAlertModal();
            setupAdminManageModal();
            setupAdminPermsModal();
            
            // تهيئة نافذة الدردشة المدمجة
            setupChatWindow(); 
            // بدء منطق الدردشة
            initializeChatApp();

            setupControlEvents(isUserAdmin);
            listenForSections();
        }

        /**
         * تحديث الواجهة
         */
        function updateUIForUser(name, isAdmin) {
             if (userNameDisplay) {
                 userNameDisplay.textContent = `مرحباً بك، ${name} (${isAdmin ? 'مدير' : 'مشاهد'})`;
             } 

            // يجب استخدام adminControls و generalControls هنا بعد أن أصبحت متغيرة عالمية
            adminControls.forEach(id => {
                const btn = document.getElementById(id);
                if (btn) {
                     const wrapper = btn.closest('.relative');
                     if (isAdmin) {
                         btn.classList.remove('hidden');
                         if (wrapper) wrapper.classList.remove('hidden');
                     } else {
                         btn.classList.add('hidden');
                          if (wrapper) wrapper.classList.add('hidden');
                     }
                }
            });

            generalControls.forEach(id => {
                const btn = document.getElementById(id);
                if (btn) {
                         btn.classList.remove('hidden');
                }
            });
            
            // إدارة أزرار تسجيل الدخول/الخروج
            if (logoutBtn && loginAdminBtn) {
                if (userId) { // إذا كان هناك مستخدم مسجل الدخول (سواء مدير أو مشاهد)
                    logoutBtn.classList.remove('hidden');
                    loginAdminBtn.classList.add('hidden');
                } else {
                    logoutBtn.classList.add('hidden');
                    loginAdminBtn.classList.remove('hidden'); 
                }
            }
        }


        /**
         * =============================================
         * تهيئة النوافذ المنبثقة (Modals)
         * =============================================
         */

        function setupAddSectionModal() {
             addSectionModal = document.getElementById('add-section-modal');
             if (!addSectionModal) return;

             addSectionModalContent = document.getElementById('add-section-modal-content');
             addSectionForm = document.getElementById('add-section-form');
             closeSectionModalBtn = document.getElementById('close-section-modal');
             cancelSectionModalBtn = document.getElementById('cancel-section-modal');
             const addSectionBtn = document.getElementById('add-section-btn');

             if (addSectionBtn) {
                 addSectionBtn.addEventListener('click', () => {
                     addSectionModal.classList.remove('hidden');
                     setTimeout(() => {
                         if (addSectionModalContent) {
                             addSectionModalContent.classList.remove('scale-95', 'opacity-0');
                             addSectionModalContent.classList.add('scale-100', 'opacity-100');
                         }
                     }, 10);
                 });
             }


             const close = () => {
                  if (addSectionModalContent) {
                      addSectionModalContent.classList.add('scale-95', 'opacity-0');
                  }
                 setTimeout(() => {
                     addSectionModal.classList.add('hidden');
                     if (addSectionForm) addSectionForm.reset();
                 }, 200);
             };

             if (closeSectionModalBtn) closeSectionModalBtn.addEventListener('click', close);
             if (cancelSectionModalBtn) cancelSectionModalBtn.addEventListener('click', close);
             addSectionModal.addEventListener('click', (e) => (e.target === addSectionModal) && close());

             if (addSectionForm) addSectionForm.addEventListener('submit', handleSectionFormSubmit);
           }

        function setupAddItemModal() {
            addItemModal = document.getElementById('add-item-modal');
            if (!addItemModal) return;

            modalContent = document.getElementById('modal-content');
            closeModalBtn = document.getElementById('close-modal');
            cancelModalBtn = document.getElementById('cancel-modal');
            addItemForm = document.getElementById('add-item-form');
            columnIdInput = document.getElementById('column-id-input');
            itemTypeInput = document.getElementById('item-type-input');

            if (!sectionsContainer) return;
            sectionsContainer.addEventListener('click', (e) => {
                const addItemBtn = e.target.closest('.add-item-btn');
                const sectionEl = addItemBtn ? addItemBtn.closest('.column-wrapper') : null;
                const canEdit = isUserAdmin || (sectionEl && sectionEl.dataset.canEdit === 'true');

                if (addItemBtn && canEdit) {
                    const columnId = addItemBtn.getAttribute('data-column-id');
                    if(columnIdInput) columnIdInput.value = columnId;

                    const tabLinkBtn = document.getElementById('tab-link');
                    if (tabLinkBtn) tabLinkBtn.click();

                    addItemModal.classList.remove('hidden');
                    setTimeout(() => {
                        if (modalContent) {
                           modalContent.classList.remove('scale-95', 'opacity-0');
                           modalContent.classList.add('scale-100', 'opacity-100');
                        }
                    }, 10);
                }
            });


            const closeModal = () => {
                 if (modalContent) modalContent.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    addItemModal.classList.add('hidden');
                   if (addItemForm) addItemForm.reset();
                }, 200);
            };

            if(closeModalBtn) closeModalBtn.addEventListener('click', closeModal);
            if (cancelModalBtn) cancelModalBtn.addEventListener('click', closeModal);
            addItemModal.addEventListener('click', (e) => (e.target === addItemModal) && closeModal());


            const tabLink = document.getElementById('tab-link');
            const tabFile = document.getElementById('tab-file');
            const linkSection = document.getElementById('link-input-section');
            const fileSection = document.getElementById('file-input-section');

            if (tabLink) {
                tabLink.addEventListener('click', () => {
                    if(linkSection) linkSection.classList.remove('hidden');
                    if (fileSection) fileSection.classList.add('hidden');
                    tabLink.classList.add('border-teal-500', 'text-teal-600');
                    tabLink.classList.remove('border-transparent', 'text-gray-500');
                    if (tabFile) {
                        tabFile.classList.add('border-transparent', 'text-gray-500');
                        tabFile.classList.remove('border-teal-500', 'text-teal-600');
                    }
                    if (itemTypeInput) itemTypeInput.value = 'link';
                });
            }

            if (tabFile) {
                tabFile.addEventListener('click', () => {
                    showAlert('ميزة رفع الملفات قيد التطوير وتتطلب إعداد Firebase Storage.');
                });
            }

            if (addItemForm) addItemForm.addEventListener('submit', handleItemFormSubmit);
        }

        function setupEditSectionModal() {
            editSectionModal = document.getElementById('edit-section-modal');
            if (!editSectionModal) return;

            const closeBtn = document.getElementById('close-edit-section-modal');
            const cancelBtn = document.getElementById('cancel-edit-section-modal');
            editSectionForm = document.getElementById('edit-section-form');
            editSectionTitleInput = document.getElementById('edit-section-title');
            editSectionIdInput = document.getElementById('edit-section-id');
            currentEditorsList = document.getElementById('current-editors-list');
            currentEditorsContainer = document.getElementById('current-editors-container');
            
            // (جديد) عنصر خانة الاختيار للتحكم في الرؤية
            const editSectionVisibilityCheckbox = document.getElementById('edit-section-visibility'); 

            
             if (!sectionsContainer) return;
            sectionsContainer.addEventListener('click', async (e) => { 
                const editBtn = e.target.closest('.section-edit-btn');
                 const sectionEl = editBtn ? editBtn.closest('.column-wrapper') : null;
                 const canEdit = isUserAdmin || (sectionEl && sectionEl.dataset.canEdit === 'true');

                if (editBtn && canEdit) {
                    if (!sectionEl) return;
                    const sectionId = sectionEl.dataset.sectionId;
                    
                    // (جديد) جلب بيانات القسم المحدثة
                    const sectionData = await getSectionDataById(sectionId);
                    if (!sectionData) return;

                    const sectionTitle = sectionData.title || '';
                    const isVisible = sectionData.isVisible !== false; // القيمة الافتراضية هي true


                   if(editSectionTitleInput) editSectionTitleInput.value = sectionTitle;
                    if (editSectionIdInput) editSectionIdInput.value = sectionId;
                    if (editSectionVisibilityCheckbox) editSectionVisibilityCheckbox.checked = isVisible; // تحديث حالة الـ checkbox

                    await loadEditorsForSection(sectionId);

                    editSectionModal.classList.remove('hidden');
                }
            });


            const close = () => editSectionModal.classList.add('hidden');
            if (closeBtn) closeBtn.addEventListener('click', close);
            if (cancelBtn) cancelBtn.addEventListener('click', close);
            editSectionModal.addEventListener('click', (e) => (e.target === editSectionModal) && close());


           if (editSectionForm) editSectionForm.addEventListener('submit', handleEditSectionFormSubmit);

           if (currentEditorsList) {
               currentEditorsList.addEventListener('click', handleRemoveEditorClick);
           }
        }

        function setupEditItemModal() {
            editItemModal = document.getElementById('edit-item-modal');
            if (!editItemModal) return;

            const closeBtn = document.getElementById('close-edit-item-modal');
            const cancelBtn = document.getElementById('cancel-edit-item-modal');
            editItemForm = document.getElementById('edit-item-form');
            editItemTitleInput = document.getElementById('edit-item-title');
            editItemLinkInput = document.getElementById('edit-item-link');
            editItemIdInput = document.getElementById('edit-item-id'); // المتغير الصحيح
            editItemSectionIdInput = document.getElementById('edit-item-section-id');

             if (!sectionsContainer) return;
            sectionsContainer.addEventListener('click', (e) => {
                const editBtn = e.target.closest('.item-edit-btn');
                 const sectionEl = editBtn ? editBtn.closest('.column-wrapper') : null;
                 const canEdit = isUserAdmin || (sectionEl && sectionEl.dataset.canEdit === 'true');

                if (editBtn && canEdit) {
                    const itemEl = editBtn.closest('.item-card');
                    if (!itemEl || !sectionEl) return;

                    const itemId = itemEl.dataset.itemId;
                    const sectionId = sectionEl.dataset.sectionId;
                    const linkElement = itemEl.querySelector('a');
                    const title = linkElement ? linkElement.textContent.trim() : '';
                    const link = linkElement ? linkElement.href : '';


                    if(editItemTitleInput) editItemTitleInput.value = title;
                    if(editItemLinkInput) editItemLinkInput.value = link;
                    // تم تصحيح الخطأ المطبعي هنا: كان يستخدم 'editItemItemIdInput'
                    if(editItemIdInput) editItemIdInput.value = itemId; 
                    if(editItemSectionIdInput) editItemSectionIdInput.value = sectionId;

                    editItemModal.classList.remove('hidden');
                }
            });


            const close = () => editItemModal.classList.add('hidden');
            if (closeBtn) closeBtn.addEventListener('click', close);
            if(cancelBtn) cancelBtn.addEventListener('click', close);
            editItemModal.addEventListener('click', (e) => (e.target === editItemModal) && close());


           if (editItemForm) editItemForm.addEventListener('submit', handleEditItemFormSubmit);
        }

        function setupAlertModal() {
            alertModal = document.getElementById('alert-modal');
            if (!alertModal) return;

            const alertModalContent = document.getElementById('alert-modal-content');
            const closeAlertModalBtn = document.getElementById('close-alert-modal');

            const close = () => {
                 if (alertModalContent) alertModalContent.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    alertModal.classList.add('hidden');
                }, 200);
            };

           if(closeAlertModalBtn) closeAlertModalBtn.addEventListener('click', close);
            alertModal.addEventListener('click', (e) => (e.target === alertModal) && close());
        }

        function setupChatWindow() {
            const chatToggle = document.getElementById('chat-toggle');
            // (تعديل) التأكد من أن جميع متغيرات الدردشة معرفة
            chatWindow = document.getElementById('chat-window');
            closeChatBtn1 = document.getElementById('close-chat'); // من قائمة الدردشة
            closeChatBtn2 = document.getElementById('close-chat-2'); // من نافذة الرسائل
            chatBackBtn = document.getElementById('chat-back-btn');
            
            chatListView = document.getElementById('chat-list-view');
            chatMessageView = document.getElementById('chat-message-view');

            if (!chatToggle || !chatWindow || !closeChatBtn1 || !closeChatBtn2 || !chatBackBtn || !chatListView || !chatMessageView) {
                return;
            }

            // زر فتح/إغلاق النافذة الرئيسية
            chatToggle.addEventListener('click', () => {
                chatWindow.classList.toggle('hidden');
                if (!chatWindow.classList.contains('hidden')) {
                    // عند الفتح، تأكد من أننا في قائمة الدردشة
                    chatListView.classList.remove('hidden');
                    chatMessageView.classList.add('hidden');
                }
            });

            // أزرار الإغلاق
            const closeChat = () => chatWindow.classList.add('hidden');
            closeChatBtn1.addEventListener('click', closeChat);
            closeChatBtn2.addEventListener('click', closeChat);

            // زر الرجوع (من الرسائل إلى القائمة)
            chatBackBtn.addEventListener('click', () => {
                chatListView.classList.remove('hidden');
                chatMessageView.classList.add('hidden');
                
                // إيقاف الاستماع للرسائل عند الرجوع
                if (chatMessageListeners[chatCurrentChat.id]) {
                    chatMessageListeners[chatCurrentChat.id]();
                    delete chatMessageListeners[chatCurrentChat.id];
                }
                chatCurrentChat = { type: 'group', id: 'group' };
            });
        }


        function setupAdminManageModal() {
            adminManageModal = document.getElementById('admin-manage-modal');
            if (!adminManageModal) return;

            adminUsersList = document.getElementById('admin-users-list');
            const closeBtn = document.getElementById('close-admin-manage-modal');
            const adminManageBtn = document.getElementById('admin-manage-btn');

            if (adminManageBtn) {
                adminManageBtn.addEventListener('click', async () => {
                    if (!isUserAdmin) return;
                    await loadUsersForAdminModal(); 
                    adminManageModal.classList.remove('hidden');
                });
            }

            const close = () => adminManageModal.classList.add('hidden');
            if (closeBtn) closeBtn.addEventListener('click', close);
            adminManageModal.addEventListener('click', (e) => (e.target === adminManageModal) && close());

            if (adminUsersList) {
                adminUsersList.addEventListener('click', async (e) => {
                    const targetButton = e.target.closest('button');
                    const userIdToUpdate = targetButton ? targetButton.dataset.userId : null;
                    if (!userIdToUpdate) return;

                    const action = targetButton.dataset.roleAction || targetButton.dataset.action || targetButton.getAttribute('data-role-action');
                    await updateUserRole(userIdToUpdate, action);
                });
            }
        }


        function setupAdminPermsModal() {
            adminPermsModal = document.getElementById('admin-perms-modal');
            if (!adminPermsModal) return;

            adminPermsList = document.getElementById('admin-perms-list');
            const closeBtn = document.getElementById('close-admin-perms-modal');
            const adminPermsBtn = document.getElementById('admin-perms-btn');

            if (adminPermsBtn) {
                 adminPermsBtn.addEventListener('click', async () => {
                     if (!isUserAdmin) {
                         showAlert('لطلب صلاحيات إضافية، يرجى التواصل مع مدير المنصة.');
                          return;
                     }
                     await loadPermissionRequests(); 
                     adminPermsModal.classList.remove('hidden');
                 });
            }

            const close = () => adminPermsModal.classList.add('hidden');
            if (closeBtn) closeBtn.addEventListener('click', close);
            adminPermsModal.addEventListener('click', (e) => (e.target === adminPermsModal) && close());

            if (adminPermsList) {
                adminPermsList.addEventListener('click', async (e) => {
                    const targetButton = e.target.closest('button');
                    if (!targetButton || !targetButton.dataset.requestId) return;

                    const requestId = targetButton.dataset.requestId;
                    const action = targetButton.dataset.action; 

                    await handlePermissionRequest(requestId, action);
                });
            }
        }


        /**
         * تحميل وعرض المستخدمين في نافذة إدارة المسؤولين
         */
        async function loadUsersForAdminModal() {
            if (!adminUsersList || !usersCollectionRef) return;
            adminUsersList.innerHTML = '<li>جاري تحميل المستخدمين...</li>';

            try {
                const querySnapshot = await getDocs(usersCollectionRef);
                adminUsersList.innerHTML = '';

                if (querySnapshot.empty) {
                    adminUsersList.innerHTML = '<li>لا يوجد مستخدمون مسجلون بعد.</li>';
                    return;
                }

                querySnapshot.forEach(docSnap => {
                    const user = docSnap.data();
                    const docId = docSnap.id;
                    const userName = user.name || '[اسم غير معروف]';
                    const userRole = user.role || 'viewer';

                    let roleLabel = 'فعّال 🟢';
                    let roleColor = 'text-green-600';
                    if (userRole === 'admin') { roleLabel = 'مدير 🔵'; roleColor = 'text-blue-600'; }
                    if (userRole === 'editor') { roleLabel = 'محرر 🟠'; roleColor = 'text-orange-600'; }
                    if (userRole === 'suspended') { roleLabel = 'موقوف 🔴'; roleColor = 'text-red-600'; }

                    let actionsHTML = '';
                    if (docId === userId) {
                        actionsHTML = '<span class="text-xs text-gray-400">(أنت)</span>';
                    } else if (userRole === 'viewer' || userRole === 'editor') {
                        actionsHTML = `
                            <button data-user-id="${docId}" data-role-action="promote" class="text-xs bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-2 rounded">ترقية لمدير</button>
                            <button data-user-id="${docId}" data-role-action="suspend" class="text-xs bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1 px-2 rounded">إيقاف</button>
                            <button data-user-id="${docId}" data-role-action="remove" class="text-xs bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-2 rounded">حذف نهائي</button>
                        `;
                    } else if (userRole === 'admin') {
                        actionsHTML = `
                            <button data-user-id="${docId}" data-role-action="demote" class="text-xs bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-2 rounded">إلغاء المدير</button>
                            <button data-user-id="${docId}" data-role-action="suspend" class="text-xs bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1 px-2 rounded">إيقاف</button>
                            <button data-user-id="${docId}" data-role-action="remove" class="text-xs bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-2 rounded">حذف نهائي</button>
                        `;
                    } else if (userRole === 'suspended') {
                        actionsHTML = `
                            <button data-user-id="${docId}" data-role-action="reactivate" class="text-xs bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-2 rounded">إعادة التفعيل</button>
                            <button data-user-id="${docId}" data-role-action="remove" class="text-xs bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-2 rounded">حذف نهائي</button>
                        `;
                    }

                    const li = document.createElement('li');
                    li.className = 'py-3 sm:py-4 border-b last:border-b-0';
                    li.innerHTML = `
                        <div class="grid grid-cols-12 items-center gap-3">
                            <div class="col-span-5">
                                <p class="text-sm font-medium text-gray-900 truncate">${userName}</p>
                                <p class="text-xs text-gray-500 truncate">UID: ${docId.substring(0, 10)}...</p>
                            </div>
                            <div class="col-span-3">
                                <span class="text-sm font-semibold ${roleColor}">${roleLabel}</span>
                            </div>
                            <div class="col-span-4 inline-flex items-center text-base font-semibold text-gray-900 gap-2">
                                ${actionsHTML}
                            </div>
                        </div>
                    `;
                    adminUsersList.appendChild(li);
                });

            } catch (error) {
                console.error("خطأ في تحميل المستخدمين للإدارة:", error);
                adminUsersList.innerHTML = '<li>حدث خطأ أثناء تحميل المستخدمين.</li>';
            }
        }


        /**
         * تحديث دور المستخدم في Firestore
         */
        async function updateUserRole(userIdToUpdate, action) {
            if (!isUserAdmin || !db || !usersPath) return;

            try {
                const userRef = doc(db, usersPath, userIdToUpdate);
                const userSnap = await getDoc(userRef);
                if (!userSnap.exists()) {
                    showAlert("لم يتم العثور على المستخدم.");
                    return;
                }
                const userData = userSnap.data();
                const userNameForEditors = userData.name || ''; 

                if (action === 'promote') {
                    await updateDoc(userRef, { role: 'admin' });
                    showAlert("✅ تمت ترقية المستخدم إلى مدير بنجاح.");
                } else if (action === 'demote') {
                    await updateDoc(userRef, { role: 'viewer' });
                    showAlert("🔄 تم إلغاء صلاحية المدير عن المستخدم.");
                } else if (action === 'suspend') {
                    await updateDoc(userRef, { role: 'suspended' });
                    showAlert("🚫 تم إيقاف المستخدم مؤقتًا.");
                } else if (action === 'reactivate') {
                    await updateDoc(userRef, { role: 'viewer' });
                    showAlert("✅ تمت إعادة تفعيل المستخدم.");
                } else if (action === 'remove') {
                    if (!confirm("⚠️ هل أنت متأكد أنك تريد حذف هذا المستخدم نهائيًا وجميع صلاحياته؟")) return;

                    const sectionsSnapshot = await getDocs(sectionsCollectionRef);
                    for (const section of sectionsSnapshot.docs) {
                        const sectionRef = doc(db, sectionsPath, section.id);
                        await updateDoc(sectionRef, {
                            editors: arrayRemove(userNameForEditors)
                        });
                    }

                    await deleteDoc(userRef);
                    showAlert("🗑️ تم حذف المستخدم وجميع صلاحياته بنجاح.");
                }

                await loadUsersForAdminModal();
            } catch (error) {
                console.error("خطأ أثناء تنفيذ الإجراء:", error);
                showAlert("❌ حدث خطأ أثناء تنفيذ الإجراء على المستخدم.");
            }
        }


          /**
           * الاستماع لطلبات الصلاحيات وتحديث الشارة
           */
        function listenForPermissionRequests() {
            if (!permissionRequestsCollectionRef || !permsBtnBadge) return;

            const q = query(permissionRequestsCollectionRef, where("status", "==", "pending"));

            if (permissionRequestsUnsubscribe) {
               permissionRequestsUnsubscribe();
            }

            permissionRequestsUnsubscribe = onSnapshot(q, (snapshot) => {
                const pendingCount = snapshot.size;
                if (pendingCount > 0) {
                    permsBtnBadge.textContent = pendingCount;
                    permsBtnBadge.classList.remove('hidden');
                } else {
                    permsBtnBadge.classList.add('hidden');
                }
            }, (error) => {
                console.error("خطأ في الاستماع لطلبات الصلاحيات:", error);
                permsBtnBadge.classList.add('hidden');
            });
        }


          /**
           * تحميل وعرض طلبات الصلاحيات المعلقة في النافذة
           */
        async function loadPermissionRequests() {
            if (!adminPermsList || !permissionRequestsCollectionRef) return;
            adminPermsList.innerHTML = '<li>جاري تحميل الطلبات...</li>';

            try {
                const q = query(permissionRequestsCollectionRef, where("status", "==", "pending"));
                const querySnapshot = await getDocs(q);
                adminPermsList.innerHTML = '';

                if (querySnapshot.empty) {
                    adminPermsList.innerHTML = '<li>لا توجد طلبات صلاحيات معلقة حالياً.</li>';
                    return;
                }

                querySnapshot.forEach(doc => {
                    const request = doc.data();
                    const requestId = doc.id;
                    const requesterName = request.requesterName || '[مستخدم غير معروف]';
                    const sectionTitle = request.sectionTitle || '[قسم غير معروف]';

                    const li = document.createElement('li');
                    li.className = 'py-3 sm:py-4 border-b last:border-b-0';
                    li.innerHTML = `
                        <div class="flex items-center justify-between space-x-4 gap-3">
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium text-gray-900 truncate"><b>${requesterName}</b> يطلب التحكم في قسم:</p>
                                <p class="text-sm text-gray-500 truncate">${sectionTitle}</p>
                            </div>
                            <div class="inline-flex items-center text-base font-semibold text-gray-900 gap-2">
                                <button data-request-id="${requestId}" data-action="approve" class="text-xs bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-2 rounded">موافقة</button>
                                <button data-request-id="${requestId}" data-action="reject" class="text-xs bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-2 rounded">رفض</button>
                            </div>
                        </div>
                    `;
                    adminPermsList.appendChild(li);
                });

            } catch (error) {
                console.error("خطأ في تحميل طلبات الصلاحيات:", error);
                adminPermsList.innerHTML = '<li>حدث خطأ أثناء تحميل الطلبات.</li>';
            }
        }

        /**
         * معالجة الموافقة أو الرفض لطلب صلاحية
         */
        async function handlePermissionRequest(requestId, action) {
             if (!isUserAdmin || !db || !permissionRequestsPath || !sectionsPath) return;

             const requestRef = doc(db, permissionRequestsPath, requestId);
             const newStatus = (action === 'approve') ? 'approved' : 'rejected';

             try {
                 const requestSnap = await getDoc(requestRef);
                 if (!requestSnap.exists()) {
                     showAlert("لم يتم العثور على الطلب.");
                     return;
                 }
                 const requestData = requestSnap.data();

                 await updateDoc(requestRef, { status: newStatus });

                 if (action === 'approve' && requestData.sectionId && requestData.requesterName) {
                     const sectionRef = doc(db, sectionsPath, requestData.sectionId);
                     await updateDoc(sectionRef, {
                         editors: arrayUnion(requestData.requesterName) 
                     });
                     showAlert(`تمت الموافقة ومنح صلاحية التحرير لـ ${requestData.requesterName} على قسم "${requestData.sectionTitle}".`);
                 } else if (action === 'reject') {
                     showAlert(`تم رفض طلب ${requestData.requesterName} للتحكم في قسم "${requestData.sectionTitle}".`);
                 }

                 await loadPermissionRequests(); 

             } catch (error) {
                 console.error(`خطأ في ${action === 'approve' ? 'الموافقة على' : 'رفض'} الطلب:`, error);
                 showAlert("حدث خطأ أثناء معالجة الطلب.");
             }
        }

          /**
           * إرسال طلب تحكم في قسم
           */
        async function requestSectionControl(sectionId, sectionTitle) {
            if (!currentUserName || !permissionRequestsCollectionRef) return;

            try {
                const q = query(permissionRequestsCollectionRef,
                                 where("requesterName", "==", currentUserName),
                                 where("sectionId", "==", sectionId),
                                 where("status", "==", "pending"));
                const existingRequests = await getDocs(q);

                if (!existingRequests.empty) {
                    showAlert("لقد قمت بإرسال طلب بالفعل لهذا القسم وهو قيد المراجعة.");
                    return;
                }

                await addDoc(permissionRequestsCollectionRef, {
                    requesterName: currentUserName,
                    sectionId: sectionId,
                    sectionTitle: sectionTitle,
                    status: 'pending',
                    timestamp: serverTimestamp()
                });
                showAlert(`تم إرسال طلبك للتحكم في قسم "${sectionTitle}". سيقوم المدير بمراجعته.`);

            } catch (error) {
                console.error("خطأ في إرسال طلب التحكم:", error);
                showAlert("حدث خطأ أثناء إرسال طلب التحكم.");
            }
        }



        /**
         * =============================================
         * منطق Firebase (CRUD للأقسام والعناصر)
         * =============================================
         */

        /**
         * (Create) إضافة قسم جديد
         */
        async function handleSectionFormSubmit(e) {
            e.preventDefault();
             const titleInput = document.getElementById('section-title');
             const visibilityCheckbox = document.getElementById('section-visibility'); // (جديد)
            if (!titleInput) return;
            const newTitle = titleInput.value.trim();
            const isVisible = visibilityCheckbox ? visibilityCheckbox.checked : true; // (جديد)
            const newOrder = Date.now(); // استخدام التوقيت كترتيب افتراضي (يمكنك تعديل هذا إذا كنت تريد ترتيباً مختلفاً)

            if (!newTitle) return;

            try {
                 if (!sectionsCollectionRef) {
                     showAlert("خطأ في الاتصال لإضافة القسم.");
                      return;
                 }
                await addDoc(sectionsCollectionRef, {
                    title: newTitle,
                    items: [],
                    editors: [],
                    isVisible: isVisible, // (جديد) إضافة حقل الرؤية
                    order: newOrder // (جديد) حقل الترتيب
                });
                const closeButton = document.getElementById('close-section-modal');
                if (closeButton) closeButton.click();
            } catch (error) {
                // (جديد) طباعة الخطأ هنا لتحديد المشكلة بالضبط (غالباً ما تكون قواعد أمان)
                console.error("خطأ في إضافة القسم (تأكد من قواعد الأمان):", error);
                showAlert("❌ فشل إضافة القسم. (يرجى التحقق من قواعد أمان Firestore).");
            }
        }

        /**
         * (Read) الاستماع وعرض الأقسام والعناصر
         */
        function listenForSections() {
             if (!sectionsCollectionRef) {
                 if (sectionsContainer) sectionsContainer.innerHTML = `<p class="text-red-500 text-center col-span-3">خطأ فادح: لم يتم تهيئة اتصال الأقسام.</p>`;
                 return;
             }
            // (تعديل) إضافة orderBy إذا كان الترتيب مطلوباً على مستوى الأقسام نفسها
            const sectionsQuery = query(sectionsCollectionRef);

            onSnapshot(sectionsQuery, (snapshot) => {
                if (sectionsContainer) sectionsContainer.innerHTML = '';
                
                // (جديد) إظهار رسالة عدم وجود أقسام بدلاً من رسالة التحميل
                if(snapshot.empty) {
                    if (sectionsContainer) sectionsContainer.innerHTML = `<p class="text-gray-500 text-center col-span-3">لا توجد أقسام حتى الآن. ${isUserAdmin ? 'قم بإضافة قسم جديد من الزر العلوي.' : 'يرجى الانتظار حتى يقوم المدير بإضافة محتوى.'}</p>`;
                }

                snapshot.docs.forEach((doc) => {
                    renderSection(doc);
                });
                
                // (جديد) تفعيل خاصية السحب والإفلات بعد رسم جميع الأقسام
                setupItemSorting();

            }, (error) => {
                // (جديد) طباعة الخطأ هنا لتحديد المشكلة بالضبط (غالباً ما تكون قواعد أمان)
                console.error("خطأ في جلب الأقسام (تأكد من قواعد الأمان):", error);
                if (sectionsContainer) sectionsContainer.innerHTML = `<p class="text-red-500 text-center col-span-3">خطأ في الاتصال بقاعدة البيانات. تأكد من أن قواعد أمان Firestore تسمح بقراءة مجموعة 'sections'.</p>`;
            });
        }
        
        /**
         * (جديد) إعداد خاصية السحب والإفلات داخل كل قسم
         */
        function setupItemSorting() {
            const lists = sectionsContainer ? sectionsContainer.querySelectorAll('.column-list') : [];
            lists.forEach(list => {
                const sectionEl = list.closest('.column-wrapper');
                const sectionId = sectionEl ? sectionEl.dataset.sectionId : null;
                const canEdit = sectionEl ? sectionEl.dataset.canEdit === 'true' : false;

                if (list && sectionId && canEdit) {
                    Sortable.create(list, {
                        group: 'shared', // يسمح بسحب العناصر بين الأقسام (يمكن إزالته إذا أردت منع النقل بين الأقسام)
                        animation: 150,
                        handle: '.drag-handle', // مفتاح التعديل هنا: السحب من مقبض السحب فقط
                        filter: '.add-item-btn', // لا تسمح بسحب زر الإضافة
                        onEnd: async function (evt) {
                            const newSectionEl = evt.to.closest('.column-wrapper');
                            const oldSectionId = sectionId;
                            const newSectionId = newSectionEl ? newSectionEl.dataset.sectionId : null;

                            if (!newSectionId) return; 

                            const oldIndex = evt.oldIndex;
                            const newIndex = evt.newIndex;
                            const itemId = evt.item.dataset.itemId;
                            
                            // 1. جلب بيانات القسم المحدثة
                            const currentSectionData = await getSectionDataById(oldSectionId);
                            if (!currentSectionData) return;
                            
                            let items = currentSectionData.items || [];
                            const movedItem = items.find(item => item.id === itemId);
                            if (!movedItem) return;
                            
                            // 2. معالجة النقل بين الأقسام
                            if (oldSectionId !== newSectionId) {
                                
                                // حذف العنصر من القسم القديم
                                items = items.filter(item => item.id !== itemId);
                                await updateDoc(doc(db, sectionsPath, oldSectionId), { items: items });

                                // إضافة العنصر للقسم الجديد بالترتيب الصحيح
                                const newSectionData = await getSectionDataById(newSectionId);
                                if (!newSectionData) return;
                                
                                let newItems = newSectionData.items || [];
                                newItems.splice(newIndex, 0, movedItem); 
                                await updateDoc(doc(db, sectionsPath, newSectionId), { items: newItems });
                                
                            } 
                            // 3. معالجة الترتيب داخل نفس القسم
                            else {
                                // إعادة ترتيب المصفوفة محليا
                                items.splice(oldIndex, 1);
                                items.splice(newIndex, 0, movedItem);

                                // حفظ الترتيب الجديد في قاعدة البيانات
                                await updateDoc(doc(db, sectionsPath, sectionId), { items: items });
                            }
                        }
                    });
                } else if (list) {
                    // تعطيل السحب لغير المحررين
                    Sortable.create(list, {
                        disabled: true
                    });
                }
            });
        }


        /**
         * (Update) معالجة تعديل عنوان القسم وحالة الرؤية
         */
        async function handleEditSectionFormSubmit(e) {
            e.preventDefault();
            const newTitle = editSectionTitleInput ? editSectionTitleInput.value.trim() : '';
            const sectionId = editSectionIdInput ? editSectionIdInput.value : '';
            // (جديد) جلب حالة الرؤية من نافذة التعديل
            const editSectionVisibilityCheckbox = document.getElementById('edit-section-visibility'); 
            const newVisibility = editSectionVisibilityCheckbox ? editSectionVisibilityCheckbox.checked : true;

            if (!newTitle || !sectionId) return;

            try {
                 if (!db || !sectionsPath) {
                     showAlert("خطأ في الاتصال لتعديل القسم.");
                      return;
                 }
                const sectionRef = doc(db, sectionsPath, sectionId);
                await updateDoc(sectionRef, {
                    title: newTitle,
                    isVisible: newVisibility // (جديد) تحديث حقل الرؤية
                });
                if(editSectionModal) editSectionModal.classList.add('hidden');
            } catch (error) {
                console.error("خطأ في تعديل القسم (تأكد من قواعد الأمان):", error);
                showAlert("❌ فشل تعديل القسم. (يرجى التحقق من قواعد أمان Firestore).");
            }
        }

        /**
         * تحميل قائمة المحررين للقسم في نافذة التعديل
         */
        async function loadEditorsForSection(sectionId) {
            if (!currentEditorsList || !currentEditorsContainer) return;

            if (!isUserAdmin) {
                currentEditorsContainer.classList.add('hidden');
                return;
            }
            currentEditorsContainer.classList.remove('hidden');
            currentEditorsList.innerHTML = '<li>جاري تحميل المحررين...</li>';

            const sectionData = await getSectionDataById(sectionId); 

            if (!sectionData || !sectionData.editors || sectionData.editors.length === 0) {
                currentEditorsList.innerHTML = '<li>لا يوجد محررون إضافيون لهذا القسم.</li>';
                return;
            }

            currentEditorsList.innerHTML = '';
            sectionData.editors.forEach(editorName => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center py-2 last:border-b-0';
                li.innerHTML = `
                    <span class="text-sm text-gray-800">${editorName}</span>
                    <button type="button" data-editor-name="${editorName}" data-section-id="${sectionId}" class="remove-editor-btn text-xs bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-2 rounded">
                        إزالة
                    </button>
                `;
                currentEditorsList.appendChild(li);
            });
        }

        /**
         * معالجة النقر على زر إزالة محرر
         */
        async function handleRemoveEditorClick(e) {
            const removeBtn = e.target.closest('.remove-editor-btn');
            if (!removeBtn || !isUserAdmin) return;

            const editorName = removeBtn.dataset.editorName;
            const sectionId = removeBtn.dataset.sectionId;

            if (!editorName || !sectionId) return;

            if (!confirm(`هل أنت متأكد أنك تريد إزالة صلاحيات المحرر "${editorName}" من هذا القسم؟`)) return;

            try {
                const sectionRef = doc(db, sectionsPath, sectionId);
                await updateDoc(sectionRef, {
                    editors: arrayRemove(editorName)
                });

                showAlert(`تمت إزالة صلاحيات "${editorName}" بنجاح.`);
                await loadEditorsForSection(sectionId); 

            } catch (error) {
                console.error("خطأ في إزالة المحرر (تأكد من قواعد الأمان):", error);
                showAlert("❌ فشل إزالة المحرر. (يرجى التحقق من قواعد أمان Firestore).");
            }
        }


        /**
         * (Create) إضافة عنصر جديد (رابط) إلى قسم
         */
        async function handleItemFormSubmit(e) {
            e.preventDefault();

            const titleInput = document.getElementById('item-title');
            const title = titleInput ? titleInput.value.trim() : '';
            const sectionId = columnIdInput ? columnIdInput.value : '';
            const itemType = itemTypeInput ? itemTypeInput.value : 'link';

            if (!title || !sectionId) {
                showAlert("الرجاء إدخال عنوان للعنصر.");
                return;
            }

            let newItemData = {
                id: crypto.randomUUID(),
                title: title,
                type: itemType
            };

            if (itemType === 'link') {
                const linkInput = document.getElementById('item-link');
                const link = linkInput ? linkInput.value.trim() : '';
                if (!link) {
                    showAlert("الرجاء إدخال رابط.");
                    return;
                }
                newItemData.url = link;
            } else if (itemType === 'file') {
                showAlert("ميزة رفع الملفات قيد التطوير.");
                return;
            }


            try {
                 if (!sectionsCollectionRef) {
                     showAlert("خطأ في الاتصال لإضافة العنصر.");
                      return;
                 }
                const sectionRef = doc(db, sectionsPath, sectionId);
                await updateDoc(sectionRef, {
                    items: arrayUnion(newItemData)
                });
                const closeButton = document.getElementById('close-modal');
                if (closeButton) closeButton.click();
            } catch (error) {
                console.error("خطأ في إضافة العنصر (تأكد من قواعد الأمان):", error);
                showAlert("❌ فشل إضافة العنصر. (يرجى التحقق من قواعد أمان Firestore).");
            }
        }

        /**
         * (Update) معالجة تعديل العنصر
         */
        async function handleEditItemFormSubmit(e) {
            e.preventDefault();
            const sectionId = editItemSectionIdInput ? editItemSectionIdInput.value : '';
            const itemId = editItemIdInput ? editItemIdInput.value : '';
            const newTitle = editItemTitleInput ? editItemTitleInput.value.trim() : '';
            const newLink = editItemLinkInput ? editItemLinkInput.value.trim() : '';

            if (!sectionId || !itemId || !newTitle || !newLink) return;

            try {
                 if (!db || !sectionsPath) {
                     showAlert("خطأ في الاتصال لتعديل العنصر.");
                      return;
                 }
                const sectionRef = doc(db, sectionsPath, sectionId);
                const sectionSnap = await getDoc(sectionRef);

                if (sectionSnap.exists()) {
                    let items = sectionSnap.data().items || []; 

                    const updatedItems = items.map(item => {
                        if (item.id === itemId) {
                            return { ...item, title: newTitle, url: newLink };
                        }
                        return item;
                    });

                    await updateDoc(sectionRef, {
                        items: updatedItems
                    });
                    const closeButton = document.getElementById('close-edit-item-modal');
                   if(closeButton) closeButton.click();
                }
            } catch (error) {
                console.error("خطأ في تعديل العنصر (تأكد من قواعد الأمان):", error);
                showAlert("❌ فشل تعديل العنصر. (يرجى التحقق من قواعد أمان Firestore).");
            }
        }

        /**
         * (Delete) حذف عنصر من قسم
         */
        async function deleteItem(sectionId, itemId) {
             if (!db || !sectionsPath) {
                 showAlert("خطأ في الاتصال لحذف العنصر.");
                  return;
             }
            const sectionRef = doc(db, sectionsPath, sectionId);
            const sectionSnap = await getDoc(sectionRef);
            const editors = (sectionSnap.exists() && sectionSnap.data().editors) ? sectionSnap.data().editors : [];
            const canDelete = isUserAdmin || editors.includes(currentUserName);

            if (!canDelete) return;
            if (!confirm("هل أنت متأكد أنك تريد حذف هذا العنصر؟")) return;

            try {
                if (sectionSnap.exists()) {
                    let items = sectionSnap.data().items || [];

                    const updatedItems = items.filter(item => item.id !== itemId);


                    await updateDoc(sectionRef, {
                        items: updatedItems
                    });
                }
            } catch (error) {
                console.error("خطأ في حذف العنصر (تأكد من قواعد الأمان):", error);
                showAlert("❌ فشل حذف العنصر. (يرجى التحقق من قواعد أمان Firestore).");
            }
        }


        /**
         * (Delete) حذف قسم كامل
         */
        async function deleteSection(sectionId) {
            if (!isUserAdmin) return;
            if (!confirm(`هل أنت متأكد أنك تريد حذف هذا القسم بالكامل؟ هذا الإجراء لا يمكن التراجع عنه.`)) return;

            try {
                 if (!db || !sectionsPath) {
                     showAlert("خطأ في الاتصال لحذف القسم.");
                      return;
                 }
                const sectionRef = doc(db, sectionsPath, sectionId);
                await deleteDoc(sectionRef);
            } catch (error) {
                console.error("خطأ في حذف القسم (تأكد من قواعد الأمان):", error);
                showAlert("❌ فشل حذف القسم. (يرجى التحقق من قواعد أمان Firestore).");
            }
        }

        /**
         * =============================================
         * إنشاء الواجهة (Rendering)
         * =============================================
         */

        /**
         * إنشاء كود HTML للقسم الواحد وجميع عناصره
         */
        function renderSection(doc) {
            const section = doc.data();
            const sectionId = doc.id;
            const editors = section.editors || []; 
            const userCanEditThisSection = currentUserRole !== 'suspended' && (isUserAdmin || editors.includes(currentUserName)); 
            
            // ===============================================
            // منطق إخفاء القسم عن المشاهدين
            // ===============================================
            const isVisibleToAll = section.isVisible !== false; // القيمة الافتراضية هي true إذا لم يتم تعيينها

            if (!isVisibleToAll && !isUserAdmin) {
                // إذا كان القسم غير مرئي للجميع والمستخدم ليس مديراً، لا تعرضه.
                return;
            }
            // ===============================================

            const sectionDiv = document.createElement('div');
            sectionDiv.className = "bg-white rounded-xl shadow-2xl overflow-hidden flex flex-col column-wrapper";
            sectionDiv.dataset.sectionId = sectionId;
            sectionDiv.dataset.canEdit = userCanEditThisSection; 

            const headerDiv = document.createElement('div');
            headerDiv.className = "column-header p-5 border-b border-gray-200 bg-gray-50 flex justify-between items-center";
            headerDiv.innerHTML = `
                <h2 class="text-2xl font-bold text-teal-800 flex items-center gap-3">
                    <svg class="w-7 h-7" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.125 2.25h-4.5c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125v-9M10.125 2.25h.375a9 9 0 019 9v.375M10.125 2.25A3.375 3.375 0 0113.5 5.625v1.5c0 .621.504 1.125 1.125 1.125h1.5a3.375 3.375 0 013.375 3.375M9 15l2.25 2.25L15 12" /></svg>
                    <span class="section-title-text">${section.title || 'قسم بدون عنوان'}</span>
                </h2>
                <div class="flex items-center gap-2">
                    ${userCanEditThisSection ? ` 
                    <button class="section-edit-btn p-1 text-blue-500 hover:text-blue-700 transition-colors" title="تعديل القسم"><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L6.832 19.82a4.5 4.5 0 01-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 011.13-1.897L16.863 4.487zm0 0L19.5 7.125" /></svg></button>
                    ${isUserAdmin ? `<button class="section-delete-btn p-1 text-red-500 hover:text-red-700 transition-colors" title="حذف القسم"><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12.578 0a48.09 48.09 0 013.478-.397m7.5 0a48.09 48.09 0 00-7.5 0" /></svg></button>` : ''} 
                    ` : ''}
                    <button class="section-print-btn p-1 text-green-500 hover:text-green-700 transition-colors" title="طباعة القسم كـ PDF">
                         <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                           <path fill-rule="evenodd" d="M5 2.75C5 1.784 5.784 1 6.75 1h6.5c.966 0 1.75.784 1.75 1.75v3.5A1.75 1.75 0 0113.25 8H6.75A1.75 1.75 0 015 6.25v-3.5zm.75 0v3.5c0 .138.112.25.25.25h6.5a.25.25 0 00.25-.25v-3.5a.25.25 0 00-.25-.25h-6.5a.25.25 0 00-.25.25zM6 10.75A.75.75 0 016.75 10h6.5a.75.75 0 010 1.5h-6.5A.75.75 0 016 10.75zM6 13.75A.75.75 0 016.75 13h6.5a.75.75 0 010 1.5h-6.5A.75.75 0 016 13.75zM3.25 9A1.75 1.75 0 001.5 10.75v3.5c0 .966.784 1.75 1.75 1.75h1.25a.75.75 0 010 1.5H3.25A3.25 3.25 0 010 14.25v-3.5A3.25 3.25 0 013.25 7.5h13.5A3.25 3.25 0 0120 10.75v3.5A3.25 3.25 0 0116.75 17.5h-1.25a.75.75 0 010-1.5h1.25A1.75 1.75 0 0018.5 14.25v-3.5A1.75 1.75 0 0016.75 9H3.25z" clip-rule="evenodd" />
                         </svg>
                    </button>
                    <button class="section-share-btn p-1 text-green-500 hover:text-green-600 transition-colors" title="مشاركة عبر واتساب">
                       <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 16 16"> <path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 014.66 1.931 6.557 6.557 0 011.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z"/> </svg>
                    </button>
                </div>
            `;
            sectionDiv.appendChild(headerDiv);

            const listDiv = document.createElement('div');
            listDiv.className = "p-4 space-y-3 flex-grow column-list";

            const items = section.items || [];
            if (items.length > 0) {
                items.forEach(item => {
                    listDiv.appendChild(renderItem(item, userCanEditThisSection)); 
                });
            } else {
                listDiv.innerHTML = `<p class="text-gray-400 text-center p-4">لا توجد عناصر في هذا القسم.</p>`;
            }
            sectionDiv.appendChild(listDiv);

             const footerDiv = document.createElement('div');
             footerDiv.className = "p-4 bg-gray-100 border-t";
             if (userCanEditThisSection) {
                 footerDiv.innerHTML = `
                      <button class="add-item-btn w-full bg-teal-600 text-white py-3 px-4 rounded-lg font-bold hover:bg-teal-700 transition duration-300 flex items-center justify-center gap-2" data-column-id="${sectionId}">
                          <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                          إضافة عنصر
                      </button>
                 `;
             } else {
                 footerDiv.innerHTML = `
                      <button class="request-control-btn w-full bg-yellow-500 text-white py-3 px-4 rounded-lg font-bold hover:bg-yellow-600 transition duration-300 flex items-center justify-center gap-2" data-section-id="${sectionId}" data-section-title="${section.title || ''}">
                          <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25a3 3 0 013 3m3 0a6 6 0 01-7.029 5.912c-.563-.097-1.159.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 1121.75 8.25z" /></svg>
                          طلب التحكم في القسم
                      </button>
                 `;
             }
             sectionDiv.appendChild(footerDiv);

            if (sectionsContainer) sectionsContainer.appendChild(sectionDiv);
        }

        /**
         * إنشاء كود HTML للعنصر الواحد
         */
        function renderItem(item, canEdit) { 
             if (!item || !item.id) return document.createElement('div');

            const itemDiv = document.createElement('div');
            // تم تعديل فئة itemDiv لحذف "justify-between" والسماح للعنوان بالنمو بشكل أفضل
            // تم إضافة group لتفعيل group-hover
            itemDiv.className = "group item-card bg-white p-4 rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition-shadow relative item-wrapper flex items-center";
            itemDiv.dataset.itemId = item.id;

            let href = item.url || '#';
            let target = (item.type === 'link' && item.url) ? 'target="_blank" rel="noopener noreferrer"' : '';
            let download = (item.type === 'file') ? `download="${item.title || 'file'}"` : '';
            
            const formattedTitle = replaceEmojis(item.title);


            const itemTypeIcon = (item.type === 'link')
                ? `<svg class="w-6 h-6 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244" /></svg>`
                : `<svg class="w-6 h-6 text-green-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m.75 12l3 3m0 0l3-3m-3 3v-6m-1.5-9H5.625a3.375 3.375 0 00-3.375 3.375v11.25a3.375 3.375 0 003.375 3.375h12.75a3.375 3.375 0 003.375-3.375V12M10.5 1.5H18" /></svg>`;
                
            // (جديد) مقبض السحب والإفلات - يظهر على الجوال والمدير
            const dragHandle = canEdit ? `
                <div class="drag-handle text-teal-800 hover:bg-gray-100 ${canEdit ? 'flex' : 'hidden'} md:hidden md:group-hover:flex">
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5M12 17.25h8.25"/></svg>
                </div>
            ` : '';
            
            // (تعديل) جعل الأزرار مرئية دائما على الجوال (بدون hover)
            const controlButtons = canEdit ? `
                 <div class="flex items-center gap-1 flex-shrink-0"> 
                     <button class="item-edit-btn p-1 text-blue-500 hover:text-blue-700 transition-colors" title="تعديل العنصر">
                         <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L6.832 19.82a4.5 4.5 0 01-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 011.13-1.897L16.863 4.487zm0 0L19.5 7.125" /></svg>
                     </button>
                     <button class="item-delete-btn p-1 text-red-500 hover:text-red-700 transition-colors" title="حذف العنصر">
                         <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12.578 0a48.09 48.09 0 013.478-.397m7.5 0a48.09 48.09 0 00-7.5 0" /></svg>
                     </button>
                 </div>
             ` : '';


            // (تعديل رئيسي) تم إعادة ترتيب العناصر لضمان ظهور العنوان أولاً مع منح مساحة مرنة له
            itemDiv.innerHTML = `
                ${dragHandle}
                 <div class="flex items-center gap-3 flex-1 min-w-0"> 
                    ${itemTypeIcon}
                    <a href="${href}" ${target} ${download} class="font-semibold text-gray-800 hover:text-teal-600 transition-colors flex-grow min-w-0 overflow-hidden">
                        <span class="block truncate">${formattedTitle || 'عنصر بدون عنوان'}</span>
                    </a>
                 </div>

                 <div class="flex items-center gap-1 flex-shrink-0 mr-2"> 
                     
                     <button class="item-share-btn p-1 text-green-500 hover:text-green-600 transition-colors" title="مشاركة عبر واتساب">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 16 16"> <path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 014.66 1.931 6.557 6.557 0 011.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z"/> </svg>
                     </button>
                    ${controlButtons}
                 </div>
            `;
            return itemDiv;
        }


        /**
         * =============================================
         * منطق الأزرار والوظائف الإضافية
         * =============================================
         */

        /**
         * ربط الأحداث للأزرار العلوية وأزرار التحكم
         */
        function setupControlEvents(isAdmin) {

            // --- 1. الأزرار العامة ---
            
            // منطق الخروج الجديد
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async () => {
                    if (confirm("هل أنت متأكد أنك تريد تسجيل الخروج؟")) {
                        await signOut(auth); // الخروج من جلسة Firebase المصادق عليها
                        // onAuthStateChanged سيتولى إظهار شاشة الدخول
                    }
                });
            }

            const printSectionsBtn = document.getElementById('print-sections-btn');
            if (printSectionsBtn) {
                printSectionsBtn.addEventListener('click', async () => {
                    await generatePdfForSections(null);
                });
            }
            
            // (جديد) ربط زر حذف جميع الدردشات
            if (deleteAllChatBtn && isAdmin) {
                 deleteAllChatBtn.classList.remove('hidden');
                 deleteAllChatBtn.addEventListener('click', deleteAllChats);
            } else if (deleteAllChatBtn) {
                 deleteAllChatBtn.classList.add('hidden');
            }


            // --- 3. تفويض الأحداث للأزرار داخل الأقسام والعناصر ---
            if (sectionsContainer) {
                 sectionsContainer.addEventListener('click', async (e) => {

                     const requestControlBtn = e.target.closest('.request-control-btn');
                     if (requestControlBtn && !isUserAdmin) { 
                         const sectionId = requestControlBtn.dataset.sectionId;
                         const sectionTitle = requestControlBtn.dataset.sectionTitle;
                         if (sectionId && sectionTitle) {
                            await requestSectionControl(sectionId, sectionTitle);
                         }
                         return;
                     }

                     const deleteItemBtn = e.target.closest('.item-delete-btn');
                     if (deleteItemBtn) {
                         const sectionEl = deleteItemBtn.closest('.column-wrapper');
                         const itemEl = deleteItemBtn.closest('.item-card');
                         if (sectionEl && itemEl) {
                            const sectionId = sectionEl.dataset.sectionId;
                            const itemId = itemEl.dataset.itemId;
                            deleteItem(sectionId, itemId);
                         }
                         return;
                     }

                     const deleteSectionBtn = e.target.closest('.section-delete-btn');
                     if (deleteSectionBtn && isAdmin) {
                         const sectionEl = deleteSectionBtn.closest('.column-wrapper');
                         if (sectionEl) {
                            const sectionId = sectionEl.dataset.sectionId;
                            deleteSection(sectionId);
                         }
                         return;
                     }

                     const printSectionBtn = e.target.closest('.section-print-btn');
                     if (printSectionBtn) {
                         const sectionEl = printSectionBtn.closest('.column-wrapper');
                         if (sectionEl) {
                            await generatePdfForSections(sectionEl);
                         }
                         return;
                     }

                     const shareSectionBtn = e.target.closest('.section-share-btn');
                     if (shareSectionBtn) {
                         const sectionEl = shareSectionBtn.closest('.column-wrapper');
                         if (sectionEl) {
                             shareSectionViaWhatsApp(sectionEl.dataset.sectionId);
                         }
                         return;
                     }

                      const shareItemBtn = e.target.closest('.item-share-btn');
                      if (shareItemBtn) {
                          const itemEl = shareItemBtn.closest('.item-card');
                           if (itemEl) {
                                 const title = itemEl.querySelector('a span')?.textContent.trim() || '';
                                 const url = itemEl.querySelector('a')?.href || '';
                                 // تأكد من أن هناك رابط صالح للمشاركة
                                 if (itemEl.querySelector('a')?.getAttribute('target')) {
                                    shareItemViaWhatsApp(title, url);
                                 } else {
                                     showAlert("لا يمكن مشاركة هذا العنصر لأنه لا يحتوي على رابط مباشر.");
                                 }
                           }
                           return;
                      }

                 });
            }
        }
        
        /**
         * (جديد ومُعدَّل) دالة حذف جميع الدردشات (للمدير)
         */
        window.deleteAllChats = async function() {
            if (!isUserAdmin) {
                showAlert("ليس لديك صلاحية المدير لتنفيذ هذا الإجراء.", 'error');
                return;
            }

            if (!confirm("⚠️ تحذير نهائي! هل أنت متأكد من حذف جميع الرسائل (الجماعية والخاصة) نهائياً؟ هذا الإجراء لا يمكن التراجع عنه.")) return;

            try {
                const batch = writeBatch(db);
                
                // 1. حذف جميع رسائل الدردشة الجماعية (Collection: chat_group)
                const groupSnapshot = await getDocs(chatPaths.groupChatCollection());
                groupSnapshot.docs.forEach((doc) => {
                    batch.delete(doc.ref);
                });

                // 2. تصفح جميع الوثائق في المجموعة الأصلية للمحادثات الخاصة (Collection: chat_private)
                // وحذف الرسائل الموجودة داخل المجموعات الفرعية لكل وثيقة
                const privateChatsBaseRef = collection(db, 'chat_private');
                const privateChatsSnapshot = await getDocs(privateChatsBaseRef);
                
                for (const docSnap of privateChatsSnapshot.docs) {
                    const messagesCollectionRef = collection(db, `chat_private/${docSnap.id}/messages`);
                    const messagesSnapshot = await getDocs(messagesCollectionRef);
                    
                    // حذف كل رسالة داخل هذه المحادثة الخاصة
                    messagesSnapshot.docs.forEach((msgDoc) => {
                        batch.delete(msgDoc.ref);
                    });
                }
                
                // 3. مسح جميع حالات العدادات غير المقروءة (Collection: chat_state)
                const chatStateBaseRef = collection(db, 'chat_state');
                const chatStateSnapshot = await getDocs(chatStateBaseRef);
                
                for (const userStateDoc of chatStateSnapshot.docs) {
                     const stateSubCollection = collection(db, `chat_state/${userStateDoc.id}/state`);
                     const stateSnapshot = await getDocs(stateSubCollection);
                     
                     // حذف كل وثيقة حالة دردشة (التي تحتوي على العدادات)
                     stateSnapshot.docs.forEach((stateDoc) => {
                         batch.delete(stateDoc.ref);
                     });
                }


                await batch.commit();
                showAlert("✅ تم حذف جميع سجلات الدردشة بنجاح!", 'success');
                
                // إغلاق نافذة الدردشة وتحديث قائمة الرسائل
                if (chatWindow && !chatWindow.classList.contains('hidden')) {
                     document.getElementById('close-chat').click();
                }
            } catch (error) {
                console.error("خطأ في حذف جميع الدردشات:", error);
                showAlert("❌ حدث خطأ كبير أثناء حذف الدردشات. (تأكد من قواعد أمان Firestore)", 'error');
            }
        }


        /**
         * إظهار نافذة التنبيه
         */
        function showAlert(message, type = 'info') {
            const alertModalMessage = document.getElementById('alert-modal-message');
            const modalContent = document.getElementById('alert-modal-content');

            if (alertModalMessage && alertModal && modalContent) {
                alertModalMessage.textContent = message;
                alertModal.classList.remove('hidden');
                setTimeout(() => {
                    modalContent.classList.remove('scale-95', 'opacity-0');
                    modalContent.classList.add('scale-100', 'opacity-100');
                }, 10);
            }
        }

        /**
         * مشاركة عنصر عبر واتساب
         */
        function shareItemViaWhatsApp(title, url) {
            if (!title || !url) {
                showAlert("لا يمكن مشاركة هذا العنصر لأنه لا يحتوي على عنوان أو رابط.");
                return;
            }
            const message = encodeURIComponent(`${title}\n${url}`);
            const whatsappUrl = `https://wa.me/?text=${message}`;
            window.open(whatsappUrl, '_blank');
        }

        /**
         * مشاركة قسم كامل عبر واتساب
         */
        async function shareSectionViaWhatsApp(sectionId) {
             if (!sectionId) return;
             const sectionData = await getSectionDataById(sectionId);
             if (!sectionData) {
                 showAlert("لم يتم العثور على بيانات القسم للمشاركة.");
                 return;
             }

             let message = `*${sectionData.title || 'قسم بدون عنوان'}*\n\n`; 
             const items = sectionData.items || [];
             if (items.length > 0) {
                 items.forEach(item => {
                      if (item.title && item.url && item.type === 'link') {
                          message += `${item.title}\n${item.url}\n\n`;
                      }
                 });
             } else {
                 message += "_لا توجد عناصر في هذا القسم._"; 
             }

             const encodedMessage = encodeURIComponent(message.trim());
             const whatsappUrl = `https://wa.me/?text=${encodedMessage}`;
             window.open(whatsappUrl, '_blank');
        }


        /**
         * =============================================
         * منطق إنشاء PDF مع QR Code
         * =============================================
         */
         
         /**
          * دالة مساعدة لتقسيم مصفوفة إلى أجزاء
          */
        function chunkArray(array, size) {
           if (!Array.isArray(array)) {
               return [];
           }
           const chunks = [];
           for (let i = 0; i < array.length; i += size) {
               chunks.push(array.slice(i, i + size));
           }
           return chunks;
        }


        /**
         * دالة مساعدة لإنشاء صفحة PDF واحدة من كود HTML
         */
        async function createPdfPageFromHTML(doc, sectionTitle, itemChunk, isFirstPage) {
            const printContainer = document.createElement('div');
            printContainer.className = 'print-container';

            const superHeader = document.createElement('div');
            superHeader.className = 'print-super-header';
            superHeader.innerHTML = `
                <div>المملكة العربية السعودية</div>
                <div>وزارة التعليم</div>
                <div>الإدارة العامة للتعليم بمنطقة عسير</div>
                <div>ابتدائية ومتوسطة الراشدون بالمربع</div>
            `;
            printContainer.appendChild(superHeader);

            const header = document.createElement('div');
            header.className = 'print-header';
            header.innerHTML = '<h1>تقرير منصة الراشدون</h1>';
            printContainer.appendChild(header);

            const contentWrapper = document.createElement('div');
            contentWrapper.className = 'print-content-wrapper';

            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'print-section';

            const titleDiv = document.createElement('div');
            titleDiv.className = 'print-section-title';
            titleDiv.textContent = sectionTitle || 'قسم بدون عنوان';
            sectionDiv.appendChild(titleDiv);

            const listDiv = document.createElement('div');
            listDiv.className = 'print-item-list';

             // (جديد) قائمة لحفظ بيانات الـ QR Code لربطها بالـ PDF
             const qrDataForPdf = [];
             
             if (Array.isArray(itemChunk) && itemChunk.length > 0) {
                 for (const item of itemChunk) {
                      if (typeof item !== 'object' || item === null) continue;

                      const itemDiv = document.createElement('div');
                      itemDiv.className = 'print-item';

                      const textDiv = document.createElement('div');
                      textDiv.className = 'print-item-text';
                      textDiv.innerHTML = `<div class="print-item-title">${item.title || 'عنصر بدون عنوان'}</div>`; 

                      const qrDiv = document.createElement('div');
                      qrDiv.className = 'print-item-qr';
                      const url = (item.type === 'link' && item.url) ? item.url : '';
                      qrDiv.dataset.url = url;

                      itemDiv.appendChild(textDiv);
                      itemDiv.appendChild(qrDiv);
                      listDiv.appendChild(itemDiv);
                      
                      if (url) {
                         qrDataForPdf.push({ div: qrDiv, url: url, text: item.title });
                      }
                 }
             } else {
                 listDiv.innerHTML = '<p style="padding: 10px; text-align: center;">لا توجد عناصر في هذا القسم.</p>';
             }
            sectionDiv.appendChild(listDiv);
            contentWrapper.appendChild(sectionDiv);
            printContainer.appendChild(contentWrapper);

            const footer = document.createElement('div');
            footer.className = 'print-footer';
            footer.innerHTML = `
                <span>إعداد المعلم: علي إبراهيم عسيري</span>
                <span>مدير المدرسة: أحمد سالم الشهري</span>
            `;
            printContainer.appendChild(footer);

            document.body.appendChild(printContainer);

            // إنشاء صور QR مؤقتاً في HTML
            qrDataForPdf.forEach(qr => {
                try { 
                    new QRCode(qr.div, {
                        text: qr.url,
                        width: 80,
                        height: 80,
                        correctLevel: QRCode.CorrectLevel.L
                    });
                } catch(qrError) {
                    qr.div.textContent = "[خطأ QR]"; 
                }
            });

            await new Promise(resolve => setTimeout(resolve, 500));

            let canvas;
            try {
                canvas = await html2canvas(printContainer, {
                    scale: 2,
                    useCORS: true,
                    width: printContainer.offsetWidth,
                    height: printContainer.offsetHeight
                });
            } catch (canvasError) {
                 document.body.removeChild(printContainer); 
                 throw canvasError; 
            }

            const imgData = canvas.toDataURL('image/png');
            const pdfWidth = doc.internal.pageSize.getWidth();
            const pdfHeight = doc.internal.pageSize.getHeight();
            
            // إضافة صفحة جديدة إذا لم تكن الصفحة الأولى
            if (!isFirstPage) doc.addPage();


            // الحصول على أبعاد العناصر في الصفحة المطبوعة
            const elementsBounds = [];
            qrDataForPdf.forEach(qr => {
                 const rect = qr.div.getBoundingClientRect();
                 elementsBounds.push({
                     url: qr.url,
                     // تحويل البكسلات إلى ملم
                     x: rect.right / (canvas.width / pdfWidth) - (rect.width / (canvas.width / pdfWidth)), // تم تعديل حساب x للرسم من اليمين
                     y: rect.top / (canvas.height / pdfHeight),
                     width: rect.width / (canvas.width / pdfWidth),
                     height: rect.height / (canvas.height / pdfHeight)
                 });
            });

            doc.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);

            // (جديد) إضافة رابط قابل للنقر فوق كل QR Code
            elementsBounds.forEach(bound => {
                doc.link(bound.x, bound.y, bound.width, bound.height, { url: bound.url });
            });

            document.body.removeChild(printContainer);
        }


        /**
         * الدالة الرئيسية لإنشاء وتنزيل الـ PDF
         */
        async function generatePdfForSections(specificSectionElement) {

            if (!pdfSpinnerModal) return; 
            pdfSpinnerModal.classList.remove('hidden');

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'p',
                unit: 'mm',
                format: 'a4'
            });

            try {
                 const sectionsToPrintElements = specificSectionElement
                      ? [specificSectionElement]
                      : (sectionsContainer ? Array.from(sectionsContainer.querySelectorAll('.column-wrapper')) : []); 


                 const sectionsData = [];
                 for (const el of sectionsToPrintElements) {
                      if (el && el.dataset && el.dataset.sectionId) {
                          const data = await getSectionDataById(el.dataset.sectionId);
                          if (data) sectionsData.push(data);
                      }
                 }

                 let isFirstPage = true;

                 for (const section of sectionsData) {
                      const items = (section && Array.isArray(section.items)) ? section.items : [];
                      const sectionTitle = (section && section.title) ? section.title : 'قسم بدون عنوان';

                      const itemChunks = chunkArray(items, 5); 

                      if (itemChunks.length === 0) {
                           await createPdfPageFromHTML(doc, sectionTitle, [], isFirstPage);
                           isFirstPage = false;
                      } else {
                           for (const chunk of itemChunks) {
                                await createPdfPageFromHTML(doc, sectionTitle, chunk, isFirstPage);
                                isFirstPage = false;
                           }
                      }
                 }

                 if (!isFirstPage) { 
                     doc.save('تقرير-الراشدون.pdf');
                 } else {
                     showAlert("لا يوجد محتوى لطباعته.");
                 }

            } catch (error) {
                console.error("خطأ في إنشاء ملف PDF:", error);
                showAlert("حدث خطأ أثناء إنشاء ملف PDF.");
            } finally {
                if (pdfSpinnerModal) pdfSpinnerModal.classList.add('hidden');
            }
        }


        /**
         * دالة مساعدة لجلب بيانات القسم المحدثة قبل الطباعة
         */
        async function getSectionDataById(sectionId) {
            if (!sectionId) return null;
             if (!db || !sectionsPath) return null;
            try {
                const sectionRef = doc(db, sectionsPath, sectionId);
                const sectionSnap = await getDoc(sectionRef);
                if (sectionSnap.exists()) {
                    return sectionSnap.data();
                }
                return null;
            } catch (error) {
                return null;
            }
        }

        // =================================================================
        // == (جديد) بدء منطق الدردشة المدمج ==
        // =================================================================

        /**
         * (جديد) بدء تشغيل منطق الدردشة
         */
        function initializeChatApp() {
            // (تعديل) التأكد من أن جميع عناصر الدردشة تم جلبها بشكل صحيح
            chatUsernameDisplay = document.getElementById('chat-username-display');
            chatUsersListDiv = document.getElementById('chat-users-list');
            chatMessagesDiv = document.getElementById('chat-messages');
            messageForm = document.getElementById('message-form');
            messageInput = document.getElementById('message-input');
            chatTitle = document.getElementById('chat-title');
            chatSubtitle = document.getElementById('chat-subtitle');
            
            if (!chatUsernameDisplay || !chatUsersListDiv || !chatMessagesDiv || !messageForm) {
                return;
            }
            
            chatUsernameDisplay.textContent = currentUserName;

            initChatAudio(); 
            document.body.addEventListener('click', initChatAudio, { once: true });
            document.body.addEventListener('keydown', initChatAudio, { once: true });

            messageForm.addEventListener('submit', handleChatMessageSubmit);
            
            listenToChatUsersAndAdmins();
            
            listenToChatUnreadCounts();
            
            chatCurrentChat = { type: 'group', id: 'group' };
        }

        /**
         * (جديد) تحديث تواجد المستخدم (لآخر ظهور)
         */
        async function updateUserPresence() {
            if (!userId || !currentUserName) return;
            try {
                await setDoc(chatPaths.userDoc(userId), { 
                    name: currentUserName, 
                    role: currentUserRole,
                    lastSeen: serverTimestamp(),
                    email: currentUserEmail
                }, { merge: true });
            } catch (e) {
                console.error("فشل في تحديث حالة التواجد:", e);
            }
        }
        
        /**
         * (جديد) تهيئة الصوت للدردشة
         */
        function initChatAudio() {
            if (chatSoundReady) return;
            Tone.start().then(() => {
                // استخدام صوت Sine بسيط وواضح للإشعارات
                chatSynth = new Tone.Synth({
                    oscillator: { type: "triangle" }, // استخدام موجة مثلثية أكثر وضوحاً
                    envelope: {
                        attack: 0.01,
                        decay: 0.2, 
                        sustain: 0,
                        release: 0.3
                    }
                }).toDestination();
                chatSoundReady = true;
            }).catch(e => console.error("Chat Audio init failed:", e));
        }
        
        /**
         * (جديد) تشغيل صوت إشعار الدردشة
         */
        function playChatNotificationSound() {
            if (chatSoundReady && chatSynth) {
                try {
                    // تشغيل نغمة عالية وواضحة (C5) بمدة أطول
                    chatSynth.triggerAttackRelease("C5", "8n"); 
                } catch(e) {
                    // (فشل)
                }
            } else {
                if (!chatSoundReady) initChatAudio();
            }
        }

        /**
         * (جديد) الاستماع لمستخدمي المنصة لبناء قوائم الدردشة
         */
        function listenToChatUsersAndAdmins() {
            onSnapshot(chatPaths.usersCollection(), (snapshot) => {
                chatAllUsers = {};
                chatAdminList = {};
                snapshot.forEach((doc) => {
                    const userData = doc.data();
                    const aUserId = doc.id; 
                    chatAllUsers[aUserId] = userData;
                    if (userData.role === 'admin') {
                        chatAdminList[aUserId] = userData;
                    }
                });
                renderPrivateChatList(); 
                setupPersistentChatListeners(); 
            }, (error) => console.error("Error listening to chat users:", error));
        }

        /**
         * (جديد) دالة اختيار الدردشة (تفتح نافذة الرسائل)
         */
        window.selectChat = function(type, targetId) {
            const oldTab = document.getElementById(`chat-tab-${chatCurrentChat.id.replace(':', '-')}`);
            if (oldTab) {
                oldTab.classList.remove('bg-blue-50', 'border-r-4', 'border-blue-500');
            }
            
            let chatId, title, subtitle;
            
            if (type === 'group') {
                chatId = 'group';
                title = 'دردشة جماعية';
                subtitle = 'رسائل عامة للجميع';
                
                const newTab = document.getElementById('chat-tab-group');
                if(newTab) newTab.classList.add('bg-blue-50', 'border-r-4', 'border-blue-500');

            } else {
                const otherUserId = targetId;
                const otherUserData = chatAllUsers[otherUserId];
                
                if (!otherUserData) {
                    showAlert("خطأ: لم يتم العثور على بيانات هذا المستخدم.");
                    return;
                }
                
                title = otherUserData.name || `مستخدم ${otherUserId.substring(0, 5)}`;
                subtitle = `محادثة خاصة مع ${title}`;
                
                chatId = getPrivateChatId(otherUserId);
                
                const newTab = document.getElementById(`chat-tab-${chatId.replace(':', '-')}`);
                if (newTab) {
                    newTab.classList.add('bg-blue-50', 'border-r-4', 'border-blue-500');
                }
            }
            
            // --- تبديل الواجهة ---
            if (chatListView && chatMessageView) {
                chatListView.classList.add('hidden');
                chatMessageView.classList.remove('hidden');
            }
            
            chatCurrentChat = { type, id: chatId };
            if (chatTitle) chatTitle.textContent = title;
            if (chatSubtitle) chatSubtitle.textContent = subtitle;
            if (chatMessagesDiv) chatMessagesDiv.innerHTML = '<div class="text-center text-gray-500">جاري تحميل الرسائل...</div>';
            
            listenToChatMessages(chatId, type);
            
            clearChatUnreadCount(chatId);
        }

        /**
         * (جديد) دالة مساعدة لإنشاء معرف دردشة خاص
         */
        function getPrivateChatId(otherUserId) {
            if (!userId || !otherUserId) return null;
            return [userId, otherUserId].sort().join(':');
        }

        /**
         * (جديد) الاستماع لرسائل الدردشة المحددة
         */
        function listenToChatMessages(chatId, type) {
            if (chatMessageListeners[chatCurrentChat.id]) {
                chatMessageListeners[chatCurrentChat.id]();
                delete chatMessageListeners[chatCurrentChat.id];
            }
            
            let q;
            if (type === 'group') {
                q = query(chatPaths.groupChatCollection(), orderBy("timestamp", "desc"), limit(50));
            } else {
                q = query(chatPaths.privateChatCollection(chatId), orderBy("timestamp", "desc"), limit(50));
            }
            
            const unsubscribe = onSnapshot(q, (snapshot) => {
                const messages = [];
                snapshot.forEach((doc) => {
                    messages.push({ id: doc.id, ...doc.data() });
                });
                renderChatMessages(messages.reverse());
                
                if (snapshot.docChanges().length > 0) {
                    const lastChange = snapshot.docChanges()[snapshot.docChanges().length - 1];
                    if (lastChange.type === "added") {
                        const newMessage = lastChange.doc.data();
                        if (newMessage.userId !== userId) { 
                            const now = Date.now();
                            const msgTime = newMessage.timestamp?.toDate().getTime() || now;
                            if ((now - msgTime) < 5000) { 
                                playChatNotificationSound();
                            }
                        }
                    }
                }
            }, (error) => {
                if (chatMessagesDiv) chatMessagesDiv.innerHTML = `<div class="text-center text-red-500">خطأ في تحميل الرسائل: ${error.message}</div>`;
            });
            
            chatMessageListeners[chatId] = unsubscribe;
        }


        /**
         * (جديد) إرسال رسالة دردشة
         */
        async function handleChatMessageSubmit(e) {
            e.preventDefault();
            if (!messageInput) return;
            const messageText = messageInput.value.trim();
            if (messageText === '' || !userId || !currentUserName) return;
            
            initChatAudio(); 
            
            const messageData = {
                text: messageText,
                userId: userId, 
                username: currentUserName, 
                timestamp: serverTimestamp()
            };
            
            try {
                if (chatCurrentChat.type === 'group') {
                    await addDoc(chatPaths.groupChatCollection(), messageData);
                } else {
                    await addDoc(chatPaths.privateChatCollection(chatCurrentChat.id), messageData);
                }
                messageInput.value = '';
            } catch (e) {
                showAlert("خطأ في إرسال الرسالة.");
            }
        }
        
        /**
         * (جديد) حذف رسالة (للمدير فقط)
         * @param {string} messageId - معرف الرسالة في Firestore
         */
        window.deleteChatMessage = async function(messageId) {
            if (!isUserAdmin || !messageId) return;

            if (!confirm("هل أنت متأكد من حذف هذه الرسالة؟")) return;

            try {
                let docRef;
                if (chatCurrentChat.type === 'group') {
                    docRef = doc(db, 'chat_group', messageId);
                } else {
                    // chatId هو مسار الوثائق الفرعية
                    docRef = doc(db, `chat_private/${chatCurrentChat.id}/messages`, messageId); 
                }
                
                await deleteDoc(docRef);
                showAlert("تم حذف الرسالة بنجاح (كمدير).", 'success');
            } catch (e) {
                console.error("خطأ في حذف الرسالة:", e);
                showAlert("فشل حذف الرسالة.");
            }
        }

        /**
         * (جديد) رسم قائمة رسائل الدردشة
         */
        function renderChatMessages(messages) {
            if (!chatMessagesDiv) return;
            if (messages.length === 0) {
                chatMessagesDiv.innerHTML = '<div class="text-center text-gray-500">لا توجد رسائل بعد.</div>';
                return;
            }
            
            chatMessagesDiv.innerHTML = messages.map(msg => {
                const isSender = msg.userId === userId; 
                const senderName = isSender ? 'أنت' : (msg.username || 'مستخدم');
                const time = msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' }) : '';
                
                // إضافة دعم الرموز التعبيرية البسيط
                const formattedText = replaceEmojis(msg.text);
                
                // زر الحذف (يظهر للمدير فقط)
                const deleteButton = isUserAdmin ? `
                    <button onclick="deleteChatMessage('${msg.id}')" class="text-red-300 hover:text-red-500 transition-colors ml-2" title="حذف الرسالة">
                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                    </button>
                ` : '';

                if (isSender) {
                    return `
                        <div class="flex justify-start">
                            <div class="max-w-xs px-4 py-3 rounded-lg bg-blue-500 text-white shadow-md">
                                <p class="text-sm font-semibold mb-1">${senderName}</p>
                                <p class="text-base break-words">${formattedText}</p>
                                <div class="flex justify-between items-center text-xs text-blue-200 mt-1">
                                    ${deleteButton}
                                    <span>${time}</span>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    return `
                        <div class="flex justify-end">
                            <div class="max-w-xs px-4 py-3 rounded-lg bg-gray-200 text-gray-800 shadow-md">
                                <p class="text-sm font-semibold mb-1">${senderName}</p>
                                <p class="text-base break-words">${formattedText}</p>
                                <div class="flex justify-between items-center text-xs text-gray-500 mt-1">
                                    ${deleteButton}
                                    <span>${time}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }).join('');
            
            chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
        }
        
        /**
         * (جديد) رسم قائمة الدردشات الخاصة (المديرين أو المستخدمين)
         */
        function renderPrivateChatList() {
            if (!chatUsersListDiv) return;
            
            let usersHtml = '';
            
            if (isUserAdmin) {
                Object.keys(chatAllUsers).forEach(uid => {
                    if (uid === userId) return;
                    
                    const user = chatAllUsers[uid];
                    const chatId = getPrivateChatId(uid);
                    const unreadCount = chatUnreadCounts[chatId] || 0;
                    
                    usersHtml += `
                        <div id="chat-tab-${chatId.replace(':', '-')}" class="p-4 flex justify-between items-center cursor-pointer border-b hover:bg-gray-100" onclick="selectChat('private', '${uid}')">
                            <div>
                                <h3 class="font-semibold text-gray-900">${user.name || `مستخدم ${uid.substring(0, 5)}`}</h3>
                                <p class="text-sm text-gray-600 truncate">${user.role || 'viewer'}</p>
                            </div>
                            <span id="unread-badge-${chatId.replace(':', '-')}" class="${unreadCount > 0 ? '' : 'hidden'} w-6 h-6 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center">${unreadCount}</span>
                        </div>
                    `;
                });
                chatUsersListDiv.innerHTML = usersHtml || '<p class="p-4 text-sm text-gray-500">لا يوجد مستخدمون آخرون بعد.</p>';
                
            } else {
                Object.keys(chatAdminList).forEach(uid => {
                    if (uid === userId) return;
                    
                    const admin = chatAdminList[uid];
                    const chatId = getPrivateChatId(uid);
                    const unreadCount = chatUnreadCounts[chatId] || 0;
                    
                    usersHtml += `
                        <div id="chat-tab-${chatId.replace(':', '-')}" class="p-4 flex justify-between items-center cursor-pointer border-b hover:bg-gray-100" onclick="selectChat('private', '${uid}')">
                            <div>
                                <h3 class="font-semibold text-gray-900">${admin.name || `مدير ${uid.substring(0, 5)}`}</h3>
                                <p class="text-sm text-gray-600">مدير النظام</p>
                            </div>
                            <span id="unread-badge-${chatId.replace(':', '-')}" class="${unreadCount > 0 ? '' : 'hidden'} w-6 h-6 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center">${unreadCount}</span>
                        </div>
                    `;
                });
                chatUsersListDiv.innerHTML = usersHtml || '<p class="p-4 text-sm text-gray-500">لا يوجد مديرون متاحون للدردشة.</p>';
            }
            
             const activeTab = document.getElementById(`chat-tab-${chatCurrentChat.id.replace(':', '-')}`);
             if (activeTab && chatMessageView.classList.contains('hidden')) {
                 activeTab.classList.add('bg-blue-50', 'border-r-4', 'border-blue-500');
             }
        }

        /**
         * (جديد) الاستماع لعدادات الرسائل غير المقروءة
         */
        function listenToChatUnreadCounts() {
            if (!userId) return;
            const chatStateQuery = chatPaths.userChatStateCollection(userId); 
            chatMessageListeners['all-state'] = onSnapshot(chatStateQuery, (snapshot) => {
                let totalUnread = 0; // العداد الكلي للزر العائم
                
                snapshot.forEach(doc => {
                    const chatId = doc.id;
                    const count = doc.data().unreadCount || 0;
                    chatUnreadCounts[chatId] = count;
                    totalUnread += count; // إضافة للعداد الكلي
                    
                    const badge = document.getElementById(`unread-badge-${chatId.replace(':', '-')}`);
                    if (badge) {
                        badge.textContent = count;
                        badge.classList.toggle('hidden', count === 0);
                    }
                });
                
                // تحديث شارة الدردشة العائمة
                if (chatTotalBadge) {
                    chatTotalBadge.textContent = totalUnread;
                    chatTotalBadge.classList.toggle('hidden', totalUnread === 0);
                }

                if (isUserAdmin) {
                    renderPrivateChatList();
                }

            }, (error) => console.error("Error listening to chat states:", error));
        }

        /**
         * (جديد) إعداد مستمعات دائمة للرسائل غير المقروءة
         */
        function setupPersistentChatListeners() {
            if (!userId) return;
            
            // 1. مستمع دائم للدردشة الجماعية
            const groupQuery = query(chatPaths.groupChatCollection(), orderBy("timestamp", "desc"), limit(1));
            chatMessageListeners['unread-group'] = onSnapshot(groupQuery, (snapshot) => {
                if (snapshot.docChanges().length > 0 && snapshot.docChanges()[0].type === 'added') {
                    const newMessage = snapshot.docChanges()[0].doc.data();
                    if (newMessage.userId !== userId && chatCurrentChat.id !== 'group') {
                        const now = Date.now();
                        const msgTime = newMessage.timestamp?.toDate().getTime() || now;
                        if ((now - msgTime) < 10000) { 
                            incrementChatUnreadCount('group');
                        }
                    }
                }
            });
            
            // 2. مستمعات للدردشات الخاصة
            const usersToListen = isUserAdmin ? Object.keys(chatAllUsers) : Object.keys(chatAdminList);
            
            usersToListen.forEach(uid => {
                if (uid === userId) return;
                const chatId = getPrivateChatId(uid);
                
                // تجنب تكرار المستمعات إذا تم تشغيل الدالة مراراً
                if (chatMessageListeners[`unread-${chatId}`]) return; 
                
                const q = query(chatPaths.privateChatCollection(chatId), orderBy("timestamp", "desc"), limit(1));
                chatMessageListeners[`unread-${chatId}`] = onSnapshot(q, (snapshot) => {
                     if (snapshot.docChanges().length > 0 && snapshot.docChanges()[0].type === 'added') {
                          const newMessage = snapshot.docChanges()[0].doc.data();
                          if (newMessage.userId !== userId && chatCurrentChat.id !== chatId) {
                              const now = Date.now();
                              const msgTime = newMessage.timestamp?.toDate().getTime() || now;
                              if ((now - msgTime) < 10000) {
                                  incrementChatUnreadCount(chatId);
                              }
                          }
                     }
                });
            });
        }
        
        /**
         * (جديد) زيادة عداد غير مقروء
         */
        async function incrementChatUnreadCount(chatId) {
            if (!userId) return;
            const docRef = chatPaths.userChatStateDoc(userId, chatId);
            try {
                const docSnap = await getDoc(docRef);
                const currentCount = docSnap.exists() ? (docSnap.data().unreadCount || 0) : 0;
                await setDoc(docRef, { unreadCount: currentCount + 1 }, { merge: true });
                playChatNotificationSound(); // تشغيل الصوت هنا
            } catch (e) {
                // (فشل)
            }
        }
        
        /**
         * (جديد) تصفير عداد غير مقروء
         */
        async function clearChatUnreadCount(chatId) {
            if (!userId) return;
            const docRef = chatPaths.userChatStateDoc(userId, chatId);
            try {
                await setDoc(docRef, { unreadCount: 0 }, { merge: true });
            } catch (e) {
                // (فشل)
            }
        }

        // =================================================================
        // == نهاية منطق الدردشة المدمج ==
        // =================================================================

    </script>
</head>
<body class="bg-gray-100">

    <div class="flex flex-col min-h-screen">

        <header class="bg-teal-700 text-white p-4 shadow-lg">
            <div class="container mx-auto flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <svg class="w-10 h-10" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 21v-8.25M15.75 21v-8.25M8.25 21v-8.25M3 9l9-6 9 6m-1.5 12V10.332A48.36 48.36 0 0012 9.75c-2.551 0-5.056.2-7.5.582V21M3 21h18M12 6.75h.008v.008H12V6.75z" />
                    </svg>
                    <h1 class="text-2xl font-bold">منصة مدرسة الراشدون</h1>
                </div>
                <div class="flex items-center gap-3">
                    <span id="user-name-display" class="hidden md:inline"></span>
                    <svg id="user-avatar" class="w-8 h-8 bg-white text-teal-700 rounded-full p-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" />
                    </svg>
                </div>
            </div>
        </header>

        <nav class="bg-white shadow-md p-3 sticky top-0 z-40">
            <!-- تم تعديل حاوية الأزرار الرئيسية لتقليل حجم الخط والمسافة على الجوال -->
            <!-- تم إضافة flex-shrink-0 للأزرار لضمان عدم انكماشها على الجوال -->
            <div class="container mx-auto flex justify-center items-center gap-2 md:gap-4 flex-wrap">
                <!-- أزرار المدير (تظهر للمدير فقط) -->
                <div class="relative hidden flex-shrink-0"> 
                    <button id="admin-manage-btn" class="flex items-center gap-1 bg-blue-600 text-white px-3 py-1 text-sm sm:text-base rounded-lg shadow-md hover:bg-blue-700 transition duration-300">
                        <svg class="w-5 h-5 sm:w-6 sm:h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM12 15a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" /></svg>
                        إدارة 
                    </button>
                </div>
                <div class="relative hidden flex-shrink-0"> 
                    <button id="admin-perms-btn" class="flex items-center gap-1 bg-yellow-500 text-white px-3 py-1 text-sm sm:text-base rounded-lg shadow-md hover:bg-yellow-600 transition duration-300">
                        <svg class="w-5 h-5 sm:w-6 sm:h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        الطلبات
                    </button>
                    <span id="admin-perms-badge" class="notification-badge hidden">0</span>
                </div>
                <div class="relative hidden flex-shrink-0"> 
                    <button id="add-section-btn" class="flex items-center gap-1 bg-green-500 text-white px-3 py-1 text-sm sm:text-base rounded-lg shadow-md hover:bg-green-600 transition duration-300">
                        <svg class="w-5 h-5 sm:w-6 sm:h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v6m3-3H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        إضافة 
                    </button>
                </div>
                
                <!-- زر حذف الدردشات (للمدير فقط) -->
                <button id="delete-all-chat-btn" class="hidden flex items-center gap-1 bg-red-700 text-white px-3 py-1 text-sm sm:text-base rounded-lg shadow-md hover:bg-red-800 transition duration-300 flex-shrink-0">
                    <svg class="w-5 h-5 sm:w-6 sm:h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12.578 0a48.09 48.09 0 013.478-.397m7.5 0a48.09 48.09 0 00-7.5 0" /></svg>
                    حذف الدردشات
                </button>

                <!-- الأزرار العامة -->
                <button id="print-sections-btn" class="hidden flex items-center gap-1 bg-gray-600 text-white px-3 py-1 text-sm sm:text-base rounded-lg shadow-md hover:bg-gray-700 transition duration-300 flex-shrink-0">
                    <svg class="w-5 h-5 sm:w-6 sm:h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                       <path fill-rule="evenodd" d="M5 2.75C5 1.784 5.784 1 6.75 1h6.5c.966 0 1.75.784 1.75 1.75v3.5A1.75 1.75 0 0113.25 8H6.75A1.75 1.75 0 015 6.25v-3.5zm.75 0v3.5c0 .138.112.25.25.25h6.5a.25.25 0 00.25-.25v-3.5a.25.25 0 00-.25-.25h-6.5a.25.25 0 00-.25.25zM6 10.75A.75.75 0 016.75 10h6.5a.75.75 0 010 1.5h-6.5A.75.75 0 016 10.75zM6 13.75A.75.75 0 016.75 13h6.5a.75.75 0 010 1.5h-6.5A.75.75 0 016 13.75zM3.25 9A1.75 1.75 0 001.5 10.75v3.5c0 .966.784 1.75 1.75 1.75h1.25a.75.75 0 010 1.5H3.25A3.25 3.25 0 010 14.25v-3.5A3.25 3.25 0 013.25 7.5h13.5A3.25 3.25 0 0120 10.75v3.5A3.25 3.25 0 0116.75 17.5h-1.25a.75.75 0 010-1.5h1.25A1.75 1.75 0 0018.5 14.25v-3.5A1.75 1.75 0 0016.75 9H3.25z" clip-rule="evenodd" />
                    </svg>
                    طباعة الكل
                </button>
                <button id="logout-btn" class="hidden flex items-center gap-1 bg-red-500 text-white px-3 py-1 text-sm sm:text-base rounded-lg shadow-md hover:bg-red-600 transition duration-300 flex-shrink-0">
                    <svg class="w-5 h-5 sm:w-6 sm:h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M12 9l-3 3m0 0l3 3m-3-3h12.75" /></svg>
                    خروج
                </button>
                <button id="login-admin-btn" class="flex items-center gap-1 bg-teal-600 text-white px-3 py-1 text-sm sm:text-base rounded-lg shadow-md hover:bg-teal-700 transition duration-300 flex-shrink-0">
                    <svg class="w-5 h-5 sm:w-6 sm:h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M12 9l-3 3m0 0l3 3m-3-3h12.75" /></svg>
                    تسجيل الدخول
                </button>
            </div>
        </nav>

        <main class="flex-grow p-4 md:p-8">
            <div id="sections-container" class="container mx-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- تم إزالة رسالة التحميل الثابتة -->
                <p id="initial-loading-message" class="text-gray-500 text-center col-span-3 text-xl p-10">
                    جاري الاتصال بقاعدة البيانات...
                </p>
            </div>
        </main>
    </div>

    <div class="fixed bottom-6 right-6 z-50">
        <button id="chat-toggle" class="bg-blue-600 text-white rounded-full w-16 h-16 flex items-center justify-center shadow-xl hover:bg-blue-700 transition-transform hover:scale-110 relative">
            <svg class="w-8 h-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.76c0 1.6 1.123 2.994 2.707 3.227 1.087.16 2.185.283 3.293.369V21l4.076-4.076a1.526 1.526 0 011.037-.443h2.88a1.875 1.875 0 001.875-1.875V16.5m-13.5-3.825V6.375c0-1.6 1.123-2.994 2.707-3.227 1.087.16 2.185.283 3.293.369V3l4.076 4.076a1.526 1.526 0 011.037.443h2.88a1.875 1.875 0 011.875 1.875v1.65M16.5 12V6.375m0 5.625v3.825m0 0v3.75m-13.5-3.75h13.5" />
            </svg>
            <span id="chat-total-badge" class="hidden absolute top-0 right-0 transform translate-x-1/2 -translate-y-1/2 bg-red-500 text-white text-xs font-bold rounded-full w-6 h-6 flex items-center justify-center">0</span>
        </button>
    </div>

    <div id="login-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[100] p-4">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md text-center">
            <svg class="w-20 h-20 text-teal-600 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 21v-8.25M15.75 21v-8.25M8.25 21v-8.25M3 9l9-6 9 6m-1.5 12V10.332A48.36 48.36 0 0012 9.75c-2.551 0-5.056.2-7.5.582V21M3 21h18M12 6.75h.008v.008H12V6.75z" />
            </svg>
            <h2 class="text-3xl font-bold text-gray-800 mb-2">تسجيل الدخول / إنشاء حساب</h2>
            <p class="text-gray-600 mb-6">الرجاء إدخال بياناتك للدخول إلى المنصة.</p>
            <form id="login-form">
                <div class="mb-4 text-right">
                    <label for="user-name-input" class="block text-sm font-medium text-gray-700 mb-1">الاسم الكامل (للتسجيل)</label>
                    <input type="text" id="user-name-input" class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500 text-lg" placeholder="الاسم الكامل">
                </div>
                <div class="mb-4 text-right">
                    <label for="user-email-input" class="block text-sm font-medium text-gray-700 mb-1">البريد الإلكتروني</label>
                    <input type="email" id="user-email-input" required class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500 text-lg" placeholder="example@domain.com">
                </div>
                 <div class="mb-4 text-right">
                    <label for="user-password-input" class="block text-sm font-medium text-gray-700 mb-1">كلمة المرور (6 أحرف على الأقل)</label>
                    <input type="password" id="user-password-input" required class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500 text-lg" placeholder="كلمة المرور">
                </div>
                <p id="login-error" class="hidden text-red-500 text-sm mb-4"></p>
                <div class="flex flex-col gap-3">
                    <button type="submit" class="w-full bg-teal-600 text-white py-3 px-5 rounded-lg hover:bg-teal-700 transition-colors font-bold text-lg">
                        تسجيل الدخول
                    </button>
                    <button type="button" id="register-new-user-btn" class="w-full bg-gray-500 text-white py-3 px-5 rounded-lg hover:bg-gray-600 transition-colors font-bold text-lg">
                        إنشاء حساب جديد
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="chat-window" class="hidden fixed bottom-24 right-6 w-96 h-[500px] bg-white rounded-lg shadow-2xl flex flex-col z-50 overflow-hidden">
        
        <div id="chat-list-view" class="flex flex-col h-full">
            <div class="flex justify-between items-center p-3 bg-blue-600 text-white">
                <h3 id="chat-list-header-title" class="font-bold">الدردشات</h3>
                <button id="close-chat" class="text-white text-2xl">&times;</button>
            </div>
            
            <div id="chat-user-info" class="p-3 border-b text-sm">
                <p>مرحباً، <span id="chat-username-display" class="font-semibold">...</span></p>
                <button id="delete-all-chat-btn-in-chat-window" class="hidden text-red-500 text-xs font-semibold mt-1 hover:text-red-700" onclick="deleteAllChats()">
                     [حذف جميع سجلات الدردشة]
                 </button>
            </div>

            <div class="flex-grow overflow-y-auto">
                <div id="chat-tab-group" class="p-4 flex justify-between items-center cursor-pointer border-b hover:bg-gray-100" onclick="selectChat('group', 'group')">
                    <div>
                        <h3 class="font-semibold text-gray-900">دردشة جماعية</h3>
                        <p class="text-sm text-gray-600">رسائل عامة للجميع</p>
                    </div>
                    <span id="unread-badge-group" class="hidden w-6 h-6 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center">0</span>
                </div>
                
                <div class="p-4 border-b">
                    <h3 class="private-chat-header flex justify-between items-center">
                        محادثات خاصة
                        <span id="unread-badge-private-total" class="hidden w-6 h-6 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center">0</span>
                    </h3>
                </div>
                
                <div id="chat-users-list" class="flex-grow overflow-y-auto">
                    <p class="p-4 text-sm text-gray-500">جاري تحميل المستخدمين...</p>
                </div>
            </div>
        </div>

        <div id="chat-message-view" class="hidden flex flex-col h-full">
            <div class="flex justify-between items-center p-3 bg-blue-600 text-white">
                <button id="chat-back-btn" class="text-white p-1 rounded-full hover:bg-blue-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l-4-4 4-4M9 5l-7 7 7 7"></path></svg>
                </button>
                <div class="text-right flex-grow min-w-0 px-2">
                    <h3 id="chat-title" class="font-bold truncate">...</h3>
                    <p id="chat-subtitle" class="text-xs truncate">...</p>
                </div>
                <button id="close-chat-2" class="text-white text-2xl flex-shrink-0">&times;</button>
            </div>
            
            <div id="chat-messages" class="flex-1 p-3 overflow-y-auto bg-gray-50 space-y-3">
                </div>
            
            <form id="message-form" class="p-3 border-t flex gap-2 bg-white relative">
                <input type="text" id="message-input" placeholder="اكتب رسالتك..." autocomplete="off"
                        class="flex-1 px-3 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 relative z-0">
                
                <button type="submit"
                         class="bg-blue-500 text-white w-10 h-10 rounded-full font-semibold hover:bg-blue-600 flex-shrink-0 flex items-center justify-center relative z-10">
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.875L6 12z" />
                    </svg>
                </button>
            </form>
        </div>
    </div>


    <div id="add-item-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4 transition-opacity duration-300">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md transform transition-all scale-95 opacity-0" id="modal-content">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 class="text-2xl font-bold text-gray-800">إضافة عنصر جديد</h3>
                <button id="close-modal" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
            </div>
            <div class="border-b border-gray-200 mb-4">
                <nav class="-mb-px flex gap-4" aria-label="Tabs">
                    <button id="tab-link" class="w-1/2 py-4 px-1 text-center border-b-2 font-medium text-sm border-teal-500 text-teal-600">
                        إضافة رابط
                    </button>
                    <button id="tab-file" class="w-1/2 py-4 px-1 text-center border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        رفع ملف
                    </button>
                </nav>
            </div>
            <form id="add-item-form">
                <input type="hidden" id="column-id-input">
                <input type="hidden" id="item-type-input" value="link">
                <div class="space-y-4">
                    <div>
                        <label for="item-title" class="block text-sm font-medium text-gray-700 mb-1">العنوان (مطلوب)</label>
                        <input type="text" id="item-title" name="item-title" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500">
                    </div>
                    <div id="link-input-section">
                        <label for="item-link" class="block text-sm font-medium text-gray-700 mb-1">الرابط (URL)</label>
                        <input type="url" id="item-link" name="item-link" placeholder="https://example.com" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500">
                    </div>
                    <div id="file-input-section" class="hidden">
                        <label for="item-file" class="block text-sm font-medium text-gray-700 mb-1">اختر ملف</label>
                        <input type="file" id="item-file" name="item-file" class="w-full text-sm text-gray-500
                            file:mr-4 file:py-2 file:px-4
                            file:rounded-lg file:border-0
                            file:text-sm file:font-semibold
                            file:bg-teal-50 file:text-teal-700
                            hover:file:bg-teal-100">
                    </div>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" id="cancel-modal" class="py-2 px-4 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                        إلغاء
                    </button>
                    <button type="submit" class="py-2 px-5 bg-teal-600 text-white rounded-lg hover:bg-teal-700 transition-colors font-semibold">
                        إضافة
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="add-section-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4 transition-opacity duration-300">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md transform transition-all scale-95 opacity-0" id="add-section-modal-content">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 class="text-2xl font-bold text-gray-800">إضافة قسم جديد</h3>
                <button id="close-section-modal" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
            </div>
            <form id="add-section-form">
                <div class="space-y-4">
                    <div>
                        <label for="section-title" class="block text-sm font-medium text-gray-700 mb-1">عنوان القسم</label>
                        <input type="text" id="section-title" name="section-title" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500">
                    </div>
                    <div class="flex items-center">
                        <input id="section-visibility" type="checkbox" checked class="w-4 h-4 text-teal-600 border-gray-300 rounded focus:ring-teal-500">
                        <label for="section-visibility" class="mr-2 text-sm font-medium text-gray-900">إظهار هذا القسم للمشاهدين العاديين</label>
                    </div>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" id="cancel-section-modal" class="py-2 px-4 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                        إلغاء
                    </button>
                    <button type="submit" class="py-2 px-5 bg-teal-600 text-white rounded-lg hover:bg-teal-700 transition-colors font-semibold">
                        إضافة
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="edit-section-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 class="text-2xl font-bold text-gray-800">تعديل القسم</h3>
                <button id="close-edit-section-modal" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
            </div>
            <form id="edit-section-form">
                <input type="hidden" id="edit-section-id">
                <div class="space-y-4">
                    <div>
                        <label for="edit-section-title" class="block text-sm font-medium text-gray-700 mb-1">عنوان القسم</label>
                        <input type="text" id="edit-section-title" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500">
                    </div>
                    <div class="flex items-center">
                        <input id="edit-section-visibility" type="checkbox" class="w-4 h-4 text-teal-600 border-gray-300 rounded focus:ring-teal-500">
                        <label for="edit-section-visibility" class="mr-2 text-sm font-medium text-gray-900">إظهار هذا القسم للمشاهدين العاديين</label>
                    </div>
                </div>
                <div id="current-editors-container" class="hidden mt-6">
                    <h4 class="text-lg font-semibold text-gray-800 mb-2 border-t pt-4">المحررون الحاليون</h4>
                    <p class="text-sm text-gray-500 mb-3">يمكنك إزالة صلاحيات التحرير من المستخدمين المضافين هنا.</p>
                    <div class="max-h-40 overflow-y-auto bg-gray-50 rounded-lg p-3">
                        <ul id="current-editors-list" class="divide-y divide-gray-200">
                            </ul>
                    </div>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" id="cancel-edit-section-modal" class="py-2 px-4 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">إلغاء</button>
                    <button type="submit" class="py-2 px-5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">حفظ التعديل</button>
                </div>
            </form>
        </div>
    </div>

    <div id="edit-item-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 class="text-2xl font-bold text-gray-800">تعديل العنصر</h3>
                <button id="close-edit-item-modal" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
            </div>
            <form id="edit-item-form">
                <input type="hidden" id="edit-item-id">
                <input type="hidden" id="edit-item-section-id">
                <div class="space-y-4">
                    <div>
                        <label for="edit-item-title" class="block text-sm font-medium text-gray-700 mb-1">العنوان</label>
                        <input type="text" id="edit-item-title" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500">
                    </div>
                    <div>
                        <label for="edit-item-link" class="block text-sm font-medium text-gray-700 mb-1">الرابط (URL)</label>
                        <input type="url" id="edit-item-link" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500">
                    </div>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" id="cancel-edit-item-modal" class="py-2 px-4 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">إلغاء</button>
                    <button type="submit" class="py-2 px-5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">حفظ التعديل</button>
                </div>
            </form>
        </div>
    </div>

    <div id="alert-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[60] p-4 transition-opacity duration-300">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm transform transition-all scale-95 opacity-0" id="alert-modal-content">
            <h3 class="text-xl font-bold text-gray-800 mb-4">تنبيه</h3>
            <p id="alert-modal-message" class="text-gray-600 mb-6">رسالة التنبيه هنا.</p>
            <div class="flex justify-end">
                <button id="close-alert-modal" class="py-2 px-5 bg-teal-600 text-white rounded-lg hover:bg-teal-700 font-semibold">
                    حسناً
                </button>
            </div>
        </div>
    </div>

    <div id="pdf-spinner-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[100] p-4">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-xs text-center">
            <svg class="animate-spin h-12 w-12 text-teal-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
             <p class="text-gray-700 mt-4 font-semibold">جاري إنشاء ملف PDF...</p>
        </div>
    </div>

    <div id="admin-manage-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[70] p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 class="text-2xl font-bold text-gray-800">إدارة المستخدمين والصلاحيات</h3>
                <button id="close-admin-manage-modal" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
            </div>
            <div class="flow-root max-h-96 overflow-y-auto">
                <ul id="admin-users-list" role="list" class="divide-y divide-gray-200">
                    <li>جاري تحميل المستخدمين...</li>
                </ul>
            </div>
        </div>
    </div>

    <div id="admin-perms-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[70] p-4">
         <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
             <div class="flex justify-between items-center border-b pb-3 mb-4">
                 <h3 class="text-2xl font-bold text-gray-800">طلبات الصلاحيات المعلقة</h3>
                 <button id="close-admin-perms-modal" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
             </div>
             <div class="flow-root max-h-96 overflow-y-auto">
                 <ul id="admin-perms-list" role="list" class="divide-y divide-gray-200">
                     <li>جاري تحميل الطلبات...</li>
                 </ul>
             </div>
         </div>
     </div>


</body>
</html>
